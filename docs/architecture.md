# 系统架构文档

## 概述

朝阳数据SQL查询工具采用分层架构设计，结合了Flask Web框架的强大功能和现代前端技术，提供了一个安全、高效、易用的数据库查询平台。

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                         │
├─────────────────────────────────────────────────────────────────┤
│  Bootstrap 5  │  Prism.js  │  SQL Formatter  │  主题系统       │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                      │
├─────────────────────────────────────────────────────────────────┤
│  Flask Routes  │  业务逻辑层  │  安全中间件  │  配置管理       │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  数据库连接池  │  连接管理器  │  查询执行器  │  结果缓存       │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                      存储层 (Storage)                          │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  MySQL  │  Oracle  │  国产数据库  │  配置文件   │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 前端组件 (Frontend Components)

#### 1.1 UI框架
- **Bootstrap 5**: 响应式UI框架
- **自定义主题**: 支持10+种主题色彩方案
- **离线资源**: 所有静态资源本地化，支持完全离线运行

#### 1.2 编辑器功能
- **代码高亮**: Prism.js提供SQL语法高亮
- **SQL美化**: SQL Formatter实现代码格式化
- **智能提示**: 基于上下文的SQL关键字提示

#### 1.3 用户交互
- **实时反馈**: 异步加载和结果展示
- **主题切换**: 动态CSS变量切换
- **响应式布局**: 适配移动端和桌面端

### 2. 应用层组件 (Application Components)

#### 2.1 Flask路由系统
```python
# 主要路由分类
- 主页路由: '/', '/sql_beautify_test'
- 配置路由: '/save_db_config', '/get_saved_db_config'
- 查询路由: '/execute_sql', '/analyze_query_plan'
- 导出路由: '/export_excel', '/export_csv', '/export_html'
- 安全路由: '/check_app_password', '/change_app_password'
- 管理路由: '/databases', '/common_sqls'
```

#### 2.2 业务逻辑层
- **配置管理器**: 应用和数据库配置的加载与保存
- **连接管理器**: 多数据库连接池管理
- **查询处理器**: SQL语句解析、验证和执行
- **导出管理器**: 多种格式的数据导出处理

#### 2.3 安全中间件
- **认证装饰器**: `@require_auth` 统一认证处理
- **输入验证器**: 参数类型和长度的严格验证
- **SQL安全检查**: 危险操作检测和阻止
- **频率限制器**: IP级别的请求频率控制

### 3. 数据层组件 (Data Layer)

#### 3.1 数据库连接池
```python
# 连接池配置参数
- 最大连接数: app_max_connections (默认10)
- 最小连接数: app_min_connections (默认1)
- 连接超时: app_connection_pool_timeout (默认30秒)
- 连接重试: app_connection_retry_count (默认3次)
```

#### 3.2 数据库驱动映射
```python
DRIVER_MAPPING = {
    'postgresql': ('PostgreSQL', get_postgresql_connection, 'psycopg2'),
    'mysql': ('MySQL', get_mysql_connection, 'pymysql'),
    'oracle': ('Oracle', get_oracle_connection, 'cx_Oracle'),
    'kingbase': ('人大金仓', get_postgresql_connection, 'psycopg2'),
    'tidb': ('TiDB', get_tidb_connection, 'pymysql'),
    # ... 更多数据库类型
}
```

#### 3.3 查询执行引擎
- **语句分割**: 智能SQL语句分割，支持多语句执行
- **安全校验**: 多层SQL安全检查
- **超时控制**: 语句级和连接级超时设置
- **结果处理**: 统一的结果格式化和分页处理

### 4. 存储层 (Storage Layer)

#### 4.1 配置文件结构
```
conf/
├── app_config.json      # 应用级配置
├── db_config.json       # 数据库配置（加密存储）
└── common_sql.json      # 常用SQL配置
```

#### 4.2 配置管理策略
- **分层配置**: 默认配置 → 文件配置 → 运行时配置
- **配置验证**: 配置值的合理性和安全性验证
- **热重载**: 部分配置支持运行时更新
- **加密存储**: 敏感信息（密码）加密存储

## 安全架构

### 多层安全模型

```
┌─────────────────────────────────────────────────────────────┐
│                    应用级安全 (Application Security)          │
├─────────────────────────────────────────────────────────────┤
│  密码保护  │  会话管理  │  权限控制  │  审计日志  │  配置加密   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    传输级安全 (Transport Security)           │
├─────────────────────────────────────────────────────────────┤
│  HTTPS支持  │  请求加密  │  响应签名  │  CSRF防护  │  XSS防护   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    数据级安全 (Data Security)              │
├─────────────────────────────────────────────────────────────┤
│  SQL注入防护  │  数据脱敏  │  访问日志  │  备份恢复  │  数据加密   │
└─────────────────────────────────────────────────────────────┘
```

### 安全机制详解

#### 2.1 认证与授权
- **应用密码**: 可选的应用级访问密码
- **会话令牌**: 基于哈希的会话管理
- **权限验证**: 每个敏感操作都需要认证

#### 2.2 输入验证
- **类型检查**: 严格的参数类型验证
- **长度限制**: 输入长度和格式验证
- **模式匹配**: 正则表达式模式验证
- **SQL安全**: 危险关键词和模式过滤

#### 2.3 防护机制
- **频率限制**: IP级别的请求频率限制
- **账户锁定**: 登录失败次数限制和锁定
- **超时控制**: 会话和查询超时管理
- **异常处理**: 统一的异常处理和日志记录

## 性能优化

### 1. 连接优化
- **连接池复用**: 减少连接建立开销
- **连接超时**: 防止连接泄漏
- **连接重试**: 自动重试失败的连接
- **连接监控**: 实时连接状态监控

### 2. 查询优化
- **结果缓存**: 查询结果临时缓存
- **分页处理**: 大数据集的智能分页
- **超时控制**: 防止长时间运行的查询
- **资源限制**: 内存和结果集大小限制

### 3. 内存优化
- **流式处理**: 大文件导出采用流式处理
- **垃圾回收**: 及时清理过期数据
- **内存监控**: 内存使用监控和限制
- **资源清理**: 自动清理临时文件和缓存

## 扩展性设计

### 1. 数据库支持扩展
```python
# 添加新数据库类型的标准流程
def add_new_database_type():
    1. 在 SUPPORTED_DATABASES 中添加新类型
    2. 实现对应的连接函数
    3. 配置驱动映射关系
    4. 添加连接测试逻辑
    5. 更新EXPLAIN计划支持
```

### 2. 导出格式扩展
```python
# 添加新导出格式的标准流程
def add_new_export_format():
    1. 实现数据转换函数
    2. 添加新的导出路由
    3. 更新前端导出选项
    4. 添加格式配置参数
    5. 测试导出功能
```

### 3. 安全策略扩展
```python
# 添加新安全策略的标准流程
def add_new_security_policy():
    1. 定义新的安全规则
    2. 实现验证函数
    3. 集成到安全中间件
    4. 添加配置选项
    5. 更新安全文档
```

## 监控与运维

### 1. 日志系统
- **操作日志**: 所有SQL查询和导出操作记录
- **安全日志**: 认证失败和安全事件记录
- **系统日志**: 应用启动、配置变更等系统事件
- **错误日志**: 异常和错误的详细记录

### 2. 性能监控
- **查询性能**: SQL执行时间监控
- **连接状态**: 数据库连接状态监控
- **资源使用**: CPU、内存、磁盘使用监控
- **响应时间**: API响应时间统计

### 3. 健康检查
- **数据库连接**: 定期连接测试
- **配置有效性**: 配置文件完整性检查
- **依赖服务**: 外部服务可用性检查
- **资源状态**: 磁盘空间、内存使用情况

## 部署架构

### 1. 单机部署
```
┌─────────────────┐
│   Nginx/Apache  │  ←  反向代理（可选）
└─────────────────┘
         │
┌─────────────────┐
│   Flask App     │  ←  主应用
└─────────────────┘
         │
┌─────────────────┐
│   Database      │  ←  目标数据库
└─────────────────┘
```

### 2. 容器化部署
```dockerfile
# Dockerfile示例
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 5000
CMD ["python", "app.py", "--port=5000"]
```

### 3. 高可用部署
- **负载均衡**: 多实例部署，负载均衡
- **配置中心**: 集中配置管理
- **日志聚合**: 统一日志收集和分析
- **监控告警**: 实时监控和告警机制

## 总结

朝阳数据SQL查询工具采用现代化的分层架构设计，具有以下特点：

1. **高内聚低耦合**: 各层职责清晰，便于维护和扩展
2. **安全可靠**: 多层安全防护，保障数据安全
3. **性能优异**: 多种优化策略，确保高效运行
4. **易于扩展**: 标准化扩展接口，支持快速功能扩展
5. **运维友好**: 完善的监控和日志系统，便于运维管理

该架构设计充分考虑了企业级应用的需求，能够支撑大规模、高并发的数据库查询场景。