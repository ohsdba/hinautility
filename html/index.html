<!DOCTYPE html><html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon: æµè§ˆå™¨åœ°å€æ Hiå›¾æ ‡ï¼Œå°†åœ¨JavaScriptä¸­åŠ¨æ€æ›´æ–° -->
    <link rel="icon" type="image/svg+xml" id="dynamicFavicon" href="">
    <!-- ä½¿ç”¨æœ¬åœ° Bootstrap èµ„æºå®ç°å®Œå…¨ç¦»çº¿ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <title>æœé˜³æ•°æ®</title>
    <style>
        /* CSS å˜é‡å®šä¹‰ä¸»é¢˜è‰² */
        :root {
            --theme-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="default"] {
            --theme-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="blue"] {
            --theme-gradient: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);
        }
        [data-theme="green"] {
            --theme-gradient: linear-gradient(135deg, #0BA360 0%, #3CBA92 100%);
        }
        [data-theme="purple"] {
            --theme-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="red"] {
            --theme-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        [data-theme="orange"] {
            --theme-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        [data-theme="ocean"] {
            --theme-gradient: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);
        }
        [data-theme="sunset"] {
            --theme-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        [data-theme="forest"] {
            --theme-gradient: linear-gradient(135deg, #0BA360 0%, #3CBA92 100%);
        }
        [data-theme="night"] {
            --theme-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        [data-theme="sakura"] {
            --theme-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        /* ä¼ä¸šçº§ä¸»é¢˜é…è‰² */
        [data-theme="ibm"] {
            --theme-gradient: linear-gradient(135deg, #054DA2 0%, #00a2e0 100%);
        }
        [data-theme="oracle"] {
            --theme-gradient: linear-gradient(135deg, #EA1B22 0%, #FECE00 100%);
        }
        [data-theme="sap"] {
            --theme-gradient: linear-gradient(135deg, #009DE0 0%, #E68800 100%);
        }
        [data-theme="microsoft"] {
            --theme-gradient: linear-gradient(135deg, #00BCF2 0%, #00ADEF 100%);
        }
        [data-theme="google"] {
            --theme-gradient: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
        }
        [data-theme="amazon"] {
            --theme-gradient: linear-gradient(135deg, #FF9900 0%, #146EB4 100%);
        }
        [data-theme="apple"] {
            --theme-gradient: linear-gradient(135deg, #000000 0%, #FAFAFA 100%);
        }
        [data-theme="meta"] {
            --theme-gradient: linear-gradient(135deg, #4267B2 0%, #898F9C 100%);
        }
        [data-theme="salesforce"] {
            --theme-gradient: linear-gradient(135deg, #1798C1 0%, #A0D65B 100%);
        }
        [data-theme="adobe"] {
            --theme-gradient: linear-gradient(135deg, #FF0000 0%, #FFDC4A 100%);
        }
        [data-theme="twitter"] {
            --theme-gradient: linear-gradient(135deg, #1DA1F2 0%, #135AA6 100%);
        }
        [data-theme="linkedin"] {
            --theme-gradient: linear-gradient(135deg, #0077B5 0%, #00A0DC 100%);
        }
        /* å…¨å±€å­—ä½“ */
        * {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        

        

        

        

        

        

        

        
        /* æ¨¡æ€æ¡†ä¸»é¢˜é¢œè‰² */
        .modal-header {
            background: var(--theme-gradient) !important;
            color: white !important;
        }
        
        .modal-custom .modal-header {
            background: var(--theme-gradient) !important;
            color: #fff !important;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
            border: none;
        }
        body {
            background: var(--theme-gradient);
            min-height: 100vh;
            padding: 20px 0;
            transition: background 0.5s ease;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            animation: fadeIn 0.6s ease-out;
            background-size: 200% 200%;
        }
        
        /* æ¸å˜èƒŒæ™¯åŠ¨ç”» */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body.animated-bg {
            animation: gradientShift 15s ease infinite, fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in-element {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .card {
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        /* é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ */
        .header-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 25px 40px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-title {
            font-size: 2.6rem;
            font-weight: 800;
            background: var(--theme-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: 1.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-title-style {
            background: var(--theme-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        /* ä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ä¼˜åŒ– */
        .theme-config-card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 28px;
            border: 1px solid rgba(226, 232, 240, 0.6);
            backdrop-filter: blur(12px);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }
        .theme-config-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(125, 180, 255, 0.2), transparent);
        }
        .theme-config-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0,0,0, 0.15);
        }
        .theme-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 28px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .theme-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .theme-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .theme-header[aria-expanded="true"] .theme-toggle-icon {
            transform: rotate(180deg);
        }
        .theme-body-wrapper {
            padding: 15px 25px 20px;
            border-top: 1px solid #eef1f5;
        }
        .theme-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .theme-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            position: relative;
        }
        .theme-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #6c757d;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .theme-btn:hover::after {
            opacity: 1;
        }
        .theme-btn:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        .theme-btn.active {
            border-color: white;
            box-shadow: 0 0 0 2px #667eea, 0 6px 16px rgba(0,0,0,0.25);
            transform: scale(1.1);
        }
        /* é¡µè„šç‰ˆæƒä¿¡æ¯ */
        .footer-copyright {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 30px;
        }
        .footer-copyright a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 600;
        }
        .footer-copyright a:hover {
            text-decoration: underline;
        }
        /* æ‰¹é‡æ‰§è¡Œç»“æœæ ·å¼ */
        .batch-results-container {
            width: 100%;
        }
        .batch-result-item {
            background-color: #f8f9fa;
            border-left: 4px solid #2196f3;
            margin-bottom: 15px;
            transition: box-shadow 0.2s ease;
        }
        .batch-result-item:hover {
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
        }
        .batch-result-item h5 {
            font-size: 1rem;
            color: #495057;
        }
        .batch-result-item code {
            background: rgba(0,0,0,.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card-custom {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 28px;
            margin-bottom: 28px;
            border: 1px solid rgba(226, 232, 240, 0.6);
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInCard 0.5s ease-out 0.2s forwards;
        }
        
        @keyframes slideInCard {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(125, 180, 255, 0.2), transparent);
        }
        .card-custom:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0,0,0, 0.15);
        }
        /* æ•°æ®åº“é…ç½®åŒºåŸŸ */
        .config-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eef1f5;
        }
        /* æ•°æ®åº“é…ç½®æŠ˜å æ ·å¼ */
        .config-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            padding: 14px 18px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid rgba(226, 232, 240, 0.7);
            margin-bottom: 16px;
        }
        .config-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .config-toggle-icon {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.1rem;
            color: #64748b;
            font-weight: 600;
            min-width: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: rgba(241, 245, 249, 0.7);
        }
        .config-header[aria-expanded="true"] .config-toggle-icon {
            transform: rotate(180deg);
        }
        .config-body-wrapper {
            transition: all 0.3s ease;
        }
        /* å¸¸ç”¨SQLåŒºåŸŸ */
        .common-sql-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eef1f5;
        }
        .common-sql-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 5px 0;
        }
        .common-sql-item {
            padding: 8px 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0; /* å…è®¸æ”¶ç¼©ä»¥é€‚åº”å®¹å™¨ */
            flex: 0 0 auto; /* ä¸ä¼¸å±•ï¼Œæ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            max-width: 100%; /* ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .common-sql-item:hover {
            background-color: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33,150,243,0.1);
        }
        .common-sql-item.default-db {
            background-color: #d4edda;
            border-color: #c3e6cb;
            position: relative;
        }
        .common-sql-item.default-db::after {
            content: 'é»˜è®¤';
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        .common-sql-item.selected-db {
            background-color: var(--theme-bg-selected, #d1ecf1);
            border-color: var(--theme-border-selected, #bee5eb);
            box-shadow: 0 0 0 3px var(--theme-shadow-selected, rgba(23, 162, 184, 0.25));
            position: relative;
        }
        .common-sql-item.selected-db::before {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            left: -8px;
            background-color: var(--theme-color, #17a2b8);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .common-sql-item.selected-db .common-sql-name {
            color: var(--theme-color, #17a2b8);
            font-weight: 600;
        }
        .common-sql-item.selected-db.default-db {
            background-color: #c3e6cb;
            border-color: #8fd19e;
        }
        .common-sql-item.selected-db.default-db::before {
            background-color: #28a745;
        }
        .common-sql-item.selected-db.default-db::after {
            content: 'é»˜è®¤';
            top: -8px;
            right: -8px;
            background-color: #17a2b8;
            font-size: 9px;
        }
        .common-sql-name {
            flex: 1;
            min-width: 0; /* å…è®¸æ”¶ç¼© */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
            color: #2c3e50;
            padding-right: 5px;
        }
        .common-sql-actions {
            display: flex;
            gap: 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .common-sql-item:hover .common-sql-actions {
            opacity: 1;
        }
        .common-sql-item.selected {
            background-color: var(--theme-bg-selected, #e3f2fd);
            border-color: var(--theme-border-selected, #2196f3);
            box-shadow: 0 0 0 3px var(--theme-shadow-selected, rgba(33, 150, 243, 0.25));
        }
        .common-sql-item.selected .common-sql-name {
            color: var(--theme-color, #1890ff);
            font-weight: 600;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: all 0.2s;
            background: transparent;
            border: none;
            color: #6b7280;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .action-btn:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .btn-edit:hover { color: #3b82f6; }
        .btn-delete:hover { color: #ef4444; }
        .btn-copy:hover { color: #10b981; }
        .btn-add-new {
            background-color: #fff;
            border: 1px dashed #3b82f6;
            color: #3b82f6;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .btn-add-new:hover {
            background-color: #3b82f6;
            color: #fff;
            border-style: solid;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(59,130,246,0.2);
        }
        /* SQLè¾“å…¥æ¡† */
        /* SQLè¾“å…¥æ¡† */
        #sqlInput {
            min-height: 180px;
            height: auto;
            font-family: Consolas, monospace !important;
            font-size: 14px;
            resize: vertical;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05) inset;
            padding: 15px;
            line-height: 1.6;
            width: 100%;
            background: #fff;
            color: #2c3e50;
            transition: all 0.3s ease;
        }
        #sqlInput:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
            outline: none;
            transform: translateY(-1px);
        }
        #sqlInput:hover {
            border-color: #94a3b8;
        }
        /* å±é™©SQLæç¤ºæ ·å¼ */
        .danger-sql-alert {
            background-color: #fee;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .danger-icon {
            font-size: 20px;
            color: #dc3545;
        }
        /* æŒ‰é’®é€šç”¨æ ·å¼ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ */
        /* æŒ‰é’®è¡Œå®¹å™¨æ ·å¼ */
        .button-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 2px;
            align-items: center;
        }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        /* ä¸»è¦æŒ‰é’®ç»„ */
        .button-group.primary-buttons {
            flex: 0 0 auto;
        }
        
        /* å¯¼å‡ºæŒ‰é’®ç»„ */
        .button-group.export-buttons {
            flex-shrink: 0;
        }

        .btn-custom {
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            border: none;
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            margin-right: 4px;
            display: inline-block;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.2px;
            text-transform: none;
        }
        .btn-custom::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-custom:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-custom:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        /* ä¸»æŒ‰é’®ï¼ˆæ‰§è¡ŒæŸ¥è¯¢ï¼‰ */
        .btn-primary-custom {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #fff;
        }
        .btn-primary-custom:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59,130,246,0.3);
            color: #fff;
        }
        /* æ¬¡è¦æŒ‰é’®ï¼ˆæ¸…ç©ºï¼‰ */
        .btn-secondary-custom {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: #fff;
        }
        .btn-secondary-custom:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(107,114,128,0.3);
            color: #fff;
        }
        /* ä¿¡æ¯æŒ‰é’®ï¼ˆåˆ†ææŸ¥è¯¢è®¡åˆ’ï¼‰ */
        .btn-info-custom {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #fff;
        }
        .btn-info-custom:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(14,165,233,0.3);
            color: #fff;
        }
        /* å¯¼å‡ºExcelæŒ‰é’® */
        .btn-export-excel {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
        }
        .btn-export-excel:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16,185,129,0.3);
            color: #fff;
        }
        /* å¯¼å‡ºCSVæŒ‰é’® */
        .btn-export-csv {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #fff;
        }
        .btn-export-csv:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139,92,246,0.3);
            color: #fff;
        }
        /* å¯¼å‡ºHTMLæŒ‰é’® */
        .btn-export-html {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: #fff;
        }
        .btn-export-html:hover {
            background: linear-gradient(135deg, #db2777 0%, #be185d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(236,72,153,0.3);
            color: #fff;
        }
        /* å¯¼å…¥é…ç½®æŒ‰é’® - è°ƒæ•´å­—ä½“é¢œè‰²å’Œæ‚¬åœèƒŒæ™¯è‰² */
        .btn-import-config-text {
            color: #10b981; /* ç»¿è‰²å­—ä½“ */
            border-color: #10b981; /* ç»¿è‰²è¾¹æ¡† */
        }
        .btn-import-config-text:hover {
            background-color: #10b981; /* æ‚¬åœæ—¶ç»¿è‰²èƒŒæ™¯ */
            color: #fff; /* æ‚¬åœæ—¶ç™½è‰²å­—ä½“ */
            border-color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16,185,129,0.3);
        }
        /* é…ç½®ä¿å­˜/æ›´æ–°æŒ‰é’® */
        .btn-save-custom, .btn-update-custom {
            color: #fff;
            margin-top: 28px;
            width: 100%;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: block;
            position: relative;
            overflow: hidden;
        }
        .btn-save-custom {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .btn-save-custom:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245,158,11,0.3);
            color: #fff;
        }
        .btn-update-custom {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn-update-custom:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239,68,68,0.3);
            color: #fff;
        }
        /* åŠ è½½ä¸­çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
            display: none;
        }
        .loading-spinner-small {
            width: 20px;
            height: 20px;
            border: 3px solid #f57c00;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .plan-analysis-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .plan-analysis-title {
            color: #2563eb;
            font-weight: 600;
            margin: 0;
        }
        
        .plan-analysis-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin: 5px 0 0 0;
        }
        /* åˆ†é¡µæ ·å¼ä¼˜åŒ– - æ ¸å¿ƒä¿®å¤æ¨ªå‘æ’åˆ— */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 16px 0;
            margin: 0 auto;
            width: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.7);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: paginationFadeIn 0.4s ease-out 0.1s forwards;
            opacity: 0;
        }
        
        @keyframes paginationFadeIn {
            to {
                opacity: 1;
            }
        }
        .page-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14.5px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            min-width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .page-btn:not(:disabled):hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #1e293b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .page-btn:disabled {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .page-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
            font-weight: 700;
            transform: translateY(-1px);
        }
        .page-jump {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .page-jump input {
            width: 60px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            text-align: center;
            height: 36px;
        }
        .page-jump button {
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #2196f3;
            color: #fff;
            border: none;
            cursor: pointer;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        /* ç»“æœåŒºåŸŸ */
        .result-area {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            background-color: #fff;
            padding: 20px;
            margin-top: 20px;
            animation: resultSlideUp 0.5s ease-out 0.2s forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes resultSlideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* è¡¨æ ¼æ ·å¼ */
        .table {
            font-size: 14.5px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            animation: tableAppear 0.4s ease-out 0.3s forwards;
            opacity: 0;
        }
        
        @keyframes tableAppear {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
            border: none;
            padding: 16px 12px;
            font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            letter-spacing: 0.2px;
        }
        .table td {
            border-color: #e2e8f0;
            padding: 14px 12px;
            vertical-align: middle;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-bottom: none;
            transition: background-color 0.2s ease;
        }
        .table tr {
            transition: background-color 0.2s ease;
        }
        .table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .table tr:hover {
            background-color: #f0f7ff !important;
        }
        .table tr:first-child td {
            border-top: 1px solid #e2e8f0;
        }
        .table tr:last-child td {
            border-bottom: 1px solid #e2e8f0;
        }
        /* è¡¨å•æ§ä»¶ */
        .form-control {
            border-radius: 10px;
            border: 1px solid #d1d5db;
            padding: 12px 16px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            height: 46px;
            background-color: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
            color: #1f2937;
        }
        .form-control:hover:not(:focus) {
            border-color: #94a3b8;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
            background-color: #ffffff;
            transform: translateY(-1px);
        }
        .form-control::placeholder {
            color: #9ca3af;
            font-style: normal;
        }
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }
        /* ç¦ç”¨çŠ¶æ€çš„è¾“å…¥æ¡†æ ·å¼ */
        .form-control:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        /* æç¤ºæ¡† */
        .alert {
            border-radius: 8px;
            border: none;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        /* åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            display: inline-block;
            vertical-align: middle;
        }
        /* è‡ªå®šä¹‰æ¨¡æ€æ¡†æ ·å¼ */
        .modal-custom .modal-dialog {
            max-width: 500px;
        }
        .modal-custom .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: scale(0.95);
            animation: modalEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
        }
        
        @keyframes modalEnter {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .modal-custom .modal-header {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: #fff;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
            border: none;
        }
        .modal-custom .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-custom .modal-body {
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        .modal-custom .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eef1f5;
            border-radius: 0 0 12px 12px;
            justify-content: center;
            gap: 15px;
        }
        .modal-custom .btn-modal {
            padding: 8px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
        }
        .btn-modal-confirm {
            background-color: #2196f3;
            color: #fff;
        }
        .btn-modal-confirm:hover {
            background-color: #1976d2;
            color: #fff;
        }
        .btn-modal-cancel {
            background-color: #6c757d;
            color: #fff;
        }
        .btn-modal-cancel:hover {
            background-color: #5a6268;
            color: #fff;
        }
        /* Excel/CSVå¯¼å‡ºé…ç½®æ¨¡æ€æ¡† */
        #excelExportModal .modal-dialog,
        #csvExportModal .modal-dialog {
            max-width: 600px;
        }
        .export-config-item {
            margin-bottom: 20px;
        }
        .export-config-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #34495e;
        }
        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            /* æŒ‰é’®è¡Œç§»åŠ¨ç«¯é€‚é… */
            .button-row {
                flex-direction: column;
                gap: 6px;
            }
            
            .button-row.main-actions {
                margin-bottom: 12px;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ç»„é€‚é… */
            .button-group {
                width: 100%;
                justify-content: center;
            }
            
            /* ç§»åŠ¨ç«¯å¯¼å‡ºæŒ‰é’®ç»„æ¢è¡Œæ˜¾ç¤º */
            .button-group.export-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            /* è°ƒæ•´ç§»åŠ¨ç«¯æŒ‰é’®å°ºå¯¸ */
            .btn-custom {
                padding: 12px 20px;
                font-size: 14px;
                flex: 1;
                min-width: 80px;
                text-align: center;
                margin-right: 0;
                white-space: normal;
                word-wrap: break-word;
                line-height: 1.4;
                height: 50px; /* ç»Ÿä¸€é«˜åº¦ */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .config-item {
                margin-bottom: 10px;
            }
            .pagination-container {
                flex-direction: column;
                gap: 8px;
            }
            .page-jump {
                margin-left: 0;
                margin-top: 5px;
            }
            .header-title {
                font-size: 2rem;
            }
            .btn-custom {
                margin-bottom: 10px;
                width: 100%;
                margin-right: 0;
            }
        }
        

        
    </style>
    <style>
        /* å°†æ•°æ®åº“ç±»å‹ä¸‹æ‹‰æ¡†æ•´ä½“å‘å³åç§»2ä¸ªå­—ç¬¦å®½åº¦ï¼Œä»¥é¿å…å·¦ä¾§å†…å®¹è´´è¾¹ */
        select#configDbType {
            transform: translateX(12px); /* å‘å³ç§»åŠ¨çº¦2ä¸ªå­—ç¬¦çš„å®½åº¦ */
            margin-left: -12px; /* è¡¥å¿transformå¯¼è‡´çš„ä½ç½®åç§»ï¼Œä¿æŒä¸å…¶ä»–è¾“å…¥æ¡†å¯¹é½ */
        }
        
        /* æµ‹è¯•è¿æ¥æŒ‰é’®æ ·å¼ */
        .btn-test-connection {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            border: 1px solid transparent;
            transition: all 0.15s ease-in-out;
        }
        
        .btn-test-connection:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .btn-test-connection:focus {
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            /* è°ƒæ•´æ¨¡æ€æ¡†å¤§å°ä»¥é€‚åº”ç§»åŠ¨è®¾å¤‡ - åŠ¨æ€å°ºå¯¸ */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
                width: auto;
            }
            
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 12px;
            }
            
            /* å°å±å¹•è®¾å¤‡è¿›ä¸€æ­¥ä¼˜åŒ– */
            @media (max-width: 576px) {
                .modal-dialog {
                    margin: 0.25rem;
                    max-width: calc(100vw - 0.5rem);
                }
                
                .modal-content {
                    max-height: 95vh;
                    border-radius: 8px;
                }
                
                /* è¶…å°å±å¯¼å‡ºæŒ‰é’®é€‚é… */
                .button-group.export-buttons {
                    gap: 4px;
                }
                
                .button-group.export-buttons .btn-custom {
                    flex: 1;
                    min-width: auto;
                    padding: 10px 12px;
                    font-size: 12px;
                }
            }
            
            /* è°ƒæ•´è¾“å…¥æ¡†é—´è· */
            .modal-body .mb-3 {
                margin-bottom: 0.75rem;
            }
            
            /* è°ƒæ•´æŒ‰é’®å¸ƒå±€ */
            .modal-footer {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-footer > button {
                margin-bottom: 0.5rem;
            }
            
            .modal-footer > button:last-child {
                margin-bottom: 0;
            }
            
            /* è°ƒæ•´ä¸»ç•Œé¢å…ƒç´  */
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* è°ƒæ•´æ•°æ®åº“è¿æ¥æ  */
            .db-connection-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .db-selector-container {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .db-actions {
                width: 100%;
            }
            
            .db-actions .btn {
                width: 100%;
                margin-bottom: 0.25rem;
            }
            
            /* è°ƒæ•´SQLæ‰§è¡ŒåŒºåŸŸ */
            .sql-execution-section {
                padding: 0.5rem;
            }
            
            /* è°ƒæ•´ç»“æœè¡¨æ ¼ */
            .table-responsive {
                font-size: 0.875rem;
            }
            
            /* è°ƒæ•´é¡µè„š */
            .footer-copyright {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            
            /* è°ƒæ•´å¤´éƒ¨æ ‡é¢˜å¸ƒå±€ï¼Œä½¿å…¶åœ¨ç§»åŠ¨ç«¯å‚ç›´å †å  */
            .header-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .header-title {
                font-size: 1.5rem;
                align-self: center;
                width: 100%;
                text-align: center;
            }
            
            #timeDisplay {
                align-self: center;
                text-align: center;
                min-width: auto;
                font-size: 0.9rem;
            }
            
            /* ç§»åŠ¨ç«¯å¤´éƒ¨æŒ‰é’®å‚ç›´æ’åˆ—ï¼Œæ–‡å­—æ¨ªæ’æ˜¾ç¤º */
            .header-wrapper > div:last-child > div:last-child {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
            
            .header-wrapper > div:last-child > div:last-child .btn {
                width: auto;
                writing-mode: horizontal-tb !important;
                text-orientation: mixed !important;
                padding: 8px 12px;
                font-size: 0.8rem;
                height: auto;
                min-height: 40px;
                white-space: nowrap;
            }
        }
        
        @media (max-width: 576px) {
            /* é’ˆå¯¹å°å±å¹•è®¾å¤‡çš„é¢å¤–ä¼˜åŒ– */
            .main-content {
                padding: 0.5rem;
            }
            
            /* å°å±å¹•æŒ‰é’®è¿›ä¸€æ­¥ä¼˜åŒ– */
            .button-row {
                gap: 6px;
            }
            
            .btn-custom {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 70px;
                white-space: normal;
                word-wrap: break-word;
                line-height: 1.4;
                height: 45px; /* ç»Ÿä¸€é«˜åº¦ */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .card {
                margin-bottom: 0.75rem;
            }
            
            .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.875rem;
            }
            
            /* å°å±å¹•å¤´éƒ¨æŒ‰é’®å‚ç›´æ’åˆ—ï¼Œæ–‡å­—æ¨ªæ’æ˜¾ç¤º */
            .header-wrapper > div:last-child > div:last-child {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.4rem;
            }
            
            .header-wrapper > div:last-child > div:last-child .btn {
                width: auto;
                writing-mode: horizontal-tb !important;
                text-orientation: mixed !important;
                padding: 6px 10px;
                font-size: 0.75rem;
                height: auto;
                min-height: 35px;
                white-space: nowrap;
            }
            
            /* è°ƒæ•´æ•°æ®åº“é…ç½®æ¨¡æ€æ¡† */
            #dbConfigModal .modal-dialog {
                margin: 0.25rem;
            }
            
            /* é’ˆå¯¹æ•°æ®åº“é…ç½®æ¨¡æ€æ¡†çš„æŒ‰é’®å¸ƒå±€ */
            #dbConfigModal .modal-footer {
                gap: 0.25rem;
            }
            
            #dbConfigModal .modal-footer .btn {
                flex: 1;
                margin-bottom: 0;
            }
        }
        
    </style>
    

    
    <!-- ä¿®å¤æ•°æ®åº“é…ç½®å¯¼å‡ºåŠŸèƒ½çš„è„šæœ¬ -->
    <script src="{{ url_for('static', filename='js/fix-export-config.js') }}"></script>
</head>
<body class="animated-bg">
    <!-- å¯†ç éªŒè¯è¦†ç›–å±‚ -->
    <div id="passwordOverlay" class="password-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); z-index: 9999; display: none; align-items: center; justify-content: center; overflow: hidden;">
        <div class="modal-dialog modal-dialog-centered" style="margin: 0; width: 100%; max-width: 450px; animation: modalAppear 0.4s ease-out;">
            <div class="modal-content" style="border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: none; overflow: hidden;">
                <div class="modal-header" style="background: var(--theme-gradient); color: white; text-align: center; padding: 25px;">
                    <div style="width: 100%; text-align: center;">
                        <h5 class="modal-title" style="font-weight: 600; font-size: 1.5rem; margin: 0;">ğŸ”’ åº”ç”¨è®¿é—®éªŒè¯</h5>
                    </div>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <form id="passwordForm">
                        <div class="form-group mb-3">
                            <label for="appPassword" class="form-label" style="font-weight: 500; color: white;">è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="appPassword" placeholder="è¾“å…¥å¯†ç " autocomplete="off" style="height: 50px; border-radius: 10px; border: 2px solid #e9ecef; padding-left: 15px; font-size: 1rem;">
                                <span class="input-group-text" style="background: #f8f9fa; border-left: none; border-radius: 0 10px 10px 0; cursor: pointer;" id="togglePasswordVisibility">
                                    ğŸ‘ï¸
                                </span>
                            </div>
                        </div>
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-primary" style="height: 50px; border-radius: 10px; background: var(--theme-gradient); border: none; font-size: 1.1rem; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s;">
                                ğŸ” éªŒè¯å¹¶è§£é”
                            </button>
                        </div>
                        <div class="text-center mt-3">
                            <a href="#" class="text-white" onclick="showChangePasswordFromLogin(); return false;" style="text-decoration: underline;">æ›´æ–°å¯†ç </a>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="background: #f8f9fa; padding: 15px; text-align: center; border-top: 1px solid #e9ecef;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¯†ç é”™è¯¯æç¤ºæ¨¡æ€æ¡† -->
    <div id="passwordErrorModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(to right, #e74c3c, #c0392b); color: white;">
                    <h5 class="modal-title">âš ï¸ éªŒè¯å¤±è´¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessageText">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeErrorModal()">å…³é—­</button>
                    <button type="button" class="btn btn-danger" onclick="resetPasswordInput()">é‡æ–°è¾“å…¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®å¯†ç æ¨¡æ€æ¡† -->
    <div id="setPasswordModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--theme-gradient); color: white;">
                    <h5 class="modal-title">ğŸ” è®¾ç½®è®¿é—®å¯†ç </h5>
                    <button type="button" class="btn-close" onclick="closeSetPasswordModal()" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <form id="setPasswordForm">
                        <div class="form-group mb-3">
                            <label for="newPassword1" class="form-label">æ–°å¯†ç ï¼š</label>
                            <input type="password" class="form-control" id="newPassword1" placeholder="è¯·è¾“å…¥æ–°å¯†ç " autocomplete="off">
                        </div>
                        <div class="form-group mb-3">
                            <label for="newPassword2" class="form-label">ç¡®è®¤å¯†ç ï¼š</label>
                            <input type="password" class="form-control" id="newPassword2" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="off">
                        </div>
                        <div id="setPasswordError" class="text-danger mt-2" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSetPasswordModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSetPassword()">ç¡®è®¤è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--theme-gradient); color: white;">
                    <h5 class="modal-title">ğŸ” æ›´æ”¹è®¿é—®å¯†ç </h5>
                    <button type="button" class="btn-close" onclick="closeChangePasswordModal()" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="form-group mb-3">
                            <label for="currentPassword" class="form-label">å½“å‰å¯†ç ï¼š</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " autocomplete="off">
                        </div>
                        <div class="form-group mb-3">
                            <label for="changeNewPassword1" class="form-label">æ–°å¯†ç ï¼š</label>
                            <input type="password" class="form-control" id="changeNewPassword1" placeholder="è¯·è¾“å…¥æ–°å¯†ç " autocomplete="off">
                        </div>
                        <div class="form-group mb-3">
                            <label for="changeNewPassword2" class="form-label">ç¡®è®¤å¯†ç ï¼š</label>
                            <input type="password" class="form-control" id="changeNewPassword2" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="off">
                        </div>
                        <div id="changePasswordError" class="text-danger mt-2" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="confirmChangePassword()">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>
        
    <!-- æˆåŠŸæ¶ˆæ¯æ¨¡æ€æ¡† -->
    <div id="successMessageModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(to right, #2ecc71, #27ae60); color: white;">
                    <h5 class="modal-title">âœ… æ“ä½œæˆåŠŸ</h5>
                    <button type="button" class="btn-close" onclick="closeSuccessMessageModal()" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessageText">æ“ä½œæˆåŠŸå®Œæˆï¼</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="closeSuccessMessageModal()">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>
        
    <div class="container" id="mainContent" style="display: none; opacity: 0; pointer-events: none; transition: none;">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ§åˆ¶æ  -->
        <div class="header-wrapper d-flex justify-content-between align-items-center mb-4">
            <div class="header-title">æœé˜³æ•°æ®</div>
            <div class="d-flex align-items-center gap-3">
                <!-- å®æ—¶æ—¶é—´æ˜¾ç¤º -->
                <div id="timeDisplay" class="header-title" style="min-width: 220px; text-align: right; font-size: 1rem;">
                    --:--:-- --<br>--:--:--
                </div>
                <!-- æŒ‰é’®å®¹å™¨ -->
                <div class="d-flex flex-column align-items-end gap-2">
                    <!-- é”å®šæŒ‰é’® -->
                    <button class="btn btn-outline-light header-title-style" onclick="lockScreen()" title="é”å®šå±å¹•" style="border-color: rgba(255,255,255,0.5); font-size: 0.9rem; font-weight: 600; padding: 5px 10px;">
                        <i class="fas fa-lock me-1"></i>é”å®š
                    </button>
                    <!-- è‡ªåŠ¨é”å®šé…ç½®æŸ¥çœ‹æŒ‰é’® -->
                    <button class="btn btn-outline-light header-title-style" onclick="delayedShowConfig()" title="æŸ¥çœ‹è‡ªåŠ¨é”å®šé…ç½®" style="border-color: rgba(255,255,255,0.5); font-size: 0.9rem; font-weight: 600; padding: 5px 10px;">
                        <i class="fas fa-cog me-1"></i>é…ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»é¢˜é…è‰²é€‰æ‹©å™¨ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="card-custom">
            <div class="config-header" data-bs-toggle="collapse" data-bs-target="#themeConfigBody" aria-expanded="false" aria-controls="themeConfigBody">
                <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0;">ä¸»é¢˜é…è‰²</div>
                <span class="config-toggle-icon">â–¼</span>
            </div>
            <div class="collapse" id="themeConfigBody">
                <div class="config-body-wrapper pt-3">
                    <div class="theme-selector">
                        <!-- ä¿ç•™æš—å¤œé»‘åŠä¹‹åçš„é¢œè‰² -->
                        <button class="theme-btn" data-theme="night" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);" title="æš—å¤œé»‘"></button>
                        <button class="theme-btn" data-theme="ocean" style="background: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);" title="æ·±æµ·è“"></button>
                        <button class="theme-btn" data-theme="sunset" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" title="è½æ—¥æ©™"></button>
                        <button class="theme-btn" data-theme="forest" style="background: linear-gradient(135deg, #0BA360 0%, #3CBA92 100%);" title="æ£®æ—ç»¿"></button>
                        <button class="theme-btn" data-theme="sakura" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" title="æ¨±èŠ±ç²‰"></button>
                        <!-- ä¼ä¸šçº§é…è‰² -->
                        <button class="theme-btn" data-theme="ibm" style="background: linear-gradient(135deg, #054DA2 0%, #00a2e0 100%);" title="IBMè“"></button>
                        <button class="theme-btn" data-theme="oracle" style="background: linear-gradient(135deg, #EA1B22 0%, #FECE00 100%);" title="Oracleçº¢é‡‘"></button>
                        <button class="theme-btn" data-theme="sap" style="background: linear-gradient(135deg, #009DE0 0%, #E68800 100%);" title="SAPè“æ©™"></button>
                        <button class="theme-btn" data-theme="microsoft" style="background: linear-gradient(135deg, #00BCF2 0%, #00ADEF 100%);" title="Microsoftè“"></button>
                        <button class="theme-btn" data-theme="google" style="background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);" title="Googleå¤šå½©"></button>
                        <button class="theme-btn" data-theme="amazon" style="background: linear-gradient(135deg, #FF9900 0%, #146EB4 100%);" title="Amazonæ©™è“"></button>
                        <button class="theme-btn" data-theme="apple" style="background: linear-gradient(135deg, #000000 0%, #FAFAFA 100%);" title="Appleé»‘ç™½"></button>
                        <button class="theme-btn" data-theme="meta" style="background: linear-gradient(135deg, #4267B2 0%, #898F9C 100%);" title="Metaè“ç°"></button>
                        <button class="theme-btn" data-theme="salesforce" style="background: linear-gradient(135deg, #1798C1 0%, #A0D65B 100%);" title="Salesforceè“ç»¿"></button>
                        <button class="theme-btn" data-theme="adobe" style="background: linear-gradient(135deg, #FF0000 0%, #FFDC4A 100%);" title="Adobeçº¢é»„"></button>
                        <button class="theme-btn" data-theme="twitter" style="background: linear-gradient(135deg, #1DA1F2 0%, #135AA6 100%);" title="Twitterè“"></button>
                        <button class="theme-btn" data-theme="linkedin" style="background: linear-gradient(135deg, #0077B5 0%, #00A0DC 100%);" title="LinkedInè“"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åº“é…ç½®åŒºåŸŸ -->
        <div class="card-custom">
            <div class="config-header" data-bs-toggle="collapse" data-bs-target="#dbConfigBody" aria-expanded="false" aria-controls="dbConfigBody">
                <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0;">æ•°æ®åº“é…ç½®</div>
                <span class="config-toggle-icon">â–¼</span>
            </div>
            <div class="collapse" id="dbConfigBody">
                <div class="config-body-wrapper pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0; font-size: 1.1rem;">æ•°æ®åº“åˆ—è¡¨</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="addNewDatabase()">æ–°å¢æ•°æ®åº“</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="openDbConfigSelectionModal()">é€‰æ‹©å¯¼å‡º</button>
                            <button class="btn btn-sm btn-import-config-text" onclick="triggerDbConfigImport()">å¯¼å…¥é…ç½®</button>
                            <input type="file" id="dbConfigImportInput" style="display: none;" accept=".json" onchange="handleDbConfigImport(this)">
                        </div>
                    </div>
                    <div id="currentDbIndicator" style="margin-bottom: 15px; font-weight: 500; color: #0d6efd;">
                        å½“å‰æ­£åœ¨è¿æ¥çš„æ•°æ®åº“: <span id="currentDbName">æ— </span>
                    </div>
                    <div id="databaseList" class="common-sql-list">
                        <!-- æ•°æ®åº“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å¸¸ç”¨SQLåŒºåŸŸ -->
        <div class="card-custom">
            <div class="config-header" data-bs-toggle="collapse" data-bs-target="#commonSqlBody" aria-expanded="false" aria-controls="commonSqlBody">
                <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0;">å¸¸ç”¨æŸ¥è¯¢è¯­å¥</div>
                <span class="config-toggle-icon">â–¼</span>
            </div>
            <div class="collapse" id="commonSqlBody">
                <div class="config-body-wrapper pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="common-sql-title mb-0" style="border-bottom: none; padding-bottom: 0; font-size: 1.1rem;">å¸¸ç”¨æŸ¥è¯¢è¯­å¥</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="triggerImportJson()">å¯¼å…¥ SQL</button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportCommonSqls()">å¯¼å‡º SQL</button>
                            <input type="file" id="importJsonInput" style="display: none;" accept=".json" onchange="handleImportJson(this)">
                        </div>
                    </div>
                    <div class="common-sql-list" id="commonSqlList">
                    </div>
                </div>
            </div>
        </div>

        <!-- SQLè¾“å…¥åŒºåŸŸ -->
        <div class="card-custom">
            <!-- å±é™©SQLæç¤º -->
            <div class="danger-sql-alert" id="dangerSqlAlert">
                <span class="danger-icon">âš ï¸</span>
                <span id="dangerSqlMsg">æ£€æµ‹åˆ°å±é™©SQLæ“ä½œï¼Œç¦æ­¢æ‰§è¡Œï¼</span>
            </div>
            
            <!-- SQLè¾“å…¥åŒºåŸŸ -->
            <div class="card-custom mb-4">
                <div class="config-header" data-bs-toggle="collapse" data-bs-target="#sqlInputBody" aria-expanded="false" aria-controls="sqlInputBody">
                    <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0;">è¯·è¾“å…¥SQLæŸ¥è¯¢è¯­å¥</div>
                    <span class="config-toggle-icon">â–¼</span>
                </div>
                <div class="collapse" id="sqlInputBody">
                    <div class="config-body-wrapper pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="config-title mb-0" style="border-bottom: none; padding-bottom: 0; font-size: 1.1rem;">SQLè¾“å…¥æ¡†</div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatCurrentSql()" title="æ ¼å¼åŒ–SQL">
                                    <i class="fas fa-indent me-1"></i>SQLç¾åŒ–
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadSqlFromFile()">
                                    <i class="fas fa-file-import me-1"></i>åŠ è½½SQLæ–‡ä»¶
                                </button>
                            </div>
                        </div>
                        <div id="sqlInput" class="form-control" contenteditable="true" oninput="handleSqlInputOptimized()" style="min-height: 120px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; outline: none; cursor: text; line-height: 1.5; font-size: 0.9rem; resize: vertical; padding: 0.375rem 0.75rem;"></div>
                        <input type="file" id="sqlFileInput" accept=".sql,.txt" style="display: none;" onchange="readSqlFile(this)">
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-2">
                    <label class="form-label">æ¯é¡µæ˜¾ç¤ºæ¡æ•°</label>
                    <select id="pageSize" class="form-control">
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
            <!-- æ“ä½œæŒ‰é’®è¡Œï¼šæ‰§è¡ŒæŸ¥è¯¢å’Œå¯¼å‡ºæŒ‰é’® -->
            <div class="button-row main-actions mb-2">
                <!-- å·¦ä¾§ï¼šä¸»è¦æ“ä½œæŒ‰é’® -->
                <div class="button-group primary-buttons">
                    <button type="button" class="btn btn-custom btn-primary-custom" onclick="showExecuteConfirm()">
                        <span id="executeBtnText">æ‰§è¡ŒæŸ¥è¯¢</span>
                    </button>
                    <button type="button" class="btn btn-custom btn-info-custom" onclick="analyzeQueryPlan()">
                        <span>åˆ†ææŸ¥è¯¢è®¡åˆ’</span>
                    </button>
                    <button type="button" class="btn btn-custom btn-secondary-custom" onclick="clearSqlInput()">æ¸…ç©º</button>
                </div>
                
                <!-- å³ä¾§ï¼šå¯¼å‡ºæŒ‰é’®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="button-group export-buttons" id="exportButtonRow" style="display: none;">
                    <button type="button" class="btn btn-custom btn-export-excel" id="exportExcelBtn" onclick="showExcelExportModal()">å¯¼å‡ºExcel</button>
                    <button type="button" class="btn btn-custom btn-export-csv" id="exportCsvBtn" onclick="showCsvExportModal()">å¯¼å‡ºCSV</button>
                    <button type="button" class="btn btn-custom btn-export-html" id="exportHtmlBtn" onclick="showHtmlExportModal()">å¯¼å‡ºHTML</button>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="result-area" id="resultArea" style="display: none;">
            <div id="statusMessage"></div>
            <div class="table-responsive" id="resultTable" style="display: none; overflow-x: auto;"></div>
            <!-- åˆ†é¡µåŒºåŸŸ - ä¼˜åŒ–ç‰ˆ -->
            <div class="pagination-area mt-4" id="paginationArea" style="display: none;">
                <div class="pagination-container">
                    <button class="page-btn" id="prevPage" onclick="handlePageChange(-1)" disabled>ä¸Šä¸€é¡µ</button>
                    <div id="pageNumberContainer"></div>
                    <button class="page-btn" id="nextPage" onclick="handlePageChange(1)" disabled>ä¸‹ä¸€é¡µ</button>
                    <div class="page-jump">
                        <span>è·³è‡³</span>
                        <input type="number" id="jumpPageInput" min="1" value="1">
                        <span>é¡µ</span>
                        <button onclick="handleJumpPage()">ç¡®å®š</button>
                    </div>
                    <span id="pageInfo" class="mx-2">å…± 0 é¡µ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰§è¡Œç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="executeConfirmModal" tabindex="-1" aria-labelledby="executeConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="executeConfirmModalLabel">æ‰§è¡ŒæŸ¥è¯¢ç¡®è®¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    ä½ ç¡®å®šè¦æ‰§è¡Œè¿™æ¡SQLæŸ¥è¯¢å—ï¼Ÿ
                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; font-family: Consolas, monospace; font-size: 14px; max-height: 200px; overflow-y: auto;" id="sqlPreview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" onclick="confirmExecuteSql()">ç¡®å®šæ‰§è¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å±é™©æ“ä½œæç¤ºæ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="dangerSqlModal" tabindex="-1" aria-labelledby="dangerSqlModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h5 class="modal-title" id="dangerSqlModalLabel">ç¦æ­¢æ‰§è¡Œå±é™©æ“ä½œ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 30px; color: #dc3545;">ğŸš«</span>
                        <span id="dangerModalMsg">æ£€æµ‹åˆ°å±é™©SQLæ“ä½œï¼Œæœ¬ç³»ç»Ÿä»…å…è®¸æ‰§è¡ŒSELECT/EXPLAINæŸ¥è¯¢ï¼</span>
                    </div>
                    <div style="padding: 10px; background-color: #fee; border-radius: 6px; color: #721c24; font-size: 14px;">
                        <strong>ç¦æ­¢çš„æ“ä½œåŒ…æ‹¬ï¼š</strong> UPDATEã€DELETEã€DROPã€ALTERã€CREATEã€RENAMEã€REPLACEã€GRANTã€REVOKEã€LOCKç­‰<br>
                        <strong>å…è®¸çš„æ“ä½œï¼š</strong> SELECTæŸ¥è¯¢ã€EXPLAINæŸ¥è¯¢è®¡åˆ’ã€WITH CTEæŸ¥è¯¢
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-confirm" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excelå¯¼å‡ºé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="excelExportModal" tabindex="-1" aria-labelledby="excelExportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);">
                    <h5 class="modal-title" id="excelExportModalLabel">Excelå¯¼å‡ºé…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="export-config-item">
                        <label class="export-config-label">æ–‡ä»¶å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="excelFileName" placeholder="è¾“å…¥æ–‡ä»¶å">
                            <span class="input-group-text">.xlsx</span>
                        </div>
                        <small class="text-muted">é»˜è®¤æ ¼å¼ï¼šSQLåç§°_æ—¥æœŸï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ­¤åç§°ã€‚</small>
                    </div>
                    <div class="export-config-item">
                        <label class="export-config-label">Excelè¡¨å¤´é¢œè‰²</label>
                        <select id="excelHeaderColor" class="form-control">
                            {% for color_code, color_name in excel_colors.items() %}
                                <option value="{{ color_code }}" {% if color_code == '4472C4' %}selected{% endif %}>{{ color_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="export-config-item">
                        <label class="export-config-label">æ˜¯å¦å¯¼å‡ºåˆ—å</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="excelIncludeHeader" id="excelIncludeHeaderYes" value="true" checked>
                            <label class="form-check-label" for="excelIncludeHeaderYes">
                                æ˜¯ï¼ˆå¯¼å‡ºåˆ—åä½œä¸ºç¬¬ä¸€è¡Œï¼‰
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="excelIncludeHeader" id="excelIncludeHeaderNo" value="false">
                            <label class="form-check-label" for="excelIncludeHeaderNo">
                                å¦ï¼ˆä»…å¯¼å‡ºæ•°æ®ï¼‰
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info py-2" style="font-size: 14px;">
                        <i class="me-1">ğŸ’¡</i> æç¤ºï¼šæ”¯æŒç°ä»£æµè§ˆå™¨çš„â€œå¦å­˜ä¸ºâ€å¯¹è¯æ¡†ï¼Œå¯è‡ªå®šä¹‰ä¿å­˜ä½ç½®ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" onclick="confirmExportExcel()">ç¡®å®šå¯¼å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSVå¯¼å‡ºé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="csvExportModal" tabindex="-1" aria-labelledby="csvExportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">
                    <h5 class="modal-title" id="csvExportModalLabel">CSVå¯¼å‡ºé…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="export-config-item">
                        <label class="export-config-label">æ–‡ä»¶å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="csvFileName" placeholder="è¾“å…¥æ–‡ä»¶å">
                            <span class="input-group-text">.csv</span>
                        </div>
                        <small class="text-muted">é»˜è®¤æ ¼å¼ï¼šSQLåç§°_æ—¥æœŸï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ­¤åç§°ã€‚</small>
                    </div>
                    <div class="export-config-item">
                        <label class="export-config-label">å­—æ®µåˆ†éš”ç¬¦</label>
                        <select id="csvSeparator" class="form-control">
                            <option value="comma">é€—å· (,)</option>
                            <option value="semicolon">åˆ†å· (;)</option>
                            <option value="tab">åˆ¶è¡¨ç¬¦ (Tab)</option>
                            <option value="pipe">ç«–çº¿ (|)</option>
                            <option value="space">ç©ºæ ¼</option>
                        </select>
                    </div>
                    <div class="export-config-item">
                        <label class="export-config-label">æ˜¯å¦å¯¼å‡ºåˆ—å</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="csvIncludeHeader" id="csvIncludeHeaderYes" value="true" checked>
                            <label class="form-check-label" for="csvIncludeHeaderYes">
                                æ˜¯ï¼ˆå¯¼å‡ºåˆ—åä½œä¸ºç¬¬ä¸€è¡Œï¼‰
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="csvIncludeHeader" id="csvIncludeHeaderNo" value="false">
                            <label class="form-check-label" for="csvIncludeHeaderNo">
                                å¦ï¼ˆä»…å¯¼å‡ºæ•°æ®ï¼‰
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info py-2" style="font-size: 14px;">
                        <i class="me-1">ğŸ’¡</i> æç¤ºï¼šæ”¯æŒç°ä»£æµè§ˆå™¨çš„â€œå¦å­˜ä¸ºâ€å¯¹è¯æ¡†ï¼Œå¯è‡ªå®šä¹‰ä¿å­˜ä½ç½®ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" onclick="confirmExportCsv()">ç¡®å®šå¯¼å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºHTMLç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="htmlExportModal" tabindex="-1" aria-labelledby="htmlExportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
                    <h5 class="modal-title" id="htmlExportModalLabel">HTMLå¯¼å‡ºé…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="export-config-item">
                        <label class="export-config-label">æ–‡ä»¶å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="htmlFileName" placeholder="è¾“å…¥æ–‡ä»¶å">
                            <span class="input-group-text">.html</span>
                        </div>
                        <small class="text-muted">é»˜è®¤æ ¼å¼ï¼šSQLåç§°_æ—¥æœŸï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ­¤åç§°ã€‚</small>
                    </div>
                    <div class="alert alert-info py-2" style="font-size: 14px;">
                        <i class="me-1">ğŸ’¡</i> æç¤ºï¼šå¯¼å‡ºçš„HTMLæ–‡ä»¶å…·æœ‰ç±»ä¼¼Oracle AWRæŠ¥å‘Šçš„ä¸“ä¸šæ ·å¼ï¼Œå¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" onclick="confirmExportHtml()">ç¡®å®šå¯¼å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºJSONç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="exportJsonModal" tabindex="-1" aria-labelledby="exportJsonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #198754 0%, #157347 100%);">
                    <h5 class="modal-title" id="exportJsonModalLabel">å¯¼å‡ºå¸¸ç”¨æŸ¥è¯¢è¯­å¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportJsonFileName" class="form-label">æ–‡ä»¶å</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="exportJsonFileName" placeholder="è¾“å…¥æ–‡ä»¶å">
                            <span class="input-group-text">.json</span>
                        </div>
                        <small class="text-muted">é»˜è®¤æŒ‰å½“å‰æ—¥æœŸå‘½åï¼Œæ‚¨å¯ä»¥ä¿®æ”¹æ­¤åç§°ã€‚</small>
                    </div>
                    <div class="alert alert-info py-2" style="font-size: 14px;">
                        <i class="me-1">ğŸ’¡</i> æç¤ºï¼šä¸‹è½½æ—¶æ‚¨çš„æµè§ˆå™¨é€šå¸¸ä¼šå¼¹å‡ºâ€œå¦å­˜ä¸ºâ€å¯¹è¯æ¡†ï¼Œä¾›æ‚¨é€‰æ‹©ä¿å­˜ä½ç½®ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" style="background-color: #198754;" onclick="confirmExportJson()">ç¡®å®šå¯¼å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜ä¸ºå¸¸ç”¨SQLæ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="saveCommonSqlModal" tabindex="-1" aria-labelledby="saveCommonSqlModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveCommonSqlModalLabel">ä¿å­˜ä¸ºå¸¸ç”¨æŸ¥è¯¢è¯­å¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="commonSqlTitleInput" class="form-label">å¸¸ç”¨è¯­å¥æ ‡é¢˜</label>
                        <input type="text" class="form-control" id="commonSqlTitleInput" placeholder="ä¾‹å¦‚ï¼šæ•°æ®åº“ç‰ˆæœ¬æŸ¥è¯¢">
                    </div>
                    <div class="mb-3">
                        <label for="commonSqlContentInput" class="form-label">SQLå†…å®¹</label>
                        <textarea class="form-control" id="commonSqlContentInput" rows="6" style="font-family: Consolas, monospace; font-size: 14px; overflow-y: hidden;" oninput="autoResizeTextarea(this)"></textarea>
                    </div>
                    <div class="text-muted" style="font-size: 14px;">
                        æ”¯æŒåœ¨æ­¤ç¼–è¾‘SQLå†…å®¹ï¼Œä¿å­˜åä¼šå†™å…¥æœ¬åœ° JSON æ–‡ä»¶ï¼Œå¹¶åœ¨â€œå¸¸ç”¨æŸ¥è¯¢è¯­å¥â€åŒºåŸŸè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" onclick="confirmSaveCommonSql()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤å¸¸ç”¨SQLç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">åˆ é™¤ç¡®è®¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);" onclick="handleDeleteCancel(); return false;"></button>
                </div>
                <div class="modal-body">
                    ç¡®å®šè¦åˆ é™¤å¸¸ç”¨æŸ¥è¯¢è¯­å¥ <strong id="deleteTargetTitle"></strong> å—ï¼Ÿ
                    <br><small class="text-danger">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal" onclick="handleDeleteCancel(); return false;">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" id="confirmDeleteBtn" style="background-color: #dc3545;">ç¡®å®šåˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤åˆ¶æ•°æ®åº“é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="copyDbConfigModal" tabindex="-1" aria-labelledby="copyDbConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0069d9 100%);">
                    <h5 class="modal-title" id="copyDbConfigModalLabel">å¤åˆ¶æ•°æ®åº“è¿æ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="copyDbNameInput" class="form-label">æ–°æ•°æ®åº“è¿æ¥åç§°</label>
                        <input type="text" class="form-control" id="copyDbNameInput" placeholder="è¯·è¾“å…¥æ–°æ•°æ®åº“è¿æ¥åç§°">
                        <div class="form-text">åŸåç§°: <span id="originalDbNameDisplay"></span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" id="confirmCopyDbBtn" style="background-color: #007bff;">ç¡®è®¤å¤åˆ¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®åº“é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="dbConfigModal" tabindex="-1" aria-labelledby="dbConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dbConfigModalTitle">æ•°æ®åº“é…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dbConfigForm">
                        <input type="hidden" id="configDbId">
                        <div class="mb-3">
                            <label for="configDbName" class="form-label">æ•°æ®åº“åç§°</label>
                            <input type="text" class="form-control" id="configDbName" placeholder="è¯·è¾“å…¥æ•°æ®åº“åç§°">
                        </div>
                        <div class="mb-3">
                            <label for="configDbType" class="form-label">æ•°æ®åº“ç±»å‹</label>
                            <select class="form-control" id="configDbType">
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="oracle">Oracle</option>
                                <option value="kingbase">Kingbase(äººå¤§é‡‘ä»“)</option>
                                <option value="tidb">TiDB(å¹³å‡¯)</option>
                                <option value="oceanbase">OceanBase(æµ·æ‰¬)</option>
                                <option value="yashandb">YashanDB(å´–å±±)</option>
                                <option value="shentong">ShenTong(ç¥é€š)</option>
                                <option value="gbase">GBase(å—å¤§é€šç”¨)</option>
                                <option value="highgo">HighGo(ç€šé«˜)</option>
                                <option value="gauss">GaussDB(é«˜æ–¯)</option>
                                <option value="uxdb">UXDB(ä¼˜å›¾)</option>
                                <option value="vastbase">Vastbase(æµ·é‡)</option>
                                <option value="greatdb">GreatDB(å·¨æ‰)</option>
                                <option value="dm">DM(è¾¾æ¢¦)</option>
                                <option value="vanward">VanwardDB(ä¸‡é‡Œ)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="configDbHost" class="form-label">ä¸»æœºåœ°å€</label>
                            <input type="text" class="form-control" id="configDbHost" placeholder="ä¾‹å¦‚ï¼šlocalhost">
                        </div>
                        <div class="mb-3">
                            <label for="configDbPort" class="form-label">ç«¯å£</label>
                            <input type="text" class="form-control" id="configDbPort" placeholder="ä¾‹å¦‚ï¼š5432">
                        </div>
                        <div class="mb-3">
                            <label for="configDbUser" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="configDbUser" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="mb-3">
                            <label for="configDbPassword" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="configDbPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                            <div class="form-text">ç•™ç©ºè¡¨ç¤ºä½¿ç”¨ç°æœ‰å¯†ç ï¼ˆä»…ç¼–è¾‘æ—¶æœ‰æ•ˆï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="configDbDatabase" class="form-label">æ•°æ®åº“å</label>
                            <input type="text" class="form-control" id="configDbDatabase" placeholder="è¯·è¾“å…¥æ•°æ®åº“å">
                        </div>
                        <div class="mb-3">
                            <label for="configDbSslMode" class="form-label">SSLæ¨¡å¼</label>
                            <select class="form-control" id="configDbSslMode">
                                <option value="disable">ç¦ç”¨SSLï¼ˆæ¨èç”¨äºè§£å†³SSLåå•†é—®é¢˜ï¼‰</option>
                                <option value="prefer">ä¼˜å…ˆä½¿ç”¨SSL</option>
                                <option value="require">å¿…é¡»ä½¿ç”¨SSL</option>
                                <option value="allow">å…è®¸SSL</option>
                            </select>
                            <div class="form-text">å´–å±±æ•°æ®åº“å»ºè®®é€‰æ‹©"ç¦ç”¨SSL"ä»¥é¿å…è¿æ¥é—®é¢˜</div>
                        </div>
                        <!-- éšè—å­—æ®µï¼Œç”¨äºå­˜å‚¨åŸå§‹åŠ å¯†å¯†ç ï¼ˆä»…åœ¨ç¼–è¾‘æ—¶ä½¿ç”¨ï¼‰ -->
                        <input type="hidden" id="originalDbPassword" value="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-modal btn-test-connection" id="dbConfigTestBtn">æµ‹è¯•è¿æ¥</button>
                    <button type="button" class="btn btn-modal btn-modal-confirm" id="dbConfigSubmitBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„šç‰ˆæƒä¿¡æ¯ -->
    <div class="footer-copyright">
        Powered by <a href="#" target="_blank">ohsdba</a> Â© 2026 | Version 2.0
    </div>
    
    <!-- éšè—çš„æ•°æ®åº“é…ç½®æ•°æ® -->
    <div id="db-config-data" style="display:none">{{ databases | tojson | safe }}</div>

    <!-- ä½¿ç”¨æœ¬åœ° Bootstrap èµ„æºå®ç°å®Œå…¨ç¦»çº¿ -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let totalPage = 0;
        let currentSql = "";
        let pageSize = 50;
        let isExecuting = false; // é˜²æ­¢é‡å¤æäº¤
        let configIsEditable = true; // é…ç½®æ˜¯å¦å¯ç¼–è¾‘ï¼ˆåˆå§‹å¯ç¼–è¾‘ï¼‰
        let isSavingConfig = false; // é…ç½®ä¿å­˜ä¸­çŠ¶æ€
        let currentQueryId = ""; // å½“å‰æŸ¥è¯¢çš„å”¯ä¸€æ ‡è¯†ï¼ˆé€‚é…åç«¯ï¼‰
        let currentSqlName = ""; // å½“å‰SQLåç§°ï¼ˆç”¨äºå¯¼å‡ºæ–‡ä»¶åï¼‰
        let editingSqlId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„å¸¸ç”¨SQL ID
        
        // ä»éšè—å…ƒç´ ä¸­è¯»å–æ•°æ®åº“é…ç½®æ•°æ®
        const dbConfigs = JSON.parse(document.getElementById('db-config-data').textContent);
        
        // å½“å‰é€‰ä¸­çš„æ•°æ®åº“ID
        let currentSelectedDbId = null;
        
        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        window.executeConfirmModal = new bootstrap.Modal(document.getElementById('executeConfirmModal'));
        window.dangerSqlModal = new bootstrap.Modal(document.getElementById('dangerSqlModal'));
        window.excelExportModal = new bootstrap.Modal(document.getElementById('excelExportModal'));
        window.csvExportModal = new bootstrap.Modal(document.getElementById('csvExportModal'));
        window.saveCommonSqlModal = new bootstrap.Modal(document.getElementById('saveCommonSqlModal'));
        window.deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        window.exportJsonModal = new bootstrap.Modal(document.getElementById('exportJsonModal'));
        window.dbConfigModal = new bootstrap.Modal(document.getElementById('dbConfigModal')); // æ–°å¢æ•°æ®åº“é…ç½®æ¨¡æ€æ¡†
        window.copyDbConfigModal = new bootstrap.Modal(document.getElementById('copyDbConfigModal')); // å¤åˆ¶æ•°æ®åº“é…ç½®æ¨¡æ€æ¡†
        window.htmlExportModal = new bootstrap.Modal(document.getElementById('htmlExportModal')); // HTMLå¯¼å‡ºæ¨¡æ€æ¡†
        
        // ä¿å­˜åŸå§‹é…ç½®å€¼ï¼ˆç”¨äºè„±æ•å’Œè¿˜åŸï¼‰
        let originalConfig = {
            host: document.getElementById('dbHost')?.dataset.original || '',
            port: document.getElementById('dbPort')?.dataset.original || '',
            user: document.getElementById('dbUser')?.dataset.original || '',
            dbName: document.getElementById('dbName')?.dataset.original || ''
        };

        // ===================== æ•°æ®åº“é…ç½®ç®¡ç† =====================
        /**
         * åŠ è½½æ•°æ®åº“é…ç½®åˆ—è¡¨
         */
        function loadDatabaseList() {
            const listContainer = document.getElementById('databaseList');
            if (!listContainer) return;
                    
            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°å¢æŒ‰é’®
            listContainer.innerHTML = '';
                    
            // æ·»åŠ ä¸€ä¸ª"æ–°å¢"æŒ‰é’®
            const addBtn = document.createElement('div');
            addBtn.className = 'common-sql-item btn-add-new';
            addBtn.innerHTML = '<span>+ æ–°å¢æ•°æ®åº“</span>';
            addBtn.onclick = function() { addNewDatabase(); };
            listContainer.appendChild(addBtn);
                    
            // ä»åç«¯è·å–æ•°æ®åº“é…ç½®åˆ—è¡¨
            fetch('/databases')
                .then(res => {
                    if (!res.ok) throw new Error('åŠ è½½æ•°æ®åº“é…ç½®å¤±è´¥');
                    return res.json();
                })
                .then(data => {
                    if (data.status !== 'success' || !Array.isArray(data.data)) {
                        throw new Error(data.message || 'è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                            
                    // ç¼“å­˜æ•°æ®åº“ä¿¡æ¯
                    window.allDatabasesCache = data.data;
                            
                    // æ¸²æŸ“æ•°æ®åº“åˆ—è¡¨
                    data.data.forEach(db => {
                        // å†…å®¹åŒºåŸŸï¼šæ˜¾ç¤ºæ•°æ®åº“ä¿¡æ¯
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'common-sql-name';
                        // æ˜¾ç¤ºæ•°æ®åº“åç§°å’Œç±»å‹ï¼Œæ›´ç®€æ´çš„æ ¼å¼
                        nameSpan.textContent = `${db.name} [${db.type.toUpperCase()}]`;
                        // è®¾ç½®æ ‡é¢˜ä»¥æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼Œä¾¿äºé¼ æ ‡æ‚¬åœæŸ¥çœ‹
                        nameSpan.title = `åç§°: ${db.name}\nç±»å‹: ${db.type.toUpperCase()}\nä¸»æœº: ${db.host}:${db.port}\næ•°æ®åº“: ${db.database}`;
                                
                        // åˆ›å»ºæ•°æ®åº“é¡¹å®¹å™¨
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'common-sql-item';
                        itemDiv.title = db.name;
                                
                        // å¦‚æœæ˜¯é»˜è®¤æ•°æ®åº“ï¼Œæ·»åŠ ç‰¹æ®Šç±»
                        if (db.is_default) {
                            itemDiv.classList.add('default-db');
                        }
                                
                        // å¦‚æœæ˜¯å½“å‰è¿æ¥çš„æ•°æ®åº“ï¼Œæ·»åŠ é€‰ä¸­ç±»
                        if (db.id === window.currentConnectedDbId) {
                            itemDiv.classList.add('selected-db');
                        }
                                
                        // å¦‚æœæ˜¯é»˜è®¤æ•°æ®åº“ä¸”å°šæœªè®¾ç½®å½“å‰è¿æ¥æ•°æ®åº“ï¼Œä½†ä¸è‡ªåŠ¨é€‰ä¸­ï¼ˆä¿æŒæœªè¿æ¥çŠ¶æ€ï¼‰
                        // ä¿ç•™é»˜è®¤æ•°æ®åº“æ ‡è®°ï¼Œä½†ä¸è‡ªåŠ¨è¿æ¥
                        if (db.is_default) {
                            // ä»…æ·»åŠ é»˜è®¤æ•°æ®åº“æ ‡è®°ï¼Œä¸è‡ªåŠ¨è¿æ¥
                        }
                                
                        // ç‚¹å‡»é€‰æ‹©æ­¤æ•°æ®åº“
                        nameSpan.onclick = function(e) {
                            e.stopPropagation();
                            connectToDatabase(db.id);
                        };
                                
                        // æ“ä½œåŒºåŸŸï¼šç¼–è¾‘å’Œåˆ é™¤
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'common-sql-actions';
                                
                        // è®¾ä¸ºé»˜è®¤æŒ‰é’®
                        const defaultBtn = document.createElement('button');
                        defaultBtn.className = 'action-btn';
                        defaultBtn.innerHTML = 'âœ“';
                        defaultBtn.title = 'è®¾ä¸ºé»˜è®¤';
                        defaultBtn.style.color = db.is_default ? '#28a745' : '#6c757d';
                        defaultBtn.onclick = function(e) {
                            e.stopPropagation();
                            setDatabaseAsDefault(db.id);
                        };
                                
                        // ç¼–è¾‘æŒ‰é’®
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn btn-edit';
                        editBtn.innerHTML = 'âœ';
                        editBtn.title = 'ç¼–è¾‘';
                        editBtn.onclick = function(e) {
                            e.stopPropagation();
                            editDatabase(db);
                        };
                                
                        // å¤åˆ¶æŒ‰é’®
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'action-btn';
                        copyBtn.innerHTML = 'â§‰';
                        copyBtn.title = 'å¤åˆ¶';
                        copyBtn.onclick = function(e) {
                            e.stopPropagation();
                            copyDatabase(db.id);
                        };
                                
                        // åˆ é™¤æŒ‰é’®
                        const delBtn = document.createElement('button');
                        delBtn.className = 'action-btn btn-delete';
                        delBtn.innerHTML = 'Ã—';
                        delBtn.title = 'åˆ é™¤';
                        delBtn.onclick = function(e) {
                            e.stopPropagation();
                            deleteDatabase(db.id, db.name);
                        };
                                
                        actionsDiv.appendChild(defaultBtn);
                        actionsDiv.appendChild(copyBtn);
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(delBtn);
                                
                        itemDiv.appendChild(nameSpan);
                        itemDiv.appendChild(actionsDiv);
                        listContainer.appendChild(itemDiv);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®åº“é…ç½®å¤±è´¥:', error);
                    showAlertModal('å¤±è´¥', `åŠ è½½æ•°æ®åº“é…ç½®å¤±è´¥ï¼š${error.message}`, 'danger');
                });
        }
        
        /**
         * é€‰æ‹©æ•°æ®åº“ï¼ˆè®¾ç½®ä¸ºå½“å‰é€‰ä¸­ï¼‰
         * @param {string} dbId - æ•°æ®åº“ID
         */
        function selectDatabase(dbId) {
            // æ›´æ–°å½“å‰é€‰ä¸­çš„æ•°æ®åº“ID
            currentSelectedDbId = dbId;
            
            // æ¸…é™¤ä¹‹å‰é€‰ä¸­é¡¹çš„æ ·å¼
            const allItems = document.querySelectorAll('#databaseList .common-sql-item');
            allItems.forEach(item => {
                item.classList.remove('selected-db');
            });
            
            // ä¸ºå½“å‰é€‰ä¸­çš„é¡¹æ·»åŠ é€‰ä¸­æ ·å¼
            const selectedItem = Array.from(allItems).find(item => {
                const nameElement = item.querySelector('.common-sql-name');
                if (nameElement) {
                    const text = nameElement.textContent;
                    const db = window.allDatabasesCache ? window.allDatabasesCache.find(d => d.id === dbId) : null;
                    return db && text.includes(db.name);
                }
                return false;
            });
            
            if (selectedItem) {
                selectedItem.classList.add('selected-db');
            }
            
            // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„æ•°æ®åº“
            const db = window.allDatabasesCache ? window.allDatabasesCache.find(d => d.id === dbId) : null;
            if (db) {
                document.getElementById('currentDbIndicator').style.display = 'block';
                document.getElementById('currentDbName').textContent = db.name;
            }
            
            showAlertModal('æç¤º', 'å·²é€‰æ‹©æ•°æ®åº“ï¼š' + getDatabaseNameById(dbId), 'info');
        }
        
        /**
         * æ ¹æ®æ•°æ®åº“IDè·å–æ•°æ®åº“åç§°
         * @param {string} dbId - æ•°æ®åº“ID
         * @returns {string} æ•°æ®åº“åç§°
         */
        function getDatabaseNameById(dbId) {
            // ä»åç«¯è·å–æ•°æ®åº“åˆ—è¡¨å¹¶æŸ¥æ‰¾åç§°
            // ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œè¿™é‡Œä½¿ç”¨ç¼“å­˜çš„æ–¹å¼
            if (window.allDatabasesCache) {
                const db = window.allDatabasesCache.find(d => d.id === dbId);
                return db ? db.name : 'æœªçŸ¥';
            }
            return 'æœªçŸ¥';
        }
        
        /**
         * æ–°å¢æ•°æ®åº“
         */
        function addNewDatabase() {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('dbConfigForm').reset();
            document.getElementById('dbConfigModalTitle').textContent = 'æ–°å¢æ•°æ®åº“é…ç½®';
            
            // è®¾ç½®é»˜è®¤SSLæ¨¡å¼ä¸ºdisableï¼ˆç‰¹åˆ«é€‚åˆå´–å±±æ•°æ®åº“ï¼‰
            const sslModeElement = document.getElementById('configDbSslMode');
            if (sslModeElement) {
                sslModeElement.value = 'disable';
            }
            document.getElementById('dbConfigSubmitBtn').onclick = function() { submitDatabaseConfig('POST'); };
                    
            // æµ‹è¯•è¿æ¥æŒ‰é’®äº‹ä»¶
            document.getElementById('dbConfigTestBtn').onclick = function() { testDatabaseConfig(); };
            
            // éšè—å¯†ç å­—æ®µï¼ˆæ–°å¢æ—¶ä¸éœ€è¦ï¼‰
            const pwdField = document.querySelector('#dbConfigForm [name="password"]');
            if (pwdField) pwdField.value = '';
            
            dbConfigModal.show();
        }
        
        /**
         * ç¼–è¾‘æ•°æ®åº“
         * @param {Object} db - æ•°æ®åº“å¯¹è±¡
         */
        function editDatabase(db) {
            // è·å–å®Œæ•´æ•°æ®åº“é…ç½®ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰
            fetch(`/get_db_config_with_password/${db.id}`)
                .then(res => res.json())
                .then(detailData => {
                    if (detailData.status !== 'success') {
                        showAlertModal('é”™è¯¯', 'æ— æ³•è·å–æ•°æ®åº“é…ç½®è¯¦æƒ…ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'danger');
                        return;
                    }
                    
                    const fullDbConfig = detailData.data;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('dbConfigModalTitle').textContent = 'ç¼–è¾‘æ•°æ®åº“é…ç½®';
                    document.getElementById('configDbId').value = fullDbConfig.id;
                    document.getElementById('configDbName').value = fullDbConfig.name;
                    document.getElementById('configDbType').value = fullDbConfig.type;
                    document.getElementById('configDbHost').value = fullDbConfig.host;
                    document.getElementById('configDbPort').value = fullDbConfig.port;
                    document.getElementById('configDbUser').value = fullDbConfig.user;
                    document.getElementById('configDbDatabase').value = fullDbConfig.database;
                    
                    // åŠ è½½SSLé…ç½®ï¼ˆå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸ºdisableï¼‰
                    const sslModeElement = document.getElementById('configDbSslMode');
                    if (sslModeElement && fullDbConfig.sslmode) {
                        sslModeElement.value = fullDbConfig.sslmode;
                    } else if (sslModeElement) {
                        // é»˜è®¤è®¾ç½®ä¸ºdisableï¼Œç‰¹åˆ«æ˜¯å¯¹äºå´–å±±æ•°æ®åº“
                        sslModeElement.value = 'disable';
                    }
                    
                    // å¯†ç å­—æ®µä¸å¡«å……ï¼Œä¿æŒç©ºç™½ï¼Œä½†ä¿å­˜åŸå§‹å¯†ç ç”¨äºè¿æ¥æµ‹è¯•
                    document.getElementById('configDbPassword').value = '';
                    // å­˜å‚¨åŸå§‹åŠ å¯†å¯†ç ï¼ˆç”¨äºè¿æ¥æµ‹è¯•ï¼‰
                    document.getElementById('originalDbPassword').value = fullDbConfig.password || '';
                    
                    document.getElementById('dbConfigSubmitBtn').onclick = function() { submitDatabaseConfig('PUT'); };
                    
                    // æµ‹è¯•è¿æ¥æŒ‰é’®äº‹ä»¶
                    document.getElementById('dbConfigTestBtn').onclick = function() { testDatabaseConfig(); };
                    
                    dbConfigModal.show();
                })
                .catch(error => {
                    console.error('è·å–æ•°æ®åº“é…ç½®è¯¦æƒ…å¤±è´¥:', error);
                    showAlertModal('é”™è¯¯', 'è·å–æ•°æ®åº“é…ç½®è¯¦æƒ…å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'danger');
                });
        }
        
        /**
         * åˆ é™¤æ•°æ®åº“
         * @param {string} dbId - æ•°æ®åº“ID
         * @param {string} dbName - æ•°æ®åº“åç§°
         */
        /**
         * åˆ é™¤æ•°æ®åº“é…ç½®
         * @param {string} dbId - æ•°æ®åº“ID
         * @param {string} dbName - æ•°æ®åº“åç§°
         */
        function deleteDatabase(dbId, dbName) {
            // è®¾ç½®åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†çš„å†…å®¹
            const deleteTargetTitle = document.getElementById('deleteTargetTitle');
            if (deleteTargetTitle) deleteTargetTitle.textContent = `ã€Œ${dbName}ã€`;
            
            // ä¸´æ—¶å­˜å‚¨dbIdå’ŒdbNameï¼Œç”¨äºç¡®è®¤åˆ é™¤æ—¶ä½¿ç”¨
            window.currentDeleteDbId = dbId;
            window.currentDeleteDbName = dbName;
            
            // ç¡®ä¿æ¨¡æ€æ¡†çŠ¶æ€æ­£ç¡®
            const modalElement = document.getElementById('deleteConfirmModal');
            if (modalElement) {
                // é‡ç½®æ¨¡æ€æ¡†çš„å…³é”®å±æ€§
                modalElement.style.display = '';
                modalElement.removeAttribute('aria-hidden');
                modalElement.classList.add('fade');
            }
            
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            deleteConfirmModal.show();
        }
        
        /**
         * å¤åˆ¶æ•°æ®åº“è¿æ¥
         * @param {string} dbId - æ•°æ®åº“ID
         */
        function copyDatabase(dbId) {
            // è·å–å½“å‰æ‰€æœ‰æ•°æ®åº“é…ç½®
            fetch('/databases')
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') {
                        showAlertModal('é”™è¯¯', 'è·å–æ•°æ®åº“åˆ—è¡¨å¤±è´¥', 'danger');
                        return;
                    }
                            
                    const allDbs = data.data;
                    const sourceDb = allDbs.find(db => db.id === dbId);
                            
                    if (!sourceDb) {
                        showAlertModal('é”™è¯¯', 'æœªæ‰¾åˆ°è¦å¤åˆ¶çš„æ•°æ®åº“', 'danger');
                        return;
                    }
                            
                    // åˆ›å»ºå‰¯æœ¬ï¼ˆæ³¨æ„ï¼šä»/databasesæ¥å£è·å–çš„é…ç½®ä¸åŒ…å«å¯†ç ï¼‰
                    const newDb = {...sourceDb};
                                        
                    // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
                    document.getElementById('originalDbNameDisplay').textContent = sourceDb.name;
                    document.getElementById('copyDbNameInput').value = sourceDb.name + '_å‰¯æœ¬';
                                        
                    // å®šä¹‰å¤åˆ¶ç¡®è®¤å‡½æ•°
                    function performCopy() {
                        const newName = document.getElementById('copyDbNameInput').value.trim();
                                            
                        if (!newName) {
                            showAlertModal('æç¤º', 'è¯·è¾“å…¥æ–°æ•°æ®åº“è¿æ¥åç§°', 'warning');
                            return;
                        }
                                            
                        // ç¡®ä¿åç§°ä¸é‡å¤
                        let uniqueName = newName;
                        let counter = 1;
                        while (allDbs.some(db => db.name === uniqueName)) {
                            uniqueName = newName + '_' + counter;
                            counter++;
                        }
                                            
                        // ä»åç«¯è·å–å®Œæ•´é…ç½®ï¼ˆåŒ…å«å¯†ç ï¼‰
                        fetch(`/get_db_config_with_password/${dbId}`)
                            .then(res => res.json())
                            .then(detailData => {
                                if (detailData.status !== 'success') {
                                    // å¦‚æœæ— æ³•è·å–å®Œæ•´é…ç½®ï¼Œæç¤ºé”™è¯¯è€Œä¸æ˜¯ä½¿ç”¨åŸºç¡€ä¿¡æ¯ï¼ˆé¿å…æ¸…ç©ºå¯†ç ï¼‰
                                    copyDbConfigModal.hide();
                                    showAlertModal('é”™è¯¯', 'æ— æ³•è·å–æ•°æ®åº“é…ç½®è¯¦æƒ…ï¼Œå¯èƒ½APIæœªæ­£ç¡®åŠ è½½ï¼Œè¯·é‡å¯åº”ç”¨åå†è¯•', 'danger');
                                    return;
                                } else {
                                    finishCopyProcess(detailData.data, allDbs, uniqueName);
                                }
                            })
                            .catch(error => {
                                // å¦‚æœè·å–è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼Œæç¤ºé”™è¯¯è€Œä¸æ˜¯é™çº§ï¼ˆé¿å…æ¸…ç©ºå¯†ç ï¼‰
                                copyDbConfigModal.hide();
                                showAlertModal('é”™è¯¯', `è·å–æ•°æ®åº“é…ç½®å¤±è´¥ï¼š${error.message}ï¼Œè¯·ç¡®ä¿APIå·²æ­£ç¡®åŠ è½½å¹¶é‡å¯åº”ç”¨`, 'danger');
                            });
                    }
                                        
                    // å®Œæˆå¤åˆ¶è¿‡ç¨‹çš„å‡½æ•°
                    function finishCopyProcess(sourceDetail, allDbs, uniqueName) {
                        // åˆ›å»ºå‰¯æœ¬
                        const newDb = {...sourceDetail};
                                            
                        // ç”ŸæˆUUIDé£æ ¼çš„IDï¼Œç¡®ä¿å”¯ä¸€æ€§
                        const uuidPart = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            const r = Math.random() * 16 | 0;
                            const v = c === 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                        const newId = `db_${Date.now()}_${uuidPart}`;
                        newDb.id = newId;
                        newDb.name = uniqueName;
                        newDb.is_default = false; // æ–°å¤åˆ¶çš„ä¸åº”æ˜¯é»˜è®¤æ•°æ®åº“
                                            
                        // ä¿å­˜æ–°çš„æ•°æ®åº“é…ç½® (è°ƒè¯•ï¼šè¾“å‡ºè¦å‘é€çš„æ•°æ®)
                        console.log('DEBUG: Copying database, sending data:', newDb);
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        const sessionToken = localStorage.getItem('app_session_token');
                        if (sessionToken) {
                            headers['X-Session-Token'] = sessionToken;
                        }
                        
                        fetch('/save_db_config', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(newDb)
                        })
                        .then(res => res.json())
                        .then(function(saveData) {
                            copyDbConfigModal.hide(); // éšè—å¤åˆ¶å¯¹è¯æ¡†
                                                
                            if (saveData.status === 'success') {
                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                const successModal = document.createElement('div');
                                successModal.className = 'modal fade modal-custom';
                                successModal.id = 'successModal';
                                successModal.innerHTML = `
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success text-white">
                                                <h5 class="modal-title">æ•°æ®åº“å¤åˆ¶æˆåŠŸ</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
                                                    <span>æ•°æ®åº“ "<strong>${uniqueName}</strong>" å·²æˆåŠŸåˆ›å»ºå¹¶ä¿å­˜ï¼</span>
                                                </div>
                                                <p class="mt-2 mb-0"><small class="text-muted">ç°åœ¨å¯ä»¥åœ¨æ•°æ®åº“åˆ—è¡¨ä¸­æ‰¾åˆ°å®ƒã€‚</small></p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-modal btn-modal-confirm" data-bs-dismiss="modal">ç¡®å®š</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(successModal);
                                
                                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                                const bsModal = new bootstrap.Modal(successModal);
                                bsModal.show();
                                
                                // æ¨¡æ€æ¡†å…³é—­åæ¸…ç†DOM
                                successModal.addEventListener('hidden.bs.modal', function () {
                                    document.body.removeChild(successModal);
                                });
                                
                                loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                                        
                                // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ç«‹å³ç¼–è¾‘æ–°å¤åˆ¶çš„æ•°æ®åº“
                                // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ç«‹å³ç¼–è¾‘æ–°å¤åˆ¶çš„æ•°æ®åº“
                                setTimeout(() => {
                                    // åˆ›å»ºç¼–è¾‘ç¡®è®¤æ¨¡æ€æ¡†
                                    const editConfirmModal = document.createElement('div');
                                    editConfirmModal.className = 'modal fade modal-custom';
                                    editConfirmModal.id = 'editConfirmModal';
                                    editConfirmModal.innerHTML = `
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-info text-white">
                                                    <h5 class="modal-title">ç¼–è¾‘æ•°æ®åº“é…ç½®</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="d-flex align-items-center">
                                                        <i class="bi bi-info-circle-fill text-info me-2" style="font-size: 1.5rem;"></i>
                                                        <div>
                                                            <p class="mb-2">æˆåŠŸå¤åˆ¶æ•°æ®åº“ "<strong>${uniqueName}</strong>"</p>
                                                            <p class="mb-0"><small>æ˜¯å¦ç«‹å³ç¼–è¾‘æ­¤æ•°æ®åº“é…ç½®ï¼Ÿ</small></p>
                                                            <p class="mb-0"><small class="text-muted">ï¼ˆå¯åœ¨æ­¤æ—¶ä¿®æ”¹å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰</small></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-modal btn-modal-cancel" data-bs-dismiss="modal">æš‚ä¸ç¼–è¾‘</button>
                                                    <button type="button" class="btn btn-modal btn-modal-confirm" id="confirmEditNowBtn">ç«‹å³ç¼–è¾‘</button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(editConfirmModal);
                                    
                                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                                    const bsModal = new bootstrap.Modal(editConfirmModal);
                                    bsModal.show();
                                    
                                    // ç»‘å®šç¡®è®¤ç¼–è¾‘æŒ‰é’®äº‹ä»¶
                                    document.getElementById('confirmEditNowBtn').onclick = function() {
                                        bsModal.hide();
                                        // è·å–æ–°å¤åˆ¶çš„æ•°æ®åº“é…ç½®å¹¶æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
                                        setTimeout(() => {
                                            fetch('/databases')
                                                .then(res => res.json())
                                                .then(data => {
                                                    if (data.status === 'success') {
                                                        const newDbConfig = data.data.find(db => db.id === newDb.id);
                                                        if (newDbConfig) {
                                                            editDatabase(newDbConfig); // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
                                                        }
                                                    }
                                                });
                                        }, 300); // ç­‰å¾…åˆ—è¡¨åˆ·æ–°
                                    };
                                    
                                    // æ¨¡æ€æ¡†å…³é—­åæ¸…ç†DOM
                                    editConfirmModal.addEventListener('hidden.bs.modal', function () {
                                        document.body.removeChild(editConfirmModal);
                                    });
                                }, 500); // ç¨å¾®å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                            } else {
                                showAlertModal('å¤±è´¥', saveData.message || 'å¤åˆ¶å¤±è´¥', 'danger');
                            }
                        })
                        .catch(error => {
                            copyDbConfigModal.hide(); // éšè—å¤åˆ¶å¯¹è¯æ¡†
                            showAlertModal('å¤±è´¥', `å¤åˆ¶å¤±è´¥ï¼š${error.message}`, 'danger');
                        });
                    }
                                        
                    // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
                    const confirmBtn = document.getElementById('confirmCopyDbBtn');
                    // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true)); // å…‹éš†èŠ‚ç‚¹ä»¥æ¸…é™¤äº‹ä»¶ç›‘å¬å™¨
                    document.getElementById('confirmCopyDbBtn').onclick = performCopy;
                                        
                    // æ˜¾ç¤ºå¤åˆ¶å¯¹è¯æ¡†
                    copyDbConfigModal.show();
                
                })
                .catch(error => {
                    showAlertModal('é”™è¯¯', `è·å–æ•°æ®åº“åˆ—è¡¨å¤±è´¥ï¼š${error.message}`, 'danger');
                });
        }
        
        /**
         * è®¾ç½®æ•°æ®åº“ä¸ºé»˜è®¤
         * @param {string} dbId - æ•°æ®åº“ID
         */
        function setDatabaseAsDefault(dbId) {
            fetch('/set_default_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ db_id: dbId })
            })
            .then(res => {
                if (!res.ok) throw new Error('è®¾ç½®é»˜è®¤æ•°æ®åº“è¯·æ±‚å¤±è´¥');
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showAlertModal('æˆåŠŸ', 'å·²è®¾ç½®ä¸ºé»˜è®¤æ•°æ®åº“ï¼', 'success');
                    loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    showAlertModal('å¤±è´¥', `è®¾ç½®å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                }
            })
            .catch(error => {
                showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
            });
        }

        /**
         * è¿æ¥æ•°æ®åº“ï¼ˆé€‰æ‹©æ•°æ®åº“å¹¶æ˜¾ç¤ºå½“å‰ä½¿ç”¨çŠ¶æ€ï¼‰
         * @param {string} dbId - æ•°æ®åº“ID
         */
        // å…¨å±€å˜é‡ï¼šè·Ÿè¸ªå½“å‰æ­£åœ¨è¿›è¡Œçš„æ•°æ®åº“è¿æ¥æ“ä½œ
        let currentConnectionOperation = null;
        
        function connectToDatabase(dbId) {
            // é˜²æ­¢é‡å¤ç‚¹å‡»ï¼šå¦‚æœå·²ç»æœ‰è¿æ¥æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œåˆ™æ‹’ç»æ–°çš„è¯·æ±‚
            if (currentConnectionOperation) {
                console.warn('æ•°æ®åº“è¿æ¥æ“ä½œå·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
                return;
            }
            
            // è·å–æ•°æ®åº“é…ç½®ä¿¡æ¯
            const db = window.allDatabasesCache ? window.allDatabasesCache.find(d => d.id === dbId) : null;
            if (!db) {
                showAlertModal('é”™è¯¯', 'æœªæ‰¾åˆ°æ•°æ®åº“é…ç½®ä¿¡æ¯', 'danger');
                return;
            }
            
            // æ ‡è®°è¿æ¥æ“ä½œå¼€å§‹
            currentConnectionOperation = dbId;
            
            // æ˜¾ç¤ºè¿æ¥æµ‹è¯•ä¸­çŠ¶æ€
            const connectStatus = document.getElementById('connectStatus');
            if (connectStatus) {
                connectStatus.textContent = 'è¿æ¥æµ‹è¯•ä¸­...';
                connectStatus.className = 'badge bg-warning';
            }
            
            // ç¦ç”¨æ‰€æœ‰è¿æ¥æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            const connectButtons = document.querySelectorAll('button[onclick*="connectToDatabase"]');
            let originalBtnStates = [];
            
            connectButtons.forEach(btn => {
                originalBtnStates.push({
                    element: btn,
                    innerHTML: btn.innerHTML,
                    disabled: btn.disabled
                });
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> è¿æ¥ä¸­...';
                btn.disabled = true;
            });
            
            // ç”±äºå®‰å…¨åŸå› ï¼Œå‰ç«¯ç¼“å­˜ä¸­ä¸åŒ…å«å¯†ç å­—æ®µ
            // éœ€è¦é‡æ–°ä»åç«¯è·å–å®Œæ•´çš„æ•°æ®åº“é…ç½®ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰
            fetch(`/get_db_config_with_password/${dbId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`è·å–æ•°æ®åº“é…ç½®å¤±è´¥: ${response.status}`);
                    }
                    return response.json();
                })
                .then(fullDbConfig => {
                    if (fullDbConfig.status !== 'success') {
                        throw new Error(fullDbConfig.message || 'è·å–é…ç½®å¤±è´¥');
                    }
                    
                    const dbConfig = fullDbConfig.data;
                    
                    // æ„é€ è¿æ¥æµ‹è¯•æ•°æ®ï¼ˆåŒ¹é…åç«¯/test_db_connectionæ¥å£æ ¼å¼ï¼‰
                    const connectionData = {
                        host: dbConfig.host,
                        port: dbConfig.port,
                        database: dbConfig.database,
                        user: dbConfig.user,
                        password: dbConfig.password,  // ä½¿ç”¨ä»åç«¯è·å–çš„åŠ å¯†å¯†ç 
                        type: dbConfig.type
                    };
                    
                    // å‘é€è¿æ¥æµ‹è¯•è¯·æ±‚åˆ°åç«¯
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    const sessionToken = localStorage.getItem('app_session_token');
                    if (sessionToken) {
                        headers['X-Session-Token'] = sessionToken;
                    }
                    
                    return fetch('/test_db_connection', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(connectionData)
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // è¿æ¥æˆåŠŸï¼Œæ›´æ–°å…¨å±€å˜é‡å’ŒUI
                        window.currentConnectedDbId = dbId;
                        currentSelectedDbId = dbId;
                        
                        // æ¸…é™¤ä¹‹å‰é€‰ä¸­é¡¹çš„æ ·å¼
                        const allItems = document.querySelectorAll('#databaseList .common-sql-item');
                        allItems.forEach(item => {
                            item.classList.remove('selected-db');
                        });
                        
                        // é«˜äº®å½“å‰è¿æ¥çš„æ•°æ®åº“é¡¹
                        const dbItems = document.querySelectorAll('#databaseList .common-sql-item');
                        dbItems.forEach(item => {
                            const nameSpan = item.querySelector('.common-sql-name');
                            if (nameSpan) {
                                const expectedDisplay = `${db.name} [${db.type.toUpperCase()}]`;
                                if (nameSpan.textContent === expectedDisplay) {
                                    item.classList.add('selected-db');
                                    
                                    // æ›´æ–°å½“å‰æ•°æ®åº“åç§°æ˜¾ç¤º
                                    const currentDbName = document.getElementById('currentDbName');
                                    if (currentDbName) {
                                        currentDbName.textContent = db.name;
                                    }
                                    
                                    // æ˜¾ç¤ºå½“å‰æ•°æ®åº“æŒ‡ç¤ºå™¨
                                    const currentDbIndicator = document.getElementById('currentDbIndicator');
                                    if (currentDbIndicator) {
                                        currentDbIndicator.style.display = 'block';
                                    }
                                }
                            }
                        });
                        
                        // æ›´æ–°è¿æ¥çŠ¶æ€ä¸ºæˆåŠŸ
                        if (connectStatus) {
                            connectStatus.textContent = 'å·²è¿æ¥';
                            connectStatus.className = 'badge bg-success';
                        }
                        
                        showAlertModal('æˆåŠŸ', `æ•°æ®åº“ "${db.name}" è¿æ¥æˆåŠŸï¼`, 'success');
                    } else {
                        // è¿æ¥å¤±è´¥
                        if (connectStatus) {
                            connectStatus.textContent = 'è¿æ¥å¤±è´¥';
                            connectStatus.className = 'badge bg-danger';
                        }
                        
                        const errorMessage = data.message || 'æœªçŸ¥é”™è¯¯';
                        showAlertModal('è¿æ¥å¤±è´¥', `æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ "${db.name}"ï¼š${errorMessage}`, 'danger');
                    }
                })
                .catch(error => {
                    // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯
                    if (connectStatus) {
                        connectStatus.textContent = 'è¿æ¥å¤±è´¥';
                        connectStatus.className = 'badge bg-danger';
                    }
                    
                    showAlertModal('è¿æ¥é”™è¯¯', `è¿æ¥æ•°æ®åº“ "${db.name}" æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`, 'danger');
                    console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                })
                .finally(() => {
                    // æ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                    originalBtnStates.forEach(state => {
                        if (state.element) {
                            state.element.innerHTML = state.innerHTML;
                            state.element.disabled = state.disabled;
                        }
                    });
                    
                    // æ¸…é™¤è¿æ¥æ“ä½œæ ‡è®°
                    currentConnectionOperation = null;
                });
        }

        /**
         * è®¾ç½®æ•°æ®åº“ä¸ºé»˜è®¤ï¼ˆå¤–éƒ¨è°ƒç”¨ç‰ˆæœ¬ï¼Œç”¨äºåˆ—è¡¨é¡¹ä¸Šçš„æŒ‰é’®ï¼‰
         * @param {string} dbId - æ•°æ®åº“ID
         */
        function setAsDefault(dbId) {
            fetch('/set_default_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ db_id: dbId })
            })
            .then(res => {
                if (!res.ok) throw new Error('è®¾ç½®é»˜è®¤æ•°æ®åº“è¯·æ±‚å¤±è´¥');
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showAlertModal('æˆåŠŸ', 'å·²è®¾ç½®ä¸ºé»˜è®¤æ•°æ®åº“ï¼', 'success');
                    
                    // æ›´æ–°UIä¸Šçš„é»˜è®¤æ ‡è®°
                    // æ¸…é™¤æ‰€æœ‰é»˜è®¤æ ‡è®°
                    document.querySelectorAll('#databaseList .db-item').forEach(item => {
                        item.removeAttribute('data-is-default');
                        item.classList.remove('default-db');
                    });
                    
                    // ä¸ºæ–°çš„é»˜è®¤æ•°æ®åº“é¡¹æ·»åŠ æ ‡è®°
                    const defaultDbItem = document.querySelector(`#databaseList .db-item[data-db-id="${dbId}"]`);
                    if (defaultDbItem) {
                        defaultDbItem.setAttribute('data-is-default', 'true');
                        defaultDbItem.classList.add('default-db');
                    }
                    
                    loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    showAlertModal('å¤±è´¥', `è®¾ç½®å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                }
            })
            .catch(error => {
                showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
            });
        }
        
        /**
         * æäº¤æ•°æ®åº“é…ç½®ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
         * @param {string} method - è¯·æ±‚æ–¹æ³•ï¼ˆPOSTæˆ–PUTï¼‰
         */
        function submitDatabaseConfig(method) {
            // è·å–è¡¨å•æ•°æ®
            const formData = {
                id: document.getElementById('configDbId').value,
                name: document.getElementById('configDbName').value.trim(),
                type: document.getElementById('configDbType').value,
                host: document.getElementById('configDbHost').value.trim(),
                port: document.getElementById('configDbPort').value.trim(),
                user: document.getElementById('configDbUser').value.trim(),
                database: document.getElementById('configDbDatabase').value.trim(),
                sslmode: document.getElementById('configDbSslMode').value
            };
            
            // å¯¹äºPUTè¯·æ±‚ï¼ˆæ›´æ–°ï¼‰ï¼Œåªæœ‰åœ¨ç”¨æˆ·æ˜ç¡®è¾“å…¥äº†æ–°å¯†ç æ—¶æ‰åŒ…å«å¯†ç å­—æ®µ
            const passwordValue = document.getElementById('configDbPassword').value;
            if (method === 'PUT') {
                // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œåªæœ‰å½“ç”¨æˆ·è¾“å…¥äº†æ–°å¯†ç æ—¶æ‰å‘é€å¯†ç å­—æ®µ
                // å¦‚æœå¯†ç å­—æ®µä¸ºç©ºï¼Œè¡¨ç¤ºä¸æ›´æ”¹å¯†ç ï¼Œä¸å‘é€å¯†ç å­—æ®µ
                if (passwordValue) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å¯†ç ï¼ˆä¸åŒäºåŸå§‹å¯†ç ï¼‰
                    const originalPassword = document.getElementById('originalDbPassword').value;
                    // åªæœ‰å½“è¾“å…¥çš„å¯†ç ä¸åŸå§‹å¯†ç ä¸åŒæ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯æ–°å¯†ç 
                    if (passwordValue !== originalPassword) {
                        formData.password = passwordValue;
                    }
                    // å¦‚æœè¾“å…¥çš„å¯†ç ä¸åŸå§‹å¯†ç ç›¸åŒï¼Œä¸æ·»åŠ åˆ°formDataï¼Œä¿æŒä¸å‘é€å¯†ç å­—æ®µ
                }
                // å¦‚æœå¯†ç å­—æ®µä¸ºç©ºï¼Œä¹Ÿä¸æ·»åŠ åˆ°formData
            } else {
                // å¯¹äºPOSTè¯·æ±‚ï¼ˆæ–°å¢ï¼‰ï¼Œå§‹ç»ˆåŒ…å«å¯†ç å­—æ®µ
                formData.password = passwordValue;
            }
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!formData.name || !formData.host || !formData.port || !formData.user || !formData.database) {
                showAlertModal('æç¤º', 'æ•°æ®åº“åç§°ã€ä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åå’Œæ•°æ®åº“åä¸ºå¿…å¡«é¡¹ï¼', 'warning');
                return;
            }
            
            // éªŒè¯ç«¯å£
            if (isNaN(formData.port)) {
                showAlertModal('æç¤º', 'ç«¯å£å¿…é¡»ä¸ºæ•°å­—ï¼', 'warning');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = document.getElementById('dbConfigSubmitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading-spinner-small"></span> ä¿å­˜ä¸­...';
            submitBtn.disabled = true;
            
            // å¯¹äºPUTè¯·æ±‚ï¼ˆæ›´æ–°ï¼‰ä¸”æ²¡æœ‰æä¾›å¯†ç æ—¶ï¼Œéœ€è¦è·å–åŸå§‹é…ç½®è¿›è¡Œè¿æ¥æµ‹è¯•
            if (method === 'PUT' && !('password' in formData)) {
                // ä½¿ç”¨å­˜å‚¨çš„åŸå§‹åŠ å¯†å¯†ç è¿›è¡Œè¿æ¥æµ‹è¯•
                const originalPassword = document.getElementById('originalDbPassword').value;
                
                if (!originalPassword) {
                    throw new Error('æ— æ³•è·å–åŸå§‹æ•°æ®åº“å¯†ç ç”¨äºè¿æ¥æµ‹è¯•');
                }
                
                // ä½¿ç”¨åŸå§‹å¯†ç è¿›è¡Œæµ‹è¯•
                const testFormDataWithPassword = {
                    ...formData,
                    password: originalPassword  // ä½¿ç”¨åŸå§‹åŠ å¯†å¯†ç 
                };
                
                testDbConnection(testFormDataWithPassword)
                    .then(() => {
                        // è¿æ¥æµ‹è¯•æˆåŠŸï¼Œä¿å­˜é…ç½®ï¼ˆä¸åŒ…å«å¯†ç å­—æ®µï¼Œä¿ç•™åŸå§‹å¯†ç ï¼‰
                        return fetch('/databases', {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)  // ä¸åŒ…å«passwordå­—æ®µ
                        });
                    })
                    .then(async res => {
                        if (!res.ok) {
                            const errorText = await res.text();
                            throw new Error(`é…ç½®ä¿å­˜è¯·æ±‚å¤±è´¥: ${res.status} ${errorText}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            dbConfigModal.hide();
                            showAlertModal('æˆåŠŸ', method === 'POST' ? 'æ•°æ®åº“é…ç½®æ–°å¢æˆåŠŸï¼' : 'æ•°æ®åº“é…ç½®æ›´æ–°æˆåŠŸï¼', 'success');
                            loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                        } else {
                            showAlertModal('å¤±è´¥', `ä¿å­˜å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('æ›´æ–°æ•°æ®åº“é…ç½®æ—¶å‡ºé”™:', error);
                        showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
                    })
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            } else {
                // å¯¹äºPOSTè¯·æ±‚æˆ–æä¾›äº†å¯†ç çš„PUTè¯·æ±‚ï¼Œç›´æ¥æµ‹è¯•å’Œä¿å­˜
                testDbConnection(formData)
                    .then(() => {
                        // è¿æ¥æµ‹è¯•æˆåŠŸï¼Œä¿å­˜é…ç½®
                        return fetch('/databases', {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                    })
                    .then(async res => {
                        if (!res.ok) {
                            const errorText = await res.text();
                            throw new Error(`é…ç½®ä¿å­˜è¯·æ±‚å¤±è´¥: ${res.status} ${errorText}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            dbConfigModal.hide();
                            showAlertModal('æˆåŠŸ', method === 'POST' ? 'æ•°æ®åº“é…ç½®æ–°å¢æˆåŠŸï¼' : 'æ•°æ®åº“é…ç½®æ›´æ–°æˆåŠŸï¼', 'success');
                            loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                        } else {
                            showAlertModal('å¤±è´¥', `ä¿å­˜å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('æ•°æ®åº“é…ç½®æ“ä½œæ—¶å‡ºé”™:', error);
                        showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
                    })
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            }
        }

        // æ•°æ®åº“é…ç½®è¾“å…¥æ¡†DOMå…ƒç´ 
        const configElements = {
            host: document.getElementById('dbHost'),
            port: document.getElementById('dbPort'),
            user: document.getElementById('dbUser'),
            pwd: document.getElementById('dbPwd'),
            dbName: document.getElementById('dbName'),
            dbType: document.getElementById('dbType'),  // æ–°å¢æ•°æ®åº“ç±»å‹é€‰æ‹©
            dbSelector: document.getElementById('dbSelector'),  // æ–°å¢æ•°æ®åº“é€‰æ‹©å™¨
            isDefaultDb: document.getElementById('isDefaultDb'),  // æ–°å¢é»˜è®¤æ•°æ®åº“å¤é€‰æ¡†
            saveBtn: document.getElementById('saveConfigBtn'),
            updateBtn: document.getElementById('updateConfigBtn'),
            saveLoading: document.getElementById('saveLoadingOverlay')
        };
        
        // ===================== SQLå®‰å…¨æ ¡éªŒï¼ˆå‰ç«¯åŒé‡æ‹¦æˆªï¼‰ =====================
        /**
         * å‰ç«¯SQLå®‰å…¨æ ¡éªŒ
         * @returns {boolean} æ˜¯å¦å®‰å…¨
         */
        function checkSqlSafety() {
            const sqlInput = document.getElementById('sqlInput');
            const dangerAlert = document.getElementById('dangerSqlAlert');
            const dangerMsg = document.getElementById('dangerSqlMsg');
            
            if (!sqlInput) return true;
            
            const sql = (sqlInput.value || sqlInput.textContent || sqlInput.innerText).trim().toUpperCase();
            if (!sql) {
                dangerAlert.style.display = 'none';
                return true;
            }
            
            // ç§»é™¤æ³¨é‡Šï¼Œé¿å…ç»•è¿‡æ£€æµ‹
            const cleanSql = sql.replace(/\/\*.*?\*\//g, '').replace(/--.*?$/gm, '').trim();
            
            // å±é™©æ“ä½œå…³é”®è¯
            const dangerousKeywords = [
                'UPDATE ', 'DELETE ', 'DROP ', 'ALTER ', 'CREATE ', 
                'RENAME ', 'REPLACE ', 'GRANT ', 'REVOKE ', 'LOCK ',
                'TRUNCATE ', 'INSERT ', 'MERGE '
            ];
            
            // æ£€æŸ¥å±é™©å…³é”®è¯
            for (const keyword of dangerousKeywords) {
                if (cleanSql.includes(keyword)) {
                    dangerMsg.textContent = `æ£€æµ‹åˆ°å±é™©æ“ä½œã€Œ${keyword.trim()}ã€ï¼Œæœ¬ç³»ç»Ÿä»…å…è®¸æ‰§è¡ŒSELECT/EXPLAINæŸ¥è¯¢ï¼`;
                    dangerAlert.style.display = 'flex';
                    return false;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæŸ¥è¯¢æ“ä½œ - æ”¹è¿›çš„åˆ¤æ–­é€»è¾‘
            // å…è®¸SELECTã€EXPLAINä»¥åŠWITHå¼€å¤´çš„åˆæ³•æŸ¥è¯¢
            const isSelectQuery = cleanSql.startsWith('SELECT') || cleanSql.startsWith('EXPLAIN');
            const isWithQuery = cleanSql.startsWith('WITH') && cleanSql.includes('SELECT');
            
            if (!isSelectQuery && !isWithQuery) {
                dangerMsg.textContent = 'æœ¬ç³»ç»Ÿä»…å…è®¸æ‰§è¡ŒSELECT/EXPLAIN/WITHæŸ¥è¯¢æ“ä½œï¼';
                dangerAlert.style.display = 'flex';
                return false;
            }
            
            dangerAlert.style.display = 'none';
            return true;
        }

        /**
         * SQLè¾“å…¥æ¡†è‡ªåŠ¨é«˜åº¦è°ƒæ•´ + å®‰å…¨æ ¡éªŒ
         */
        function autoResizeTextarea(element) {
            if (!element || element.tagName.toLowerCase() !== 'textarea') return;
            
            console.log('autoResizeTextarea called with element:', element.id || element.tagName);
            console.log('Current value:', element.value);
            console.log('Current height:', element.style.height);
            
            // åŸºäºè¡Œæ•°è®¡ç®—é«˜åº¦
            const content = element.value;
            const lines = content.split('\n').length;
            const minHeight = 120;
            const maxHeight = 10000; // 10000pxä¸Šé™
            
            // è®¡ç®—ç›®æ ‡é«˜åº¦
            let targetHeight = Math.max(lines * 25, minHeight);
            
            console.log('Lines:', lines, 'Target height:', targetHeight);
            
            // å¦‚æœè¶…è¿‡æœ€å¤§é«˜åº¦ï¼Œå¯ç”¨æ»šåŠ¨æ¡
            if (targetHeight > maxHeight) {
                targetHeight = maxHeight;
                element.style.overflowY = 'auto';  // æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡
            } else {
                element.style.overflowY = 'hidden'; // éšè—æ»šåŠ¨æ¡
            }
            
            // åº”ç”¨é«˜åº¦
            element.style.height = targetHeight + 'px';
            console.log('Applied height:', targetHeight + 'px');
        }
        
        function handleSqlInput() {
            const sqlInput = document.getElementById('sqlInput');
            autoResizeTextarea(sqlInput);
            checkSqlSafety();
            updateSqlHighlight(); // æ›´æ–°è¯­æ³•é«˜äº®
        }
        
        /**
         * è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
         */
        function loadSqlFromFile() {
            document.getElementById('sqlFileInput').click();
        }
        
        /**
         * è¯»å–SQLæ–‡ä»¶å†…å®¹å¹¶åŠ è½½åˆ°æ–‡æœ¬æ¡†
         * @param {HTMLInputElement} input - æ–‡ä»¶è¾“å…¥å…ƒç´ 
         */
        function readSqlFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.sql') && !fileName.endsWith('.txt')) {
                showAlertModal('é”™è¯¯', 'è¯·é€‰æ‹©æœ‰æ•ˆçš„SQLæ–‡ä»¶(.sql)æˆ–æ–‡æœ¬æ–‡ä»¶(.txt)', 'danger');
                return;
            }
            
            // é¦–å…ˆå°è¯•ä½¿ç”¨UTF-8ç¼–ç è¯»å–æ–‡ä»¶
            const utf8Reader = new FileReader();
            utf8Reader.onload = function(e) {
                try {
                    const sqlContent = e.target.result;
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ˜æ˜¾çš„ä¸­æ–‡ä¹±ç ç‰¹å¾ï¼ˆè¿ç»­çš„é—®å·æˆ–ç‰¹æ®Šå­—ç¬¦ï¼‰
                    if (detectChineseGarbled(sqlContent)) {
                        // å¦‚æœæ£€æµ‹åˆ°ä¹±ç ï¼Œå°è¯•ä½¿ç”¨GBKç¼–ç é‡æ–°è¯»å–
                        tryReadWithGBK(file);
                    } else {
                        // æ²¡æœ‰æ£€æµ‹åˆ°ä¹±ç ï¼Œç›´æ¥ä½¿ç”¨å†…å®¹
                        loadSqlToInput(sqlContent);
                    }
                } catch (error) {
                    showAlertModal('é”™è¯¯', 'è§£ææ–‡ä»¶å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                }
            };
            utf8Reader.onerror = function() {
                // UTF-8è¯»å–å¤±è´¥ï¼Œå°è¯•GBK
                tryReadWithGBK(file);
            };
            utf8Reader.readAsText(file, 'UTF-8');
        }
        
        /**
         * å°è¯•ä½¿ç”¨GBKç¼–ç è¯»å–æ–‡ä»¶
         * @param {File} file - æ–‡ä»¶å¯¹è±¡
         */
        function tryReadWithGBK(file) {
            const gbkReader = new FileReader();
            gbkReader.onload = function(e) {
                try {
                    const sqlContent = e.target.result;
                    loadSqlToInput(sqlContent);
                } catch (error) {
                    showAlertModal('é”™è¯¯', 'è§£ææ–‡ä»¶å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                }
            };
            gbkReader.onerror = function() {
                showAlertModal('é”™è¯¯', 'è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ç¼–ç æ ¼å¼', 'danger');
            };
            // æ³¨æ„ï¼šFileReaderåŸç”Ÿä¸æ”¯æŒGBKï¼Œè¿™é‡Œä½¿ç”¨TextDecoderè¿›è¡Œå¤„ç†
            const arrayBufferReader = new FileReader();
            arrayBufferReader.onload = function(e) {
                try {
                    // å°è¯•ä½¿ç”¨TextDecoderå¤„ç†å¯èƒ½çš„GBKç¼–ç 
                    const uint8Array = new Uint8Array(e.target.result);
                    // å…ˆå°è¯•UTF-8
                    try {
                        const decoder = new TextDecoder('utf-8', { fatal: false });
                        const sqlContent = decoder.decode(uint8Array);
                        if (detectChineseGarbled(sqlContent)) {
                            // å¦‚æœä»æœ‰ä¹±ç ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–ç¼–ç æ–¹å¼
                            // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¸€äº›æŠ€å·§
                            const gbkContent = attemptGBKDecode(uint8Array);
                            loadSqlToInput(gbkContent || sqlContent); // ä½¿ç”¨å°è¯•è§£ç çš„ç»“æœï¼Œå¦åˆ™ä½¿ç”¨UTF-8ç»“æœ
                        } else {
                            loadSqlToInput(sqlContent);
                        }
                    } catch (decodeError) {
                        // å¦‚æœUTF-8è§£ç å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
                        const fallbackContent = attemptGBKDecode(uint8Array);
                        loadSqlToInput(fallbackContent || '');
                    }
                } catch (error) {
                    showAlertModal('é”™è¯¯', 'è§£ç æ–‡ä»¶å†…å®¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                }
            };
            arrayBufferReader.onerror = function() {
                showAlertModal('é”™è¯¯', 'è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            };
            arrayBufferReader.readAsArrayBuffer(file);
        }
        
        /**
         * å°è¯•ä½¿ç”¨å¤šç§æ–¹æ³•è§£ç ä¸åŒç¼–ç çš„å†…å®¹
         * @param {Uint8Array} uint8Array - å­—èŠ‚æ•°ç»„
         * @returns {string} è§£ç åçš„å†…å®¹
         */
        function attemptGBKDecode(uint8Array) {
            try {
                // å¸¸è§çš„ä¸­æ–‡ç¼–ç åˆ—è¡¨
                const encodings = ['utf-8', 'gbk', 'gb2312', 'big5', 'shift-jis', 'euc-kr'];
                
                for (let encoding of encodings) {
                    try {
                        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¿™ç§ç¼–ç 
                        if (TextDecoder.supports && TextDecoder.supports(encoding)) {
                            const decoder = new TextDecoder(encoding, { fatal: false });
                            const decodedText = decoder.decode(uint8Array);
                            
                            // æ£€æŸ¥è§£ç ç»“æœæ˜¯å¦åˆç†ï¼ˆä¸­æ–‡å­—ç¬¦è¾ƒå¤šä¸”ä¹±ç è¾ƒå°‘ï¼‰
                            if (checkDecodingQuality(decodedText)) {
                                return decodedText;
                            }
                        } else {
                            // å¦‚æœä¸æ”¯æŒè¯¥ç¼–ç ï¼Œè·³è¿‡
                            continue;
                        }
                    } catch (e) {
                        // æ­¤ç¼–ç ä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
                        continue;
                    }
                }
                
                // å¦‚æœä¸Šè¿°ç¼–ç éƒ½æ— æ³•äº§ç”Ÿå¥½çš„ç»“æœï¼Œå°è¯•UTF-8ä½œä¸ºåå¤‡
                try {
                    const utf8Decoder = new TextDecoder('utf-8', { fatal: false });
                    return utf8Decoder.decode(uint8Array);
                } catch (e) {
                    // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•ç®€å•è½¬æ¢
                    return trySimpleConversion(uint8Array);
                }
            } catch (error) {
                console.error('Encoding detection and decoding failed:', error);
                return null;
            }
        }
        
        /**
         * å°è¯•ç®€å•çš„ç¼–ç è½¬æ¢æ–¹æ³•
         * @param {Uint8Array} uint8Array - å­—èŠ‚æ•°ç»„
         * @returns {string} è½¬æ¢åçš„å†…å®¹
         */
        function trySimpleConversion(uint8Array) {
            try {
                // å°è¯•æœ€å¸¸è§çš„å‡ ç§ç¼–ç 
                const encodings = ['utf-8', 'gbk', 'gb2312'];
                
                for (let encoding of encodings) {
                    try {
                        // åˆ›å»ºä¸€ä¸ªTextDecoderå®ä¾‹
                        let decoder;
                        try {
                            decoder = new TextDecoder(encoding);
                        } catch (e) {
                            // å¦‚æœä¸æ”¯æŒæ­¤ç¼–ç ï¼Œè·³è¿‡
                            continue;
                        }
                        
                        const decodedText = decoder.decode(uint8Array);
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå¦‚æœæ²¡æœ‰æˆ–å…¨æ˜¯ä¹±ç åˆ™ç»§ç»­å°è¯•å…¶ä»–ç¼–ç 
                        if (decodedText && (hasChineseCharacters(decodedText) || !hasGarbledCharacters(decodedText))) {
                            return decodedText;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                // å¦‚æœéƒ½å¤±è´¥äº†ï¼Œå°è¯•æœ€ç®€å•çš„è½¬æ¢
                let str = '';
                for (let i = 0; i < uint8Array.length; i++) {
                    str += String.fromCharCode(uint8Array[i]);
                }
                return str;
            } catch (e) {
                console.error('Simple conversion failed:', e);
                return '';
            }
        }
        
        /**
         * æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
         * @param {string} text - è¦æ£€æŸ¥çš„æ–‡æœ¬
         * @returns {boolean} æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
         */
        function hasChineseCharacters(text) {
            return /[\u4e00-\u9fa5]/.test(text);
        }
        
        /**
         * æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¹±ç å­—ç¬¦
         * @param {string} text - è¦æ£€æŸ¥çš„æ–‡æœ¬
         * @returns {boolean} æ˜¯å¦åŒ…å«ä¹±ç å­—ç¬¦
         */
        function hasGarbledCharacters(text) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ›¿æ¢å­—ç¬¦æˆ–è¿‡å¤šçš„é—®å·
            return /[\uFFFD]|[?]{3,}/.test(text);
        }
        
        /**
         * æ£€æµ‹æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«ä¸­æ–‡ä¹±ç 
         * @param {string} text - è¦æ£€æµ‹çš„æ–‡æœ¬
         * @returns {boolean} æ˜¯å¦åŒ…å«ä¹±ç 
         */
        function detectChineseGarbled(text) {
            if (!text) return false;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å…¸å‹çš„ä¹±ç ç‰¹å¾
            // å¦‚è¿ç»­çš„é—®å·ã€ç‰¹æ®Šç¬¦å·æˆ–å…¶ä»–éé¢„æœŸå­—ç¬¦
            const garbledPatterns = [
                /[\uFFFD]/,           // æ›¿æ¢å­—ç¬¦ ()
                /[\?]{2,}/,           // è¿ç»­é—®å·
                /[^\u00-\u007F\u4e00-\u9fa5\x0a\x0d]{3,}/,  // è¿ç»­éASCIIã€éä¸­æ–‡ã€éæ¢è¡Œç¬¦çš„å­—ç¬¦
                /(?:[^\x00-\x7F\x0A\x0D\u4e00-\u9fa5]){2,}/ // è¿ç»­éè‹±æ–‡ã€éä¸­æ–‡ã€éæ¢è¡Œç¬¦çš„å­—ç¬¦
            ];
            
            return garbledPatterns.some(pattern => pattern.test(text));
        }
        
        /**
         * æ£€æŸ¥è§£ç è´¨é‡
         * @param {string} text - è§£ç åçš„æ–‡æœ¬
         * @returns {boolean} è§£ç è´¨é‡æ˜¯å¦è‰¯å¥½
         */
        function checkDecodingQuality(text) {
            if (!text) return false;
            
            // ç»Ÿè®¡ä¸­æ–‡å­—ç¬¦æ•°é‡å’Œä¹±ç å­—ç¬¦æ•°é‡
            const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
            const garbledChars = (text.match(/[\uFFFD\?]/g) || []).length;
            const totalChars = text.length;
            
            // ç»Ÿè®¡å¯æ‰“å°ASCIIå­—ç¬¦ï¼ˆæ’é™¤æ§åˆ¶å­—ç¬¦ï¼‰
            const printableAsciiChars = (text.match(/[ -~]/g) || []).length;
            
            // å¦‚æœä¸­æ–‡å­—ç¬¦è¾ƒå¤šä¸”ä¹±ç è¾ƒå°‘ï¼Œåˆ™è®¤ä¸ºè§£ç è´¨é‡è¾ƒå¥½
            if (totalChars > 0) {
                const chineseRatio = chineseChars / totalChars;
                const garbledRatio = garbledChars / totalChars;
                const printableRatio = printableAsciiChars / totalChars;
                
                // å¦‚æœä¸­æ–‡å æ¯”è¶…è¿‡ä¸€å®šæ¯”ä¾‹ä¸”ä¹±ç å æ¯”å¾ˆä½ï¼Œåˆ™è®¤ä¸ºè´¨é‡å¥½
                // æˆ–è€…æ²¡æœ‰ä¹±ç å­—ç¬¦
                return (chineseRatio > 0.02 && garbledRatio < 0.05) || 
                       (garbledRatio === 0 && printableRatio > 0.8);
            }
            
            return false;
        }
        
        /**
         * å°†SQLå†…å®¹åŠ è½½åˆ°è¾“å…¥æ¡†
         * @param {string} sqlContent - SQLå†…å®¹
         */
        function loadSqlToInput(sqlContent) {
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = sqlContent;
                    updateSqlHighlight(); // æ‰‹åŠ¨è§¦å‘è¯­æ³•é«˜äº®
                } else {
                    sqlInput.value = sqlContent;
                }
                // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥è°ƒæ•´æ–‡æœ¬æ¡†å¤§å°ã€è¿›è¡Œå®‰å…¨æ£€æŸ¥å’Œè¯­æ³•é«˜äº®
                sqlInput.dispatchEvent(new Event('input'));
            }
        }

        // ===================== å·¥å…·å‡½æ•° - è„±æ•å¤„ç† =====================
        /**
         * é€šç”¨è„±æ•å‡½æ•°
         * @param {string} value - åŸå§‹å€¼
         * @param {string} type - ç±»å‹ï¼ˆhost/port/user/dbNameï¼‰
         * @returns {string} è„±æ•åçš„å€¼
         */
        function maskValue(value, type) {
            if (!value) return '';
            
            switch(type) {
                case 'host':
                    // IPåœ°å€ï¼šä¿ç•™å‰ä¸¤æ®µï¼Œåä¸¤æ®µè„±æ•ï¼ˆå¦‚ 192.168.1.100 â†’ 192.168.*.*ï¼‰
                    // åŸŸåï¼šä¿ç•™å‰2ä¸ªå­—ç¬¦å’Œæœ€åä¸€ä¸ªåŸŸåæ®µï¼ˆå¦‚ mysql.example.com â†’ my*.example.comï¼‰
                    const ipRegex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
                    if (ipRegex.test(value)) {
                        const parts = value.split('.');
                        return `${parts[0]}.${parts[1]}.*.*`;
                    } else {
                        if (value.length <= 4) {
                            return value.substring(0, 1) + '*'.repeat(value.length - 1);
                        }
                        const domainParts = value.split('.');
                        if (domainParts.length > 1) {
                            const mainPart = domainParts[0];
                            const suffix = domainParts.slice(1).join('.');
                            return mainPart.substring(0, 2) + '*' + '.' + suffix;
                        } else {
                            return value.substring(0, 2) + '*'.repeat(value.length - 2);
                        }
                    }
                    
                case 'port':
                    // ç«¯å£ï¼šå…¨éƒ¨è„±æ•ï¼ˆå¦‚ 5432 â†’ ****ï¼‰
                    return '*'.repeat(value.length);
                    
                case 'user':
                    // ç”¨æˆ·åï¼šä¿ç•™å‰1ä¸ªå­—ç¬¦ï¼Œå…¶ä½™è„±æ•ï¼ˆå¦‚ admin â†’ a***ï¼‰
                    if (value.length <= 2) {
                        return value.substring(0, 1) + '*'.repeat(value.length - 1);
                    }
                    return value.substring(0, 1) + '*'.repeat(value.length - 1);
                    
                case 'dbName':
                    // æ•°æ®åº“åï¼šä¿ç•™å‰2ä¸ªå­—ç¬¦ï¼Œå…¶ä½™è„±æ•ï¼ˆå¦‚ testdb â†’ te***ï¼‰
                    if (value.length <= 3) {
                        return value.substring(0, 1) + '*'.repeat(value.length - 1);
                    }
                    return value.substring(0, 2) + '*'.repeat(value.length - 2);
                    
                default:
                    return value;
            }
        }

        /**
         * è¿˜åŸé…ç½®å€¼ï¼ˆç¼–è¾‘æ—¶æ˜¾ç¤ºåŸå§‹å€¼ï¼‰
         */
        function restoreConfigValues() {
            if (configElements.host) configElements.host.value = originalConfig.host;
            if (configElements.port) configElements.port.value = originalConfig.port;
            if (configElements.user) configElements.user.value = originalConfig.user;
            if (configElements.dbName) configElements.dbName.value = originalConfig.dbName;
        }

        // ===================== æ•°æ®åº“è¿æ¥æµ‹è¯• =====================
        // å…¨å±€è¿æ¥æ§åˆ¶å™¨ï¼Œç”¨äºå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿æ¥
        let connectionController = null;
        
        /**
         * å–æ¶ˆå½“å‰æ­£åœ¨è¿›è¡Œçš„æ•°æ®åº“è¿æ¥
         */
        function cancelCurrentConnection() {
            if (connectionController) {
                connectionController.abort();
                connectionController = null;
                
                // æ¢å¤UIçŠ¶æ€
                const connectStatus = document.getElementById('connectStatus');
                if (connectStatus) {
                    connectStatus.textContent = 'å·²å–æ¶ˆ';
                    connectStatus.className = 'badge bg-secondary';
                }
                
                // æ¢å¤æ‰€æœ‰è¿æ¥æŒ‰é’®
                const connectButtons = document.querySelectorAll('button[onclick*="connectToDatabase"]');
                connectButtons.forEach(btn => {
                    if (btn.innerHTML.includes('è¿æ¥ä¸­')) {
                        btn.innerHTML = 'è¿æ¥';
                        btn.disabled = false;
                    }
                });
                
                showAlertModal('æç¤º', 'æ•°æ®åº“è¿æ¥å·²å–æ¶ˆ', 'info');
            }
        }
        
        /**
         * æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆæ”¯æŒå¤šæ•°æ®åº“ç±»å‹ï¼‰
         * @param {Object} config - æ•°æ®åº“é…ç½®
         * @returns {Promise} è¿æ¥ç»“æœ
         */
        
        function testDbConnection(config) {
            // å¦‚æœå·²æœ‰è¿æ¥æ­£åœ¨è¿›è¡Œï¼Œå…ˆå–æ¶ˆå®ƒ
            if (connectionController) {
                console.log('å–æ¶ˆä¹‹å‰çš„è¿æ¥æµ‹è¯•');
                connectionController.abort();
                connectionController = null;
            }
            
            // åˆ›å»ºæ–°çš„ AbortController ç”¨äºå–æ¶ˆè¯·æ±‚
            const controller = new AbortController();
            connectionController = controller;
            
            return new Promise((resolve, reject) => {
                // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ8ç§’ï¼‰ä»¥é¿å…é¡µé¢å¡æ­»ï¼ŒåŒæ—¶ç»™æ•°æ®åº“è¶³å¤Ÿæ—¶é—´å“åº”
                const timeout = setTimeout(() => {
                    if (connectionController === controller) {
                        controller.abort();
                        reject(new Error('è¿æ¥è¶…æ—¶ï¼ˆ8ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œæ•°æ®åº“é…ç½®'));
                    }
                }, 8000);
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                const sessionToken = localStorage.getItem('app_session_token');
                if (sessionToken) {
                    headers['X-Session-Token'] = sessionToken;
                }
                
                fetch('/test_db_connection', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(config),
                    signal: controller.signal  // ç»‘å®š abort æ§åˆ¶å™¨
                })
                .then(res => {
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        resolve(true);
                    } else {
                        reject(new Error(data.message || 'æ•°æ®åº“è¿æ¥å¤±è´¥'));
                    }
                })
                .catch(error => {
                    clearTimeout(timeout);
                    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
                    if (error.name === 'AbortError') {
                        reject(new Error('è¿æ¥å·²è¢«å–æ¶ˆ'));
                    } else if (error instanceof TypeError && error.message.includes('fetch')) {
                        reject(new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®'));
                    } else {
                        reject(error);
                    }
                })
                .finally(() => {
                    // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
                    clearTimeout(timeout);
                    // æ¸…ç†æ§åˆ¶å™¨
                    if (connectionController === controller) {
                        connectionController = null;
                    }
                });
            });
        }

        /**
         * åŠ è½½é€‰ä¸­çš„æ•°æ®åº“é…ç½®
         */
        function loadSelectedDbConfig() {
            const selector = document.getElementById('dbSelector');
            const selectedId = selector.value;
            
            if (!selectedId) {
                // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
                document.getElementById('dbType').value = 'postgresql';
                document.getElementById('dbHost').value = '';
                document.getElementById('dbPort').value = '';
                document.getElementById('dbUser').value = '';
                document.getElementById('dbPwd').value = '';
                document.getElementById('dbName').value = '';
                document.getElementById('isDefaultDb').checked = false;
                return;
            }
            
            // æŸ¥æ‰¾é€‰ä¸­çš„æ•°æ®åº“é…ç½®
            const selectedDb = dbConfigs.find(db => db.id === selectedId);
            if (selectedDb) {
                document.getElementById('dbType').value = selectedDb.type || 'postgresql';
                document.getElementById('dbHost').value = selectedDb.host || '';
                document.getElementById('dbPort').value = selectedDb.port || '';
                document.getElementById('dbUser').value = selectedDb.user || '';
                document.getElementById('dbPwd').value = selectedDb.password || '';
                document.getElementById('dbName').value = selectedDb.database || '';
                document.getElementById('isDefaultDb').checked = selectedDb.is_default || false;
            }
        }
        
        /**
         * æµ‹è¯•æ•°æ®åº“é…ç½®è¿æ¥
         */
        function testDatabaseConfig() {
            // è·å–è¡¨å•æ•°æ®
            const formData = {
                name: document.getElementById('configDbName').value.trim(),
                type: document.getElementById('configDbType').value,
                host: document.getElementById('configDbHost').value.trim(),
                port: document.getElementById('configDbPort').value.trim(),
                user: document.getElementById('configDbUser').value.trim(),
                database: document.getElementById('configDbDatabase').value.trim(),
                password: document.getElementById('configDbPassword').value,
                sslmode: document.getElementById('configDbSslMode').value
            };
        
            // éªŒè¯å¿…å¡«å­—æ®µï¼ˆé™¤äº†å¯†ç ï¼‰
            if (!formData.name || !formData.host || !formData.port || !formData.user || !formData.database) {
                showAlertModal('æç¤º', 'æ•°æ®åº“åç§°ã€ä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åå’Œæ•°æ®åº“åä¸ºå¿…å¡«é¡¹ï¼', 'warning');
                return;
            }
        
            // éªŒè¯ç«¯å£
            if (isNaN(formData.port)) {
                showAlertModal('æç¤º', 'ç«¯å£å¿…é¡»ä¸ºæ•°å­—ï¼', 'warning');
                return;
            }
        
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ²¡æœ‰è¾“å…¥æ–°å¯†ç 
            const isEditing = document.getElementById('configDbId').value;
            const originalPassword = document.getElementById('originalDbPassword').value;
        
            if (isEditing && !formData.password && originalPassword) {
                // ä½¿ç”¨åŸå§‹åŠ å¯†å¯†ç è¿›è¡Œæµ‹è¯•
                formData.password = originalPassword;
            }
        
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const testBtn = document.getElementById('dbConfigTestBtn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span class="loading-spinner-small"></span> æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
        
            // å‘é€æµ‹è¯•è¯·æ±‚
            testDbConnection(formData)
                .then(() => {
                    showAlertModal('æˆåŠŸ', 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                })
                .catch(error => {
                    showAlertModal('è¿æ¥å¤±è´¥', error.message || 'æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥', 'danger');
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    testBtn.innerHTML = originalText;
                    testBtn.disabled = false;
                });
        }
        
        /**
         * è®¾ç½®é€‰ä¸­çš„æ•°æ®åº“ä¸ºé»˜è®¤æ•°æ®åº“
         */
        function setSelectedDbAsDefault() {
            const selector = document.getElementById('dbSelector');
            const selectedId = selector.value;
            
            if (!selectedId) {
                showAlertModal('æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°æ®åº“ï¼', 'warning');
                return;
            }
            
            // å‘é€è¯·æ±‚è®¾ç½®é»˜è®¤æ•°æ®åº“
            fetch('/set_default_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ db_id: selectedId })
            })
            .then(res => {
                if (!res.ok) throw new Error('è®¾ç½®é»˜è®¤æ•°æ®åº“è¯·æ±‚å¤±è´¥');
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showAlertModal('æˆåŠŸ', 'å·²è®¾ç½®ä¸ºé»˜è®¤æ•°æ®åº“ï¼', 'success');
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥æ›´æ–°æ•°æ®åº“åˆ—è¡¨
                    location.reload();
                } else {
                    showAlertModal('å¤±è´¥', `è®¾ç½®å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                }
            })
            .catch(error => {
                showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
            });
        }

        /**
         * æµ‹è¯•å½“å‰æ•°æ®åº“é…ç½®
         */
        function testCurrentDbConfig() {
            // è·å–è¾“å…¥å€¼
            const dbType = configElements.dbType?.value.trim() || 'postgresql';
            const host = configElements.host?.value.trim() || '';
            const port = configElements.port?.value.trim() || '';
            const user = configElements.user?.value.trim() || '';
            const pwd = configElements.pwd?.value || '';
            const dbName = configElements.dbName?.value.trim() || '';
            
            // åŸºç¡€æ ¡éªŒ
            if (!host) {
                showAlertModal('æç¤º', 'ä¸»æœºåœ°å€ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!port) {
                showAlertModal('æç¤º', 'ç«¯å£ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (isNaN(port)) {
                showAlertModal('æç¤º', 'ç«¯å£å¿…é¡»ä¸ºæ•°å­—ï¼', 'warning');
                return;
            }
            if (!user) {
                showAlertModal('æç¤º', 'ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!dbName) {
                showAlertModal('æç¤º', 'æ•°æ®åº“åä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!dbType) {
                showAlertModal('æç¤º', 'è¯·é€‰æ‹©æ•°æ®åº“ç±»å‹ï¼', 'warning');
                return;
            }

            const config = {
                type: dbType,
                host: host,
                port: port,
                user: user,
                password: pwd,
                database: dbName
            };
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const testBtn = document.querySelector('button[onclick="testCurrentDbConfig()"]');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<span class="loading-spinner-small"></span> æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            testDbConnection(config)
                .then(() => {
                    showAlertModal('æˆåŠŸ', 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                })
                .catch(error => {
                    showAlertModal('å¤±è´¥', `è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${error.message}`, 'danger');
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    testBtn.innerHTML = originalText;
                    testBtn.disabled = false;
                });
        }

        // ===================== æ•°æ®åº“é…ç½®äº¤äº’ =====================
        /**
         * åˆ‡æ¢é…ç½®è¾“å…¥æ¡†çš„å¯ç¼–è¾‘çŠ¶æ€
         * @param {boolean} editable - æ˜¯å¦å¯ç¼–è¾‘
         */
        function toggleConfigEditable(editable) {
            configIsEditable = editable;
            
            // é…ç½®é¡¹åˆ—è¡¨
            const configItems = [
                { el: configElements.host, type: 'host' },
                { el: configElements.port, type: 'port' },
                { el: configElements.user, type: 'user' },
                { el: configElements.dbName, type: 'dbName' },
                { el: configElements.pwd, type: 'pwd' }
            ];
            
            // è®¾ç½®è¾“å…¥æ¡†ç¦ç”¨/å¯ç”¨çŠ¶æ€
            configItems.forEach(item => {
                if (item.el) {
                    item.el.disabled = !editable;
                    
                    // éå¯†ç é¡¹ï¼šç¦ç”¨æ—¶è„±æ•ï¼Œå¯ç”¨æ—¶è¿˜åŸ
                    if (item.type !== 'pwd') {
                        if (!editable) {
                            // è„±æ•æ˜¾ç¤º
                            item.el.value = maskValue(originalConfig[item.type], item.type);
                        } else {
                            // è¿˜åŸåŸå§‹å€¼
                            item.el.value = originalConfig[item.type];
                        }
                    }
                }
            });
            
            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            if (configElements.saveBtn) configElements.saveBtn.style.display = editable ? 'block' : 'none';
            if (configElements.updateBtn) configElements.updateBtn.style.display = editable ? 'none' : 'block';
        }

        /**
         * å¯ç”¨é…ç½®ç¼–è¾‘ï¼ˆç‚¹å‡»æ›´æ–°é…ç½®æ—¶è°ƒç”¨ï¼‰
         */
        function enableConfigEdit() {
            toggleConfigEditable(true);
        }

        /**
         * ä¿å­˜æ•°æ®åº“é…ç½®ï¼ˆå…ˆæµ‹è¯•è¿æ¥ï¼ŒæˆåŠŸåå†ä¿å­˜å’Œè„±æ•ï¼‰
         */
        function saveDbConfig() {
            // é˜²æ­¢é‡å¤ä¿å­˜
            if (isSavingConfig) {
                // ä½¿ç”¨æ¨¡æ€æ¡†æç¤ºï¼Œæ›¿ä»£alert
                showAlertModal('æç¤º', 'æ­£åœ¨ä¿å­˜é…ç½®ï¼Œè¯·ç¨å€™...', 'info');
                return;
            }
            
            // è·å–è¾“å…¥å€¼
            const dbType = configElements.dbType?.value.trim() || 'postgresql';
            const host = configElements.host?.value.trim() || '';
            const port = configElements.port?.value.trim() || '';
            const user = configElements.user?.value.trim() || '';
            const pwd = configElements.pwd?.value || '';
            const dbName = configElements.dbName?.value.trim() || '';
            const isDefault = configElements.isDefaultDb?.checked || false;
            
            // è·å–å½“å‰é€‰æ‹©çš„æ•°æ®åº“IDï¼ˆå¦‚æœæ˜¯ç¼–è¾‘ç°æœ‰é…ç½®ï¼‰
            const selector = document.getElementById('dbSelector');
            const currentDbId = selector.value || null;
            
            // åŸºç¡€æ ¡éªŒ
            if (!host) {
                showAlertModal('æç¤º', 'ä¸»æœºåœ°å€ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!port) {
                showAlertModal('æç¤º', 'ç«¯å£ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (isNaN(port)) {
                showAlertModal('æç¤º', 'ç«¯å£å¿…é¡»ä¸ºæ•°å­—ï¼', 'warning');
                return;
            }
            if (!user) {
                showAlertModal('æç¤º', 'ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!dbName) {
                showAlertModal('æç¤º', 'æ•°æ®åº“åä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }
            if (!dbType) {
                showAlertModal('æç¤º', 'è¯·é€‰æ‹©æ•°æ®åº“ç±»å‹ï¼', 'warning');
                return;
            }

            const config = {
                id: currentDbId || null,  // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œåˆ™ä¸ºæ–°é…ç½®
                type: dbType,
                host: host,
                port: port,
                user: user,
                password: pwd,
                database: dbName,
                is_default: isDefault
            };
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            isSavingConfig = true;
            if (configElements.saveLoading) {
                configElements.saveLoading.style.display = 'flex';
            }
            
            // ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•æ•°æ®åº“è¿æ¥
            testDbConnection(config)
                .then(() => {
                    // è¿æ¥æˆåŠŸï¼Œç¬¬äºŒæ­¥ï¼šä¿å­˜é…ç½®
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    const sessionToken = localStorage.getItem('app_session_token');
                    if (sessionToken) {
                        headers['X-Session-Token'] = sessionToken;
                    }
                    
                    return fetch('/save_db_config', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(config)
                    });
                })
                .then(res => {
                    if (!res.ok) throw new Error('é…ç½®ä¿å­˜è¯·æ±‚å¤±è´¥');
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // ä¿å­˜æˆåŠŸï¼Œæ›´æ–°åŸå§‹é…ç½®å€¼
                        originalConfig = {
                            host: host,
                            port: port,
                            user: user,
                            dbName: dbName
                        };
                        
                        // é‡æ–°åŠ è½½æ•°æ®åº“åˆ—è¡¨
                        location.reload(); // ç®€å•æ–¹æ³•ï¼šé‡æ–°åŠ è½½é¡µé¢ä»¥æ›´æ–°æ•°æ®åº“åˆ—è¡¨
                        
                        showAlertModal('æˆåŠŸ', 'æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œé…ç½®å·²ä¿å­˜ï¼', 'success');
                    } else {
                        showAlertModal('å¤±è´¥', `é…ç½®ä¿å­˜å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                    }
                })
                .catch(error => {
                    // è¿æ¥å¤±è´¥æˆ–ä¿å­˜å¤±è´¥
                    showAlertModal('å¤±è´¥', `æ“ä½œå¤±è´¥ï¼š${error.message}`, 'danger');
                })
                .finally(() => {
                    // éšè—åŠ è½½çŠ¶æ€
                    isSavingConfig = false;
                    if (configElements.saveLoading) {
                        configElements.saveLoading.style.display = 'none';
                    }
                });
        }

        // ===================== åˆ†é¡µåŠŸèƒ½ - æ ¸å¿ƒä¿®å¤ =====================
        /**
         * æ¸²æŸ“é¡µç æŒ‰é’®ï¼ˆæ¨ªå‘æ’åˆ—ï¼‰
         */
        function renderPageNumbers() {
            const container = document.getElementById('pageNumberContainer');
            if (!container) return;
            container.innerHTML = '';
            
            if (totalPage <= 0) return;
            
            // æ˜¾ç¤ºè§„åˆ™ï¼š
            // 1. æ€»é¡µæ•°â‰¤10ï¼šæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            // 2. æ€»é¡µæ•°>10ï¼šæ˜¾ç¤ºå½“å‰é¡µå‰å3é¡µ + é¦–å°¾é¡µ
            let startPage = 1;
            let endPage = totalPage;
            
            if (totalPage > 10) {
                startPage = Math.max(1, currentPage - 3);
                endPage = Math.min(totalPage, currentPage + 3);
                
                // ç¡®ä¿æ˜¾ç¤º10ä¸ªé¡µç 
                if (endPage - startPage < 9) {
                    if (startPage === 1) {
                        endPage = 10;
                    } else if (endPage === totalPage) {
                        startPage = totalPage - 9;
                    }
                }
            }
            
            // æ·»åŠ é¦–é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'page-btn disabled';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }
            
            // æ·»åŠ ä¸­é—´é¡µç 
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // æ·»åŠ å°¾é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (endPage < totalPage) {
                if (endPage < totalPage - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'page-btn disabled';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
                addPageButton(totalPage);
            }
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) pageInfo.textContent = `å…± ${totalPage} é¡µ`;
            
            // æ›´æ–°è·³è½¬è¾“å…¥æ¡†æœ€å¤§å€¼
            const jumpInput = document.getElementById('jumpPageInput');
            if (jumpInput) {
                jumpInput.max = totalPage;
                jumpInput.value = currentPage;
            }
            
            // æ›´æ–°ä¸Šä¸‹é¡µæŒ‰é’®çŠ¶æ€
            updatePageButtonStatus();
        }

        /**
         * æ·»åŠ é¡µç æŒ‰é’®
         * @param {number} pageNum - é¡µç 
         */
        function addPageButton(pageNum) {
            const container = document.getElementById('pageNumberContainer');
            const button = document.createElement('button');
            button.className = `page-btn ${pageNum === currentPage ? 'active' : ''}`;
            button.textContent = pageNum;
            button.onclick = () => handlePageClick(pageNum);
            container.appendChild(button);
        }

        /**
         * æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰
         */
        function updatePageButtonStatus() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPage;
        }

        /**
         * ç‚¹å‡»é¡µç æŒ‰é’®
         * @param {number} pageNum - ç›®æ ‡é¡µç 
         */
        function handlePageClick(pageNum) {
            if (pageNum === currentPage || pageNum < 1 || pageNum > totalPage) return;
            currentPage = pageNum;
            executeSqlQuery();
        }

        /**
         * å¤„ç†ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ
         * @param {number} direction - æ–¹å‘ï¼š-1 ä¸Šä¸€é¡µï¼Œ1 ä¸‹ä¸€é¡µ
         */
        function handlePageChange(direction) {
            const newPage = currentPage + direction;
            if (newPage < 1 || newPage > totalPage) return;
            currentPage = newPage;
            executeSqlQuery();
        }

        /**
         * å¤„ç†è·³è½¬é¡µç 
         */
        function handleJumpPage() {
            const jumpInput = document.getElementById('jumpPageInput');
            let targetPage = parseInt(jumpInput.value);
            
            if (isNaN(targetPage)) targetPage = 1;
            targetPage = Math.max(1, Math.min(targetPage, totalPage));
            
            if (targetPage !== currentPage) {
                currentPage = targetPage;
                executeSqlQuery();
            }
            
            jumpInput.value = currentPage;
        }
        
        /**
         * æ‰§è¡Œç‹¬ç«‹è¯­å¥çš„åˆ†é¡µæŸ¥è¯¢ï¼ˆåªæ›´æ–°ç‰¹å®šè¯­å¥çš„ç»“æœï¼Œä¸æ›¿æ¢æ•´ä¸ªç»“æœåŒºåŸŸï¼‰
         * @param {string} sql - è¦æ‰§è¡Œçš„SQLè¯­å¥
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {number} page - é¡µç 
         */
        function executeIndividualSqlPage(sql, statementIndex, page) {
            if (isExecuting) return;
            isExecuting = true;
            
            // è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“ID
            const dbId = currentSelectedDbId || null;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const executeBtnText = document.getElementById('executeBtnText');
            if (executeBtnText) {
                executeBtnText.innerHTML = '<span class="loading-spinner"></span> æ‰§è¡Œä¸­...';
            }
            
            // æ„å»ºè¯·æ±‚å‚æ•°
            const formData = new FormData();
            formData.append('sql', sql);
            formData.append('page', page);
            formData.append('page_size', pageSize);
            formData.append('individual_execution', 'true');  // æ ‡è®°ä¸ºç‹¬ç«‹æ‰§è¡Œ
            formData.append('statement_index', statementIndex);
            if (dbId) {
                formData.append('db_id', dbId);
            }
            
            // å‘é€è¯·æ±‚
            const headers = {};
            const sessionToken = localStorage.getItem('app_session_token');
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }
            
            fetch('/execute_sql', {
                method: 'POST',
                headers: headers,
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.status === 'success' && data.columns && data.results) {
                    // åªæ›´æ–°ç‰¹å®šè¯­å¥çš„ç»“æœï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»“æœåŒºåŸŸ
                    updateIndividualStatementResult(statementIndex, data);
                } else {
                    // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.innerHTML = `<div class="alert alert-danger">${data.message || 'æ‰§è¡Œå¤±è´¥'}</div>`;
                }
            })
            .catch(error => {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                isExecuting = false;
                const executeBtnText = document.getElementById('executeBtnText');
                if (executeBtnText) {
                    executeBtnText.textContent = 'æ‰§è¡ŒæŸ¥è¯¢';
                }
            });
        }
        
        /**
         * æ›´æ–°ç‰¹å®šè¯­å¥çš„ç»“æœæ˜¾ç¤º
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {Object} newData - æ–°çš„æ•°æ®
         */
        function updateIndividualStatementResult(statementIndex, newData) {
            // æ‰¾åˆ°å¯¹åº”è¯­å¥çš„ç»“æœå®¹å™¨
            const statementElements = document.querySelectorAll('.batch-result-item');
            let targetStatementElement = null;
            
            // éå†æ‰¾åˆ°å¯¹åº”è¯­å¥çš„å…ƒç´ 
            for (let element of statementElements) {
                const header = element.querySelector('h5');
                if (header && header.textContent.includes(`ç¬¬ ${statementIndex} æ¡è¯­å¥`)) {
                    targetStatementElement = element;
                    break;
                }
            }
            
            if (!targetStatementElement) return;
            
            // æ›´æ–°è¡¨æ ¼å†…å®¹
            const tableContainer = targetStatementElement.querySelector('.table-responsive');
            if (tableContainer) {
                let tableHtml = `<div class="table-responsive"><table class="table table-striped table-hover">
                    <thead><tr>`;
                newData.columns.forEach(col => {
                    tableHtml += `<th>${col}</th>`;
                });
                tableHtml += `</tr></thead><tbody>`;
                
                newData.results.forEach(row => {
                    tableHtml += `<tr>`;
                    row.forEach(cell => {
                        // å¤„ç†ç©ºå€¼
                        const cellValue = cell === null ? '' : cell;
                        tableHtml += `<td>${cellValue}</td>`;
                    });
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody></table></div>`;
                
                tableContainer.outerHTML = tableHtml;
            }
            
            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            const statusDiv = targetStatementElement.querySelector('.alert.alert-info');
            if (statusDiv) {
                statusDiv.innerHTML = `æ€»è®°å½•æ•°ï¼š${newData.total_count} | å½“å‰é¡µï¼š${newData.page}/${newData.total_page}`;
            }
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updateIndividualPaginationControls(statementIndex, newData);
        }
        
        /**
         * æ›´æ–°ç‰¹å®šè¯­å¥çš„åˆ†é¡µæ§ä»¶
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {Object} data - åˆ†é¡µæ•°æ®
         */
        function updateIndividualPaginationControls(statementIndex, data) {
            const paginationContainer = document.querySelector(`.individual-pagination[data-statement-index="${statementIndex}"] .individual-page-numbers`);
            if (!paginationContainer) return;
            
            // é‡å»ºåˆ†é¡µæŒ‰é’®
            paginationContainer.innerHTML = '';
            
            let startPage = 1;
            let endPage = data.total_page;
            
            if (data.total_page > 10) {
                startPage = Math.max(1, data.page - 3);
                endPage = Math.min(data.total_page, data.page + 3);
                
                // ç¡®ä¿æ˜¾ç¤º10ä¸ªé¡µç 
                if (endPage - startPage < 9) {
                    if (startPage === 1) {
                        endPage = 10;
                    } else if (endPage === data.total_page) {
                        startPage = data.total_page - 9;
                    }
                }
            }
            
            // æ·»åŠ é¦–é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = `page-btn ${1 === data.page ? 'active' : ''}`;
                firstPageBtn.textContent = '1';
                firstPageBtn.onclick = () => handleIndividualPageClick(statementIndex, 1);
                paginationContainer.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'page-btn disabled';
                    ellipsis.textContent = '...';
                    paginationContainer.appendChild(ellipsis);
                }
            }
            
            // æ·»åŠ ä¸­é—´é¡µç 
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === data.page ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => handleIndividualPageClick(statementIndex, i);
                paginationContainer.appendChild(pageBtn);
            }
            
            // æ·»åŠ å°¾é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (endPage < data.total_page) {
                if (endPage < data.total_page - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'page-btn disabled';
                    ellipsis.textContent = '...';
                    paginationContainer.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = `page-btn ${data.total_page === data.page ? 'active' : ''}`;
                lastPageBtn.textContent = data.total_page;
                lastPageBtn.onclick = () => handleIndividualPageClick(statementIndex, data.total_page);
                paginationContainer.appendChild(lastPageBtn);
            }
            
            // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
            const prevBtn = document.querySelector(`.individual-pagination[data-statement-index="${statementIndex}"] .page-btn[onclick*="handleIndividualPageChange\\(${statementIndex}, -1\\)"]`);
            const nextBtn = document.querySelector(`.individual-pagination[data-statement-index="${statementIndex}"] .page-btn[onclick*="handleIndividualPageChange\\(${statementIndex}, 1\\)"]`);
            
            if (prevBtn) {
                prevBtn.disabled = data.page <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = data.page >= data.total_page;
            }
            
            // æ›´æ–°è·³è½¬è¾“å…¥æ¡†
            const jumpInput = document.querySelector(`.individual-jump-input[data-statement="${statementIndex}"]`);
            if (jumpInput) {
                jumpInput.max = data.total_page;
                jumpInput.value = data.page;
            }
            
            // æ›´æ–°æ€»é¡µæ•°æ˜¾ç¤º
            const pageSpan = document.querySelector(`.individual-pagination[data-statement-index="${statementIndex}"] .pagination-container span:last-child`);
            if (pageSpan && pageSpan.textContent.includes('å…±')) {
                pageSpan.textContent = `å…± ${data.total_page} é¡µ`;
            }
        }
        
        /**
         * å¤„ç†ç‹¬ç«‹åˆ†é¡µçš„ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {number} direction - æ–¹å‘ï¼š-1 ä¸Šä¸€é¡µï¼Œ1 ä¸‹ä¸€é¡µ
         */
        function handleIndividualPageChange(statementIndex, direction) {
            const newPage = getCurrentStatementPage(statementIndex) + direction;
            const resultData = window.currentBatchResults ? window.currentBatchResults.find(r => r.statement_index === statementIndex) : null;
            
            if (!resultData || !resultData.total_page) return;
            
            if (newPage < 1 || newPage > resultData.total_page) return;
            
            // æ›´æ–°å½“å‰è¯­å¥çš„é¡µç 
            updateStatementPage(statementIndex, newPage);
            // æ‰§è¡Œç‹¬ç«‹è¯­å¥çš„åˆ†é¡µæŸ¥è¯¢
            executeIndividualSqlPage(resultData.original_sql, statementIndex, newPage);
        }
        
        /**
         * å¤„ç†ç‹¬ç«‹åˆ†é¡µçš„é¡µç ç‚¹å‡»
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {number} pageNum - ç›®æ ‡é¡µç 
         */
        function handleIndividualPageClick(statementIndex, pageNum) {
            const resultData = window.currentBatchResults ? window.currentBatchResults.find(r => r.statement_index === statementIndex) : null;
            
            if (!resultData || !resultData.total_page) return;
            if (pageNum === getCurrentStatementPage(statementIndex) || pageNum < 1 || pageNum > resultData.total_page) return;
            
            // æ›´æ–°å½“å‰è¯­å¥çš„é¡µç 
            updateStatementPage(statementIndex, pageNum);
            // æ‰§è¡Œç‹¬ç«‹è¯­å¥çš„åˆ†é¡µæŸ¥è¯¢
            executeIndividualSqlPage(resultData.original_sql, statementIndex, pageNum);
        }
        
        /**
         * å¤„ç†ç‹¬ç«‹åˆ†é¡µçš„è·³è½¬
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         */
        function handleIndividualJumpPage(statementIndex) {
            const jumpInputs = document.querySelectorAll(`.individual-jump-input[data-statement="${statementIndex}"]`);
            if (!jumpInputs.length) return;
            
            const jumpInput = jumpInputs[0];
            let targetPage = parseInt(jumpInput.value);
            const resultData = window.currentBatchResults ? window.currentBatchResults.find(r => r.statement_index === statementIndex) : null;
            
            if (!resultData || !resultData.total_page) return;
            
            if (isNaN(targetPage)) targetPage = getCurrentStatementPage(statementIndex);
            targetPage = Math.max(1, Math.min(targetPage, resultData.total_page));
            
            if (targetPage !== getCurrentStatementPage(statementIndex)) {
                // æ›´æ–°å½“å‰è¯­å¥çš„é¡µç 
                updateStatementPage(statementIndex, targetPage);
                // æ‰§è¡Œç‹¬ç«‹è¯­å¥çš„åˆ†é¡µæŸ¥è¯¢
                executeIndividualSqlPage(resultData.original_sql, statementIndex, targetPage);
            }
            
            jumpInput.value = getCurrentStatementPage(statementIndex);
        }
        
        /**
         * è·å–å½“å‰è¯­å¥çš„é¡µç 
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @returns {number} å½“å‰é¡µç 
         */
        function getCurrentStatementPage(statementIndex) {
            // ä»å…¨å±€å˜é‡æˆ–DOMä¸­è·å–å½“å‰è¯­å¥çš„é¡µç 
            if (!window.statementPages) {
                window.statementPages = {};
            }
            return window.statementPages[statementIndex] || 1;
        }
        
        /**
         * æ›´æ–°è¯­å¥çš„é¡µç 
         * @param {number} statementIndex - è¯­å¥ç´¢å¼•
         * @param {number} page - æ–°é¡µç 
         */
        function updateStatementPage(statementIndex, page) {
            if (!window.statementPages) {
                window.statementPages = {};
            }
            window.statementPages[statementIndex] = page;
        }

        // ===================== SQLæ“ä½œç›¸å…³ =====================
        /**
         * å¤åˆ¶å¸¸ç”¨SQLåˆ°è¾“å…¥æ¡†
         * @param {HTMLElement} element - ç‚¹å‡»çš„SQLå…ƒç´ 
         */
        function copyToSqlInput(element) {
            const sqlInput = document.getElementById('sqlInput');
            if (!sqlInput || !element) return;
            
            const dataSql = element.dataset.sql;
            const sqlText = dataSql ? dataSql.trim() : element.textContent.trim();
            // å¦‚æœæ˜¯æ³¨é‡Šè¡Œï¼Œè‡ªåŠ¨æ¢è¡Œæ·»åŠ ç¤ºä¾‹
            if (sqlText.startsWith('--')) {
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = sqlText + '\n';
                    updateSqlHighlight(); // æ‰‹åŠ¨è§¦å‘è¯­æ³•é«˜äº®
                } else {
                    sqlInput.value = sqlText + '\n';
                }
            } else {
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = sqlText;
                    updateSqlHighlight(); // æ‰‹åŠ¨è§¦å‘è¯­æ³•é«˜äº®
                } else {
                    sqlInput.value = sqlText;
                }
            }
            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦å¹¶è§¦å‘å®‰å…¨æ ¡éªŒ
            handleSqlInput();
            // èšç„¦è¾“å…¥æ¡†
            sqlInput.focus();
        }

        /**
         * æ¸…ç©ºSQLè¾“å…¥æ¡†
         */
        function clearSqlInput() {
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = '';
                    updateSqlHighlight(); // æ‰‹åŠ¨è§¦å‘è¯­æ³•é«˜äº®
                } else {
                    sqlInput.value = '';
                }
                checkSqlSafety();
                autoResizeTextarea(sqlInput);
                updateSqlHighlight(); // æ›´æ–°è¯­æ³•é«˜äº®
            }
            // éšè—ç»“æœåŒºåŸŸå’Œå¯¼å‡ºæŒ‰é’®è¡Œ
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('exportButtonRow').style.display = 'none';
            document.getElementById('exportExcelBtn').style.display = 'none';
            document.getElementById('exportCsvBtn').style.display = 'none';
            document.getElementById('exportHtmlBtn').style.display = 'none';
            currentQueryId = '';
        }

        /**
         * æ˜¾ç¤ºæ‰§è¡Œç¡®è®¤æ¨¡æ€æ¡†
         */
        function showExecuteConfirm() {
            const sqlInput = document.getElementById('sqlInput');
            const sqlText = (sqlInput.value || sqlInput.textContent || sqlInput.innerText).trim();
            
            if (!sqlText) {
                showAlertModal('æç¤º', 'è¯·è¾“å…¥SQLæŸ¥è¯¢è¯­å¥ï¼', 'warning');
                return;
            }
            
            // å‰ç«¯å®‰å…¨æ ¡éªŒ
            if (!checkSqlSafety()) {
                dangerSqlModal.show();
                return;
            }
            
            // æ˜¾ç¤ºSQLé¢„è§ˆ
            document.getElementById('sqlPreview').textContent = sqlText;
            currentSql = sqlText;
            executeConfirmModal.show();
        }

        /**
         * ç¡®è®¤æ‰§è¡ŒSQL
         */
        function confirmExecuteSql() {
            if (isExecuting) return;
            if (!currentSql) return;
            
            // éšè—æ¨¡æ€æ¡†
            executeConfirmModal.hide();
            // é‡ç½®åˆ†é¡µ
            currentPage = 1;
            // è·å–æ¯é¡µæ¡æ•°
            pageSize = parseInt(document.getElementById('pageSize').value) || 50;
            // æ‰§è¡ŒæŸ¥è¯¢
            executeSqlQuery();
        }

        /**
         * æ‰§è¡ŒSQLæŸ¥è¯¢ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
         */
        function executeSqlQuery(specificSql = null, statementIndex = null) {
            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥åˆ°æ•°æ®åº“
            if (!window.currentConnectedDbId || !currentSelectedDbId) {
                showAlertModal('æç¤º', 'è¯·å…ˆè¿æ¥åˆ°æ•°æ®åº“åå†æ‰§è¡ŒSQLæŸ¥è¯¢ï¼', 'warning');
                isExecuting = false;
                return;
            }
            
            if (isExecuting) return;
            isExecuting = true;
            
            // è®°å½•æ˜¯å¦æ˜¯ç‹¬ç«‹è¯­å¥æ‰§è¡Œï¼ˆåˆ†é¡µæ“ä½œï¼‰
            const isIndividualExecution = (specificSql !== null && statementIndex !== null);
            
            // è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“ID
            const dbId = currentSelectedDbId || null;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const executeBtnText = document.getElementById('executeBtnText');
            if (executeBtnText) {
                executeBtnText.innerHTML = '<span class="loading-spinner"></span> æ‰§è¡Œä¸­...';
            }
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            const resultArea = document.getElementById('resultArea');
            resultArea.style.display = 'block';
            resultArea.scrollIntoView({ behavior: 'smooth' });
            
            // æ„å»ºè¯·æ±‚å‚æ•°
            const formData = new FormData();
            // å¦‚æœæŒ‡å®šäº†ç‰¹å®šçš„SQLè¯­å¥ï¼ˆå¦‚åœ¨åˆ†é¡µæ—¶ï¼‰ï¼Œåˆ™ä½¿ç”¨è¯¥SQLï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€çš„currentSql
            const sqlToExecute = specificSql || currentSql;
            formData.append('sql', sqlToExecute);
            
            // å¦‚æœæ˜¯é’ˆå¯¹ç‰¹å®šè¯­å¥çš„åˆ†é¡µè¯·æ±‚ï¼Œä½¿ç”¨è¯¥è¯­å¥çš„é¡µç 
            let targetPage = currentPage;
            if (statementIndex !== null && window.statementPages && window.statementPages[statementIndex]) {
                targetPage = window.statementPages[statementIndex];
            }
            
            formData.append('page', targetPage);
            formData.append('page_size', pageSize);
            if (dbId) {
                formData.append('db_id', dbId);
            }
            
            // æ·»åŠ æ ‡è®°ï¼ŒæŒ‡ç¤ºæ˜¯å¦æ˜¯ç‹¬ç«‹æ‰§è¡Œ
            if (isIndividualExecution) {
                formData.append('individual_execution', 'true');
                formData.append('statement_index', statementIndex);
            }
            
            // å‘é€è¯·æ±‚
            const headers = {};
            const sessionToken = localStorage.getItem('app_session_token');
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }
            
            fetch('/execute_sql', {
                method: 'POST',
                headers: headers,
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š${res.status}`);
                return res.json();
            })
            .then(data => {
                const statusMessage = document.getElementById('statusMessage');
                const resultTable = document.getElementById('resultTable');
                const paginationArea = document.getElementById('paginationArea');
                
                if (data.status === 'success') {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ‰¹é‡æ‰§è¡Œç»“æœ
                    if (data.is_batch && data.results) {
                        // æ‰¹é‡æ‰§è¡Œç»“æœ
                        statusMessage.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        
                        // ä¿å­˜æ‰¹é‡æ‰§è¡Œç»“æœï¼Œä»¥ä¾¿åˆ†é¡µå‡½æ•°å¯ä»¥è®¿é—®
                        window.currentBatchResults = data.results;
                        
                        // æ¸²æŸ“æ‰¹é‡æ‰§è¡Œç»“æœ
                        let batchResultsHtml = '<div class="batch-results-container">' +
                            data.results.map((result, index) => {
                                let resultHtml = '<div class="batch-result-item mb-4 p-3 border rounded">' +
                                    `<h5 class="mb-3">ç¬¬ ${result.statement_index} æ¡è¯­å¥: <code>${result.original_sql}</code></h5>`;
                                                        
                                if (result.columns && result.results) {
                                    // æœ‰æŸ¥è¯¢ç»“æœ
                                    resultHtml += `<div class="alert alert-info">æ€»è®°å½•æ•°ï¼š${result.total_count} | å½“å‰é¡µï¼š${result.page}/${result.total_page}</div>`;
                                                            
                                    // ä¸ºæ¯ä¸ªç»“æœæ·»åŠ å•ç‹¬çš„å¯¼å‡ºæŒ‰é’®ï¼ˆæ”¾åœ¨ç»“æœä¸Šæ–¹ï¼‰
                                    resultHtml += `<div class="mt-2 mb-3">`;
                                    resultHtml += `<button class="btn btn-sm btn-export-excel me-2" onclick="exportSingleResult('${result.query_id}', 'excel', 'SQL_${result.statement_index}_')">å¯¼å‡ºExcel</button>`;
                                    resultHtml += `<button class="btn btn-sm btn-export-csv me-2" onclick="exportSingleResult('${result.query_id}', 'csv', 'SQL_${result.statement_index}_')">å¯¼å‡ºCSV</button>`;
                                    resultHtml += `<button class="btn btn-sm btn-export-html me-2" onclick="exportSingleResult('${result.query_id}', 'html', 'SQL_${result.statement_index}_')">å¯¼å‡ºHTML</button>`;
                                    resultHtml += `</div>`;
                                                            
                                    // ä¸ºæ¯ä¸ªç»“æœæ·»åŠ ç‹¬ç«‹çš„åˆ†é¡µæ§ä»¶ï¼ˆæ”¾åœ¨è¡¨æ ¼ä¸Šæ–¹ï¼‰
                                    if (result.total_page && result.total_page > 1) {
                                        // åˆ›å»ºç‹¬ç«‹çš„åˆ†é¡µæ§ä»¶HTMLï¼Œä½¿ç”¨å”¯ä¸€çš„ID
                                        resultHtml += `
                                        <div class="pagination-area mt-3 individual-pagination" data-statement-index="${result.statement_index}">
                                            <div class="pagination-container">
                                                <button class="page-btn" onclick="handleIndividualPageChange(${result.statement_index}, -1)" ${result.page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                                                <div class="individual-page-numbers" id="individualPageNumbers_${result.statement_index}">`;
                                                                
                                        // è®¡ç®—é¡µç æ˜¾ç¤º
                                        let startPage = 1;
                                        let endPage = result.total_page;
                                                                
                                        if (result.total_page > 10) {
                                            startPage = Math.max(1, result.page - 3);
                                            endPage = Math.min(result.total_page, result.page + 3);
                                                                    
                                            // ç¡®ä¿æ˜¾ç¤º10ä¸ªé¡µç 
                                            if (endPage - startPage < 9) {
                                                if (startPage === 1) {
                                                    endPage = 10;
                                                } else if (endPage === result.total_page) {
                                                    startPage = result.total_page - 9;
                                                }
                                            }
                                        }
                                                                
                                        // æ·»åŠ é¦–é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
                                        if (startPage > 1) {
                                            resultHtml += `<button class="page-btn ${1 === result.page ? 'active' : ''}" onclick="handleIndividualPageClick(${result.statement_index}, 1)">1</button>`;
                                            if (startPage > 2) {
                                                resultHtml += `<span class="page-btn disabled">...</span>`;
                                            }
                                        }
                                                                
                                        // æ·»åŠ ä¸­é—´é¡µç 
                                        for (let i = startPage; i <= endPage; i++) {
                                            resultHtml += `<button class="page-btn ${i === result.page ? 'active' : ''}" onclick="handleIndividualPageClick(${result.statement_index}, ${i})">${i}</button>`;
                                        }
                                                                
                                        // æ·»åŠ å°¾é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
                                        if (endPage < result.total_page) {
                                            if (endPage < result.total_page - 1) {
                                                resultHtml += `<span class="page-btn disabled">...</span>`;
                                            }
                                            resultHtml += `<button class="page-btn ${result.total_page === result.page ? 'active' : ''}" onclick="handleIndividualPageClick(${result.statement_index}, ${result.total_page})">${result.total_page}</button>`;
                                        }
                                                                
                                        resultHtml += `
                                                </div>
                                                <button class="page-btn" onclick="handleIndividualPageChange(${result.statement_index}, 1)" ${result.page >= result.total_page ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                                                <div class="page-jump">
                                                    <span>è·³è‡³</span>
                                                    <input type="number" class="individual-jump-input" data-statement="${result.statement_index}" min="1" max="${result.total_page}" value="${result.page}" style="width: 60px;">
                                                    <span>é¡µ</span>
                                                    <button onclick="handleIndividualJumpPage(${result.statement_index})">ç¡®å®š</button>
                                                </div>
                                                <span class="mx-2">å…± ${result.total_page} é¡µ</span>
                                            </div>
                                        </div>`;
                                    }
                                                            
                                    // æ¸²æŸ“è¡¨æ ¼
                                    resultHtml += `<div class="table-responsive"><table class="table table-striped table-hover">`;
                                    resultHtml += '<thead><tr>';
                                    result.columns.forEach(col => {
                                        resultHtml += `<th>${col}</th>`;
                                    });
                                    resultHtml += '</tr></thead><tbody>';
                                                            
                                    result.results.forEach(row => {
                                        resultHtml += '<tr>';
                                        row.forEach(cell => {
                                            // å¤„ç†ç©ºå€¼
                                            const cellValue = cell === null ? '' : cell;
                                            resultHtml += `<td>${cellValue}</td>`;
                                        });
                                        resultHtml += '</tr>';
                                    });
                                    resultHtml += '</tbody></table></div>';
                                } else {
                                    // æ— æŸ¥è¯¢ç»“æœï¼ˆå¦‚INSERT/UPDATE/DELETEç­‰ï¼‰
                                    resultHtml += `<div class="alert alert-secondary">${result.message || 'æ‰§è¡ŒæˆåŠŸ'}</div>`;
                                }
                                                        
                                resultHtml += '</div>';
                                return resultHtml;
                            }).join('') +
                            '</div>';
                        
                        resultTable.innerHTML = batchResultsHtml;
                        resultTable.style.display = 'block';
                        
                        // å¯¹äºæ‰¹é‡æ‰§è¡Œï¼Œç›®å‰åˆ†é¡µåŠŸèƒ½çš„å¤„ç†é€»è¾‘ï¼š
                        // 1. å¦‚æœæ‰€æœ‰è¯­å¥éƒ½æ²¡æœ‰æŸ¥è¯¢ç»“æœï¼ˆå³éƒ½æ˜¯INSERT/UPDATE/DELETEç­‰ï¼‰ï¼Œåˆ™éšè—åˆ†é¡µ
                        // 2. å¦‚æœæœ‰ä»»ä½•è¯­å¥æœ‰æŸ¥è¯¢ç»“æœï¼Œåˆ†é¡µåŠŸèƒ½ä¿ç•™ï¼Œä½†å½“å‰çš„å‰ç«¯æ¶æ„åªæ”¯æŒå•ä¸€ç»“æœé›†çš„åˆ†é¡µ
                        // å› æ­¤ï¼Œå¦‚æœå­˜åœ¨éœ€è¦åˆ†é¡µçš„æŸ¥è¯¢ç»“æœï¼Œæˆ‘ä»¬æ˜¾ç¤ºåˆ†é¡µï¼Œä½†å®é™…åˆ†é¡µæ“ä½œå¯èƒ½éœ€è¦é‡æ–°æ‰§è¡Œå¯¹åº”çš„SQL
                        let hasPaginatedResults = false;
                        if (data.results) {
                            for (let result of data.results) {
                                if (result.columns && result.results && result.total_page && result.total_page > 1) {
                                    hasPaginatedResults = true;
                                    break;
                                }
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰éœ€è¦åˆ†é¡µçš„æ•°æ®ï¼Œåˆ™éšè—åˆ†é¡µ
                        if (!hasPaginatedResults) {
                            paginationArea.style.display = 'none';
                        } else {
                            // å¯¹äºæ‰¹é‡æ‰§è¡Œï¼Œéšè—ä¸»åˆ†é¡µæ§ä»¶ï¼Œå› ä¸ºæ¯æ¡è¯­å¥æœ‰è‡ªå·±çš„ç‹¬ç«‹åˆ†é¡µ
                            paginationArea.style.display = 'none';
                                                    
                            // ä¸éœ€è¦è®¾ç½®ä¸»åˆ†é¡µå‚æ•°ï¼Œå› ä¸ºæ¯æ¡è¯­å¥ä½¿ç”¨è‡ªå·±çš„åˆ†é¡µæ§ä»¶
                        }
                        
                        // å¯¹äºæ‰¹é‡æ‰§è¡Œï¼Œè®¾ç½®å…¨å±€currentQueryIdä¸ºç¬¬ä¸€ä¸ªæœ‰ç»“æœçš„æŸ¥è¯¢IDï¼Œä»¥ä¾¿åº•éƒ¨çš„å¯¼å‡ºæŒ‰é’®èƒ½å·¥ä½œ
                        // ä¼˜å…ˆé€‰æ‹©æœ‰æ•°æ®ç»“æœçš„æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€‰æ‹©ä»»æ„ä¸€ä¸ªæœ‰query_idçš„
                        const firstResultWithColumns = data.results.find(r => r.columns && r.results && r.query_id);
                        const firstResultWithQueryId = data.results.find(r => r.query_id);
                        
                        if (firstResultWithColumns) {
                            // ä¼˜å…ˆä½¿ç”¨æœ‰æ•°æ®çš„ç¬¬ä¸€ä¸ªç»“æœ
                            currentQueryId = firstResultWithColumns.query_id;
                            console.log('æ‰¹é‡æ‰§è¡Œï¼šè®¾ç½®currentQueryIdä¸º', currentQueryId);
                            
                            // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®è¡Œ - ä¸å•æ¡è¯­å¥æ‰§è¡Œç›¸åŒçš„é€»è¾‘
                            document.getElementById('exportButtonRow').style.display = 'flex';
                            document.getElementById('exportExcelBtn').style.display = 'inline-block';
                            document.getElementById('exportCsvBtn').style.display = 'inline-block';
                            document.getElementById('exportHtmlBtn').style.display = 'inline-block';
                        } else if (firstResultWithQueryId) {
                            // å¦‚æœæ²¡æœ‰æœ‰æ•°æ®çš„ç»“æœï¼Œä½†æœ‰query_idï¼Œåˆ™ä»å…è®¸å¯¼å‡ºï¼ˆå¯èƒ½å¯¼å‡ºç©ºç»“æœï¼‰
                            currentQueryId = firstResultWithQueryId.query_id;
                            console.log('æ‰¹é‡æ‰§è¡Œï¼šè®¾ç½®currentQueryIdä¸º', currentQueryId, '(æ¥è‡ªæ— æ•°æ®ä½†æœ‰IDçš„ç»“æœ)');
                            
                            // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®è¡Œ - ä¸å•æ¡è¯­å¥æ‰§è¡Œç›¸åŒçš„é€»è¾‘
                            document.getElementById('exportButtonRow').style.display = 'flex';
                            document.getElementById('exportExcelBtn').style.display = 'inline-block';
                            document.getElementById('exportCsvBtn').style.display = 'inline-block';
                            document.getElementById('exportHtmlBtn').style.display = 'inline-block';
                        } else {
                            // å¦‚æœæ²¡æœ‰ä»»ä½•ç»“æœæœ‰query_idï¼Œåˆ™éšè—å¯¼å‡ºæŒ‰é’®
                            currentQueryId = null;
                            console.log('æ‰¹é‡æ‰§è¡Œï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•query_idï¼Œéšè—å¯¼å‡ºæŒ‰é’®');
                            
                            // éšè—å¯¼å‡ºæŒ‰é’® - ä¸å•æ¡è¯­å¥æ‰§è¡Œç›¸åŒçš„é€»è¾‘
                            document.getElementById('exportExcelBtn').style.display = 'none';
                            document.getElementById('exportCsvBtn').style.display = 'none';
                            document.getElementById('exportHtmlBtn').style.display = 'none';
                        }
                        
                        // é¢å¤–éªŒè¯
                        console.log('æ‰¹é‡æ‰§è¡Œç»“æŸï¼šcurrentQueryIdæœ€ç»ˆå€¼ä¸º', currentQueryId);
                        console.log('æ‰¹é‡æ‰§è¡Œç»“æŸï¼šå¯¼å‡ºæŒ‰é’®çŠ¶æ€æ£€æŸ¥ - Excel:', document.getElementById('exportExcelBtn').style.display, 
                                   'CSV:', document.getElementById('exportCsvBtn').style.display,
                                   'HTML:', document.getElementById('exportHtmlBtn').style.display);
                    } else if (data.columns && data.results) {
                        // å•ä¸ªæŸ¥è¯¢ç»“æœ
                        statusMessage.innerHTML = `<div class="alert alert-success">æŸ¥è¯¢æˆåŠŸï¼æ€»è®°å½•æ•°ï¼š${data.total_count} | å½“å‰é¡µï¼š${data.page}/${data.total_page}</div>`;
                        
                        // åˆ›å»ºåŒ…å«åˆ†é¡µæ§ä»¶å’Œè¡¨æ ¼çš„å®Œæ•´HTML
                        let resultHtml = '';
                        
                        // æ·»åŠ åˆ†é¡µæ§ä»¶ï¼ˆåœ¨è¡¨æ ¼ä¸Šæ–¹ï¼‰
                        if (data.total_page > 1) {
                            resultHtml += `
                            <div class="pagination-area mt-3">
                                <div class="pagination-container">
                                    <button class="page-btn" onclick="handlePageChange(-1)" ${(data.page <= 1) ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                                    <div id="pageNumberContainer">`;
                            
                            // è®¡ç®—é¡µç æ˜¾ç¤º
                            let startPage = 1;
                            let endPage = data.total_page;
                            
                            if (data.total_page > 10) {
                                startPage = Math.max(1, data.page - 3);
                                endPage = Math.min(data.total_page, data.page + 3);
                                
                                // ç¡®ä¿æ˜¾ç¤º10ä¸ªé¡µç 
                                if (endPage - startPage < 9) {
                                    if (startPage === 1) {
                                        endPage = 10;
                                    } else if (endPage === data.total_page) {
                                        startPage = data.total_page - 9;
                                    }
                                }
                            }
                            
                            // æ·»åŠ é¦–é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
                            if (startPage > 1) {
                                resultHtml += `<button class="page-btn ${(1 === data.page) ? 'active' : ''}" onclick="handlePageClick(1)">1</button>`;
                                if (startPage > 2) {
                                    resultHtml += `<span class="page-btn disabled">...</span>`;
                                }
                            }
                            
                            // æ·»åŠ ä¸­é—´é¡µç 
                            for (let i = startPage; i <= endPage; i++) {
                                resultHtml += `<button class="page-btn ${(i === data.page) ? 'active' : ''}" onclick="handlePageClick(${i})">${i}</button>`;
                            }
                            
                            // æ·»åŠ å°¾é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
                            if (endPage < data.total_page) {
                                if (endPage < data.total_page - 1) {
                                    resultHtml += `<span class="page-btn disabled">...</span>`;
                                }
                                resultHtml += `<button class="page-btn ${(data.total_page === data.page) ? 'active' : ''}" onclick="handlePageClick(${data.total_page})">${data.total_page}</button>`;
                            }
                            
                            resultHtml += `
                                    </div>
                                    <button class="page-btn" onclick="handlePageChange(1)" ${(data.page >= data.total_page) ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                                    <div class="page-jump">
                                        <span>è·³è‡³</span>
                                        <input type="number" id="jumpPageInput" min="1" max="${data.total_page}" value="${data.page}" style="width: 60px;">
                                        <span>é¡µ</span>
                                        <button onclick="handleJumpPage()">ç¡®å®š</button>
                                    </div>
                                    <span class="mx-2">å…± ${data.total_page} é¡µ</span>
                                </div>
                            </div>`;
                        }
                        
                        // æ¸²æŸ“è¡¨æ ¼
                        resultHtml += `<div class="table-responsive"><table class="table table-striped table-hover">
                            <thead><tr>`;
                        data.columns.forEach(col => {
                            resultHtml += `<th>${col}</th>`;
                        });
                        resultHtml += `</tr></thead><tbody>`;
                        
                        data.results.forEach(row => {
                            resultHtml += `<tr>`;
                            row.forEach(cell => {
                                // å¤„ç†ç©ºå€¼
                                const cellValue = cell === null ? '' : cell;
                                resultHtml += `<td>${cellValue}</td>`;
                            });
                            resultHtml += `</tr>`;
                        });
                        resultHtml += `</tbody></table></div>`;
                        
                        resultTable.innerHTML = resultHtml;
                        resultTable.style.display = 'block';
                        
                        // æ›´æ–°å…¨å±€åˆ†é¡µå˜é‡
                        totalPage = data.total_page;
                        currentPage = data.page;
                        
                        // éšè—åº•éƒ¨åˆ†é¡µåŒºåŸŸï¼ˆå› ä¸ºåˆ†é¡µæ§ä»¶å·²åœ¨è¡¨æ ¼ä¸Šæ–¹ç”Ÿæˆï¼‰
                        paginationArea.style.display = 'none';
                        
                        // ä¿å­˜æŸ¥è¯¢IDï¼Œæ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®è¡Œ
                        currentQueryId = data.query_id;
                        document.getElementById('exportButtonRow').style.display = 'flex';
                        document.getElementById('exportExcelBtn').style.display = 'inline-block';
                        document.getElementById('exportCsvBtn').style.display = 'inline-block';
                        document.getElementById('exportHtmlBtn').style.display = 'inline-block';
                    } else {
                        // æ— æŸ¥è¯¢ç»“æœï¼ˆå¦‚æ‰§è¡ŒEXPLAINï¼‰
                        statusMessage.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        resultTable.style.display = 'none';
                        paginationArea.style.display = 'none';
                        document.getElementById('exportButtonRow').style.display = 'none';
                        document.getElementById('exportExcelBtn').style.display = 'none';
                        document.getElementById('exportCsvBtn').style.display = 'none';
                        document.getElementById('exportHtmlBtn').style.display = 'none';
                    }
                } else {
                    statusMessage.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    resultTable.style.display = 'none';
                    paginationArea.style.display = 'none';
                    document.getElementById('exportButtonRow').style.display = 'none';
                    document.getElementById('exportExcelBtn').style.display = 'none';
                    document.getElementById('exportCsvBtn').style.display = 'none';
                    document.getElementById('exportHtmlBtn').style.display = 'none';
                }
            })
            .catch(error => {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
                document.getElementById('resultTable').style.display = 'none';
                document.getElementById('paginationArea').style.display = 'none';
                document.getElementById('exportButtonRow').style.display = 'none';
                document.getElementById('exportExcelBtn').style.display = 'none';
                document.getElementById('exportCsvBtn').style.display = 'none';
                document.getElementById('exportHtmlBtn').style.display = 'none';
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                isExecuting = false;
                const executeBtnText = document.getElementById('executeBtnText');
                if (executeBtnText) {
                    executeBtnText.textContent = 'æ‰§è¡ŒæŸ¥è¯¢';
                }
            });
        }

        /**
         * åˆ†æSQLæŸ¥è¯¢è®¡åˆ’
         */
        function analyzeQueryPlan() {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥åˆ°æ•°æ®åº“
                if (!window.currentConnectedDbId || !currentSelectedDbId) {
                    showAlertModal('æç¤º', 'è¯·å…ˆè¿æ¥åˆ°æ•°æ®åº“åå†åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼', 'warning');
                    return;
                }

                // è·å–SQLè¯­å¥
                const sqlInput = document.getElementById('sqlInput');
                const sql = (sqlInput.value || sqlInput.textContent || sqlInput.innerText).trim();

                if (!sql) {
                    showAlertModal('æç¤º', 'è¯·è¾“å…¥è¦åˆ†æçš„SQLè¯­å¥ï¼', 'warning');
                    return;
                }

                // æ”¹è¿›çš„SELECTè¯­å¥æ£€æŸ¥ - ç§»é™¤æ³¨é‡ŠåéªŒè¯
                const cleanSql = sql.replace(/\/\*.*?\*\//g, '').replace(/--.*?$/gm, '').trim();
                const cleanSqlUpper = cleanSql.toUpperCase();
                
                const isSelectQuery = (
                    cleanSqlUpper.startsWith('SELECT') || 
                    cleanSqlUpper.startsWith('EXPLAIN') ||
                    (cleanSqlUpper.startsWith('WITH') && cleanSqlUpper.includes('SELECT'))
                );
                
                if (!isSelectQuery) {
                    showAlertModal('æç¤º', 'æŸ¥è¯¢è®¡åˆ’åˆ†æä»…æ”¯æŒSELECT/EXPLAIN/WITHæŸ¥è¯¢è¯­å¥ï¼', 'warning');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const analyzeBtn = document.querySelector('button[onclick="analyzeQueryPlan()"]');
                const originalText = analyzeBtn.innerHTML;
                analyzeBtn.innerHTML = '<span class="loading-spinner"></span> åˆ†æä¸­...';
                analyzeBtn.disabled = true;
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼Œä¸æ‰§è¡ŒSQLä¿æŒä¸€è‡´
                const resultArea = document.getElementById('resultArea');
                const statusMessage = document.getElementById('statusMessage');
                const resultTable = document.getElementById('resultTable');
                
                resultArea.style.display = 'block';
                resultArea.scrollIntoView({ behavior: 'smooth' });
                
                // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯ï¼Œä¸æ‰§è¡ŒSQLçš„æ ·å¼ä¿æŒä¸€è‡´
                statusMessage.innerHTML = `
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <div>
                            <strong>æ­£åœ¨åˆ†ææŸ¥è¯¢è®¡åˆ’...</strong><br>
                            <small class="text-muted">æ­£åœ¨è·å–æ•°æ®åº“æ‰§è¡Œè®¡åˆ’ï¼Œè¯·ç¨å€™</small>
                        </div>
                    </div>
                `;
                
                // éšè—ç»“æœè¡¨æ ¼ç›´åˆ°è·å–åˆ°æ•°æ®
                resultTable.style.display = 'none';
                
                // éšè—åˆ†é¡µåŒºåŸŸ
                document.getElementById('paginationArea').style.display = 'none';

            // å‡†å¤‡è¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('sql', sql);
            if (currentSelectedDbId) {
                formData.append('db_id', currentSelectedDbId);
            }

            // å‘é€è¯·æ±‚
            const headers = {};
            const sessionToken = localStorage.getItem('app_session_token');
            if (sessionToken) {
                headers['X-Session-Token'] = sessionToken;
            }

            // å‘é€è¯·æ±‚
            fetch('/analyze_query_plan', {
                method: 'POST',
                headers: headers,
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // æ˜¾ç¤ºæŸ¥è¯¢è®¡åˆ’ç»“æœ
                    displayQueryPlanResult(data);
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶æ¸…é™¤åŠ è½½çŠ¶æ€
                    statusMessage.innerHTML = `
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <span class="me-2">âŒ</span>
                            <div>
                                <strong>æŸ¥è¯¢è®¡åˆ’åˆ†æå¤±è´¥</strong><br>
                                <small class="text-muted">${data.message || 'æœªçŸ¥é”™è¯¯'}</small>
                            </div>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    resultTable.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('æŸ¥è¯¢è®¡åˆ’åˆ†æå¤±è´¥:', error);
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯å¹¶æ¸…é™¤åŠ è½½çŠ¶æ€
                statusMessage.innerHTML = `
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <span class="me-2">âŒ</span>
                        <div>
                            <strong>æŸ¥è¯¢è®¡åˆ’åˆ†æå¤±è´¥</strong><br>
                            <small class="text-muted">${error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥'}</small>
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                resultTable.style.display = 'none';
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            });
        } catch (error) {
            console.error('æŸ¥è¯¢è®¡åˆ’åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const analyzeBtn = document.querySelector('button[onclick="analyzeQueryPlan()"]');
            if (analyzeBtn) {
                const originalText = analyzeBtn.innerHTML.replace('<span class="loading-spinner"></span> åˆ†æä¸­...', 'åˆ†ææŸ¥è¯¢è®¡åˆ’');
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.innerHTML = `
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <span class="me-2">âŒ</span>
                        <div>
                            <strong>æŸ¥è¯¢è®¡åˆ’åˆ†æå¤±è´¥</strong><br>
                            <small class="text-muted">å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•</small>
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
            }
        }
        }

        /**
         * æ˜¾ç¤ºæŸ¥è¯¢è®¡åˆ’ç»“æœ
         * @param {Object} data - æŸ¥è¯¢è®¡åˆ’ç»“æœæ•°æ®
         */
        function displayQueryPlanResult(data) {
            const resultArea = document.getElementById('resultArea');
            const statusMessage = document.getElementById('statusMessage');
            const resultTable = document.getElementById('resultTable');

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultArea.style.display = 'block';

            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            statusMessage.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <strong>æŸ¥è¯¢è®¡åˆ’åˆ†æç»“æœ</strong> - æ•°æ®åº“ç±»å‹: ${data.db_type}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" 
                            onclick="this.parentElement.style.display='none';"></button>
                </div>
            `;

            // æ„å»ºè¡¨æ ¼å’Œå¯è§†åŒ–é€‰é¡¹
            if (data.data && data.data.length > 0) {
                // æ·»åŠ å¯è§†åŒ–åˆ‡æ¢æŒ‰é’®å’Œå¯¼å‡ºæŒ‰é’®
                let controlHtml = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>æ‰§è¡Œè®¡åˆ’åˆ†æ</h6>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="exportQueryPlan()">
                                <i class="fas fa-file-export me-1"></i>å¯¼å‡ºHTML
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="togglePlanView('table')">è¡¨æ ¼è§†å›¾</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="togglePlanView('visual')">å¯è§†åŒ–è§†å›¾</button>
                        </div>
                    </div>
                `;
                
                // é»˜è®¤æ˜¾ç¤ºè¡¨æ ¼è§†å›¾
                let tableHtml = '<div id="planTableView">';
                tableHtml += '<table class="table table-striped table-bordered table-hover"><thead><tr>';

                // æ·»åŠ åˆ—æ ‡é¢˜
                data.columns.forEach(col => {
                    // ä¸ºID/Stepåˆ—æ·»åŠ ç‰¹æ®Šçš„æ’åºæç¤º
                    if (col.toLowerCase().includes('id') || col.toLowerCase().includes('step') || col.toLowerCase().includes('seq')) {
                        tableHtml += `<th title="æ‰§è¡Œé¡ºåº">${escapeHtml(col)} â†—</th>`;
                    } else {
                        tableHtml += `<th>${escapeHtml(col)}</th>`;
                    }
                });

                tableHtml += '</tr></thead><tbody>';

                // æ·»åŠ æ•°æ®è¡Œï¼Œçªå‡ºæ˜¾ç¤ºæ‰§è¡Œé¡ºåº
                data.data.forEach((row, rowIndex) => {
                    // ä¸ºæ¯ä¸€è¡Œæ·»åŠ é¢œè‰²ç¼–ç ï¼Œä»¥ä¾¿æ›´å®¹æ˜“è·Ÿè¸ªæ‰§è¡Œé¡ºåº
                    const rowStyle = rowIndex % 2 === 0 ? '' : 'background-color: #f8f9fa;';
                    tableHtml += `<tr style="${rowStyle}">`;
                    
                    data.columns.forEach(col => {
                        // å¯¹äºIDæˆ–Stepåˆ—ï¼Œæ·»åŠ ç‰¹æ®Šçš„è§†è§‰æŒ‡ç¤º
                        let cellClass = '';
                        let cellStyle = '';
                        if (col.toLowerCase().includes('id') || col.toLowerCase().includes('step') || col.toLowerCase().includes('seq')) {
                            cellClass = 'fw-bold text-primary';
                            cellStyle = 'font-weight: bold; color: #0d6efd; background-color: #e7f1ff;';
                        }
                        
                        // å¯¹äºå¯èƒ½åŒ…å«å¤æ‚JSONçš„å¯¹è±¡ï¼Œæ ¼å¼åŒ–æ˜¾ç¤º
                        let cellValue = row[col];
                        if (typeof cellValue === 'object' && cellValue !== null) {
                            cellValue = JSON.stringify(cellValue, null, 2);
                        } else if (cellValue === null) {
                            cellValue = '<em>NULL</em>';
                        } else {
                            cellValue = escapeHtml(String(cellValue));
                        }
                        
                        tableHtml += `<td class="${cellClass}" style="${cellStyle}"><pre style="white-space: pre-wrap; word-break: break-word; margin: 0; font-size: 0.85em; background: none !important; border: none !important;">${cellValue}</pre></td>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                tableHtml += '</div>';

                // æ„å»ºå¯è§†åŒ–è§†å›¾
                let visualHtml = '<div id="planVisualView" style="display:none;">';
                visualHtml += '<div class="plan-visual-container" style="padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">';
                
                // ç®€å•çš„æµç¨‹å›¾å¯è§†åŒ–
                visualHtml += '<div class="plan-flow" style="display: flex; flex-direction: column; gap: 15px;">';
                
                data.data.forEach((row, index) => {
                    let stepId = '';
                    let operation = '';
                    
                    // ä¼˜å…ˆæŸ¥æ‰¾Stepåˆ—ï¼ˆå› ä¸ºæˆ‘ä»¬ç°åœ¨åœ¨åç«¯æ·»åŠ äº†Stepåˆ—ï¼‰
                    if (row.hasOwnProperty('Step')) {
                        stepId = row['Step'];
                    } else {
                        // å°è¯•æ‰¾åˆ°ID/Stepåˆ—å’Œæ“ä½œåˆ—
                        for (let col of data.columns) {
                            const colLower = col.toLowerCase();
                            if (colLower.includes('id') || colLower.includes('step') || colLower.includes('seq')) {
                                stepId = row[col] || (index + 1);
                            }
                            if (colLower.includes('operation') || colLower.includes('plan') || colLower.includes('description') || colLower.includes('op')) {
                                operation = row[col] || 'Unknown Operation';
                            }
                        }
                    }
                    
                    // å¦‚æœä»æ²¡æœ‰æ‰¾åˆ°stepIdï¼Œä½¿ç”¨ç´¢å¼•+1
                    if (!stepId) {
                        stepId = index + 1;
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šçš„æ“ä½œåˆ—ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªéStepåˆ—çš„å€¼
                    if (!operation) {
                        for (let col in row) {
                            if (col !== 'Step' && !col.toLowerCase().includes('id') && !col.toLowerCase().includes('step')) {
                                operation = row[col];
                                break;
                            }
                        }
                        if (!operation) {
                            const values = Object.values(row);
                            operation = values[0] || 'Unknown Operation';
                        }
                    }
                    
                    visualHtml += `
                        <div class="plan-step" style="display: flex; align-items: center;">
                            <div class="step-number" style="width: 30px; height: 30px; border-radius: 50%; background: #0d6efd; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">
                                ${escapeHtml(stepId.toString())}
                            </div>
                            <div class="step-operation" style="padding: 10px 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #0d6efd; flex-grow: 1;">
                                ${escapeHtml(operation.toString())}
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ ç®­å¤´ï¼ˆé™¤äº†æœ€åä¸€ä¸ªæ­¥éª¤ï¼‰
                    if (index < data.data.length - 1) {
                        visualHtml += '<div class="arrow" style="height: 20px; display: flex; align-items: center; justify-content: center;">â¬‡</div>';
                    }
                });
                
                visualHtml += '</div>';
                visualHtml += '</div>';
                visualHtml += '</div>';

                resultTable.innerHTML = controlHtml + tableHtml + visualHtml;
                resultTable.style.display = 'block';
                
                // å­˜å‚¨æ•°æ®ä¾›å¯è§†åŒ–å‡½æ•°ä½¿ç”¨
                window.queryPlanData = data;
            } else {
                resultTable.innerHTML = '<div class="alert alert-warning" role="alert">æœªè¿”å›æŸ¥è¯¢è®¡åˆ’æ•°æ®</div>';
                resultTable.style.display = 'block';
            }

            // éšè—åˆ†é¡µåŒºåŸŸ
            document.getElementById('paginationArea').style.display = 'none';
        }

        /**
         * åˆ‡æ¢æŸ¥è¯¢è®¡åˆ’è§†å›¾ï¼ˆè¡¨æ ¼/å¯è§†åŒ–ï¼‰
         * @param {string} view - è§†å›¾ç±»å‹ ('table' æˆ– 'visual')
         */
        function togglePlanView(view) {
            const tableView = document.getElementById('planTableView');
            const visualView = document.getElementById('planVisualView');
            
            if (view === 'table') {
                tableView.style.display = 'block';
                visualView.style.display = 'none';
            } else if (view === 'visual') {
                tableView.style.display = 'none';
                visualView.style.display = 'block';
            }
        }

        /**
         * å¯¼å‡ºæŸ¥è¯¢è®¡åˆ’ä¸ºHTMLæ ¼å¼
         */
        function exportQueryPlan() {
            if (!window.queryPlanData) {
                showAlertModal('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æŸ¥è¯¢è®¡åˆ’æ•°æ®', 'danger');
                return;
            }

            const data = window.queryPlanData;
            
            // ç”ŸæˆHTMLå†…å®¹
            let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“æŸ¥è¯¢è®¡åˆ’åˆ†ææŠ¥å‘Š</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .metadata {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .metadata div {
            margin: 5px 0;
        }
        .metadata strong {
            color: #495057;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th {
            background: #4a6fa5;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9em;
        }
        @media print {
            body {
                padding: 0;
                background: white;
            }
            .header, .metadata, .table-container {
                box-shadow: none;
                border: 1px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ•°æ®åº“æŸ¥è¯¢è®¡åˆ’åˆ†ææŠ¥å‘Š</h1>
    </div>
    
    <div class="metadata">
        <div><strong>æ•°æ®åº“ç±»å‹:</strong> ${data.db_type}</div>
        <div><strong>åˆ†ææ—¶é—´:</strong> ${new Date().toLocaleString()}</div>
        <div><strong>SQLè¯­å¥:</strong> <code>${escapeHtmlForExport((document.getElementById('sqlInput').value || document.getElementById('sqlInput').textContent || document.getElementById('sqlInput').innerText) || 'N/A')}</code></div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>`;
            
            // æ·»åŠ è¡¨å¤´
            data.columns.forEach(col => {
                htmlContent += `<th>${escapeHtmlForExport(col)}</th>`;
            });
            
            htmlContent += `</tr>
            </thead>
            <tbody>`;
            
            // æ·»åŠ æ•°æ®è¡Œ
            if (data.data && data.data.length > 0) {
                data.data.forEach(row => {
                    htmlContent += '<tr>';
                    data.columns.forEach(col => {
                        let cellValue = row[col];
                        if (typeof cellValue === 'object' && cellValue !== null) {
                            cellValue = JSON.stringify(cellValue, null, 2);
                        } else if (cellValue === null) {
                            cellValue = 'NULL';
                        }
                        htmlContent += `<td><pre style="margin: 0; white-space: pre-wrap; word-break: break-word;">${escapeHtmlForExport(String(cellValue))}</pre></td>`;
                    });
                    htmlContent += '</tr>';
                });
            } else {
                htmlContent += `<tr><td colspan="${data.columns.length}">æ²¡æœ‰æŸ¥è¯¢è®¡åˆ’æ•°æ®</td></tr>`;
            }
            
            htmlContent += `</tbody>
        </table>
    </div>
    
    <div class="footer">
        <p>Generated by Data Check Tool</p>
        <p>${new Date().toLocaleString()}</p>
    </div>
</body>
</html>`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_plan_${data.db_type}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.html`;
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        /**
         * HTMLè½¬ä¹‰å‡½æ•°ï¼ˆç”¨äºå¯¼å‡ºï¼‰
         * @param {string} text - è¦è½¬ä¹‰çš„æ–‡æœ¬
         */
        function escapeHtmlForExport(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /**
         * HTMLè½¬ä¹‰å‡½æ•°
         * @param {string} text - è¦è½¬ä¹‰çš„æ–‡æœ¬
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ===================== å¯¼å‡ºç›¸å…³åŠŸèƒ½ =====================
        /**
         * æ˜¾ç¤ºExcelå¯¼å‡ºé…ç½®æ¨¡æ€æ¡†
         */
        function showExcelExportModal() {
            try {
                console.log('showExcelExportModalè¢«è°ƒç”¨ï¼ŒcurrentQueryIdå€¼:', currentQueryId);
                
                // æ£€æŸ¥currentQueryId
                if (!currentQueryId) {
                    console.warn('å¯¼å‡ºExcelå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                    showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                    return false;
                }
                
                // è·å–æ¨¡æ€æ¡†å…ƒç´ 
                const modalElement = document.getElementById('excelExportModal');
                if (!modalElement) {
                    console.error('Excelå¯¼å‡ºæ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    showAlertModal('é”™è¯¯', 'å¯¼å‡ºæ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'danger');
                    return false;
                }
                
                // è·å–æ–‡ä»¶åè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const baseName = currentSqlName || 'æŸ¥è¯¢ç»“æœ';
                const defaultFileName = `${baseName}_${today}`;
                const fileNameInput = document.getElementById('excelFileName');
                if (fileNameInput) {
                    fileNameInput.value = defaultFileName;
                }
                
                // ç›´æ¥ä½¿ç”¨Bootstrapçš„dataå±æ€§æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè¿™æ˜¯ä¸€ç§å¤‡ç”¨æ–¹æ¡ˆ
                // å…ˆå°è¯•ä½¿ç”¨JavaScript API
                const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                bsModal.show();
                
                console.log('Excelå¯¼å‡ºæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                return true;
            } catch (error) {
                console.error('æ˜¾ç¤ºExcelå¯¼å‡ºæ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message, error.stack);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·è€Œä¸æ˜¯é™é»˜å¤±è´¥
                showAlertModal('é”™è¯¯', `æ˜¾ç¤ºå¯¼å‡ºé…ç½®ç•Œé¢å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                return false;
            }
        }
        
        /**
         * æ˜¾ç¤ºCSVå¯¼å‡ºé…ç½®æ¨¡æ€æ¡†
         */
        function showCsvExportModal() {
            try {
                console.log('showCsvExportModalè¢«è°ƒç”¨ï¼ŒcurrentQueryIdå€¼:', currentQueryId);
                
                // æ£€æŸ¥currentQueryId
                if (!currentQueryId) {
                    console.warn('å¯¼å‡ºCSVå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                    showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                    return false;
                }
                
                // è·å–æ¨¡æ€æ¡†å…ƒç´ 
                const modalElement = document.getElementById('csvExportModal');
                if (!modalElement) {
                    console.error('CSVå¯¼å‡ºæ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    showAlertModal('é”™è¯¯', 'å¯¼å‡ºæ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'danger');
                    return false;
                }
                
                // è·å–æ–‡ä»¶åè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const baseName = currentSqlName || 'æŸ¥è¯¢ç»“æœ';
                const defaultFileName = `${baseName}_${today}`;
                const fileNameInput = document.getElementById('csvFileName');
                if (fileNameInput) {
                    fileNameInput.value = defaultFileName;
                }
                
                // ç›´æ¥ä½¿ç”¨Bootstrapçš„dataå±æ€§æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè¿™æ˜¯ä¸€ç§å¤‡ç”¨æ–¹æ¡ˆ
                // å…ˆå°è¯•ä½¿ç”¨JavaScript API
                const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                bsModal.show();
                
                console.log('CSVå¯¼å‡ºæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                return true;
            } catch (error) {
                console.error('æ˜¾ç¤ºCSVå¯¼å‡ºæ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message, error.stack);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·è€Œä¸æ˜¯é™é»˜å¤±è´¥
                showAlertModal('é”™è¯¯', `æ˜¾ç¤ºå¯¼å‡ºé…ç½®ç•Œé¢å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                return false;
            }
        }
        
        /**
         * æ˜¾ç¤ºHTMLå¯¼å‡ºé…ç½®æ¨¡æ€æ¡†
         */
        function showHtmlExportModal() {
            try {
                console.log('showHtmlExportModalè¢«è°ƒç”¨ï¼ŒcurrentQueryIdå€¼:', currentQueryId);
                
                // æ£€æŸ¥currentQueryId
                if (!currentQueryId) {
                    console.warn('å¯¼å‡ºHTMLå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                    showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                    return false;
                }
                
                // è·å–æ¨¡æ€æ¡†å…ƒç´ 
                const modalElement = document.getElementById('htmlExportModal');
                if (!modalElement) {
                    console.error('HTMLå¯¼å‡ºæ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    showAlertModal('é”™è¯¯', 'å¯¼å‡ºæ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'danger');
                    return false;
                }
                
                // è·å–æ–‡ä»¶åè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const baseName = currentSqlName || 'æŸ¥è¯¢ç»“æœ';
                const defaultFileName = `${baseName}_${today}`;
                const fileNameInput = document.getElementById('htmlFileName');
                if (fileNameInput) {
                    fileNameInput.value = defaultFileName;
                }
                
                // ç›´æ¥ä½¿ç”¨Bootstrapçš„dataå±æ€§æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè¿™æ˜¯ä¸€ç§å¤‡ç”¨æ–¹æ¡ˆ
                // å…ˆå°è¯•ä½¿ç”¨JavaScript API
                const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                bsModal.show();
                
                console.log('HTMLå¯¼å‡ºæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                return true;
            } catch (error) {
                console.error('æ˜¾ç¤ºHTMLå¯¼å‡ºæ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message, error.stack);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·è€Œä¸æ˜¯é™é»˜å¤±è´¥
                showAlertModal('é”™è¯¯', `æ˜¾ç¤ºå¯¼å‡ºé…ç½®ç•Œé¢å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                return false;
            }
        }

        /**
         * ä»åç«¯åŠ è½½å¸¸ç”¨SQLåˆ—è¡¨
         */
        function loadCommonSqls() {
            const listContainer = document.getElementById('commonSqlList');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            
            // å…ˆæ·»åŠ ä¸€ä¸ªâ€œæ–°å¢â€æŒ‰é’®
            const addBtn = document.createElement('div');
            addBtn.className = 'common-sql-item btn-add-new';
            addBtn.innerHTML = '<span>+ æ–°å¢å¸¸ç”¨</span>';
            addBtn.onclick = function() { showSaveCommonSqlModal(); };
            listContainer.appendChild(addBtn);

            fetch('/common_sqls')
                .then(res => {
                    if (!res.ok) throw new Error('åŠ è½½å¸¸ç”¨SQLå¤±è´¥');
                    return res.json();
                })
                .then(data => {
                    if (data.status !== 'success' || !Array.isArray(data.data)) {
                        throw new Error(data.message || 'è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                    data.data.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'common-sql-item';
                        itemDiv.title = item.title;
                        
                        // å†…å®¹åŒºåŸŸï¼šç‚¹å‡»åŠ è½½SQL
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'common-sql-name';
                        nameSpan.textContent = item.title || 'æœªå‘½åSQL';
                        nameSpan.onclick = function(e) {
                            e.stopPropagation();
                            currentSqlName = item.title || 'æŸ¥è¯¢ç»“æœ'; // è®°å½•SQLåç§°
                            copyToSqlInputDirect(item.sql);
                            
                            // æ¸…é™¤ä¹‹å‰é€‰ä¸­çš„é¡¹
                            const selectedItems = document.querySelectorAll('.common-sql-item.selected');
                            selectedItems.forEach(selectedItem => {
                                selectedItem.classList.remove('selected');
                            });
                            
                            // ä¸ºå½“å‰é¡¹æ·»åŠ é€‰ä¸­æ ·å¼
                            const parentItem = nameSpan.closest('.common-sql-item');
                            if (parentItem) {
                                parentItem.classList.add('selected');
                            }
                        };
                        
                        // æ“ä½œåŒºåŸŸï¼šç¼–è¾‘å’Œåˆ é™¤
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'common-sql-actions';
                        
                        // ç¼–è¾‘æŒ‰é’®
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn btn-edit';
                        editBtn.innerHTML = 'âœ';
                        editBtn.title = 'ç¼–è¾‘';
                        editBtn.onclick = function(e) {
                            e.stopPropagation();
                            showSaveCommonSqlModal(item);
                        };
                        
                        // å¤åˆ¶æŒ‰é’®
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'action-btn btn-copy';
                        copyBtn.innerHTML = 'â§‰';
                        copyBtn.title = 'å¤åˆ¶';
                        copyBtn.onclick = function(e) {
                            e.stopPropagation();
                            copyCommonSql(item);
                        };
                        
                        // åˆ é™¤æŒ‰é’®
                        const delBtn = document.createElement('button');
                        delBtn.className = 'action-btn btn-delete';
                        delBtn.innerHTML = 'Ã—';
                        delBtn.title = 'åˆ é™¤';
                        delBtn.onclick = function(e) {
                            e.stopPropagation();
                            deleteCommonSql(item.id, item.title);
                        };
                        
                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(copyBtn);
                        actionsDiv.appendChild(delBtn);
                        
                        itemDiv.appendChild(nameSpan);
                        itemDiv.appendChild(actionsDiv);
                        listContainer.appendChild(itemDiv);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½å¸¸ç”¨SQLå¤±è´¥:', error);
                });
        }

        /**
         * å¯¼å‡ºå¸¸ç”¨ SQL ä¸º JSON (æ˜¾ç¤ºå¯¼å‡ºé…ç½®)
         */
        function exportCommonSqls() {
            const fileNameInput = document.getElementById('exportJsonFileName');
            const defaultName = `common_sqls_${new Date().toISOString().split('T')[0].replace(/-/g, '')}`;
            if (fileNameInput) fileNameInput.value = defaultName;
            exportJsonModal.show();
        }

        /**
         * ç¡®è®¤å¯¼å‡º JSON
         */
        async function confirmExportJson() {
            const fileNameInput = document.getElementById('exportJsonFileName');
            let fileName = (fileNameInput?.value || 'common_sqls').trim();
            if (!fileName.endsWith('.json')) fileName += '.json';

            try {
                // å¦‚æœæµè§ˆå™¨æ”¯æŒ showSaveFilePickerï¼Œåˆ™ç›´æ¥è°ƒç”¨ç³»ç»Ÿå¯¹è¯æ¡†
                if (window.showSaveFilePicker) {
                    const response = await fetch('/common_sqls');
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);

                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'JSON Files',
                            accept: {'application/json': ['.json']},
                        }],
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(JSON.stringify(result.data, null, 2));
                    await writable.close();
                    
                    exportJsonModal.hide();
                    showAlertModal('æˆåŠŸ', 'æ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼', 'success');
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ a æ ‡ç­¾ä¸‹è½½ï¼Œåˆ©ç”¨ Content-Disposition æç¤ºä½ç½®
                    exportJsonModal.hide();
                    const url = `/export_common_sqls?filename=${encodeURIComponent(fileName)}`;
                    window.open(url, '_blank');
                }
            } catch (err) {
                if (err.name === 'AbortError') return; // ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜å¯¹è¯æ¡†
                showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
            }
        }

        /**
         * è§¦å‘å¯¼å…¥ JSON æ–‡ä»¶
         */
        function triggerImportJson() {
            document.getElementById('importJsonInput').click();
        }

        /**
         * å¤„ç†å¯¼å…¥ JSON æ–‡ä»¶
         */
        function handleImportJson(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (!Array.isArray(jsonData)) {
                        throw new Error('JSON æ ¼å¼é”™è¯¯ï¼šæ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯æ•°ç»„ï¼');
                    }
                    
                    // ç®€å•æ ¡éªŒæ•°æ®é¡¹ç»“æ„
                    jsonData.forEach((item, index) => {
                        if (!item.title || !item.sql) {
                            throw new Error(`ç¬¬ ${index + 1} ä¸ªæ•°æ®é¡¹ç¼ºå°‘ title æˆ– sql å­—æ®µï¼`);
                        }
                    });

                    // å‘é€åˆ°åç«¯ä¿å­˜
                    fetch('/import_common_sqls', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showAlertModal('æˆåŠŸ', 'å¯¼å…¥æˆåŠŸï¼', 'success');
                            loadCommonSqls();
                        } else {
                            showAlertModal('å¤±è´¥', `å¯¼å…¥å¤±è´¥ï¼š${data.message}`, 'danger');
                        }
                        input.value = ''; // æ¸…ç©ºé€‰æ‹©
                    })
                    .catch(err => {
                        showAlertModal('å¤±è´¥', `è¯·æ±‚å¤±è´¥ï¼š${err.message}`, 'danger');
                        input.value = '';
                    });

                } catch (err) {
                    showAlertModal('å¤±è´¥', `è§£æ JSON å¤±è´¥ï¼š${err.message}`, 'danger');
                    input.value = '';
                }
            };
            reader.readAsText(file);
        }

        /**
         * ç›´æ¥å¡«å……SQLåˆ°è¾“å…¥æ¡†
         */
        function copyToSqlInputDirect(sqlText) {
            const sqlInput = document.getElementById('sqlInput');
            if (!sqlInput) return;
            
            // å±•å¼€SQLè¾“å…¥åŒºåŸŸï¼ˆå¦‚æœå®ƒæ˜¯æŠ˜å çš„ï¼‰
            const sqlInputBody = document.getElementById('sqlInputBody');
            const toggleHeader = document.querySelector('[data-bs-target="#sqlInputBody"]');
            if (sqlInputBody && toggleHeader) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦æŠ˜å 
                if (!sqlInputBody.classList.contains('show')) {
                    // å±•å¼€é¢æ¿
                    sqlInputBody.classList.add('show');
                    // æ›´æ–°å›¾æ ‡æ–¹å‘
                    const toggleIcon = toggleHeader.querySelector('.config-toggle-icon');
                    if (toggleIcon) {
                        toggleIcon.textContent = 'â–²';
                    }
                    // æ›´æ–°aria-expandedå±æ€§
                    toggleHeader.setAttribute('aria-expanded', 'true');
                }
            }
            
            if (sqlInput.contentEditable === 'true') {
                sqlInput.textContent = sqlText || '';
                updateSqlHighlight(); // æ‰‹åŠ¨è§¦å‘è¯­æ³•é«˜äº®
            } else {
                sqlInput.value = sqlText || '';
            }
            handleSqlInput();
            sqlInput.focus();
        }

        /**
         * ç¡®è®¤å¯¼å‡ºExcelï¼ˆæ”¯æŒshowSaveFilePickerï¼‰
         */
        async function confirmExportExcel() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸´æ—¶å¯¼å‡ºå‚æ•°ï¼ˆæ‰¹é‡æ‰§è¡Œç»“æœçš„å¯¼å‡ºæŒ‰é’®ï¼‰
            if (window.temporaryExportParams && window.temporaryExportParams.type === 'excel') {
                // ä½¿ç”¨ä¸´æ—¶å‚æ•°è¿›è¡Œå¯¼å‡º
                confirmTemporaryExport('excel');
                return;
            }
            
            // æ£€æŸ¥å…¨å±€å¯¼å‡ºçš„currentQueryId
            if (!currentQueryId) {
                console.warn('å¯¼å‡ºExcelå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                return;
            }
            
            // è·å–é…ç½®å‚æ•°
            const headerColor = document.getElementById('excelHeaderColor').value;
            const includeHeader = document.querySelector('input[name="excelIncludeHeader"]:checked').value;
            let fileName = document.getElementById('excelFileName').value.trim() || 'æŸ¥è¯¢ç»“æœ';
            if (!fileName.endsWith('.xlsx')) fileName += '.xlsx';
            
            try {
                // å°è¯•ä½¿ç”¨ç°ä»£æµè§ˆå™¨API
                if (window.showSaveFilePicker) {
                    const url = `/export_excel?query_id=${currentQueryId}&header_color=${headerColor}&include_header=${includeHeader}`;
                    fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥');
                        return response.blob();
                    })
                    .then(blob => {
                        return window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: 'Excel Files',
                                accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']},
                            }],
                        }).then(handle => {
                            return handle.createWritable().then(writable => {
                                return writable.write(blob).then(() => {
                                    return writable.close();
                                });
                            });
                        });
                    })
                    .then(() => {
                        // æˆåŠŸä¿å­˜åéšè—æ¨¡æ€æ¡†
                        if (window.excelExportModal) {
                            window.excelExportModal.hide();
                        } else {
                            // å¦‚æœæ¨¡æ€æ¡†å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨bootstrapåŸç”Ÿæ–¹æ³•
                            const modalElement = document.getElementById('excelExportModal');
                            if (modalElement) {
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) {
                                    modalInstance.hide();
                                } else {
                                    // æœ€åæ‰‹æ®µï¼šç›´æ¥è®¾ç½®æ ·å¼éšè—
                                    modalElement.style.display = 'none';
                                    document.body.classList.remove('modal-open');
                                    const backdrop = document.querySelector('.modal-backdrop');
                                    if (backdrop) backdrop.remove();
                                }
                            }
                        }
                        showAlertModal('æˆåŠŸ', 'Excelæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼', 'success');
                    })
                    .catch(err => {
                        if (err.name !== 'AbortError') {
                            showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                        }
                    });
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä¼ ç»Ÿä¸‹è½½
                    const url = `/export_excel?query_id=${currentQueryId}&header_color=${headerColor}&include_header=${includeHeader}&filename=${encodeURIComponent(fileName)}`;
                    // ç¡®ä¿æ¨¡æ€æ¡†å…³é—­
                    if (window.excelExportModal) {
                        window.excelExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('excelExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    window.open(url, '_blank');
                    showAlertModal('æç¤º', 'Excelæ–‡ä»¶æ­£åœ¨ä¸‹è½½ä¸­...', 'info');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿéšè—æ¨¡æ€æ¡†
                    if (window.excelExportModal) {
                        window.excelExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('excelExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                }
            }
        }

        /**
         * æ˜¾ç¤ºCSVå¯¼å‡ºé…ç½®æ¨¡æ€æ¡†
         */
        function showCsvExportModal() {
            try {
                console.log('showCsvExportModalè¢«è°ƒç”¨ï¼ŒcurrentQueryIdå€¼:', currentQueryId);
                
                // æ£€æŸ¥currentQueryId
                if (!currentQueryId) {
                    console.warn('å¯¼å‡ºCSVå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                    showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                    return false;
                }
                
                // è·å–æ¨¡æ€æ¡†å…ƒç´ 
                const modalElement = document.getElementById('csvExportModal');
                if (!modalElement) {
                    console.error('CSVå¯¼å‡ºæ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    showAlertModal('é”™è¯¯', 'å¯¼å‡ºæ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'danger');
                    return false;
                }
                
                // è·å–æ–‡ä»¶åè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const baseName = currentSqlName || 'æŸ¥è¯¢ç»“æœ';
                const defaultFileName = `${baseName}_${today}`;
                const fileNameInput = document.getElementById('csvFileName');
                if (fileNameInput) {
                    fileNameInput.value = defaultFileName;
                }
                
                // ç›´æ¥ä½¿ç”¨Bootstrapçš„dataå±æ€§æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè¿™æ˜¯ä¸€ç§å¤‡ç”¨æ–¹æ¡ˆ
                // å…ˆå°è¯•ä½¿ç”¨JavaScript API
                const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                bsModal.show();
                
                console.log('CSVå¯¼å‡ºæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                return true;
            } catch (error) {
                console.error('æ˜¾ç¤ºCSVå¯¼å‡ºæ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message, error.stack);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·è€Œä¸æ˜¯é™é»˜å¤±è´¥
                showAlertModal('é”™è¯¯', `æ˜¾ç¤ºå¯¼å‡ºé…ç½®ç•Œé¢å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                return false;
            }
        }

        /**
         * æ˜¾ç¤ºHTMLå¯¼å‡ºé…ç½®æ¨¡æ€æ¡†
         */
        function showHtmlExportModal() {
            try {
                console.log('showHtmlExportModalè¢«è°ƒç”¨ï¼ŒcurrentQueryIdå€¼:', currentQueryId);
                
                // æ£€æŸ¥currentQueryId
                if (!currentQueryId) {
                    console.warn('å¯¼å‡ºHTMLå¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æŸ¥è¯¢ID');
                    showAlertModal('æç¤º', 'æ— å¯ç”¨æŸ¥è¯¢ç»“æœï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ï¼', 'warning');
                    return false;
                }
                
                // è·å–æ¨¡æ€æ¡†å…ƒç´ 
                const modalElement = document.getElementById('htmlExportModal');
                if (!modalElement) {
                    console.error('HTMLå¯¼å‡ºæ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    showAlertModal('é”™è¯¯', 'å¯¼å‡ºæ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'danger');
                    return false;
                }
                
                // è·å–æ–‡ä»¶åè¾“å…¥æ¡†å¹¶è®¾ç½®é»˜è®¤å€¼
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const baseName = currentSqlName || 'æŸ¥è¯¢ç»“æœ';
                const defaultFileName = `${baseName}_${today}`;
                const fileNameInput = document.getElementById('htmlFileName');
                if (fileNameInput) {
                    fileNameInput.value = defaultFileName;
                }
                
                // ç›´æ¥ä½¿ç”¨Bootstrapçš„dataå±æ€§æ–¹å¼æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œè¿™æ˜¯ä¸€ç§å¤‡ç”¨æ–¹æ¡ˆ
                // å…ˆå°è¯•ä½¿ç”¨JavaScript API
                const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                bsModal.show();
                
                console.log('HTMLå¯¼å‡ºæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
                return true;
            } catch (error) {
                console.error('æ˜¾ç¤ºHTMLå¯¼å‡ºæ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.name, error.message, error.stack);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·è€Œä¸æ˜¯é™é»˜å¤±è´¥
                showAlertModal('é”™è¯¯', `æ˜¾ç¤ºå¯¼å‡ºé…ç½®ç•Œé¢å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
                return false;
            }
        }
        
        /**
         * ç¡®è®¤å¯¼å‡ºCSVï¼ˆæ”¯æŒshowSaveFilePickerï¼‰
         */
        async function confirmExportCsv() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸´æ—¶å¯¼å‡ºå‚æ•°ï¼ˆæ‰¹é‡æ‰§è¡Œç»“æœçš„å¯¼å‡ºæŒ‰é’®ï¼‰
            if (window.temporaryExportParams && window.temporaryExportParams.type === 'csv') {
                // ä½¿ç”¨ä¸´æ—¶å‚æ•°è¿›è¡Œå¯¼å‡º
                confirmTemporaryExport('csv');
                return;
            }
            
            // æ£€æŸ¥å…¨å±€å¯¼å‡ºçš„currentQueryId
            if (!currentQueryId) return;
            
            // è·å–é…ç½®å‚æ•°
            const separator = document.getElementById('csvSeparator').value;
            const includeHeader = document.querySelector('input[name="csvIncludeHeader"]:checked').value;
            let fileName = document.getElementById('csvFileName').value.trim() || 'æŸ¥è¯¢ç»“æœ';
            if (!fileName.endsWith('.csv')) fileName += '.csv';
            
            try {
                // å°è¯•ä½¿ç”¨ç°ä»£æµè§ˆå™¨API
                if (window.showSaveFilePicker) {
                    const url = `/export_csv?query_id=${currentQueryId}&separator=${separator}&include_header=${includeHeader}`;
                    fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥');
                        return response.blob();
                    })
                    .then(blob => {
                        return window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: 'CSV Files',
                                accept: {'text/csv': ['.csv']},
                            }],
                        }).then(handle => {
                            return handle.createWritable().then(writable => {
                                return writable.write(blob).then(() => {
                                    return writable.close();
                                });
                            });
                        });
                    })
                    .then(() => {
                        // æˆåŠŸä¿å­˜åéšè—æ¨¡æ€æ¡†
                        if (window.csvExportModal) {
                            window.csvExportModal.hide();
                        } else {
                            // å¦‚æœæ¨¡æ€æ¡†å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨bootstrapåŸç”Ÿæ–¹æ³•
                            const modalElement = document.getElementById('csvExportModal');
                            if (modalElement) {
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) {
                                    modalInstance.hide();
                                } else {
                                    // æœ€åæ‰‹æ®µï¼šç›´æ¥è®¾ç½®æ ·å¼éšè—
                                    modalElement.style.display = 'none';
                                    document.body.classList.remove('modal-open');
                                    const backdrop = document.querySelector('.modal-backdrop');
                                    if (backdrop) backdrop.remove();
                                }
                            }
                        }
                        showAlertModal('æˆåŠŸ', 'CSVæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼', 'success');
                    })
                    .catch(err => {
                        if (err.name !== 'AbortError') {
                            showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                        }
                    });
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä¼ ç»Ÿä¸‹è½½
                    const url = `/export_csv?query_id=${currentQueryId}&separator=${separator}&include_header=${includeHeader}&filename=${encodeURIComponent(fileName)}`;
                    // ç¡®ä¿æ¨¡æ€æ¡†å…³é—­
                    if (window.csvExportModal) {
                        window.csvExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('csvExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    window.open(url, '_blank');
                    showAlertModal('æç¤º', 'CSVæ–‡ä»¶æ­£åœ¨ä¸‹è½½ä¸­...', 'info');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿéšè—æ¨¡æ€æ¡†
                    if (window.csvExportModal) {
                        window.csvExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('csvExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                }
            }
        }
        
        /**
         * ç¡®è®¤å¯¼å‡ºHTMLï¼ˆæ”¯æŒshowSaveFilePickerï¼‰
         */
        async function confirmExportHtml() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸´æ—¶å¯¼å‡ºå‚æ•°ï¼ˆæ‰¹é‡æ‰§è¡Œç»“æœçš„å¯¼å‡ºæŒ‰é’®ï¼‰
            if (window.temporaryExportParams && window.temporaryExportParams.type === 'html') {
                // ä½¿ç”¨ä¸´æ—¶å‚æ•°è¿›è¡Œå¯¼å‡º
                confirmTemporaryExport('html');
                return;
            }
            
            // æ£€æŸ¥å…¨å±€å¯¼å‡ºçš„currentQueryId
            if (!currentQueryId) return;
            
            let fileName = document.getElementById("htmlFileName").value.trim() || "æŸ¥è¯¢ç»“æœ";
            if (!fileName.endsWith(".html")) fileName += ".html";
            
            try {
                // å°è¯•ä½¿ç”¨ç°ä»£æµè§ˆå™¨API
                if (window.showSaveFilePicker) {
                    const url = `/export_html?query_id=${currentQueryId}`;
                    fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error("å¯¼å‡ºå¤±è´¥");
                        return response.blob();
                    })
                    .then(blob => {
                        return window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: "HTML Files",
                                accept: {"text/html": [".html"]},
                            }],
                        }).then(handle => {
                            return handle.createWritable().then(writable => {
                                return writable.write(blob).then(() => {
                                    return writable.close();
                                });
                            });
                        });
                    })
                    .then(() => {
                        // æˆåŠŸä¿å­˜åéšè—æ¨¡æ€æ¡†
                        if (window.htmlExportModal) {
                            window.htmlExportModal.hide();
                        } else {
                            // å¦‚æœæ¨¡æ€æ¡†å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨bootstrapåŸç”Ÿæ–¹æ³•
                            const modalElement = document.getElementById('htmlExportModal');
                            if (modalElement) {
                                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                                if (modalInstance) {
                                    modalInstance.hide();
                                } else {
                                    // æœ€åæ‰‹æ®µï¼šç›´æ¥è®¾ç½®æ ·å¼éšè—
                                    modalElement.style.display = 'none';
                                    document.body.classList.remove('modal-open');
                                    const backdrop = document.querySelector('.modal-backdrop');
                                    if (backdrop) backdrop.remove();
                                }
                            }
                        }
                        showAlertModal("æˆåŠŸ", "HTMLæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼", "success");
                    })
                    .catch(err => {
                        if (err.name !== "AbortError") {
                            showAlertModal("å¤±è´¥", `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, "danger");
                        }
                    });
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä¼ ç»Ÿä¸‹è½½
                    const url = `/export_html?query_id=${currentQueryId}&filename=${encodeURIComponent(fileName)}`;
                    // ç¡®ä¿æ¨¡æ€æ¡†å…³é—­
                    if (window.htmlExportModal) {
                        window.htmlExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('htmlExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    window.open(url, "_blank");
                    showAlertModal('æç¤º', 'HTMLæ–‡ä»¶æ­£åœ¨ä¸‹è½½ä¸­...', 'info');
                }
            } catch (err) {
                if (err.name !== "AbortError") {
                    // ç¡®ä¿åœ¨é”™è¯¯æƒ…å†µä¸‹ä¹Ÿéšè—æ¨¡æ€æ¡†
                    if (window.htmlExportModal) {
                        window.htmlExportModal.hide();
                    } else {
                        const modalElement = document.getElementById('htmlExportModal');
                        if (modalElement) {
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                modalElement.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) backdrop.remove();
                            }
                        }
                    }
                    showAlertModal("å¤±è´¥", `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, "danger");
                }
            }
        }
        
        /**
         * æ˜¾ç¤ºä¿å­˜/ç¼–è¾‘å¸¸ç”¨SQLçš„æ¨¡æ€æ¡†
         * @param {Object} item - å¦‚æœæ˜¯ç¼–è¾‘ï¼Œåˆ™ä¼ å…¥è¯¥SQLé¡¹å¯¹è±¡
         */
        function showSaveCommonSqlModal(item = null) {
            const titleInput = document.getElementById('commonSqlTitleInput');
            const contentInput = document.getElementById('commonSqlContentInput');
            const modalTitle = document.getElementById('saveCommonSqlModalLabel');
            
            if (!titleInput || !contentInput) return;

            if (item) {
                // ç¼–è¾‘æ¨¡å¼
                editingSqlId = item.id;
                titleInput.value = item.title || '';
                contentInput.value = item.sql || '';
                if (modalTitle) modalTitle.textContent = 'ç¼–è¾‘å¸¸ç”¨æŸ¥è¯¢è¯­å¥';
            } else {
                // æ–°å¢æ¨¡å¼ï¼šæ¸…ç©ºæ‰€æœ‰é»˜è®¤å€¼
                editingSqlId = null;
                titleInput.value = '';
                contentInput.value = '';
                if (modalTitle) modalTitle.textContent = 'æ–°å¢å¸¸ç”¨æŸ¥è¯¢è¯­å¥';
            }
            
            autoResizeTextarea(contentInput);
            saveCommonSqlModal.show();
        }

        /**
         * ç¡®è®¤ä¿å­˜æˆ–æ›´æ–°å¸¸ç”¨SQL
         */
        function confirmSaveCommonSql() {
            const titleInput = document.getElementById('commonSqlTitleInput');
            const contentInput = document.getElementById('commonSqlContentInput');
            if (!titleInput || !contentInput) return;

            const title = titleInput.value.trim();
            const sqlText = contentInput.value.trim();

            if (!title) {
                showAlertModal('æç¤º', 'è¯·å¡«å†™å¸¸ç”¨è¯­å¥æ ‡é¢˜ï¼', 'warning');
                return;
            }
            if (!sqlText) {
                showAlertModal('æç¤º', 'SQLå†…å®¹ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }

            const payload = { title: title, sql: sqlText };
            if (editingSqlId) {
                payload.id = editingSqlId;
            }

            fetch('/common_sqls', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error('æ“ä½œå¤±è´¥');
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showAlertModal('æˆåŠŸ', editingSqlId ? 'å·²æ›´æ–°å¸¸ç”¨æŸ¥è¯¢è¯­å¥ï¼' : 'å·²ä¿å­˜å¸¸ç”¨æŸ¥è¯¢è¯­å¥ï¼', 'success');
                    saveCommonSqlModal.hide();
                    loadCommonSqls();
                } else {
                    throw new Error(data.message || 'æ“ä½œå¤±è´¥');
                }
            })
            .catch(error => {
                showAlertModal('å¤±è´¥', `ä¿å­˜å¤±è´¥ï¼š${error.message}`, 'danger');
            });
        }

        /**
         * åˆ é™¤å¸¸ç”¨SQLï¼ˆæ”¹ä¸ºBootstrapæ¨¡æ€æ¡†ç¡®è®¤ï¼‰
         */
        function deleteCommonSql(id, title) {
            const deleteTargetTitle = document.getElementById('deleteTargetTitle');
            if (deleteTargetTitle) deleteTargetTitle.textContent = `ã€Œ${title}ã€`;
            
            // ä¸´æ—¶å­˜å‚¨idå’Œtitleï¼Œç”¨äºç¡®è®¤åˆ é™¤æ—¶ä½¿ç”¨
            window.currentDeleteSqlId = id;
            window.currentDeleteSqlTitle = title;
            
            // ç¡®ä¿æ¨¡æ€æ¡†çŠ¶æ€æ­£ç¡®
            const modalElement = document.getElementById('deleteConfirmModal');
            if (modalElement) {
                // é‡ç½®æ¨¡æ€æ¡†çš„å…³é”®å±æ€§
                modalElement.style.display = '';
                modalElement.removeAttribute('aria-hidden');
                modalElement.classList.add('fade');
            }
            
            // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            deleteConfirmModal.show();
        }

        /**
         * å¤åˆ¶å¸¸ç”¨SQL
         * @param {Object} item - è¦å¤åˆ¶çš„SQLé¡¹
         */
        function copyCommonSql(item) {
            // æ‰“å¼€ä¿å­˜å¸¸ç”¨SQLçš„æ¨¡æ€æ¡†ï¼Œé¢„å…ˆå¡«å…¥å¤åˆ¶çš„æ•°æ®
            const titleInput = document.getElementById('commonSqlTitleInput');
            const contentInput = document.getElementById('commonSqlContentInput');
            
            if (titleInput && contentInput) {
                // è®¾ç½®é»˜è®¤æ ‡é¢˜ä¸ºåŸæ ‡é¢˜åŠ "_å‰¯æœ¬"
                titleInput.value = item.title + '_å‰¯æœ¬';
                // è®¾ç½®SQLå†…å®¹ä¸ºåŸå†…å®¹
                contentInput.value = item.sql;
                
                // è®¾ç½®ä¸ºæ–°å¢æ¨¡å¼ï¼ˆæ¸…é™¤ç¼–è¾‘æ¨¡å¼çš„IDï¼‰
                editingSqlId = null;
                
                // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                const modalTitle = document.getElementById('saveCommonSqlModalLabel');
                if (modalTitle) modalTitle.textContent = 'å¤åˆ¶å¸¸ç”¨æŸ¥è¯¢è¯­å¥';
                
                // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
                autoResizeTextarea(contentInput);
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                saveCommonSqlModal.show();
            }
        }

        /**
         * æ˜¾ç¤ºé€šç”¨æç¤ºæ¨¡æ€æ¡†
         * @param {string} title - æ ‡é¢˜
         * @param {string} message - å†…å®¹
         * @param {string} type - ç±»å‹ï¼ˆsuccess/warning/danger/infoï¼‰
         */
        function showAlertModal(title, message, type) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æç¤ºæ¡†
            let alertModal = document.getElementById('alertModal');
            if (!alertModal) {
                // åŠ¨æ€åˆ›å»ºæç¤ºæ¨¡æ€æ¡†
                alertModal = document.createElement('div');
                alertModal.id = 'alertModal';
                alertModal.className = 'modal fade modal-custom';
                alertModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-${type} text-white">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                            </div>
                            <div class="modal-body">${message}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-modal btn-modal-confirm" data-bs-dismiss="modal">ç¡®å®š</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alertModal);
            } else {
                // æ›´æ–°ç°æœ‰æç¤ºæ¡†å†…å®¹
                alertModal.querySelector('.modal-title').textContent = title;
                alertModal.querySelector('.modal-body').textContent = message;
                alertModal.querySelector('.modal-header').className = `modal-header bg-${type} text-white`;
            }
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            new bootstrap.Modal(alertModal).show();
        }

        // å¤„ç†åˆ é™¤å–æ¶ˆæ“ä½œ - ç®€åŒ–ç‰ˆæœ¬
        function handleDeleteCancel() {
            try {
                // ä½¿ç”¨Bootstrap Modalå®ä¾‹éšè—æ¨¡æ€æ¡†
                if (window.deleteConfirmModal && typeof window.deleteConfirmModal.hide === 'function') {
                    window.deleteConfirmModal.hide();
                }
                
                // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„æ•°æ®ï¼Œé˜²æ­¢åœ¨å–æ¶ˆæ“ä½œæ—¶ç•™ä¸‹è„æ•°æ®
                window.currentDeleteDbId = null;
                window.currentDeleteDbName = null;
                window.currentDeleteSqlId = null;
                window.currentDeleteSqlTitle = null;
                
            } catch (error) {
                console.error('å¤„ç†åˆ é™¤å–æ¶ˆæ“ä½œæ—¶å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½å¤±è´¥ï¼Œè‡³å°‘è¦æ¸…é™¤ä¸´æ—¶æ•°æ®
                window.currentDeleteDbId = null;
                window.currentDeleteDbName = null;
                window.currentDeleteSqlId = null;
                window.currentDeleteSqlTitle = null;
            }
        }

        // å¤‡ç”¨å…³é—­å‡½æ•° - å¦‚æœä¸»è¦æ–¹æ³•å¤±è´¥
        function forceCloseDeleteModal() {
            try {
                const modal = document.getElementById('deleteConfirmModal');
                if (modal) {
                    // åªéšè—æ¨¡æ€æ¡†ï¼Œä¸å½±å“å…¶çŠ¶æ€
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    
                    // æ¸…é™¤ä¸´æ—¶æ•°æ®
                    window.currentDeleteDbId = null;
                    window.currentDeleteDbName = null;
                    window.currentDeleteSqlId = null;
                    window.currentDeleteSqlTitle = null;
                }
            } catch (e) {
                console.error('å¼ºåˆ¶å…³é—­æ¨¡æ€æ¡†æ—¶å‡ºé”™:', e);
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            // é¦–å…ˆå°è¯•ä»é…ç½®ä¸­åŠ è½½ä¸»é¢˜é¢œè‰²
            if (window.appConfig && window.appConfig.app_theme_color) {
                // å¦‚æœé…ç½®ä¸­æŒ‡å®šäº†ä¸»é¢˜é¢œè‰²ï¼Œåˆ™ä½¿ç”¨é…ç½®ä¸­çš„å€¼
                applyTheme(window.appConfig.app_theme_color);
            } else {
                // å¦åˆ™ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¿å­˜çš„ä¸»é¢˜ï¼Œé»˜è®¤ä¸ºæš—å¤œé»‘
                const savedTheme = localStorage.getItem('selectedTheme') || 'night';
                applyTheme(savedTheme);
            }
            
            // åˆå§‹åŒ–é…ç½®é¡¹çŠ¶æ€ï¼ˆé»˜è®¤å¯ç¼–è¾‘ï¼‰
            toggleConfigEditable(true);
            // åˆå§‹åŒ–SQLè¾“å…¥æ¡†é«˜åº¦å’Œç›‘å¬
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {
                autoResizeTextarea(sqlInput);
                sqlInput.addEventListener('input', handleSqlInput);
            }
            // åŠ è½½å¸¸ç”¨SQLåˆ—è¡¨
            loadCommonSqls();
            // åŠ è½½æ•°æ®åº“é…ç½®åˆ—è¡¨
            loadDatabaseList();
            // ç›‘å¬æ¯é¡µæ¡æ•°å˜åŒ–
            document.getElementById('pageSize').addEventListener('change', function() {
                pageSize = parseInt(this.value) || 50;
                if (currentSql && currentQueryId) {
                    currentPage = 1;
                    executeSqlQuery();
                }
            });
            
            // åˆå§‹åŒ–å¯¼å‡ºæ¨¡æ€æ¡†
            try {
                // åˆå§‹åŒ–Excelå¯¼å‡ºæ¨¡æ€æ¡†
                if (document.getElementById('excelExportModal')) {
                    window.excelExportModal = new bootstrap.Modal(document.getElementById('excelExportModal'));
                }
                
                // åˆå§‹åŒ–CSVå¯¼å‡ºæ¨¡æ€æ¡†
                if (document.getElementById('csvExportModal')) {
                    window.csvExportModal = new bootstrap.Modal(document.getElementById('csvExportModal'));
                }
                
                // åˆå§‹åŒ–HTMLå¯¼å‡ºæ¨¡æ€æ¡†
                if (document.getElementById('htmlExportModal')) {
                    window.htmlExportModal = new bootstrap.Modal(document.getElementById('htmlExportModal'));
                }
                
                // åˆå§‹åŒ–JSONå¯¼å‡ºæ¨¡æ€æ¡†
                if (document.getElementById('exportJsonModal')) {
                    window.exportJsonModal = new bootstrap.Modal(document.getElementById('exportJsonModal'));
                }
                
                // åˆå§‹åŒ–ä¿å­˜å¸¸ç”¨SQLæ¨¡æ€æ¡†
                if (document.getElementById('saveCommonSqlModal')) {
                    window.saveCommonSqlModal = new bootstrap.Modal(document.getElementById('saveCommonSqlModal'));
                }
                
                // åˆå§‹åŒ–åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
                if (document.getElementById('deleteConfirmModal')) {
                    window.deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                }
            } catch (error) {
                console.warn('æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥:', error);
            }
        };

        // ===================== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ =====================
        /**
         * åº”ç”¨ä¸»é¢˜
         */
        function applyTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            
            // æ ¹æ®ä¸»é¢˜åç§°è®¾ç½®CSSå˜é‡
            const themeColors = {
                'default': '#1890ff',
                'blue': '#1890ff',
                'green': '#52c41a',
                'purple': '#722ed1',
                'red': '#f5222d',
                'orange': '#fa8c16',
                'night': '#2c3e50',
                'ocean': '#2E3192',
                'sunset': '#fa709a',
                'forest': '#0BA360',
                'sakura': '#f093fb',
                'ibm': '#054DA2',
                'oracle': '#EA1B22',
                'sap': '#006494',
                'microsoft': '#0078d4',
                'google': '#4285f4',
                'amazon': '#ff9900',
                'meta': '#4267B2',
                'netflix': '#e50914',
                'spotify': '#1DB954',
                'adobe': '#FF0000',
                'salesforce': '#00A1E0'
            };
            
            const themeColor = themeColors[themeName] || '#1890ff';
            const root = document.documentElement;
            root.style.setProperty('--theme-color', themeColor);
            root.style.setProperty('--theme-bg-selected', hexToRgbA(themeColor, 0.15));
            root.style.setProperty('--theme-border-selected', themeColor);
            root.style.setProperty('--theme-shadow-selected', hexToRgba(themeColor, 0.25));
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('selectedTheme', themeName);
            
            // æ›´æ–°faviconå›¾æ ‡
            updateFavicon(themeColor);
        }

        // ç»‘å®šä¸»é¢˜åˆ‡æ¢äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    applyTheme(this.dataset.theme);
                });
            });
            
            // åˆå§‹åŒ–é€šç”¨æç¤ºæ¨¡æ€æ¡†
            if (document.getElementById('alertModal')) {
                window.alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            }
            
            // åˆå§‹åŒ–æ—¶å°†å½“å‰è¿æ¥æ•°æ®åº“ç½®ä¸ºç©º
            window.currentConnectedDbId = null;
            window.currentConnectedDbType = null;
            
            // è®¾ç½®å½“å‰æ•°æ®åº“åç§°ä¸º"æ— "ï¼ˆæŒ‡ç¤ºå™¨å§‹ç»ˆæ˜¾ç¤ºï¼Œä½†å†…å®¹ä¸º"æ— "ï¼‰
            const currentDbName = document.getElementById('currentDbName');
            if (currentDbName) {
                currentDbName.textContent = 'æ— ';
            }
            
            // æ›´æ–°è¿æ¥çŠ¶æ€ä¸ºæœªè¿æ¥
            const connectStatus = document.getElementById('connectStatus');
            if (connectStatus) {
                connectStatus.textContent = 'æœªè¿æ¥';
                connectStatus.className = 'badge bg-secondary';
            }
            
            // ç»Ÿä¸€å¤„ç†åˆ é™¤ç¡®è®¤æŒ‰é’®çš„äº‹ä»¶
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', function() {
                    // å¤„ç†æ•°æ®åº“åˆ é™¤
                    if (window.currentDeleteDbId) {
                        deleteConfirmModal.hide();
                        
                        // æ£€æŸ¥æ˜¯å¦åˆ é™¤å½“å‰è¿æ¥çš„æ•°æ®åº“
                        const isDeletingCurrentDb = (window.currentConnectedDbId === window.currentDeleteDbId);
                        
                        fetch(`/databases?id=${window.currentDeleteDbId}`, {
                            method: 'DELETE'
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showAlertModal('æˆåŠŸ', 'æ•°æ®åº“é…ç½®å·²åˆ é™¤', 'success');
                                
                                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è¿æ¥çš„æ•°æ®åº“ï¼Œå…ˆæ–­å¼€è¿æ¥
                                if (isDeletingCurrentDb) {
                                    disconnectFromDatabase();
                                }
                                
                                loadDatabaseList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                            } else {
                                showAlertModal('å¤±è´¥', data.message || 'åˆ é™¤å¤±è´¥', 'danger');
                            }
                        })
                        .catch(error => {
                            showAlertModal('å¤±è´¥', `è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'danger');
                        });
                        
                        // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„æ•°æ®
                        window.currentDeleteDbId = null;
                        window.currentDeleteDbName = null;
                    }
                    // å¤„ç†å¸¸ç”¨SQLåˆ é™¤
                    else if (window.currentDeleteSqlId) {
                        deleteConfirmModal.hide();
                        
                        fetch(`/common_sqls?id=${window.currentDeleteSqlId}`, {
                            method: 'DELETE'
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                showAlertModal('æˆåŠŸ', 'å¸¸ç”¨æŸ¥è¯¢è¯­å¥å·²åˆ é™¤', 'success');
                                loadCommonSqls();
                            } else {
                                showAlertModal('å¤±è´¥', data.message || 'åˆ é™¤å¤±è´¥', 'danger');
                            }
                        })
                        .catch(error => {
                            showAlertModal('å¤±è´¥', `è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'danger');
                        });
                        
                        // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„æ•°æ®
                        window.currentDeleteSqlId = null;
                        window.currentDeleteSqlTitle = null;
                    }
                });
            }
            
            // æ·»åŠ æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å–æ¶ˆå’Œå…³é—­æŒ‰é’®æ­£å¸¸å·¥ä½œ
            const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
            if (deleteConfirmModalEl) {
                deleteConfirmModalEl.addEventListener('hidden.bs.modal', function () {
                    // æ¸…é™¤ä¸´æ—¶å­˜å‚¨çš„æ•°æ®ï¼Œé˜²æ­¢åœ¨å–æ¶ˆæ“ä½œæ—¶ç•™ä¸‹è„æ•°æ®
                    window.currentDeleteDbId = null;
                    window.currentDeleteDbName = null;
                    window.currentDeleteSqlId = null;
                    window.currentDeleteSqlTitle = null;
                    
                    // ç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨éšè—åé‡ç½®çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥æ­£å¸¸æ˜¾ç¤º
                    setTimeout(() => {
                        const modalBackdrop = document.querySelector('.modal-backdrop');
                        if (modalBackdrop) {
                            modalBackdrop.remove();
                        }
                        document.body.classList.remove('modal-open');
                    }, 100);
                });
            }
        });
    

        /**
         * å¯¼å‡ºå•ä¸ªç»“æœï¼ˆæ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†ï¼‰
         * @param {string} queryId - æŸ¥è¯¢ID
         * @param {string} type - å¯¼å‡ºç±»å‹ (excel, csv, html)
         * @param {string} prefix - æ–‡ä»¶åå‰ç¼€
         */
        function exportSingleResult(queryId, type, prefix) {
            // ä¸´æ—¶ä¿å­˜æŸ¥è¯¢IDå’Œå¯¼å‡ºç±»å‹ï¼Œä»¥ä¾¿åœ¨æ¨¡æ€æ¡†ä¸­ä½¿ç”¨
            window.temporaryExportParams = {
                queryId: queryId,
                type: type,
                prefix: prefix
            };
            
            // æ ¹æ®å¯¼å‡ºç±»å‹æ˜¾ç¤ºç›¸åº”çš„é…ç½®æ¨¡æ€æ¡†
            switch(type) {
                case 'excel':
                    showExcelExportModal();
                    break;
                case 'csv':
                    showCsvExportModal();
                    break;
                case 'html':
                    showHtmlExportModal();
                    break;
            }
        }
        
        /**
         * ç¡®è®¤å¯¼å‡ºä¸´æ—¶å‚æ•°æŒ‡å®šçš„ç»“æœ
         * @param {string} type - å¯¼å‡ºç±»å‹
         */
        function confirmTemporaryExport(type) {
            if (!window.temporaryExportParams) {
                showAlertModal('é”™è¯¯', 'å¯¼å‡ºå‚æ•°ä¸¢å¤±ï¼Œè¯·é‡æ–°é€‰æ‹©å¯¼å‡ºé¡¹ï¼', 'danger');
                return;
            }
            
            const { queryId, prefix } = window.temporaryExportParams;
            
            // è·å–ç”¨æˆ·è¾“å…¥çš„æ–‡ä»¶åï¼Œå¦‚æœæœªè¾“å…¥åˆ™ä½¿ç”¨é»˜è®¤åç§°
            let fileName = '';
            switch(type) {
                case 'excel':
                    fileName = document.getElementById('excelFileName')?.value.trim() || (prefix + 'SQLæŸ¥è¯¢ç»“æœ_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-'));
                    break;
                case 'csv':
                    fileName = document.getElementById('csvFileName')?.value.trim() || (prefix + 'SQLæŸ¥è¯¢ç»“æœ_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-'));
                    break;
                case 'html':
                    fileName = document.getElementById('htmlFileName')?.value.trim() || (prefix + 'SQLæŸ¥è¯¢ç»“æœ_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-'));
                    break;
            }
            
            // ç¡®ä¿æ–‡ä»¶æ‰©å±•åæ­£ç¡®
            if (type === 'excel' && !fileName.endsWith('.xlsx')) fileName += '.xlsx';
            if (type === 'csv' && !fileName.endsWith('.csv')) fileName += '.csv';
            if (type === 'html' && !fileName.endsWith('.html')) fileName += '.html';
            
            const params = new URLSearchParams({
                query_id: queryId,
                filename: fileName.replace(/\.(xlsx|csv|html)$/, '') // ç§»é™¤æ‰©å±•åï¼Œåç«¯ä¼šé‡æ–°æ·»åŠ 
            });
            
            // æ·»åŠ ç‰¹å®šç±»å‹çš„å‚æ•°
            switch(type) {
                case 'excel':
                    const headerColor = document.getElementById('excelHeaderColor')?.value || '4472C4';
                    const includeHeader = document.querySelector('input[name="excelIncludeHeader"]:checked')?.value || 'true';
                    params.set('header_color', headerColor);
                    params.set('include_header', includeHeader);
                    break;
                case 'csv':
                    const separator = document.getElementById('csvSeparator')?.value || 'comma';
                    const csvIncludeHeader = document.querySelector('input[name="csvIncludeHeader"]:checked')?.value || 'true';
                    params.set('separator', separator);
                    params.set('include_header', csvIncludeHeader);
                    break;
                case 'html':
                    // HTMLå¯¼å‡ºä¸éœ€è¦é¢å¤–å‚æ•°
                    break;
            }
            
            // å°è¯•ä½¿ç”¨ç°ä»£æµè§ˆå™¨API
            if (window.showSaveFilePicker) {
                try {
                    let exportUrl;
                    switch(type) {
                        case 'excel':
                            exportUrl = '/export_excel?' + params.toString();
                            break;
                        case 'csv':
                            exportUrl = '/export_csv?' + params.toString();
                            break;
                        case 'html':
                            exportUrl = '/export_html?' + params.toString();
                            break;
                    }
                    
                    fetch(exportUrl)
                    .then(response => {
                        if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥');
                        return response.blob();
                    })
                    .then(blob => {
                        return window.showSaveFilePicker({
                            suggestedName: fileName, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ–‡ä»¶å
                            types: [{
                                description: getExportDescription(type),
                                accept: getExportAccept(type)
                            }]
                        }).then(handle => {
                            return handle.createWritable().then(writable => {
                                return writable.write(blob).then(() => {
                                    return writable.close();
                                });
                            });
                        });
                    })
                    .then(() => {
                        // æˆåŠŸä¿å­˜åæ¸…é™¤ä¸´æ—¶å‚æ•°å¹¶éšè—æ¨¡æ€æ¡†
                        window.temporaryExportParams = null;
                        hideCurrentExportModal(type);
                        showAlertModal('æˆåŠŸ', getSuccessMessage(type), 'success');
                    })
                    .catch(err => {
                        if (err.name !== 'AbortError') {
                            console.error('å¯¼å‡ºå¤±è´¥:', err);
                            showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                        }
                    });
                } catch (err) {
                    console.error('å¯¼å‡ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', err);
                    showAlertModal('å¤±è´¥', `å¯¼å‡ºå¤±è´¥ï¼š${err.message}`, 'danger');
                }
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä¼ ç»Ÿä¸‹è½½ï¼Œä½†ä»è¦éšè—æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæç¤º
                let exportUrl;
                switch(type) {
                    case 'excel':
                        exportUrl = '/export_excel?' + params.toString();
                        break;
                    case 'csv':
                        exportUrl = '/export_csv?' + params.toString();
                        break;
                    case 'html':
                        exportUrl = '/export_html?' + params.toString();
                        break;
                }
                
                // å…ˆéšè—æ¨¡æ€æ¡†å¹¶æ˜¾ç¤ºæç¤º
                setTimeout(() => {
                    window.location.href = exportUrl;
                    // æ¸…é™¤ä¸´æ—¶å‚æ•°
                    window.temporaryExportParams = null;
                    hideCurrentExportModal(type);
                    showAlertModal('æç¤º', 'æ–‡ä»¶æ­£åœ¨ä¸‹è½½ä¸­...', 'info');
                }, 300); // ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿æ¨¡æ€æ¡†éšè—å’Œæ¶ˆæ¯æ˜¾ç¤º
            }
        }
        
        /**
         * è·å–å¯¼å‡ºæè¿°
         * @param {string} type - å¯¼å‡ºç±»å‹
         * @returns {string} æè¿°æ–‡æœ¬
         */
        function getExportDescription(type) {
            switch(type) {
                case 'excel':
                    return 'Excel Files';
                case 'csv':
                    return 'CSV Files';
                case 'html':
                    return 'HTML Files';
                default:
                    return 'Files';
            }
        }
        
        /**
         * è·å–å¯¼å‡ºæ¥å—çš„æ–‡ä»¶ç±»å‹
         * @param {string} type - å¯¼å‡ºç±»å‹
         * @returns {Object} acceptå¯¹è±¡
         */
        function getExportAccept(type) {
            switch(type) {
                case 'excel':
                    return {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']};
                case 'csv':
                    return {'text/csv': ['.csv']};
                case 'html':
                    return {'text/html': ['.html']};
                default:
                    return {};
            }
        }
        
        /**
         * è·å–æˆåŠŸæ¶ˆæ¯
         * @param {string} type - å¯¼å‡ºç±»å‹
         * @returns {string} æˆåŠŸæ¶ˆæ¯
         */
        function getSuccessMessage(type) {
            switch(type) {
                case 'excel':
                    return 'Excelæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼';
                case 'csv':
                    return 'CSVæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼';
                case 'html':
                    return 'HTMLæ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼';
                default:
                    return 'æ–‡ä»¶å·²æˆåŠŸä¿å­˜ï¼';
            }
        }
        
        /**
         * éšè—å½“å‰å¯¼å‡ºæ¨¡æ€æ¡†
         * @param {string} type - å¯¼å‡ºç±»å‹
         */
        function hideCurrentExportModal(type) {
            switch(type) {
                case 'excel':
                    if (window.excelExportModal) {
                        window.excelExportModal.hide();
                    }
                    break;
                case 'csv':
                    if (window.csvExportModal) {
                        window.csvExportModal.hide();
                    }
                    break;
                case 'html':
                    if (window.htmlExportModal) {
                        window.htmlExportModal.hide();
                    }
                    break;
            }
        }
        /**
         * å¯¼å‡ºå½“å‰é¡µé¢ä¸Šçš„æ•°æ®åº“é…ç½®
         */
        function exportCurrentDbConfig() {
            // è·å–å½“å‰æ•°æ®åº“é…ç½®
            const databaseList = document.getElementById('databaseList');
            if (!databaseList) {
                console.error('æ‰¾ä¸åˆ°æ•°æ®åº“åˆ—è¡¨å…ƒç´ ');
                showAlertModal('é”™è¯¯', 'æ‰¾ä¸åˆ°æ•°æ®åº“é…ç½®åˆ—è¡¨ï¼', 'danger');
                return;
            }
            
            // æ£€æŸ¥æ‰€æœ‰åŒ…å«æ•°æ®åº“ç›¸å…³è¾“å…¥å­—æ®µçš„å…ƒç´ 
            const dbConfigs = [];
            
            // å°è¯•æŸ¥æ‰¾æ‰€æœ‰åŒ…å«æ•°æ®åº“é…ç½®è¾“å…¥å­—æ®µçš„å…ƒç´ 
            const allElements = databaseList.querySelectorAll('.input-group');
            
            allElements.forEach((element, index) => {
                // æ£€æŸ¥è¿™ä¸ªå…ƒç´ æ˜¯å¦åŒ…å«æ•°æ®åº“é…ç½®å­—æ®µ
                const nameInput = element.querySelector('input[name="name"]');
                const aliasInput = element.querySelector('input[name="alias"]');
                const typeSelect = element.querySelector('select[name="type"]');
                const hostInput = element.querySelector('input[name="host"]');
                const portInput = element.querySelector('input[name="port"]');
                const userInput = element.querySelector('input[name="user"]');
                const passwordInput = element.querySelector('input[name="password"]');
                const databaseInput = element.querySelector('input[name="database"]');
                const idInput = element.querySelector('input[name="id"]');
                
                // å¦‚æœåŒ…å«è¶³å¤Ÿçš„æ•°æ®åº“é…ç½®å­—æ®µï¼Œåˆ™è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“é…ç½®é¡¹
                if (nameInput || aliasInput || hostInput || portInput || 
                    userInput || passwordInput || databaseInput || typeSelect) {
                    
                    const config = {};
                    
                    if (nameInput) config.name = nameInput.value;
                    if (aliasInput) config.alias = aliasInput.value;
                    if (typeSelect) config.type = typeSelect.value;
                    if (hostInput) config.host = hostInput.value;
                    if (portInput) config.port = portInput.value;
                    if (userInput) config.user = userInput.value;
                    if (passwordInput) config.password = passwordInput.value;
                    if (databaseInput) config.database = databaseInput.value;
                    if (idInput) config.id = idInput.value;
                    
                    // å¦‚æœIDä¸å­˜åœ¨ï¼Œç”Ÿæˆä¸€ä¸ª
                    if (!config.id) {
                        config.id = Date.now().toString();
                    }
                    
                    dbConfigs.push(config);
                    console.log(`æ”¶é›†åˆ°é…ç½®é¡¹ ${index + 1}: `, config);
                }
            });
            
            // æç¤ºç”¨æˆ·å¯¼å‡ºæ•°é‡
            if (dbConfigs.length === 0) {
                showAlertModal('æç¤º', 'å½“å‰é¡µé¢ä¸Šæ²¡æœ‰æ•°æ®åº“é…ç½®å¯å¯¼å‡ºï¼è¯·å…ˆæ·»åŠ æ•°æ®åº“é…ç½®ã€‚', 'info');
                return;
            }
            
            console.log(`å‡†å¤‡å¯¼å‡º ${dbConfigs.length} ä¸ªé…ç½®: `, dbConfigs);
            
            // åˆ›å»ºå¹¶ä¸‹è½½JSONæ–‡ä»¶
            const blob = new Blob([JSON.stringify(dbConfigs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'current_db_config.json';
            document.body.appendChild(a);
            
            // è§¦å‘ä¸‹è½½
            a.click();
            
            // æ¸…ç†èµ„æº
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            // æç¤ºç”¨æˆ·å¯¼å‡ºæ•°é‡
            showAlertModal('æˆåŠŸ', `æˆåŠŸå¯¼å‡º ${dbConfigs.length} ä¸ªå½“å‰æ•°æ®åº“é…ç½®ï¼`, 'success');
        }
        
        /**
         * å¯¼å‡ºæœ¬åœ°ä¿å­˜çš„æ•°æ®åº“é…ç½®æ–‡ä»¶
         */
        function exportSavedDbConfig() {
            // å¯¹äºæœ¬åœ°ä¿å­˜çš„é…ç½®ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸‹è½½é“¾æ¥åˆ°æœåŠ¡å™¨ä¸Šçš„db_config.jsonæ–‡ä»¶
            // è¿™å°†è§¦å‘æµè§ˆå™¨ä¸‹è½½æœåŠ¡å™¨ä¸Šçš„åŸå§‹é…ç½®æ–‡ä»¶ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰
            
            // ä»æœåŠ¡å™¨è·å–æœ¬åœ°ä¿å­˜çš„é…ç½®æ–‡ä»¶ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰
            fetch('/get_saved_db_config_with_password')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error('è·å–æœ¬åœ°é…ç½®å¤±è´¥');
                    }
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'saved_db_config.json';
                    document.body.appendChild(a);
                    a.click();
                    
                    // æ¸…ç†èµ„æº
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showAlertModal('æˆåŠŸ', 'æˆåŠŸå¯¼å‡ºæœ¬åœ°ä¿å­˜çš„æ•°æ®åº“é…ç½®ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰ï¼', 'success');
                })
                .catch(error => {
                    console.error('å¯¼å‡ºæœ¬åœ°é…ç½®å¤±è´¥:', error);
                    
                    // å¦‚æœè·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œæç¤ºç”¨æˆ·å¯èƒ½éœ€è¦å…ˆä¿å­˜é…ç½®
                    showAlertModal('æç¤º', 'æœ¬åœ°é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®ï¼Œå°†å¯¼å‡ºå½“å‰é¡µé¢é…ç½®ä½œä¸ºæ›¿ä»£ã€‚', 'info');
                    
                    // ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œå¯¼å‡ºå½“å‰é¡µé¢é…ç½®
                    exportCurrentDbConfig();
                });
        }

        /**
         * è§¦å‘æ•°æ®åº“é…ç½®å¯¼å…¥
         */
        function triggerDbConfigImport() {
            document.getElementById('dbConfigImportInput').click();
        }

        /**
         * å¤„ç†æ•°æ®åº“é…ç½®å¯¼å…¥
         */
        function handleDbConfigImport(input) {
            if (input.files.length === 0) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const configs = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(configs)) {
                        throw new Error('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // å°†å¯¼å…¥çš„é…ç½®å‘é€åˆ°åç«¯ä¿å­˜
                    configs.forEach(config => {
                        // å¦‚æœæ²¡æœ‰IDï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ID
                        if (!config.id) {
                            config.id = 'import_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                        // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨ä¸»æœºä¿¡æ¯ä½œä¸ºåç§°
                        if (!config.name) {
                            config.name = config.host + ':' + config.port;
                        }
                    });
                    
                    // å‘é€æ‰¹é‡ä¿å­˜è¯·æ±‚
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    const sessionToken = localStorage.getItem('app_session_token');
                    if (sessionToken) {
                        headers['X-Session-Token'] = sessionToken;
                    }
                    
                    fetch('/save_db_config', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ databases: configs })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('ä¿å­˜å¯¼å…¥çš„é…ç½®å¤±è´¥');
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            // é‡æ–°åŠ è½½æ•°æ®åº“åˆ—è¡¨ä»¥æ˜¾ç¤ºå¯¼å…¥çš„é…ç½®
                            loadDatabaseList();
                            showAlertModal('æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${configs.length} ä¸ªæ•°æ®åº“é…ç½®ï¼`, 'success');
                        } else {
                            throw new Error(data.message || 'ä¿å­˜å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        showAlertModal('é”™è¯¯', `å¯¼å…¥å¤±è´¥ï¼š${error.message}`, 'danger');
                    });
                    
                } catch (error) {
                    showAlertModal('é”™è¯¯', `å¯¼å…¥å¤±è´¥ï¼š${error.message}`, 'danger');
                } finally {
                    // æ¸…ç©ºinputä»¥å…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
                    input.value = '';
                }
            };
            reader.readAsText(file);
        }

        /**
         * å°†æ•°æ®åº“é…ç½®æ·»åŠ åˆ°åˆ—è¡¨ä¸­
         */
        function addDatabaseToList(config) {
            const databaseList = document.getElementById('databaseList');
            // ä½¿ç”¨ä¼ å…¥çš„IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆæ–°ID
            const dbId = config.id || Date.now().toString();
            const dbName = config.name || 'æœªå‘½åæ•°æ®åº“';
            const dbType = config.type || 'mysql';
            const dbHost = config.host || 'localhost';
            const dbPort = config.port || '3306';
            const dbUser = config.user || '';
            const dbPassword = config.password || '';
            const dbDatabase = config.database || '';
            // ä½¿ç”¨åˆ«åå­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨åç§°
            const dbAlias = config.alias || config.name || 'æœªå‘½åæ•°æ®åº“';
            
            const dbItem = document.createElement('div');
            dbItem.className = 'db-item';
            dbItem.dataset.dbId = dbId;
            dbItem.innerHTML = `
                <div class="input-group mb-2" style="align-items: center;">
                    <input type="hidden" name="id" value="${dbId}">
                    <span class="db-alias-span" onclick="highlightDatabase(this)" style="width: 100px; flex-shrink: 0; margin-right: 5px; padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; background-color: #fff; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${dbAlias}">${dbAlias}</span>
                    <input type="text" name="alias" class="form-control db-alias-input" placeholder="åˆ«å" value="${dbAlias}" style="width: 100px; flex-shrink: 0; margin-right: 5px; display: none;">
                    <input type="text" name="name" class="form-control" placeholder="åç§°" value="${dbName}" style="width: 100px; flex-shrink: 0; margin-right: 5px;">
                    <select name="type" class="form-control" style="min-width: 150px; flex-shrink: 0; margin-right: 5px;">
                        <option value="mysql" ${dbType === 'mysql' ? 'selected' : ''}>MySQL</option>
                        <option value="postgresql" ${dbType === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
                        <option value="oracle" ${dbType === 'oracle' ? 'selected' : ''}>Oracle</option>
                        <option value="sqlserver" ${dbType === 'sqlserver' ? 'selected' : ''}>SQL Server</option>
                        <option value="sqlite" ${dbType === 'sqlite' ? 'selected' : ''}>SQLite</option>
                        <option value="kingbase" ${dbType === 'kingbase' ? 'selected' : ''}>Kingbase(äººå¤§é‡‘ä»“)</option>
                        <option value="tidb" ${dbType === 'tidb' ? 'selected' : ''}>TiDB(å¹³å‡¯)</option>
                        <option value="oceanbase" ${dbType === 'oceanbase' ? 'selected' : ''}>OceanBase(æµ·æ‰¬)</option>
                        <option value="yashandb" ${dbType === 'yashandb' ? 'selected' : ''}>YashanDB(å´–å±±)</option>
                        <option value="shentong" ${dbType === 'shentong' ? 'selected' : ''}>ShenTong(ç¥é€š)</option>
                        <option value="gbase" ${dbType === 'gbase' ? 'selected' : ''}>GBase(å—å¤§é€šç”¨)</option>
                        <option value="highgo" ${dbType === 'highgo' ? 'selected' : ''}>HighGo(ç€šé«˜)</option>
                        <option value="gauss" ${dbType === 'gauss' ? 'selected' : ''}>GaussDB(é«˜æ–¯)</option>
                        <option value="uxdb" ${dbType === 'uxdb' ? 'selected' : ''}>UXDB(ä¼˜å›¾)</option>
                        <option value="vastbase" ${dbType === 'vastbase' ? 'selected' : ''}>Vastbase(æµ·é‡)</option>
                        <option value="greatdb" ${dbType === 'greatdb' ? 'selected' : ''}>GreatDB(å·¨æ‰)</option>
                        <option value="dm" ${dbType === 'dm' ? 'selected' : ''}>DM(è¾¾æ¢¦)</option>
                        <option value="vanward" ${dbType === 'vanward' ? 'selected' : ''}>VanwardDB(ä¸‡é‡Œ)</option>
                    </select>
                    <input type="text" name="host" class="form-control" placeholder="ä¸»æœº" value="${dbHost}" style="width: 120px; flex-shrink: 0; margin-right: 5px;">
                    <input type="text" name="port" class="form-control" placeholder="ç«¯å£" value="${dbPort}" style="width: 70px; flex-shrink: 0; margin-right: 5px;">
                    <input type="text" name="user" class="form-control" placeholder="ç”¨æˆ·å" value="${dbUser}" style="width: 100px; flex-shrink: 0; margin-right: 5px;">
                    <input type="password" name="password" class="form-control" placeholder="å¯†ç " value="${dbPassword}" style="width: 100px; flex-shrink: 0; margin-right: 5px;">
                    <input type="text" name="database" class="form-control" placeholder="æ•°æ®åº“" value="${dbDatabase}" style="width: 100px; flex-shrink: 0; margin-right: 5px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeDatabase(this)" style="margin-right: 5px;">åˆ é™¤</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="connectToDatabase('${dbId}')" style="margin-right: 5px;">è¿æ¥</button>
                    <button type="button" class="btn btn-warning btn-sm" onclick="setAsDefault('${dbId}')" style="margin-right: 5px;">è®¾ä¸ºé»˜è®¤</button>
                </div>
            `;
            databaseList.appendChild(dbItem);
        }
        /**
         * ä»åˆ—è¡¨ä¸­ç§»é™¤æ•°æ®åº“é…ç½®é¡¹
         */
        function removeDatabase(button) {
            // è·å–æŒ‰é’®æ‰€åœ¨çš„æ•°æ®åº“é¡¹
            const dbItem = button.closest('.common-sql-item');
            if (dbItem) {
                // è·å–æ•°æ®åº“åç§°ç”¨äºåç»­å¤„ç†
                const nameSpan = dbItem.querySelector('.common-sql-name');
                if (nameSpan) {
                    const dbName = nameSpan.textContent.split(' [')[0]; // æå–æ•°æ®åº“åç§°
                    
                    // æŸ¥æ‰¾æ•°æ®åº“å¯¹è±¡è·å–ID
                    const db = window.allDatabasesCache ? window.allDatabasesCache.find(d => d.name === dbName) : null;
                    if (db) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ä½¿ç”¨çš„æ•°æ®åº“è¿æ¥
                        if (window.currentConnectedDbId === db.id) {
                            // å¦‚æœæ˜¯å½“å‰è¿æ¥çš„æ•°æ®åº“ï¼Œæ–­å¼€è¿æ¥
                            disconnectFromDatabase();
                        }
                    }
                }
                
                // ä»DOMä¸­ç§»é™¤è¯¥é¡¹
                dbItem.remove();
            }
        }
        
        /**
         * æ–­å¼€æ•°æ®åº“è¿æ¥
         */
        function disconnectFromDatabase() {
            window.currentConnectedDbId = null;
            window.currentConnectedDbType = null;
            currentSelectedDbId = null;  // åŒæ—¶é‡ç½®å½“å‰é€‰ä¸­çš„æ•°æ®åº“ID
            // æ›´æ–°UIçŠ¶æ€
            const connectStatus = document.getElementById('connectStatus');
            if (connectStatus) {
                connectStatus.textContent = 'æœªè¿æ¥';
                connectStatus.className = 'badge bg-secondary';
            }
            
            // æ¸…é™¤æ•°æ®åº“é¡¹çš„é€‰ä¸­çŠ¶æ€
            const allItems = document.querySelectorAll('#databaseList .common-sql-item');
            allItems.forEach(item => {
                item.classList.remove('selected-db');
            });
            
            // æ¸…é™¤å½“å‰æ•°æ®åº“åç§°æ˜¾ç¤º
            const currentDbName = document.getElementById('currentDbName');
            if (currentDbName) {
                currentDbName.textContent = 'æ— ';
            }
        }


        /**
         * æ‰“å¼€æ•°æ®åº“é…ç½®é€‰æ‹©å¯¼å‡ºæ¨¡æ€æ¡†
         */
        function openDbConfigSelectionModal() {
            // ä»æœåŠ¡å™¨è·å–æœ¬åœ°ä¿å­˜çš„æ‰€æœ‰æ•°æ®åº“é…ç½®
            fetch('/get_saved_db_config')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('è·å–æœ¬åœ°é…ç½®å¤±è´¥');
                    }
                })
                .then(configs => {
                    showDbConfigSelectionModal(configs);
                })
                .catch(error => {
                    console.error('è·å–æœ¬åœ°é…ç½®å¤±è´¥:', error);
                    
                    // å¦‚æœè·å–æœåŠ¡å™¨é…ç½®å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æœ¬åœ°é…ç½®æ–‡ä»¶ä¸å­˜åœ¨
                    showAlertModal('æç¤º', 'æœ¬åœ°é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®ï¼Œè¯·å…ˆä¿å­˜é…ç½®åå†å¯¼å‡ºã€‚', 'info');
                });
        }
        
        /**
         * æ˜¾ç¤ºæ•°æ®åº“é…ç½®é€‰æ‹©å¯¼å‡ºæ¨¡æ€æ¡†
         */
        function showDbConfigSelectionModal(configs) {
            // å­˜å‚¨é…ç½®åˆ°å…¨å±€å˜é‡ä»¥ä¾¿åç»­è®¿é—®
            window.currentDbConfigs = configs;
            
            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            let configItems = '';
            configs.forEach((config, index) => {
                const displayName = config.alias || config.name || `æ•°æ®åº“ ${index + 1}`;
                configItems += `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="${index}" id="configCheck${index}">
                    <label class="form-check-label" for="configCheck${index}">
                        ${displayName} (${config.type || 'unknown'}) - ${config.host}:${config.port} (${config.database || 'default'})
                    </label>
                </div>`;
            });
            
            const modalHtml = `
            <div class="modal fade" id="dbConfigSelectionModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">é€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®åº“é…ç½®</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“é…ç½®è¿›è¡Œå¯¼å‡ºï¼š</p>
                            <div id="configSelectionList">
                                ${configItems}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="exportSelectedConfigs()">å¯¼å‡ºé€‰ä¸­é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalElement = document.getElementById('dbConfigSelectionModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†DOM
            modalElement.addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }
        
        /**
         * æ˜¾ç¤ºæ•°æ®åº“é…ç½®é€‰æ‹©å¯¼å‡ºæ¨¡æ€æ¡†
         */
        function showDbConfigSelectionModal(configs) {
            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            let configItems = '';
            configs.forEach((config, index) => {
                const displayName = config.alias || config.name || `æ•°æ®åº“ ${index + 1}`;
                configItems += `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="${index}" id="configCheck${index}">
                    <label class="form-check-label" for="configCheck${index}">
                        ${displayName} (${config.type || 'unknown'}) - ${config.host}:${config.port} (${config.database || 'default'})
                    </label>
                </div>`;
            });
            
            const modalHtml = `
            <div class="modal fade" id="dbConfigSelectionModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">é€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®åº“é…ç½®</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“é…ç½®è¿›è¡Œå¯¼å‡ºï¼š</p>
                            <div id="configSelectionList">
                                ${configItems}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="exportSelectedConfigs()">å¯¼å‡ºé€‰ä¸­é…ç½®</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalElement = document.getElementById('dbConfigSelectionModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†DOM
            modalElement.addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }
    
    
        // åº”ç”¨å¯†ç éªŒè¯åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†åº”ç”¨å¯†ç 
            fetch('/has_app_password')
                .then(response => response.json())
                .then(response => {
                    const hasPassword = response.has_password;
                            
                    // å¦‚æœè®¾ç½®äº†å¯†ç ï¼Œåˆ™æ˜¾ç¤ºå¯†ç éªŒè¯æ¨¡æ€æ¡†
                    if (hasPassword) {
                        showPasswordModal();
                    } else {
                        // å¦‚æœæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œæ˜¾ç¤ºè®¾ç½®å¯†ç æ¨¡æ€æ¡†
                        showSetPasswordModal();
                    }
                })
                .catch(error => {
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºå¯†ç æ¨¡æ€æ¡†
                    console.error('æ£€æŸ¥å¯†ç çŠ¶æ€å¤±è´¥:', error);
                    showPasswordModal();
                });
        
            // æ˜¾ç¤ºå¯†ç éªŒè¯æ¨¡æ€æ¡†
            function showPasswordModal() {
                // é¦–å…ˆç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                const overlay = document.getElementById('passwordOverlay');
                if (overlay) {
                    // ç¡®ä¿è¦†ç›–å±‚çš„z-indexè¶³å¤Ÿé«˜
                    overlay.style.zIndex = '9999';
                    // æ˜¾ç¤ºè¦†ç›–å±‚å¹¶è®¾ç½®ä¸ºflexå¸ƒå±€
                    overlay.style.display = 'flex';
                    console.log('å¯†ç è¦†ç›–å±‚å·²æ˜¾ç¤º');
                } else {
                    console.log('è­¦å‘Šï¼šæœªæ‰¾åˆ° passwordOverlay å…ƒç´ ');
                }
            }
        
            // æ˜¾ç¤ºè®¾ç½®å¯†ç æ¨¡æ€æ¡†
            function showSetPasswordModal() {
                try {
                    // éšè—éªŒè¯å¯†ç çš„è¦†ç›–å±‚
                    const overlay = document.getElementById('passwordOverlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                            
                    // æ˜¾ç¤ºè®¾ç½®å¯†ç æ¨¡æ€æ¡†
                    const setModalElement = document.getElementById('setPasswordModal');
                    if (setModalElement) {
                        // åŒæ—¶è®¾ç½®showç±»ã€displayã€roleå’Œaria-modalï¼Œå››è€…ç¼ºä¸€ä¸å¯
                        setModalElement.classList.add('show');
                        setModalElement.style.display = 'block';
                        setModalElement.setAttribute('aria-modal', 'true');
                        setModalElement.setAttribute('role', 'dialog');
                        
                        // åŒæ—¶ä½¿ç”¨Bootstrap Modalç±»æ¥ç¡®ä¿æ­£ç¡®åˆå§‹åŒ–ï¼Œé…ç½®ä¸ºç‚¹å‡»å¤–éƒ¨ä¸å…³é—­
                        const modalInstance = new bootstrap.Modal(setModalElement, {
                            backdrop: 'static',
                            keyboard: false  // åŒæ—¶ç¦ç”¨ESCé”®å…³é—­
                        });
                        modalInstance.show();
                    } else {
                        console.error('setPasswordModal element not found');
                    }
                            
                    
                            
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                } catch (error) {
                    console.error('Error in showSetPasswordModal:', error);
                }
            }
        
            // å¯†ç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            const appPasswordInput = document.getElementById('appPassword');
            if (appPasswordInput) {
                appPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') { // å›è½¦é”®
                        const passwordForm = document.getElementById('passwordForm');
                        if (passwordForm) {
                            passwordForm.dispatchEvent(new Event('submit', {cancelable: true}));
                        }
                    }
                });
            }
        
            // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
            const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');
            if (togglePasswordVisibility) {
                togglePasswordVisibility.addEventListener('click', function() {
                    const passwordField = document.getElementById('appPassword');
                    if (passwordField) {
                        const isVisible = passwordField.type === 'text';
                        
                        if (isVisible) {
                            passwordField.type = 'password';
                            this.textContent = 'ğŸ‘ï¸'; // æ˜¾ç¤ºçœ¼ç›å›¾æ ‡
                        } else {
                            passwordField.type = 'text';
                            this.textContent = 'ğŸ™ˆ'; // æ˜¾ç¤ºéšè—çœ¼ç›å›¾æ ‡
                        }
                    }
                });
            }
        
            // å¤„ç†å¯†ç éªŒè¯è¡¨å•æäº¤
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                            
                    const passwordInput = document.getElementById('appPassword');
                    const password = passwordInput ? passwordInput.value : '';
                            
                    fetch('/check_app_password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({password: password})
                    })
                    .then(response => response.json())
                .then(response => {
                    if (response.status === 'success') {
                        // éªŒè¯æˆåŠŸï¼Œä¿å­˜ä¼šè¯ä»¤ç‰Œ
                        if (response.session_token) {
                            // å°†ä¼šè¯ä»¤ç‰Œå­˜å‚¨åœ¨localStorageä¸­ï¼Œä¾›åç»­APIè°ƒç”¨ä½¿ç”¨
                            localStorage.setItem('app_session_token', response.session_token);
                        }
                                        
                        // éšè—è¦†ç›–å±‚å¹¶æ˜¾ç¤ºä¸»å†…å®¹
                        const overlay = document.getElementById('passwordOverlay');
                        if (overlay) {
                            overlay.style.display = 'none'; // éšè—è€Œéç§»é™¤è¦†ç›–å±‚
                        }
                                        
                        const mainContent = document.getElementById('mainContent');
                        if (mainContent) {
                            // ç§»é™¤æ‰€æœ‰é™åˆ¶æ ·å¼ï¼Œç¡®ä¿å®Œå…¨å¯è§å’Œå¯äº¤äº’
                            mainContent.style.display = 'block';
                            mainContent.style.opacity = '1';
                            mainContent.style.pointerEvents = 'auto';
                            mainContent.style.visibility = 'visible';
                                            
                            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¿‡æ¸¡æ•ˆæœï¼Œç«‹å³ç”Ÿæ•ˆ
                            mainContent.style.transition = 'none';
                        }
                                        
                        // ç¡®ä¿bodyå¯ä»¥æ»šåŠ¨
                        document.body.style.overflow = 'auto';
                                        
                        // ç¡®ä¿é¡µé¢çš„CSSç±»ä¸ä¼šå¹²æ‰°
                        document.body.className = document.body.className.replace(/\banimated-bg\b/g, '');
                                        
                        // éªŒè¯æˆåŠŸåï¼Œå¦‚æœæœ‰é”™è¯¯æ¨¡æ€æ¡†æ˜¾ç¤ºï¼Œéœ€è¦ç§»é™¤å®ƒ
                        const errorModalElement = document.getElementById('passwordErrorModal');
                        if (errorModalElement) {
                            errorModalElement.classList.remove('show');
                            errorModalElement.style.display = 'none';
                            errorModalElement.removeAttribute('aria-modal');
                            errorModalElement.removeAttribute('role');
                        }
                                        
                        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„èƒŒæ™¯é®ç½©
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                                        
                        // æ¢å¤bodyæ ·å¼
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                                        
                        // è®¾ç½®å®šæ—¶å™¨ï¼Œ30åˆ†é’Ÿåè‡ªåŠ¨å›åˆ°é”å®šé¡µé¢
                        startAutoLockTimer();
                    } else {
                        // éªŒè¯å¤±è´¥ï¼Œå…ˆæ¸…ç©ºå¯†ç è¾“å…¥æ¡†
                        document.getElementById('appPassword').value = '';
                                        
                        // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                        document.getElementById('errorMessageText').textContent = response.message || 'å¯†ç é”™è¯¯';
                                                                
                        // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                        const errorModalElement = document.getElementById('passwordErrorModal');
                        // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                        errorModalElement.classList.add('show');
                        errorModalElement.style.display = 'block';
                        errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                        errorModalElement.setAttribute('aria-modal', 'true');
                        errorModalElement.setAttribute('role', 'dialog');
                                                
                        // æ·»åŠ èƒŒæ™¯é®ç½©
                        let backdrop = document.querySelector('.modal-backdrop.error-message-backdrop');
                        if (!backdrop) {
                            backdrop = document.createElement('div');
                            backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                            backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                            document.body.appendChild(backdrop);
                        }
                                                
                        // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                        document.body.style.overflow = 'hidden';
                        document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                        
                        // ç¡®ä¿å¯†ç è¾“å…¥æ¡†é‡æ–°è·å¾—ç„¦ç‚¹
                        setTimeout(() => {
                            document.getElementById('appPassword').focus();
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('å¯†ç éªŒè¯è¯·æ±‚å¤±è´¥:', error);
                            
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'éªŒè¯è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                                            
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    let backdrop = document.querySelector('.modal-backdrop.error-message-backdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                        backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                        document.body.appendChild(backdrop);
                    }
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                });
            });
                        
            // ç¡®è®¤è®¾ç½®å¯†ç 
            window.confirmSetPassword = function() {
                const pwd1 = document.getElementById('newPassword1').value;
                const pwd2 = document.getElementById('newPassword2').value;
                        
                if (pwd1 !== pwd2) {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼';
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                    return;
                }
                                
                if (pwd1.trim() === '') {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'å¯†ç ä¸èƒ½ä¸ºç©ºï¼';
                                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                                    
                    return;
                }
                
                // æ£€æŸ¥å¯†ç å¼ºåº¦ï¼ˆå¦‚æœå¯ç”¨äº†å¯†ç å¼ºåº¦éªŒè¯ï¼‰
                // è·å–å½“å‰é…ç½®ä¸­çš„å¯†ç å¼ºåº¦éªŒè¯è®¾ç½®
                let passwordStrengthRequired = false;
                try {
                    // å¦‚æœé…ç½®å¯ç”¨ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¯†ç å¼ºåº¦éªŒè¯
                    if (window.appConfig && typeof window.appConfig.app_password_strength_required !== 'undefined') {
                        passwordStrengthRequired = window.appConfig.app_password_strength_required;
                    } else {
                        // å¦‚æœé…ç½®ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä»é¡µé¢å…ƒç´ æˆ–å…¶ä»–é€”å¾„è·å–é…ç½®çŠ¶æ€
                        // æˆ–è€…ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¦‚æœç”¨æˆ·å·²ç»çŸ¥é“å¯ç”¨äº†å¼ºå¯†ç éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥æ€»æ˜¯è¿›è¡ŒéªŒè¯
                        // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶è·³è¿‡å‰ç«¯éªŒè¯ï¼Œä¾èµ–åç«¯éªŒè¯ï¼Œä½†åœ¨ç•Œé¢ä¸Šç»™ç”¨æˆ·ä¸€äº›æç¤º
                        console.log('åº”ç”¨é…ç½®å°šæœªåŠ è½½å®Œæˆï¼Œå°†ä¾èµ–åç«¯è¿›è¡Œå¯†ç å¼ºåº¦éªŒè¯');
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥å¯†ç å¼ºåº¦é…ç½®æ—¶å‡ºé”™:', e);
                    passwordStrengthRequired = false;
                }
                                
                if (passwordStrengthRequired) {
                    const passwordValidationResult = validatePasswordStrength(pwd1);
                    if (!passwordValidationResult.isValid) {
                        // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                        document.getElementById('errorMessageText').textContent = passwordValidationResult.reason;
                                                    
                        // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                        const errorModalElement = document.getElementById('passwordErrorModal');
                        // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                        errorModalElement.classList.add('show');
                        errorModalElement.style.display = 'block';
                        errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                        errorModalElement.setAttribute('aria-modal', 'true');
                        errorModalElement.setAttribute('role', 'dialog');
                                                    
                        // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                        const existingBackdrops = document.querySelectorAll('.modal-backdrop, .error-message-backdrop');
                        existingBackdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                                                    
                        // æ·»åŠ èƒŒæ™¯é®ç½©
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                        backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                        document.body.appendChild(backdrop);
                                                    
                        // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                        document.body.style.overflow = 'hidden';
                        document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                                    
                        return;
                    }
                }
                                    
                // å‘é€è®¾ç½®å¯†ç è¯·æ±‚
                fetch('/set_app_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({password: pwd1, confirm_password: pwd2})
                })
                .then(response => response.json())
                .then(response => {
                    if (response.status === 'success') {
                        // è®¾ç½®æˆåŠŸï¼Œéšè—è®¾ç½®å¯†ç æ¨¡æ€æ¡†
                        hideModal('setPasswordModal');
                                                
                        // éšè—å¯†ç è¦†ç›–å±‚å¹¶æ˜¾ç¤ºä¸»å†…å®¹
                        const overlay = document.getElementById('passwordOverlay');
                        if (overlay) {
                            overlay.style.display = 'none';
                        }
                                        
                        const mainContent = document.getElementById('mainContent');
                        if (mainContent) {
                            // ç§»é™¤æ‰€æœ‰é™åˆ¶æ ·å¼ï¼Œç¡®ä¿å®Œå…¨å¯è§å’Œå¯äº¤äº’
                            mainContent.style.display = 'block';
                            mainContent.style.opacity = '1';
                            mainContent.style.pointerEvents = 'auto';
                            mainContent.style.visibility = 'visible';
                                            
                            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¿‡æ¸¡æ•ˆæœï¼Œç«‹å³ç”Ÿæ•ˆ
                            mainContent.style.transition = 'none';
                        }
                                        
                        // ç¡®ä¿bodyå¯ä»¥æ»šåŠ¨
                        document.body.style.overflow = 'auto';
                                        
                        // ç¡®ä¿é¡µé¢çš„CSSç±»ä¸ä¼šå¹²æ‰°
                        var className = document.body.className;
                        document.body.className = className.split('animated-bg').join('');
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showSuccessMessage('å¯†ç è®¾ç½®æˆåŠŸï¼');
                    } else {
                        // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                        document.getElementById('errorMessageText').textContent = response.message || 'å¯†ç è®¾ç½®å¤±è´¥';
                                
                        // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                        const errorModalElement = document.getElementById('passwordErrorModal');
                        // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                        errorModalElement.classList.add('show');
                        errorModalElement.style.display = 'block';
                        errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºotherå…ƒç´ çš„z-index
                        errorModalElement.setAttribute('aria-modal', 'true');
                        errorModalElement.setAttribute('role', 'dialog');
                                
                        // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                        const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                        existingBackdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                        
                        // æ·»åŠ èƒŒæ™¯é®ç½©
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                        backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºotherå†…å®¹çš„z-index
                        document.body.appendChild(backdrop);
                                
                        // æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿ç”¨æˆ·é‡æ–°è¾“å…¥
                        const newPassword1 = document.getElementById('newPassword1');
                        const newPassword2 = document.getElementById('newPassword2');
                        
                        if (newPassword1) {
                            newPassword1.value = '';
                            setTimeout(() => {
                                newPassword1.focus(); // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                            }, 100);
                        }
                        if (newPassword2) {
                            newPassword2.value = '';
                        }
                                
                        // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                        document.body.style.overflow = 'hidden';
                        document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                    }
                })
                .catch(error => {
                    console.error('è®¾ç½®å¯†ç è¯·æ±‚å¤±è´¥:', error);
                            
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'è®¾ç½®å¯†ç è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                            
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºotherå…ƒç´ çš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                            
                    // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                    existingBackdrops.forEach(backdrop => {
                        backdrop.remove();
                    });
                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºotherå†…å®¹çš„z-index
                    document.body.appendChild(backdrop);
                            
                    // æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿ç”¨æˆ·é‡æ–°è¾“å…¥
                    const newPassword1 = document.getElementById('newPassword1');
                    const newPassword2 = document.getElementById('newPassword2');
                    
                    if (newPassword1) {
                        newPassword1.value = '';
                        setTimeout(() => {
                            newPassword1.focus(); // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                        }, 100);
                    }
                    if (newPassword2) {
                        newPassword2.value = '';
                    }
                            
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                });
            };
        
            // ç¡®è®¤ä¿®æ”¹å¯†ç 
            window.confirmChangePassword = function() {
                const currentPwd = document.getElementById('currentPassword').value;
                const newPwd1 = document.getElementById('changeNewPassword1').value;
                const newPwd2 = document.getElementById('changeNewPassword2').value;
                        
                if (currentPwd.trim() === '') {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'åŸå¯†ç ä¸å¯¹';
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                    return;
                }
                                
                if (newPwd1 !== newPwd2) {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'æ–°è¾“å…¥å¯†ç ä¸ä¸€è‡´';
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                    return;
                }
                                
                if (newPwd1.trim() === '') {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼';
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                    return;
                }
                                
                if (newPwd1.trim() === '') {
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = 'æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼';
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                    return;
                }

                // æ£€æŸ¥å¯†ç å¼ºåº¦ï¼ˆå¦‚æœå¯ç”¨äº†å¯†ç å¼ºåº¦éªŒè¯ï¼‰
                // è·å–å½“å‰é…ç½®ä¸­çš„å¯†ç å¼ºåº¦éªŒè¯è®¾ç½®
                let passwordStrengthRequired = false;
                try {
                    // å¦‚æœé…ç½®å¯ç”¨ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¯†ç å¼ºåº¦éªŒè¯
                    if (window.appConfig && typeof window.appConfig.app_password_strength_required !== 'undefined') {
                        passwordStrengthRequired = window.appConfig.app_password_strength_required;
                    } else {
                        // å¦‚æœé…ç½®ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä»é¡µé¢å…ƒç´ æˆ–å…¶ä»–é€”å¾„è·å–é…ç½®çŠ¶æ€
                        // æˆ–è€…ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¦‚æœç”¨æˆ·å·²ç»çŸ¥é“å¯ç”¨äº†å¼ºå¯†ç éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥æ€»æ˜¯è¿›è¡ŒéªŒè¯
                        // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶è·³è¿‡å‰ç«¯éªŒè¯ï¼Œä¾èµ–åç«¯éªŒè¯ï¼Œä½†åœ¨ç•Œé¢ä¸Šç»™ç”¨æˆ·ä¸€äº›æç¤º
                        console.log('åº”ç”¨é…ç½®å°šæœªåŠ è½½å®Œæˆï¼Œå°†ä¾èµ–åç«¯è¿›è¡Œå¯†ç å¼ºåº¦éªŒè¯');
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥å¯†ç å¼ºåº¦é…ç½®æ—¶å‡ºé”™:', e);
                    passwordStrengthRequired = false;
                }
                
                if (passwordStrengthRequired) {
                    const passwordValidationResult = validatePasswordStrength(newPwd1);
                    if (!passwordValidationResult.isValid) {
                        // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                        document.getElementById('errorMessageText').textContent = passwordValidationResult.reason;
                                    
                        // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                        const errorModalElement = document.getElementById('passwordErrorModal');
                        // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                        errorModalElement.classList.add('show');
                        errorModalElement.style.display = 'block';
                        errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                        errorModalElement.setAttribute('aria-modal', 'true');
                        errorModalElement.setAttribute('role', 'dialog');
                                    
                        // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                        const existingBackdrops = document.querySelectorAll('.modal-backdrop, .error-message-backdrop');
                        existingBackdrops.forEach(backdrop => {
                            backdrop.remove();
                        });
                                    
                        // æ·»åŠ èƒŒæ™¯é®ç½©
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                        backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                        document.body.appendChild(backdrop);
                                    
                        // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                        document.body.style.overflow = 'hidden';
                        document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                                    
                        return;
                    }
                }
                        
                // é¦–å…ˆéªŒè¯å½“å‰å¯†ç æ˜¯å¦æ­£ç¡®
                fetch('/check_app_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({password: currentPwd})
                })
                .then(response => response.json())
                .then(response => {
                    if (response.status === 'success') {
                        // å½“å‰å¯†ç éªŒè¯é€šè¿‡ï¼Œè®¾ç½®æ–°å¯†ç 
                        return fetch('/set_app_password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({password: newPwd1, confirm_password: newPwd2})
                        }).then(function(setResponse) {
                            return setResponse.json();
                        });
                    } else {
                        throw new Error('åŸå¯†ç ä¸å¯¹');
                    }
                })
                .then(response => {
                    if (response && response.status === 'success') {
                        // ä¿®æ”¹æˆåŠŸï¼Œéšè—ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
                        hideModal('changePasswordModal');
                                                
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showSuccessMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•ã€‚');
                                                
                        // é‡æ–°æ˜¾ç¤ºå¯†ç éªŒè¯è¦†ç›–å±‚
                        showPasswordModal();
                    } else {
                        throw new Error(response.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
                    }
                })
                .catch(error => {
                    const errorMessage = error.message || 'å¯†ç éªŒè¯æˆ–ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•';
                    // æ›´æ–°é”™è¯¯æ¶ˆæ¯
                    document.getElementById('errorMessageText').textContent = errorMessage;
                                    
                    // ç«‹å³æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
                    const errorModalElement = document.getElementById('passwordErrorModal');
                    // ä½¿ç”¨åŸç”ŸDOMæ–¹æ³•æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œé¿å…Bootstrapå®ä¾‹é—®é¢˜
                    errorModalElement.classList.add('show');
                    errorModalElement.style.display = 'block';
                    errorModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                    errorModalElement.setAttribute('aria-modal', 'true');
                    errorModalElement.setAttribute('role', 'dialog');
                                    
                    // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©ï¼ˆå¦‚æœæœ‰ï¼‰
                    const existingBackdrop = document.querySelector('.modal-backdrop');
                    if (existingBackdrop) {
                        existingBackdrop.remove();
                    }
                                    
                    // æ·»åŠ èƒŒæ™¯é®ç½©
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show error-message-backdrop';
                    backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                    document.body.appendChild(backdrop);
                                    
                    // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                    document.body.style.overflow = 'hidden';
                    document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ¸…ç©ºå“ªäº›è¾“å…¥æ¡†ï¼Œä½†ä¿æŒæ¨¡æ€æ¡†æ‰“å¼€
                    if (errorMessage.includes('åŸå¯†ç ä¸å¯¹')) {
                        // å¦‚æœæ˜¯å½“å‰å¯†ç é”™è¯¯ï¼Œåªæ¸…ç©ºå½“å‰å¯†ç å­—æ®µï¼Œä½†ä¿æŒæ¨¡æ€æ¡†æ‰“å¼€
                        const currentPassword = document.getElementById('currentPassword');
                        if (currentPassword) {
                            currentPassword.value = '';
                        }
                    } else if (errorMessage.includes('å¯†ç ä¸ä¸€è‡´')) {
                        // å¦‚æœæ˜¯æ–°å¯†ç ä¸ä¸€è‡´ï¼Œæ¸…ç©ºæ–°å¯†ç å­—æ®µï¼Œä½†ä¿æŒæ¨¡æ€æ¡†æ‰“å¼€
                        const changeNewPassword1 = document.getElementById('changeNewPassword1');
                        const changeNewPassword2 = document.getElementById('changeNewPassword2');
                        if (changeNewPassword1) {
                            changeNewPassword1.value = '';
                        }
                        if (changeNewPassword2) {
                            changeNewPassword2.value = '';
                        }
                    }
                });
            };
        
            // éšè—æ¨¡æ€æ¡†çš„é€šç”¨å‡½æ•°
            function hideModal(modalId) {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.classList.remove('show');
                    modalElement.style.display = 'none';
                    modalElement.removeAttribute('aria-modal');
                    modalElement.removeAttribute('role');
                    
                    // ç§»é™¤å¯¹åº”çš„èƒŒæ™¯é®ç½©
                    let backdrop;
                    if (modalId === 'setPasswordModal' || modalId === 'changePasswordModal') {
                        backdrop = document.querySelector('.modal-backdrop.general-modal-backdrop');
                    } else if (modalId === 'successMessageModal') {
                        backdrop = document.querySelector('.modal-backdrop.success-message-backdrop');
                    } else if (modalId === 'passwordErrorModal') {
                        backdrop = document.querySelector('.modal-backdrop.error-message-backdrop');
                    } else {
                        // é€šç”¨æŸ¥æ‰¾
                        backdrop = document.querySelector('.modal-backdrop');
                    }
                    
                    if (backdrop) {
                        backdrop.remove();
                    }
                }
            }
        
            // è‡ªåŠ¨é”å®šå®šæ—¶å™¨
            let autoLockTimer = null;
                    
            // ä»åç«¯è·å–åº”ç”¨é…ç½®
            let appConfig = {
                auto_lock_timeout_minutes: 30,
                auto_lock_reminder_minutes: 25,
                app_title: 'æœé˜³æ•°æ®'
            }; // é»˜è®¤é…ç½®
            
            // è·å–åº”ç”¨é…ç½®
            fetch('/get_app_config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.status === 'success' && data.config) {
                        appConfig = data.config;
                        console.log('åº”ç”¨é…ç½®åŠ è½½æˆåŠŸ:', appConfig);
                        
                        // éªŒè¯é…ç½®å€¼
                        if (typeof appConfig.app_auto_lock_timeout_minutes !== 'number' ||
                            typeof appConfig.app_auto_lock_reminder_minutes !== 'number' ||
                            appConfig.app_auto_lock_timeout_minutes <= 0 || 
                            appConfig.app_auto_lock_reminder_minutes <= 0 ||
                            appConfig.app_auto_lock_reminder_minutes >= appConfig.app_auto_lock_timeout_minutes) {
                            console.warn('è·å–çš„åº”ç”¨é…ç½®å€¼ä¸åˆç†ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                            appConfig = {
                                app_auto_lock_timeout_minutes: 30,
                                app_auto_lock_reminder_minutes: 25,
                                app_title: 'æœé˜³æ•°æ®'
                            };
                        }
                        
                        // æ›´æ–°é¡µé¢æ ‡é¢˜
                        const pageTitle = appConfig.app_title || 'æœé˜³æ•°æ®';
                        document.title = pageTitle;
                        
                        // æ›´æ–°å¤´éƒ¨æ ‡é¢˜æ˜¾ç¤º
                        const headerTitleElement = document.querySelector('.header-title');
                        if (headerTitleElement && headerTitleElement.textContent.includes('æœé˜³æ•°æ®')) {
                            headerTitleElement.textContent = pageTitle;
                        }
                    } else {
                        console.warn('è·å–åº”ç”¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                        
                        // ä½¿ç”¨é»˜è®¤æ ‡é¢˜
                        document.title = 'æœé˜³æ•°æ®';
                    }
                })
                .catch(error => {
                    console.error('è·å–åº”ç”¨é…ç½®å‡ºé”™ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
                    
                    // ä½¿ç”¨é»˜è®¤æ ‡é¢˜
                    document.title = 'æœé˜³æ•°æ®';
                });

            // å…¨å±€å˜é‡å­˜å‚¨æé†’å®šæ—¶å™¨
            let reminderTimer = null;
            let isAutoLockActive = true; // æ ‡è®°è‡ªåŠ¨é”å®šæ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€

            // å¼€å§‹è‡ªåŠ¨é”å®šå®šæ—¶å™¨
            function startAutoLockTimer() {
                // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨
                if (autoLockTimer) {
                    clearTimeout(autoLockTimer);
                }
                
                if (reminderTimer) {
                    clearTimeout(reminderTimer);
                }
                
                // è®¾ç½®ä¸ºæ´»åŠ¨çŠ¶æ€
                isAutoLockActive = true;
                
                // è®¡ç®—æé†’æ—¶é—´å’Œé”å®šæ—¶é—´ï¼ˆä»é…ç½®ä¸­è·å–ï¼Œè½¬æ¢ä¸ºæ¯«ç§’ï¼‰
                const reminderMinutes = appConfig.app_auto_lock_reminder_minutes || 25;
                const timeoutMinutes = appConfig.app_auto_lock_timeout_minutes || 30;
                const remainingMinutes = timeoutMinutes - reminderMinutes; // æé†’æ—¶å‰©ä½™æ—¶é—´
                
                // è®¾ç½®æé†’å®šæ—¶å™¨
                reminderTimer = setTimeout(function() {
                    // æ£€æŸ¥è‡ªåŠ¨é”å®šæ˜¯å¦ä»ç„¶æ¿€æ´»
                    if (!isAutoLockActive) {
                        return;
                    }
                    
                    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰æé†’æ¨¡æ€æ¡†ï¼Œé¿å…é‡å¤åˆ›å»º
                    const existingReminder = document.getElementById('autoLockReminderModal');
                    if (existingReminder) {
                        // å¦‚æœå·²æœ‰æé†’æ¨¡æ€æ¡†ï¼Œä¸åˆ›å»ºæ–°çš„
                        return;
                    }
                    
                    // åˆ›å»ºæé†’æ¨¡æ€æ¡†
                    const reminderModal = document.createElement('div');
                    reminderModal.className = 'modal';
                    reminderModal.id = 'autoLockReminderModal';
                    reminderModal.tabIndex = -1;
                    reminderModal.setAttribute('aria-labelledby', 'autoLockReminderModalLabel');
                    reminderModal.setAttribute('aria-hidden', 'true');
                    reminderModal.innerHTML = `
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
                                    <h5 class="modal-title" id="autoLockReminderModalLabel">â° è‡ªåŠ¨é”å®šæé†’</h5>
                                </div>
                                <div class="modal-body">
                                    <p>ç³»ç»Ÿå°†åœ¨${remainingMinutes}åˆ†é’Ÿåè‡ªåŠ¨é”å®šï¼Œæ˜¯å¦ç»§ç»­ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Ÿ</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="continueActivityBtn">ç»§ç»­ä¿æŒ</button>
                                    <button type="button" class="btn btn-warning" id="immediateLockBtn">ç«‹å³é”å®š</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(reminderModal);
                    
                    // è·å–æŒ‰é’®å…ƒç´ å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    const continueBtn = reminderModal.querySelector('#continueActivityBtn');
                    const lockBtn = reminderModal.querySelector('#immediateLockBtn');
                    
                    if (continueBtn) {
                        continueBtn.addEventListener('click', function() {
                            handleContinueActivity();
                        });
                    }
                    
                    if (lockBtn) {
                        lockBtn.addEventListener('click', function() {
                            handleImmediateLock();
                        });
                    }
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆä¸ä½¿ç”¨fadeç±»ä»¥é¿å…ä¸å¿…è¦çš„åŠ¨ç”»æ•ˆæœï¼‰
                    const modalInstance = new bootstrap.Modal(reminderModal, {
                        backdrop: 'static',  // é˜²æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­
                        keyboard: false      // é˜²æ­¢ESCé”®å…³é—­
                    });
                    modalInstance.show();
                    
                    // å½“æ¨¡æ€æ¡†è¢«éšè—æ—¶ï¼Œæ¸…ç†DOMå…ƒç´ 
                    reminderModal.addEventListener('hidden.bs.modal', function () {
                        this.remove();
                    });
                }, reminderMinutes * 60 * 1000); // æ ¹æ®é…ç½®çš„æé†’æ—¶é—´è®¾ç½®
                
                // è®¾ç½®è‡ªåŠ¨é”å®šå®šæ—¶å™¨
                autoLockTimer = setTimeout(function() {
                    // æ£€æŸ¥è‡ªåŠ¨é”å®šæ˜¯å¦ä»ç„¶æ¿€æ´»
                    if (!isAutoLockActive) {
                        return;
                    }
                    
                    // æ˜¾ç¤ºå¯†ç éªŒè¯è¦†ç›–å±‚
                    showPasswordModal();
                            
                    // éšè—ä¸»å†…å®¹
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.style.display = 'none';
                    }
                    
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æé†’æ¨¡æ€æ¡†
                    const existingReminder = document.getElementById('autoLockReminderModal');
                    if (existingReminder) {
                        // å…³é—­æ¨¡æ€æ¡†è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
                        const modalInstance = bootstrap.Modal.getInstance(existingReminder);
                        if (modalInstance) {
                            modalInstance.dispose();
                        }
                        existingReminder.remove();
                    }
                }, timeoutMinutes * 60 * 1000); // æ ¹æ®é…ç½®çš„è¶…æ—¶æ—¶é—´è®¾ç½®
                        
                // ç›‘å¬ç”¨æˆ·æ´»åŠ¨ï¼Œé‡ç½®å®šæ—¶å™¨
                resetTimerOnActivity();
            }
                    
            // å¤„ç†ç»§ç»­æ´»åŠ¨
            function handleContinueActivity() {
                // å…³é—­æé†’æ¨¡æ€æ¡†
                const reminderModal = document.getElementById('autoLockReminderModal');
                if (reminderModal) {
                    const modalInstance = bootstrap.Modal.getInstance(reminderModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    } else {
                        // å¦‚æœæ²¡æœ‰é€šè¿‡Bootstrap Modalå®ä¾‹åˆ›å»ºï¼Œç›´æ¥ç§»é™¤å…ƒç´ 
                        reminderModal.remove();
                    }
                }
                
                // é‡ç½®è‡ªåŠ¨é”å®šå®šæ—¶å™¨
                resetAutoLockTimer();
            }
            
            // å¤„ç†ç«‹å³é”å®š
            function handleImmediateLock() {
                // å…³é—­æé†’æ¨¡æ€æ¡†
                const reminderModal = document.getElementById('autoLockReminderModal');
                if (reminderModal) {
                    const modalInstance = bootstrap.Modal.getInstance(reminderModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    } else {
                        // å¦‚æœæ²¡æœ‰é€šè¿‡Bootstrap Modalå®ä¾‹åˆ›å»ºï¼Œç›´æ¥ç§»é™¤å…ƒç´ 
                        reminderModal.remove();
                    }
                }
                
                // æ‰§è¡Œé”å®šåŠŸèƒ½
                lockScreen();
            }
            
            // æ˜¾ç¤ºå½“å‰è‡ªåŠ¨é”å®šé…ç½®
            function showAutoLockConfig() {
                // åˆ›å»ºé…ç½®ä¿¡æ¯æ¨¡æ€æ¡†
                const configModal = document.createElement('div');
                configModal.className = 'modal fade';
                configModal.id = 'autoLockConfigModal';
                configModal.tabIndex = -1;
                configModal.setAttribute('aria-labelledby', 'autoLockConfigModalLabel');
                configModal.setAttribute('aria-hidden', 'true');
                configModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white;">
                                <h5 class="modal-title" id="autoLockConfigModalLabel">ğŸ”’ è‡ªåŠ¨é”å®šé…ç½®</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-clock me-2"></i>å½“å‰é…ç½®:</h6>
                                    <ul class="mb-0">
                                        <li>è‡ªåŠ¨é”å®šæ—¶é—´: <strong>${appConfig.app_auto_lock_timeout_minutes || 30}</strong> åˆ†é’Ÿ</li>
                                        <li>æé†’æ—¶é—´: <strong>${appConfig.app_auto_lock_reminder_minutes || 25}</strong> åˆ†é’Ÿå</li>
                                        <li>å‰©ä½™é”å®šæ—¶é—´: <strong id="remainingTimeDisplay">-</strong> åˆ†é’Ÿ</li>
                                        <li>è¯­å¥è¶…æ—¶æ—¶é—´: <strong>${appConfig.db_statement_timeout || 30}</strong> ç§’</li>
                                        <li>è¿æ¥è¶…æ—¶æ—¶é—´: <strong>${appConfig.db_connect_timeout || 10}</strong> ç§’</li>
                                    </ul>
                                </div>
                                <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>ç³»ç»Ÿå°†åœ¨æ´»åŠ¨åœæ­¢ ${appConfig.app_auto_lock_timeout_minutes || 30} åˆ†é’Ÿåè‡ªåŠ¨é”å®š</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(configModal);
                
                // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
                updateRemainingTimeDisplay();
                
                // ä½¿ç”¨Bootstrapçš„Modalç±»æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modalInstance = new bootstrap.Modal(configModal);
                modalInstance.show();
                
                // å½“æ¨¡æ€æ¡†è¢«éšè—æ—¶ï¼Œæ¸…ç†DOMå…ƒç´ 
                configModal.addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }
            
            // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
            function updateRemainingTimeDisplay() {
                const remainingTimeDisplay = document.getElementById('remainingTimeDisplay');
                if (remainingTimeDisplay) {
                    // è¿™é‡Œå¯ä»¥æ ¹æ®å®šæ—¶å™¨è®¡ç®—å‰©ä½™æ—¶é—´ï¼Œæš‚æ—¶æ˜¾ç¤ºé…ç½®çš„å€¼
                    const remaining = (appConfig.app_auto_lock_timeout_minutes || 30) - (appConfig.app_auto_lock_reminder_minutes || 25);
                    remainingTimeDisplay.textContent = remaining;
                }
            }
            
            // ç›‘å¬ç”¨æˆ·æ´»åŠ¨ä»¥é‡ç½®è‡ªåŠ¨é”å®šå®šæ—¶å™¨
            function resetTimerOnActivity() {
                // ç›‘å¬é¼ æ ‡ç§»åŠ¨ã€é”®ç›˜æŒ‰é”®ã€æ»šåŠ¨ç­‰äº‹ä»¶
                ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(eventType => {
                    document.addEventListener(eventType, resetAutoLockTimer, { passive: true });
                });
            }
                    
            // é‡ç½®è‡ªåŠ¨é”å®šå®šæ—¶å™¨
            function resetAutoLockTimer() {
                // åœæ­¢å½“å‰çš„è‡ªåŠ¨é”å®šå®šæ—¶å™¨
                if (autoLockTimer) {
                    clearTimeout(autoLockTimer);
                }
                
                if (reminderTimer) {
                    clearTimeout(reminderTimer);
                }
                
                // è®¾ç½®ä¸ºéæ´»åŠ¨çŠ¶æ€ä»¥ç¡®ä¿å½“å‰å®šæ—¶å™¨ä¸å†æ‰§è¡Œ
                isAutoLockActive = false;
                        
                // é‡æ–°å¼€å§‹è®¡æ—¶
                startAutoLockTimer();
            }
        
            // åœ¨é¡µé¢åŠ è½½æ—¶å¦‚æœæ²¡æœ‰å¯†ç ï¼Œå¼€å§‹ç›‘å¬ç”¨æˆ·æ´»åŠ¨
            fetch('/has_app_password')
                .then(response => response.json())
                .then(response => {
                    if (response.has_password) {
                        // å¦‚æœæœ‰å¯†ç ï¼Œå¼€å§‹è‡ªåŠ¨é”å®šå®šæ—¶å™¨
                        startAutoLockTimer();
                    }
                });
        
            // è®¾ç½®å¯†ç åŠŸèƒ½ï¼ˆèœå•ä¸­çš„åŠŸèƒ½ï¼‰
            window.setPassword = function() {
                // éšè—ä¸»å†…å®¹
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.display = 'none';
                }
                        
                // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
                const changeModalElement = document.getElementById('changePasswordModal');
                changeModalElement.classList.add('show');
                changeModalElement.style.display = 'block';
                changeModalElement.setAttribute('aria-modal', 'true');
                changeModalElement.setAttribute('role', 'dialog');
                        
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // æ·»åŠ èƒŒæ™¯é®ç½©
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show general-modal-backdrop';
                backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                document.body.appendChild(backdrop);
                        
                // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                document.body.style.overflow = 'hidden';
                document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
            };
                    
            // å…³é—­é”™è¯¯æ¨¡æ€æ¡†çš„å‡½æ•°
            window.closeErrorModal = function() {
                const errorModalElement = document.getElementById('passwordErrorModal');
                if (errorModalElement) {
                    errorModalElement.classList.remove('show');
                    errorModalElement.style.display = 'none';
                    errorModalElement.removeAttribute('aria-modal');
                    errorModalElement.removeAttribute('role');
                                
                    // ç§»é™¤èƒŒæ™¯é®ç½©
                    const backdrop = document.querySelector('.modal-backdrop.error-message-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                                
                    // æ¢å¤bodyæ ·å¼
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            };
                        
            // å…³é—­è®¾ç½®å¯†ç æ¨¡æ€æ¡†çš„å‡½æ•°
            window.closeSetPasswordModal = function() {
                const setModalElement = document.getElementById('setPasswordModal');
                if (setModalElement) {
                    setModalElement.classList.remove('show');
                    setModalElement.style.display = 'none';
                    setModalElement.removeAttribute('aria-modal');
                    setModalElement.removeAttribute('role');
                                
                    // ç§»é™¤èƒŒæ™¯é®ç½©
                    const backdrop = document.querySelector('.modal-backdrop.general-modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                                
                    // æ¢å¤bodyæ ·å¼
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            };
                        
            // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†çš„å‡½æ•°
            window.closeChangePasswordModal = function(clearFields = {}) {
                const changeModalElement = document.getElementById('changePasswordModal');
                if (changeModalElement) {
                    changeModalElement.classList.remove('show');
                    changeModalElement.style.display = 'none';
                    changeModalElement.removeAttribute('aria-modal');
                    changeModalElement.removeAttribute('role');
                    
                    // ç§»é™¤èƒŒæ™¯é®ç½©
                    const backdrop = document.querySelector('.modal-backdrop.general-modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // æ ¹æ®å‚æ•°æ¸…ç©ºæŒ‡å®šçš„è¾“å…¥æ¡†
                    if (clearFields.currentPassword) {
                        const currentPassword = document.getElementById('currentPassword');
                        if (currentPassword) {
                            currentPassword.value = '';
                        }
                    }
                    if (clearFields.newPasswords) {
                        const changeNewPassword1 = document.getElementById('changeNewPassword1');
                        const changeNewPassword2 = document.getElementById('changeNewPassword2');
                        if (changeNewPassword1) {
                            changeNewPassword1.value = '';
                        }
                        if (changeNewPassword2) {
                            changeNewPassword2.value = '';
                        }
                    }
                    
                    // æ¢å¤bodyæ ·å¼
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // æ˜¾ç¤ºåº”ç”¨è®¿é—®éªŒè¯æ¨¡æ€æ¡†ï¼ˆå¯†ç è¦†ç›–å±‚ï¼‰
                    showPasswordModal();
                }
            };
                        
            // ä»ç™»å½•é¡µé¢æ˜¾ç¤ºæ›´æ”¹å¯†ç æ¨¡æ€æ¡†
            window.showChangePasswordFromLogin = function() {
                // éšè—å¯†ç éªŒè¯è¦†ç›–å±‚
                const overlay = document.getElementById('passwordOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
                const changeModalElement = document.getElementById('changePasswordModal');
                if (changeModalElement) {
                    // åŒæ—¶è®¾ç½®showç±»ã€displayã€roleå’Œaria-modalï¼Œå››è€…ç¼ºä¸€ä¸å¯
                    changeModalElement.classList.add('show');
                    changeModalElement.style.display = 'block';
                    changeModalElement.setAttribute('aria-modal', 'true');
                    changeModalElement.setAttribute('role', 'dialog');
                    
                    // åŒæ—¶ä½¿ç”¨Bootstrap Modalç±»æ¥ç¡®ä¿æ­£ç¡®åˆå§‹åŒ–ï¼Œé…ç½®ä¸ºç‚¹å‡»å¤–éƒ¨ä¸å…³é—­
                    const modalInstance = new bootstrap.Modal(changeModalElement, {
                        backdrop: 'static',
                        keyboard: false  // åŒæ—¶ç¦ç”¨ESCé”®å…³é—­
                    });
                    modalInstance.show();
                    
                    // åœ¨æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤ºåè®¾ç½®ç„¦ç‚¹åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                    setTimeout(() => {
                        const firstInput = document.getElementById('currentPassword');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    }, 300);
                }
                
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // è®©Bootstrapè‡ªå·±ç®¡ç†é®ç½©å±‚ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
                // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                document.body.style.overflow = 'hidden';
                document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
            };
                        
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯æ¨¡æ€æ¡†
            window.showSuccessMessage = function(message) {
                // æ›´æ–°æˆåŠŸæ¶ˆæ¯æ–‡æœ¬
                document.getElementById('successMessageText').textContent = message;
                            
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯æ¨¡æ€æ¡†
                const successModalElement = document.getElementById('successMessageModal');
                successModalElement.classList.add('show');
                successModalElement.style.display = 'block';
                successModalElement.style.zIndex = '10000'; // è®¾ç½®é«˜äºpasswordOverlayçš„z-index
                successModalElement.setAttribute('aria-modal', 'true');
                successModalElement.setAttribute('role', 'dialog');
                            
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // æ·»åŠ èƒŒæ™¯é®ç½©
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show success-message-backdrop';
                backdrop.style.zIndex = '9998'; // è®¾ç½®ä½äºæ¨¡æ€æ¡†ä½†é«˜äºpasswordOverlayçš„z-index
                document.body.appendChild(backdrop);
                            
                // ç¡®ä¿bodyæœ‰é€‚å½“çš„æ ·å¼
                document.body.style.overflow = 'hidden';
                document.body.style.paddingRight = '0px'; // é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„åç§»
            };
                        
            // å…³é—­æˆåŠŸæ¶ˆæ¯æ¨¡æ€æ¡†
            window.closeSuccessMessageModal = function() {
                const successModalElement = document.getElementById('successMessageModal');
                if (successModalElement) {
                    successModalElement.classList.remove('show');
                    successModalElement.style.display = 'none';
                    successModalElement.removeAttribute('aria-modal');
                    successModalElement.removeAttribute('role');
                                
                    // ç§»é™¤èƒŒæ™¯é®ç½©
                    const backdrop = document.querySelector('.modal-backdrop.success-message-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                                
                    // æ¢å¤bodyæ ·å¼
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            };
                    
            // é‡ç½®å¯†ç è¾“å…¥æ¡†å¹¶èšç„¦
            window.resetPasswordInput = function() {
                // å…³é—­é”™è¯¯æ¨¡æ€æ¡†
                closeErrorModal();
                        
                // æ¸…ç©ºç™»å½•å¯†ç è¾“å…¥æ¡†å¹¶èšç„¦
                setTimeout(() => {
                    const passwordInput = document.getElementById('appPassword');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                        passwordInput.select();
                    }
                    
                    // åŒæ—¶æ¸…ç©ºè®¾ç½®å¯†ç è¾“å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const newPassword1 = document.getElementById('newPassword1');
                    const newPassword2 = document.getElementById('newPassword2');
                    
                    if (newPassword1) {
                        newPassword1.value = '';
                    }
                    if (newPassword2) {
                        newPassword2.value = '';
                    }
                }, 100);
            };
        }
        
        // æ¸…ç©ºè®¾ç½®å¯†ç è¾“å…¥æ¡†
        window.clearSetPasswordInputs = function() {
            const newPassword1 = document.getElementById('newPassword1');
            const newPassword2 = document.getElementById('newPassword2');
            
            if (newPassword1) {
                newPassword1.value = '';
            }
            if (newPassword2) {
                newPassword2.value = '';
            }
        }
    });
    
    // é”å®šåŠŸèƒ½ï¼šè¿”å›åˆ°åº”ç”¨è®¿é—®éªŒè¯é¡µé¢
    function lockScreen() {
        console.log('é”å®šåŠŸèƒ½è¢«è§¦å‘');
        
        // æ·»åŠ è§†è§‰åé¦ˆï¼Œè®©ç”¨æˆ·çŸ¥é“æ­£åœ¨æ‰§è¡Œé”å®šæ“ä½œ
        const lockButton = document.querySelector('button[onclick="lockScreen()"]');
        if (lockButton) {
            const originalText = lockButton.innerHTML;
            lockButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>é”å®šä¸­...';
            lockButton.disabled = true;
            
            console.log('æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ï¼Œ300msåæ‰§è¡Œé”å®šæ“ä½œ');
            
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´å†æ‰§è¡Œé”å®šï¼Œç»™ç”¨æˆ·è§†è§‰åé¦ˆ
            setTimeout(() => {
                console.log('å¼€å§‹æ‰§è¡Œé”å®šæ“ä½œ');
                
                // ç›´æ¥æ‰§è¡Œéšè—æ¨¡æ€æ¡†çš„é€»è¾‘
                // éšè—è®¾ç½®å¯†ç æ¨¡æ€æ¡†
                const setPasswordModal = document.getElementById('setPasswordModal');
                if (setPasswordModal) {
                    setPasswordModal.classList.remove('show');
                    setPasswordModal.style.display = 'none';
                    setPasswordModal.removeAttribute('aria-modal');
                    setPasswordModal.removeAttribute('role');
                }
                
                // éšè—æ›´æ”¹å¯†ç æ¨¡æ€æ¡†
                const changePasswordModal = document.getElementById('changePasswordModal');
                if (changePasswordModal) {
                    changePasswordModal.classList.remove('show');
                    changePasswordModal.style.display = 'none';
                    changePasswordModal.removeAttribute('aria-modal');
                    changePasswordModal.removeAttribute('role');
                }
                
                // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„é®ç½©å±‚
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                console.log('å·²éšè—æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†');
                
                // ç›´æ¥æ‰§è¡Œæ˜¾ç¤ºå¯†ç éªŒè¯è¦†ç›–å±‚çš„é€»è¾‘
                // é¦–å…ˆç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å…¶ä»–é®ç½©å±‚
                const existingBackdrops = document.querySelectorAll('.modal-backdrop');
                existingBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                const overlay = document.getElementById('passwordOverlay');
                if (overlay) {
                    // ç¡®ä¿è¦†ç›–å±‚çš„z-indexè¶³å¤Ÿé«˜
                    overlay.style.zIndex = '9999';
                    // æ˜¾ç¤ºè¦†ç›–å±‚å¹¶è®¾ç½®ä¸ºflexå¸ƒå±€
                    overlay.style.display = 'flex';
                    console.log('å¯†ç è¦†ç›–å±‚å·²æ˜¾ç¤º');
                } else {
                    console.log('è­¦å‘Šï¼šæœªæ‰¾åˆ° passwordOverlay å…ƒç´ ');
                }
                
                // æ¸…ç©ºå¯†ç è¾“å…¥æ¡†ï¼Œç¡®ä¿å®‰å…¨æ€§
                const passwordInput = document.getElementById('appPassword');
                if (passwordInput) {
                    passwordInput.value = '';
                    console.log('å¯†ç è¾“å…¥æ¡†å·²æ¸…ç©º');
                }
                
                // éšè—ä¸»å†…å®¹
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.display = 'none';
                    console.log('ä¸»å†…å®¹å·²éšè—');
                } else {
                    console.log('è­¦å‘Šï¼šæœªæ‰¾åˆ° mainContent å…ƒç´ ');
                }
                
                // æ³¨æ„ï¼šä¸ä¿®æ”¹ isExecuting çŠ¶æ€ï¼Œä»¥ç¡®ä¿æ­£åœ¨æ‰§è¡Œçš„SQLä¸ä¼šè¢«ä¸­æ–­
                // isExecuting = false; // æ³¨é‡Šæ‰è¿™è¡Œï¼Œé¿å…ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„SQL
                
                // æ¢å¤æŒ‰é’®åŸå§‹çŠ¶æ€
                lockButton.innerHTML = originalText;
                lockButton.disabled = false;
                console.log('æŒ‰é’®çŠ¶æ€å·²æ¢å¤');
            }, 300);
        } else {
            console.log('è­¦å‘Šï¼šæœªæ‰¾åˆ°é”å®šæŒ‰é’®');
            
            // ç¡®ä¿éšè—æ‰€æœ‰å…¶ä»–å¯èƒ½çš„æ¨¡æ€æ¡†
            hideAllModals();
            
            // æ˜¾ç¤ºå¯†ç éªŒè¯è¦†ç›–å±‚
            showPasswordModal();
            
            // éšè—ä¸»å†…å®¹
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
        }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šéšè—æ‰€æœ‰å¯èƒ½æ˜¾ç¤ºçš„æ¨¡æ€æ¡†
        function hideAllModals() {
            // éšè—è®¾ç½®å¯†ç æ¨¡æ€æ¡†
            const setPasswordModal = document.getElementById('setPasswordModal');
            if (setPasswordModal) {
                setPasswordModal.classList.remove('show');
                setPasswordModal.style.display = 'none';
                setPasswordModal.removeAttribute('aria-modal');
                setPasswordModal.removeAttribute('role');
            }
            
            // éšè—æ›´æ”¹å¯†ç æ¨¡æ€æ¡†
            const changePasswordModal = document.getElementById('changePasswordModal');
            if (changePasswordModal) {
                changePasswordModal.classList.remove('show');
                changePasswordModal.style.display = 'none';
                changePasswordModal.removeAttribute('aria-modal');
                changePasswordModal.removeAttribute('role');
            }
            
            // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„é®ç½©å±‚
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            console.log('å·²éšè—æ‰€æœ‰å…¶ä»–æ¨¡æ€æ¡†');
        }
        
        /**
         * å…¬å†è½¬æ¢
         * 1900~2100åŒºé—´å†…çš„å…¬å†è½¬å†œå†
         */
        var chineseCalendar = {

            /**
             * å†œå†1900~2100ä¿¡æ¯è¡¨
             */
            lunarInfo: [
             0x104bd,   0x4ae,   0xa57,  0xa54d,   0xd26,   0xd95,  0x9655,   0x56a,   0x9ad,  0x455d, // 1900~1909
               0x4ae,  0xca5b,   0xa4d,   0xd25,  0xbd25,   0xb54,   0xd6a,  0x4ada,   0x95b,  0xf497, // 1910~1919
               0x497,   0xa4b,  0xab4b,   0x6a5,   0x6d4,  0x9ab5,   0x2b6,   0x957,  0x452f,   0x497, // 1920~1929
              0xc656,   0xd4a,   0xea5,  0xb6a9,   0x5ad,   0x2b6,  0x786e,   0x92e,  0xfc8d,   0xc95, // 1930~1939
               0xd4a,  0xdd8a,   0xb55,   0x56a,  0x9a5b,   0x25d,   0x92d,  0x4d2b,   0xa95,  0xeb55, // 1940~1949
               0x6ca,   0xb55,  0xb535,   0x4da,   0xa5b,  0x7457,   0x52b, 0x10a9a,   0xe95,   0x6aa, // 1950~1959
              0xcaea,   0xab5,   0x4b6,  0x8aae,   0xa57,   0x526,  0x6f26,   0xd95,  0xe5b5,   0x56a, // 1960~1969
               0x96d,  0xa4dd,   0x4ad,   0xa4d,  0x8d4d,   0xd25, 0x10d55,   0xb54,   0xb6a,  0xd95a, // 1970~1979
               0x95b,   0x49b,  0x8a97,   0xa4b, 0x14b27,   0x6a5,   0x6d4,  0xcaf4,   0xab6,   0x957, // 1980~1989
              0xa4af,   0x497,   0x64b,  0x674a,   0xea5, 0x106b5,   0x5ac,   0xab6,  0xa96d,   0x92e, // 1990~1999
               0xc96,  0x8d95,   0xd4a,   0xda5,  0x4755,   0x56a,  0xeabb,   0x25d,   0x92d,  0xacab, // 2000~2009
               0xa95,   0xb4a,  0x8baa,   0xad5, 0x1255d,   0x4ba,   0xa5b,  0xd517,   0x52b,   0xa93, // 2010~2019
              0x8795,   0x6aa,   0xad5,  0x45b5,   0x4b6,  0xca6e,   0xa4e,   0xd26,  0xaea6,   0xd53, // 2020~2029
               0x5aa,  0x676a,   0x96d, 0x164af,   0x4ad,   0xa4d,  0xdd0b,   0xd25,   0xd52,  0xadd4, // 2030~2039
               0xb5a,   0x56d,  0x455b,   0x49b,  0xea57,   0xa4b,   0xaa5,  0xbb25,   0x6d2,   0xada, // 2040~2049
              0x74b6,   0x937, 0x1049f,   0x497,   0x64b,  0xd68a,   0xea5,   0x6aa,  0x9a6c,   0xaae, // 2050~2059
               0x92e,  0x6d2e,   0xc96,  0xed55,   0xd4a,   0xda5,  0xa5d5,   0x56a,   0xa6d,  0x855d, // 2060~2069
               0x52d, 0x10a9b,   0xa95,   0xb4a,  0xcb6a,   0xad5,   0x55a,  0x8aba,   0xa5b,   0x52b, // 2070~2079
              0x6b27,   0x693,  0xe733,   0x6aa,   0xad5,  0xb4b5,   0x4b6,   0xa57,  0x854e,   0xd16, // 2080~2089
             0x10e96,   0xd52,   0xdaa,  0xd6aa,   0x56d,   0x4ae,  0x8a9d,   0xa2d,   0xd15,  0x4f25, // 2090~2099
               0xd52 // 2100
            ],

            /**
             * äºŒåå››èŠ‚æ°”é€Ÿç®—è¡¨
             * èŠ‚æ°”ç‚¹æ—¶é—´ï¼ˆå•ä½æ˜¯åˆ†é’Ÿï¼‰
             * ä»0å°å¯’èµ·ç®—
             */
            termInfo :[
                0,21208,42467,63836,
                85337,107014,128867,150921,
                173149,195551,218072,240693,
                263343,285989,308563,331033,
                353350,375494,397447,419210,
                440795,462224,483532,504758
            ],

            /**
             * äºŒåå››èŠ‚æ°”å¯¹åº”è¡¨
             * ä»0å°å¯’èµ·ç®—
             */
            solarTerm: [
                'å°å¯’', 'å¤§å¯’', 'ç«‹æ˜¥', 'é›¨æ°´',
                'æƒŠè›°', 'æ˜¥åˆ†', 'æ¸…æ˜', 'è°·é›¨',
                'ç«‹å¤', 'å°æ»¡', 'èŠ’ç§', 'å¤è‡³',
                'å°æš‘', 'å¤§æš‘', 'ç«‹ç§‹', 'å¤„æš‘',
                'ç™½éœ²', 'ç§‹åˆ†', 'å¯’éœ²', 'éœœé™',
                'ç«‹å†¬', 'å°é›ª', 'å¤§é›ª', 'å†¬è‡³'
            ],

            /**
             * å†œå†æœˆä»½
             */
            chineseMonthCN: ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'],

            /**
             * å†œå†æ—¥æœŸ
             */
            chineseDayCN: ['åˆ', 'å', 'å»¿', 'å…'],

            /**
             * ä¸­æ–‡æ•°å­—
             */
            numberCN: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'],

            /**
             * è·å–å†œå†å¹´ä¸€å¹´çš„å¤©æ•°
             */
            lunarYearDays: function(y) {
                var i, sum = 12 * 29;
                for (i = 1; i < 1 << 12; i <<= 1) {
                    sum += (this.lunarInfo[y - 1900] & i) ? 1 : 0;
                }
                return (sum + this.leapDays(y));
            },

            /**
             * è·å–å†œå†å¹´é—°æœˆæœˆä»½ï¼Œä¸å­˜åœ¨è¿”å›0
             */
            leapMonth: function(y) {
                return ((this.lunarInfo[y - 1900] >> 13) & 0xf);
            },

            /**
             * è·å–å†œå†å¹´é—°æœˆçš„å¤©æ•°ï¼Œä¸å­˜åœ¨é—°æœˆè¿”å›0
             */
            leapDays: function(y) {
                if (this.leapMonth(y)) {
                    return ((this.lunarInfo[y - 1900] & 0x1000) ? 30 : 29);
                }
                return 0;
            },

            /**
             * è·å–å†œå†å¹´æŸæœˆçš„å¤©æ•°ï¼Œæ­£å¸¸æœˆä»½
             */
            lunarDaysOfMonth: function(y, m) {
                if (m > 12 || m < 1)
                    return -1;
                return ((this.lunarInfo[y - 1900] & (0x1000 >> m)) ? 30 : 29);
            },

            /**
             * æœˆä»½è½¬æ±‰å­—
             */
            toChinaMonth: function(m) {
                if (m > 12 || m < 1)
                    return -1;
                return this.chineseMonthCN[m - 1] + "æœˆ";
            },

            /**
             * å†œå†å¤©è½¬æ±‰å­—
             */
            toChinaDay: function(d) {
                if(d > 30)
                    return -1;
                if(d == 10)
                    return this.chineseDayCN[0]+this.chineseDayCN[1];
                return this.chineseDayCN[Math.floor(d / 10)] + this.numberCN[d % 10];
            },

            /**
             * è·å–ä¸€å¹´ä¸­çš„ç¬¬å‡ ä¸ªèŠ‚æ°”
             */
            termForIndex: function(y,n) {
                if(n>24){
                    return -1;
                }
                var offDate = new Date(( 31556925974.7*(y-1900) + this.termInfo[n]*60000 ) + Date.UTC(1900,0,6,2,3,57));
                return offDate.getUTCDate();
            },

            /**
             * è·å–æŸæ—¥çš„èŠ‚æ°”ï¼Œä¸æ˜¯èŠ‚æ°”è¿”å› undefined
             */
            termOfDay: function(y,m,d){
                var mon = parseInt(m) - 1;
                y = parseInt(y);
                d = parseInt(d);
                var solarTerms = undefined;
                // å…ˆè®¡ç®—å½“æœˆç¬¬ä¸€ä¸ªèŠ‚æ°”
                var index = mon*2
                if (this.termForIndex(y, index) == d) {
                    solarTerms = this.solarTerm[index];
                }
                index ++;
                if (this.termForIndex(y, index ) == d) {
                    solarTerms = this.solarTerm[index];
                }
                return solarTerms;
            },

            /**
             * å…¬å†è½¬å†œå†
             * å…¬å†å¹´æœˆæ—¥è·å¾—è¯¦ç»†çš„å…¬å†ã€å†œå†ä¿¡æ¯
             */
            gregorian2lunar: function(y, m, d) {
                // é»˜è®¤è·å¾—å½“å¤©
                var objDate = new Date();
                if (y && m && d) {
                    objDate = new Date(y, parseInt(m) - 1, d)
                }

                // æ ¡éªŒä¼ å‚åŒºé—´ï¼Œ1900-1-31 ~ 2100-12-31
                var minDate = new Date(1900, 0, 31),
                    maxDate = new Date(2100, 11, 31);
                if (objDate < minDate || objDate > maxDate) {
                    return -1;
                }

                // é‡æ–°è·å–å¹´æœˆæ—¥æ•°å€¼
                var y = objDate.getFullYear(),
                    m = objDate.getMonth() + 1,
                    d = objDate.getDate();
                var i, leap = 0,
                    temp = 0;
                // è®¡ç®—æ—¥æœŸåˆ° 1900-1-31 ä¹‹é—´å¤©æ•°
                var offset = (Date.UTC(objDate.getFullYear(), objDate.getMonth(), objDate.getDate()) - Date.UTC(1900, 0,
                    31)) / 8.64e7;
                for (i = 1900; i <= 2100 && offset > 0; i++) {
                    temp = this.lunarYearDays(i);
                    offset -= temp;
                }
                // ä¿®æ­£åç§»é‡
                if (offset < 0) {
                    offset += temp;
                    i--;
                }

                // å–æ˜ŸæœŸ
                var dayOfWeek = objDate.getDay(),
                    cWeek = this.numberCN[dayOfWeek];
                if (dayOfWeek == 0) {
                    dayOfWeek = 7;
                }

                // å†œå†å¹´
                var year = i;
                var leapMonth = this.leapMonth(i);
                var isLeap = false;
                // æ ¹æ®åç§»é‡è®¡ç®—å¤©æ•°
                for (i = 1; i < 13 && offset > 0; i++) {
                    if (leapMonth > 0 && i == (leapMonth + 1) && isLeap == false) {
                        // å¾ªç¯é—°æœˆï¼Œå–é—°æœˆå¤©æ•°ï¼Œæœˆä»½å‡1
                        --i;
                        isLeap = true;
                        temp = this.leapDays(year);
                    } else {
                        // å–æ™®é€šæœˆå¤©æ•°
                        temp = this.lunarDaysOfMonth(year, i);
                    }
                    // å¾ªç¯åˆ°é—°æœˆä¸‹ä¸ªæœˆï¼Œè§£é™¤é—°æœˆ
                    if (isLeap == true && i == (leapMonth + 1)) {
                        isLeap = false;
                    }
                    offset -= temp;
                }
                // offsetä¸º0æ—¶ï¼Œå¹¶ä¸”åˆšæ‰è®¡ç®—çš„æœˆä»½æ˜¯é—°æœˆï¼Œè¦æ ¡æ­£
                if (offset == 0 && leapMonth > 0 && i == leapMonth + 1) {
                    if (isLeap) {
                        isLeap = false;
                    } else {
                        isLeap = true;
                        --i;
                    }
                }
                // offsetå°äº0æ—¶ï¼Œä¹Ÿè¦æ ¡æ­£
                if (offset < 0) {
                    offset += temp;
                    --i;
                }

                // è·å–å†œå†å¤§å°å°½
                var lunation = (isLeap ? this.leapDays(year) : this.lunarDaysOfMonth(year, i)) > 29

                // å†œå†æœˆ
                var month = i;
                // å†œå†æ—¥
                var day = offset + 1;

                return {
                    'chinaYear': year,
                    'chinaMonth': month,
                    'chinaDay': day,
                    'chinaMonthCn': (isLeap ? "é—°" : '') + this.toChinaMonth(month),
                    'chinaDayCn': this.toChinaDay(day),
                    'solarYear': y,
                    'solarMonth': m,
                    'solarDay': d,
                    'lunation': lunation ? 'å¤§' : 'å°',
                    'isLeap': isLeap,
                    'term': this.termOfDay(y,m,d),
                    'dayOfWeek': dayOfWeek,
                    'week': "æ˜ŸæœŸ" + cWeek
                }
            }
        };

        // å¯¹å¤–æ¥å£å‡½æ•°ï¼Œä¿æŒä¸åŸæœ‰ä»£ç å…¼å®¹
        function solarToLunar(solarDate) {
            const year = solarDate.getFullYear();
            const month = solarDate.getMonth() + 1;
            const day = solarDate.getDate();
            
            const result = chineseCalendar.gregorian2lunar(year, month, day);
            
            if (result === -1) {
                throw new Error('æ—¥æœŸè¶…å‡ºæ”¯æŒèŒƒå›´');
            }
            
            // å¤©å¹²åœ°æ”¯è®¡ç®—ï¼ˆ1900å¹´æ˜¯åºšå­å¹´ï¼‰
            const heavenlyStems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const earthlyBranches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            const stemIndex = (result.chinaYear - 1900 + 6) % 10;
            const branchIndex = (result.chinaYear - 1900) % 12;
            const yearGanZhi = heavenlyStems[stemIndex] + earthlyBranches[branchIndex];
            
            // è·å–èŠ‚æ°”ä¿¡æ¯
            const solarTerm = chineseCalendar.termOfDay(year, month, day);
            
            return {
                lunarYear: yearGanZhi + 'å¹´',
                lunarMonth: result.chinaMonthCn,
                lunarDay: result.chinaDayCn,
                solarTerm: solarTerm // èŠ‚æ°”ä¿¡æ¯
            };
        }

        // ä¿æŒåŸæœ‰çš„getLunarDateæ¥å£
        function getLunarDate(date) {
            try {
                const lunarResult = solarToLunar(date);
                // å¦‚æœæœ‰èŠ‚æ°”ï¼Œåˆ™åœ¨å†œå†åæ˜¾ç¤ºèŠ‚æ°”
                const solarTermStr = lunarResult.solarTerm ? ` ${lunarResult.solarTerm}` : '';
                const lunarStr = `${lunarResult.lunarYear}${lunarResult.lunarMonth}${lunarResult.lunarDay}${solarTermStr}`;
                return {
                    full: lunarStr,
                    year: lunarResult.lunarYear,
                    month: lunarResult.lunarMonth,
                    day: lunarResult.lunarDay,
                    isLeap: lunarResult.lunarMonth.startsWith('é—°'),
                    solarTerm: lunarResult.solarTerm
                };
            } catch (error) {
                return { full: 'å†œå†è®¡ç®—é”™è¯¯', error: error.message };
            }
        }








    
    // å®æ—¶æ—¶é—´æ›´æ–°å‡½æ•° - åŸå§‹ç‰ˆæœ¬
    function updateTime() {
        try {
            let displayStr; // å£°æ˜æ˜¾ç¤ºå­—ç¬¦ä¸²å˜é‡
            
            const now = new Date();
            
            // è·å–å¹´æœˆæ—¥æ—¶åˆ†ç§’
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
            const dateTimeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // è·å–æ˜ŸæœŸ
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekdayStr = weekdays[now.getDay()];
            
            // è·å–å†œå†å’ŒèŠ‚æ°”ä¿¡æ¯
            const lunarResult = getLunarDate(now);
            const lunarStr = lunarResult.full;
            const solarTerm = lunarResult.solarTerm;
            
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // ç§»åŠ¨ç«¯ï¼šåˆ†ä¸¤è¡Œæ˜¾ç¤º
                // ç¬¬ä¸€è¡Œï¼šå…¬å†æ—¶é—´ + èŠ‚æ°”
                let firstLine = `${dateTimeStr}`;
                if (solarTerm) {
                    firstLine += ` ${solarTerm}`;
                }
                
                // ç¬¬äºŒè¡Œï¼šæ˜ŸæœŸ + å†œå†
                const secondLine = `${weekdayStr} ${lunarStr.replace(solarTerm ? ' ' + solarTerm : '', '')}`;
                
                displayStr = `${firstLine}<br>${secondLine}`;
            } else {
                // æ¡Œé¢ç«¯ï¼šä¿æŒåŸæœ‰æ ¼å¼
                displayStr = `${dateTimeStr}`;
                if (solarTerm) {
                    displayStr += ` ${solarTerm}`;
                }
                displayStr += `<br>${weekdayStr} ${lunarStr.replace(solarTerm ? ' ' + solarTerm : '', '')}`;
            }
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            const timeDisplay = document.getElementById('timeDisplay');
            if (timeDisplay) {
                timeDisplay.innerHTML = displayStr;
                
                // æ·»åŠ é”™è¯¯çŠ¶æ€æŒ‡ç¤º
                if (lunarStr.includes('é”™è¯¯') || lunarStr.includes('undefined')) {
                    timeDisplay.style.color = '#dc3545'; // çº¢è‰²
                    timeDisplay.title = lunarResult.error || 'æ—¥æœŸæ˜¾ç¤ºå¼‚å¸¸';
                } else {
                    timeDisplay.style.color = ''; // æ¢å¤é»˜è®¤é¢œè‰²
                    timeDisplay.title = '';
                }
            }
        } catch (error) {
            console.error('æ—¶é—´æ›´æ–°é”™è¯¯:', error);
            const timeDisplay = document.getElementById('timeDisplay');
            if (timeDisplay) {
                timeDisplay.innerHTML = `æ—¶é—´æ˜¾ç¤ºé”™è¯¯: ${error.message}`;
                timeDisplay.style.color = '#dc3545';
            }
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ—¶é—´æ›´æ–°
    document.addEventListener('DOMContentLoaded', function() {
        // ç«‹å³æ›´æ–°ä¸€æ¬¡æ—¶é—´
        updateTime();
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updateTime, 1000);
    });
    
    // ç­‰å¾…å‡½æ•°å¯ç”¨çš„è¾…åŠ©å‡½æ•°
    function waitForFunction(funcName, callback, maxAttempts = 50, interval = 100) {
        let attempts = 0;
        const checkFunc = function() {
            attempts++;
            const func = window[funcName];
            if (typeof func === 'function') {
                callback(func);
            } else if (attempts < maxAttempts) {
                setTimeout(checkFunc, interval);
            } else {
                console.error(`${funcName} function is not defined after waiting`);
            }
        };
        checkFunc();
    }
    
    // é¡µé¢å®Œå…¨åŠ è½½åç»‘å®šäº‹ä»¶ï¼ˆç•™ç©ºï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨å†…è”äº‹ä»¶ï¼‰
    // ä¸éœ€è¦åŠ¨æ€ç»‘å®šï¼Œå› ä¸ºæŒ‰é’®ä½¿ç”¨onclick="delayedShowConfig()"
    
    // å»¶è¿Ÿæ˜¾ç¤ºé…ç½®çš„å‡½æ•°
    function delayedShowConfig() {
        // é¦–å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°çš„é…ç½®
        fetch('/get_app_config')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // æ›´æ–°å…¨å±€é…ç½®
                window.appConfig = data.config;
                
                // ä½¿ç”¨æ›´å…¨é¢çš„å‡½æ•°æ£€æŸ¥æœºåˆ¶
                let func = null;
                
                // æ£€æŸ¥å‡½æ•°çš„å¤šä¸ªå¯èƒ½ä½ç½®
                if (typeof showAutoLockConfig === 'function') {
                    func = showAutoLockConfig;
                } else if (typeof window.showAutoLockConfig === 'function') {
                    func = window.showAutoLockConfig;
                } else {
                    // å¦‚æœå‡½æ•°ä»ç„¶æœªå®šä¹‰ï¼Œå°è¯•åœ¨å…¨å±€ä½œç”¨åŸŸä¸­æŸ¥æ‰¾
                    func = window['showAutoLockConfig'];
                    if (typeof func !== 'function') {
                        // ä½œä¸ºæœ€åæ‰‹æ®µï¼Œå°è¯•ä½¿ç”¨evalæ¥æ‰§è¡Œå‡½æ•°ï¼ˆä»…åœ¨å¿…è¦æ—¶ï¼‰
                        try {
                            // å®šä¹‰ä¸€ä¸ªå¤‡é€‰å‡½æ•°
                            func = function() {
                                // åˆ›å»ºé…ç½®ä¿¡æ¯æ¨¡æ€æ¡† - ä»åŸå‡½æ•°å¤åˆ¶çš„é€»è¾‘
                                const configModal = document.createElement('div');
                                configModal.className = 'modal fade';
                                configModal.id = 'autoLockConfigModal';
                                configModal.tabIndex = -1;
                                configModal.setAttribute('aria-labelledby', 'autoLockConfigModalLabel');
                                configModal.setAttribute('aria-hidden', 'true');
                                configModal.innerHTML = `
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white;">
                                                <h5 class="modal-title" id="autoLockConfigModalLabel">âš™ï¸ åº”ç”¨é…ç½®</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-info-circle me-2"></i>å½“å‰é…ç½®:</h6>
                                                    <ul class="mb-0">
                                                        <li>åº”ç”¨æ ‡é¢˜: <strong id="currentTitle">${data.config?.app_title || 'æœé˜³æ•°æ®'}</strong></li>
                                                        <li>è‡ªåŠ¨é”å®šæ—¶é—´: <strong id="currentTimeout">${data.config?.app_auto_lock_timeout_minutes || 30}</strong> åˆ†é’Ÿ</li>
                                                        <li>æé†’æ—¶é—´: <strong id="currentReminder">${data.config?.app_auto_lock_reminder_minutes || 25}</strong> åˆ†é’Ÿå</li>
                                                        <li>å‰©ä½™é”å®šæ—¶é—´: <strong id="remainingTimeDisplay">-</strong> åˆ†é’Ÿ</li>
                                                        <li>è¯­å¥è¶…æ—¶æ—¶é—´: <strong id="currentStmtTimeout">${data.config?.db_statement_timeout || 30}</strong> ç§’</li>
                                                        <li>è¿æ¥è¶…æ—¶æ—¶é—´: <strong id="currentConnTimeout">${data.config?.db_connect_timeout || 10}</strong> ç§’</li>
                                                        <li>æœ€å¤§è¿æ¥æ•°: <strong id="currentMaxConnections">${data.config?.app_max_connections || 10}</strong></li>
                                                        <li>æœ€å°è¿æ¥æ•°: <strong id="currentMinConnections">${data.config?.app_min_connections || 1}</strong></li>
                                                        <li>è¿æ¥æ± è¶…æ—¶: <strong id="currentPoolTimeout">${data.config?.app_connection_pool_timeout || 30}</strong> ç§’</li>
                                                        <li>ç»“æœç¼“å­˜æ—¶é—´: <strong id="currentResultCache">${data.config?.app_result_cache_time || 3600}</strong> ç§’</li>
                                                        <li>æœ€å¤§ç»“æœé›†å¤§å°: <strong id="currentMaxResultSize">${data.config?.app_max_result_size || 10000}</strong> è¡Œ</li>
                                                        <li>å¯†ç å¤æ‚åº¦éªŒè¯: <strong id="currentPasswordStrengthRequired">${data.config?.app_password_strength_required ? 'å¯ç”¨' : 'ç¦ç”¨'}</strong></li>
                                                        <li>ä¸»é¢˜é¢œè‰²: <strong id="currentThemeColor">${data.config?.app_theme_color || 'default'}</strong></li>
                                                    </ul>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <h6><i class="fas fa-edit me-2"></i>ä¿®æ”¹é…ç½®:</h6>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-12">
                                                            <label for="newTitle" class="form-label">åº”ç”¨æ ‡é¢˜</label>
                                                            <input type="text" class="form-control" id="newTitle" maxlength="50" placeholder="è¾“å…¥åº”ç”¨æ ‡é¢˜" value="${data.config?.app_title || 'æœé˜³æ•°æ®'}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newTimeout" class="form-label">è‡ªåŠ¨é”å®šæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                                            <input type="number" class="form-control" id="newTimeout" min="1" max="1440" value="${data.config?.app_auto_lock_timeout_minutes || 30}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newReminder" class="form-label">æé†’æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                                            <input type="number" class="form-control" id="newReminder" min="1" max="1439" value="${data.config?.app_auto_lock_reminder_minutes || 25}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newStmtTimeout" class="form-label">è¯­å¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newStmtTimeout" min="1" max="300" value="${data.config?.db_statement_timeout || 30}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newConnTimeout" class="form-label">è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newConnTimeout" min="1" max="60" value="${data.config?.db_connect_timeout || 10}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newMaxConnections" class="form-label">æœ€å¤§è¿æ¥æ•°</label>
                                                            <input type="number" class="form-control" id="newMaxConnections" min="1" max="100" value="${data.config?.app_max_connections || 10}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newMinConnections" class="form-label">æœ€å°è¿æ¥æ•°</label>
                                                            <input type="number" class="form-control" id="newMinConnections" min="0" max="10" value="${data.config?.app_min_connections || 1}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newPoolTimeout" class="form-label">è¿æ¥æ± è¶…æ—¶ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newPoolTimeout" min="1" max="300" value="${data.config?.app_connection_pool_timeout || 30}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newResultCacheTime" class="form-label">ç»“æœç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newResultCacheTime" min="1" max="7200" value="${data.config?.app_result_cache_time || 3600}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newMaxResultSize" class="form-label">æœ€å¤§ç»“æœé›†å¤§å°</label>
                                                            <input type="number" class="form-control" id="newMaxResultSize" min="1" max="100000" value="${data.config?.app_max_result_size || 10000}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newPageSize" class="form-label">é¡µé¢å¤§å°</label>
                                                            <input type="number" class="form-control" id="newPageSize" min="1" max="500" value="${data.config?.app_page_size || 50}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newLoginFailuresLimit" class="form-label">ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶</label>
                                                            <input type="number" class="form-control" id="newLoginFailuresLimit" min="1" max="20" value="${data.config?.app_login_failures_limit || 5}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newAccountLockoutMinutes" class="form-label">è´¦æˆ·é”å®šæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                                            <input type="number" class="form-control" id="newAccountLockoutMinutes" min="1" max="1440" value="${data.config?.app_account_lockout_minutes || 30}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newConcurrentQueries" class="form-label">å¹¶å‘æŸ¥è¯¢æ•°</label>
                                                            <input type="number" class="form-control" id="newConcurrentQueries" min="1" max="20" value="${data.config?.app_concurrent_queries || 5}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newQueryQueueSize" class="form-label">æŸ¥è¯¢é˜Ÿåˆ—å¤§å°</label>
                                                            <input type="number" class="form-control" id="newQueryQueueSize" min="1" max="50" value="${data.config?.app_query_queue_size || 10}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newMemoryLimitMb" class="form-label">å†…å­˜é™åˆ¶ï¼ˆMBï¼‰</label>
                                                            <input type="number" class="form-control" id="newMemoryLimitMb" min="1" max="2048" value="${data.config?.app_memory_limit_mb || 512}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newBatchInsertSize" class="form-label">æ‰¹é‡æ’å…¥å¤§å°</label>
                                                            <input type="number" class="form-control" id="newBatchInsertSize" min="1" max="10000" value="${data.config?.app_batch_insert_size || 1000}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newTransactionTimeout" class="form-label">äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newTransactionTimeout" min="1" max="600" value="${data.config?.app_transaction_timeout || 120}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newConnectionRetryCount" class="form-label">è¿æ¥é‡è¯•æ¬¡æ•°</label>
                                                            <input type="number" class="form-control" id="newConnectionRetryCount" min="0" max="10" value="${data.config?.app_connection_retry_count || 3}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newLogRetentionDays" class="form-label">æ—¥å¿—ä¿ç•™å¤©æ•°</label>
                                                            <input type="number" class="form-control" id="newLogRetentionDays" min="1" max="365" value="${data.config?.app_log_retention_days || 30}">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newAutoSaveInterval" class="form-label">è‡ªåŠ¨ä¿å­˜é—´éš”ï¼ˆç§’ï¼‰</label>
                                                            <input type="number" class="form-control" id="newAutoSaveInterval" min="0" max="3600" value="${data.config?.app_auto_save_interval || 300}">
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newPasswordStrengthRequired" class="form-label">å¯ç”¨å¯†ç å¤æ‚åº¦éªŒè¯</label>
                                                            <select class="form-select" id="newPasswordStrengthRequired">
                                                                <option value="false" ${data.config?.app_password_strength_required ? '' : 'selected'}>ç¦ç”¨</option>
                                                                <option value="true" ${data.config?.app_password_strength_required ? 'selected' : ''}>å¯ç”¨</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newThemeColor" class="form-label">ä¸»é¢˜é¢œè‰²</label>
                                                            <select class="form-select" id="newThemeColor">
                                                                <option value="night" ${data.config?.app_theme_color === 'night' ? 'selected' : ''}>æš—å¤œé»‘</option>
                                                                <option value="ocean" ${data.config?.app_theme_color === 'ocean' ? 'selected' : ''}>æ·±æµ·è“</option>
                                                                <option value="sunset" ${data.config?.app_theme_color === 'sunset' ? 'selected' : ''}>è½æ—¥æ©™</option>
                                                                <option value="forest" ${data.config?.app_theme_color === 'forest' ? 'selected' : ''}>æ£®æ—ç»¿</option>
                                                                <option value="sakura" ${data.config?.app_theme_color === 'sakura' ? 'selected' : ''}>æ¨±èŠ±ç²‰</option>
                                                                <option value="ibm" ${data.config?.app_theme_color === 'ibm' ? 'selected' : ''}>IBMè“</option>
                                                                <option value="oracle" ${data.config?.app_theme_color === 'oracle' ? 'selected' : ''}>Oracleçº¢é‡‘</option>
                                                                <option value="sap" ${data.config?.app_theme_color === 'sap' ? 'selected' : ''}>SAPè“æ©™</option>
                                                                <option value="microsoft" ${data.config?.app_theme_color === 'microsoft' ? 'selected' : ''}>Microsoftè“</option>
                                                                <option value="google" ${data.config?.app_theme_color === 'google' ? 'selected' : ''}>Googleå¤šå½©</option>
                                                                <option value="amazon" ${data.config?.app_theme_color === 'amazon' ? 'selected' : ''}>Amazonæ©™è“</option>
                                                                <option value="apple" ${data.config?.app_theme_color === 'apple' ? 'selected' : ''}>Appleé»‘ç™½</option>
                                                                <option value="meta" ${data.config?.app_theme_color === 'meta' ? 'selected' : ''}>Metaè“ç°</option>
                                                                <option value="salesforce" ${data.config?.app_theme_color === 'salesforce' ? 'selected' : ''}>Salesforceè“ç»¿</option>
                                                                <option value="adobe" ${data.config?.app_theme_color === 'adobe' ? 'selected' : ''}>Adobeçº¢é»„</option>
                                                                <option value="twitter" ${data.config?.app_theme_color === 'twitter' ? 'selected' : ''}>Twitterè“</option>
                                                                <option value="linkedin" ${data.config?.app_theme_color === 'linkedin' ? 'selected' : ''}>LinkedInè“</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <label for="newPassword" class="form-label">è®¿é—®å¯†ç </label>
                                                            <input type="password" class="form-control" id="newPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="confirmNewPassword" class="form-label">ç¡®è®¤å¯†ç </label>
                                                            <input type="password" class="form-control" id="confirmNewPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
                                                        </div>
                                                    </div>
                                                    <div class="form-text mt-2">
                                                        <small>æç¤ºï¼šæé†’æ—¶é—´åº”å°äºè‡ªåŠ¨é”å®šæ—¶é—´ | è¶…æ—¶æ—¶é—´ç”¨äºæ§åˆ¶æ•°æ®åº“æ“ä½œ | å¦‚éœ€ä¿®æ”¹å¯†ç è¯·åœ¨æ­¤è®¾ç½®</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-primary" onclick="saveAutoLockConfig()">ä¿å­˜é…ç½®</button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(configModal);
                                
                                // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
                                const remainingTimeDisplay = document.getElementById('remainingTimeDisplay');
                                if (remainingTimeDisplay) {
                                    const remaining = (data.config?.auto_lock_timeout_minutes || 30) - (data.config?.auto_lock_reminder_minutes || 25);
                                    remainingTimeDisplay.textContent = remaining;
                                }
                                
                                // ä½¿ç”¨Bootstrapçš„Modalç±»æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†
                                const modalInstance = new bootstrap.Modal(configModal);
                                modalInstance.show();
                                
                                // å½“æ¨¡æ€æ¡†è¢«éšè—æ—¶ï¼Œæ¸…ç†DOMå…ƒç´ 
                                configModal.addEventListener('hidden.bs.modal', function () {
                                    this.remove();
                                });
                            };
                        } catch (e) {
                            console.error('æ— æ³•åˆ›å»ºå¤‡é€‰å‡½æ•°:', e);
                            alert('è‡ªåŠ¨é”å®šé…ç½®åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                            return;
                        }
                    }
                }
                
                // è°ƒç”¨æ‰¾åˆ°çš„å‡½æ•°
                if (typeof func === 'function') {
                    try {
                        func();
                    } catch (e) {
                        console.error('æ‰§è¡ŒshowAutoLockConfigæ—¶å‡ºé”™:', e);
                    }
                } else {
                    console.error('showAutoLockConfigå‡½æ•°ä»ç„¶æœªå®šä¹‰');
                    alert('è‡ªåŠ¨é”å®šé…ç½®åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                }
            } else {
                console.error('è·å–åº”ç”¨é…ç½®å¤±è´¥:', data.message);
                alert('è·å–é…ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        })
        .catch(error => {
            console.error('è·å–åº”ç”¨é…ç½®æ—¶å‡ºé”™:', error);
            alert('è·å–é…ç½®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
        });
    }
    
    // å¯†ç å¼ºåº¦éªŒè¯å‡½æ•°
    function validatePasswordStrength(password) {
        // è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        const isValidLength = password.length >= minLength;
    
        if (!isValidLength) {
            return { isValid: false, reason: `å¯†ç é•¿åº¦è‡³å°‘${minLength}ä½` };
        }
        if (!hasUpperCase) {
            return { isValid: false, reason: "å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯" };
        }
        if (!hasLowerCase) {
            return { isValid: false, reason: "å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯" };
        }
        if (!hasNumbers) {
            return { isValid: false, reason: "å¯†ç å¿…é¡»åŒ…å«æ•°å­—" };
        }
        if (!hasSpecialChar) {
            return { isValid: false, reason: "å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦(!@#$%^&*(),.?\":{}|<>)" };
        }
    
        return { isValid: true, reason: "" };
    }
    
    // ä¿å­˜è‡ªåŠ¨é”å®šé…ç½®åˆ°æœåŠ¡å™¨
    function saveAutoLockConfig() {
        // è·å–æ–°çš„é…ç½®å€¼
        const newTitle = document.getElementById('newTitle').value;
        const newTimeout = document.getElementById('newTimeout').value;
        const newReminder = document.getElementById('newReminder').value;
        const newStmtTimeout = document.getElementById('newStmtTimeout').value;
        const newConnTimeout = document.getElementById('newConnTimeout').value;
        const newMaxConnections = document.getElementById('newMaxConnections').value;
        const newMinConnections = document.getElementById('newMinConnections').value;
        const newPoolTimeout = document.getElementById('newPoolTimeout').value;
        const newResultCacheTime = document.getElementById('newResultCacheTime').value;
        const newMaxResultSize = document.getElementById('newMaxResultSize').value;
        const newPageSize = document.getElementById('newPageSize').value;
        const newLoginFailuresLimit = document.getElementById('newLoginFailuresLimit').value;
        const newAccountLockoutMinutes = document.getElementById('newAccountLockoutMinutes').value;
        const newConcurrentQueries = document.getElementById('newConcurrentQueries').value;
        const newQueryQueueSize = document.getElementById('newQueryQueueSize').value;
        const newMemoryLimitMb = document.getElementById('newMemoryLimitMb').value;
        const newBatchInsertSize = document.getElementById('newBatchInsertSize').value;
        const newTransactionTimeout = document.getElementById('newTransactionTimeout').value;
        const newConnectionRetryCount = document.getElementById('newConnectionRetryCount').value;
        const newLogRetentionDays = document.getElementById('newLogRetentionDays').value;
        const newAutoSaveInterval = document.getElementById('newAutoSaveInterval').value;
        const newPasswordStrengthRequired = document.getElementById('newPasswordStrengthRequired').value;
        const newThemeColor = document.getElementById('newThemeColor').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        
        // éªŒè¯è¾“å…¥å€¼
        if (!newTitle || !newTimeout || !newReminder || !newStmtTimeout || !newConnTimeout || 
            !newMaxConnections || !newMinConnections || !newPoolTimeout || !newResultCacheTime || 
            !newMaxResultSize || !newPageSize || !newLoginFailuresLimit || !newAccountLockoutMinutes || 
            !newConcurrentQueries || !newQueryQueueSize || !newMemoryLimitMb || !newBatchInsertSize || 
            !newTransactionTimeout || !newConnectionRetryCount || !newLogRetentionDays || !newAutoSaveInterval) {
            showConfigAlert('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼', 'danger');
            return;
        }
        
        // éªŒè¯å¯†ç 
        if (newPassword && newPassword !== confirmNewPassword) {
            showConfigAlert('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´ï¼', 'danger');
            return;
        }
        
        const titleValue = newTitle.trim();
        const timeoutValue = parseInt(newTimeout);
        const reminderValue = parseInt(newReminder);
        const stmtTimeoutValue = parseInt(newStmtTimeout);
        const connTimeoutValue = parseInt(newConnTimeout);
        const maxConnectionsValue = parseInt(newMaxConnections);
        const minConnectionsValue = parseInt(newMinConnections);
        const poolTimeoutValue = parseInt(newPoolTimeout);
        const resultCacheTimeValue = parseInt(newResultCacheTime);
        const maxResultSizeValue = parseInt(newMaxResultSize);
        const pageSizeValue = parseInt(newPageSize);
        const loginFailuresLimitValue = parseInt(newLoginFailuresLimit);
        const accountLockoutMinutesValue = parseInt(newAccountLockoutMinutes);
        const concurrentQueriesValue = parseInt(newConcurrentQueries);
        const queryQueueSizeValue = parseInt(newQueryQueueSize);
        const memoryLimitMbValue = parseInt(newMemoryLimitMb);
        const batchInsertSizeValue = parseInt(newBatchInsertSize);
        const transactionTimeoutValue = parseInt(newTransactionTimeout);
        const connectionRetryCountValue = parseInt(newConnectionRetryCount);
        const logRetentionDaysValue = parseInt(newLogRetentionDays);
        const autoSaveIntervalValue = parseInt(newAutoSaveInterval);
        const passwordStrengthRequiredValue = newPasswordStrengthRequired === 'true';
        const themeColorValue = newThemeColor;
        const passwordValue = newPassword; // ä¿ç•™åŸå§‹å€¼ï¼Œä¸è½¬æ¢ä¸ºæ•´æ•°
        
        // å¦‚æœå¯ç”¨äº†å¯†ç å¤æ‚åº¦éªŒè¯ï¼Œæ£€æŸ¥å¯†ç å¼ºåº¦
        if (passwordStrengthRequiredValue && newPassword) {
            const passwordValidationResult = validatePasswordStrength(newPassword);
            if (!passwordValidationResult.isValid) {
                showConfigAlert(`å¯†ç ä¸ç¬¦åˆå¤æ‚åº¦è¦æ±‚: ${passwordValidationResult.reason}`, 'danger');
                return;
            }
        }
        
        if (titleValue.length === 0) {
            showConfigAlert('åº”ç”¨æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼', 'danger');
            return;
        }
        
        if (titleValue.length > 50) {
            showConfigAlert('åº”ç”¨æ ‡é¢˜ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦ï¼', 'danger');
            return;
        }
        
        if (isNaN(timeoutValue) || isNaN(reminderValue) || isNaN(stmtTimeoutValue) || isNaN(connTimeoutValue)) {
            showConfigAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼', 'danger');
            return;
        }
        
        if (timeoutValue <= 0 || timeoutValue > 1440) {
            showConfigAlert('è‡ªåŠ¨é”å®šæ—¶é—´åº”åœ¨1-1440åˆ†é’Ÿä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (reminderValue <= 0 || reminderValue >= timeoutValue) {
            showConfigAlert('æé†’æ—¶é—´åº”å¤§äº0ä¸”å°äºè‡ªåŠ¨é”å®šæ—¶é—´ï¼', 'danger');
            return;
        }
        
        if (stmtTimeoutValue <= 0 || stmtTimeoutValue > 300) {
            showConfigAlert('è¯­å¥è¶…æ—¶æ—¶é—´åº”åœ¨1-300ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (connTimeoutValue <= 0 || connTimeoutValue > 60) {
            showConfigAlert('è¿æ¥è¶…æ—¶æ—¶é—´åº”åœ¨1-60ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (maxConnectionsValue <= 0 || maxConnectionsValue > 100) {
            showConfigAlert('æœ€å¤§è¿æ¥æ•°åº”åœ¨1-100ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (minConnectionsValue < 0 || minConnectionsValue > 10) {
            showConfigAlert('æœ€å°è¿æ¥æ•°åº”åœ¨0-10ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (poolTimeoutValue <= 0 || poolTimeoutValue > 300) {
            showConfigAlert('è¿æ¥æ± è¶…æ—¶æ—¶é—´åº”åœ¨1-300ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (resultCacheTimeValue <= 0 || resultCacheTimeValue > 7200) {
            showConfigAlert('ç»“æœç¼“å­˜æ—¶é—´åº”åœ¨1-7200ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (maxResultSizeValue <= 0 || maxResultSizeValue > 100000) {
            showConfigAlert('æœ€å¤§ç»“æœé›†å¤§å°åº”åœ¨1-100000ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (pageSizeValue <= 0 || pageSizeValue > 500) {
            showConfigAlert('é¡µé¢å¤§å°åº”åœ¨1-500ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (loginFailuresLimitValue <= 0 || loginFailuresLimitValue > 20) {
            showConfigAlert('ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶åº”åœ¨1-20ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (accountLockoutMinutesValue <= 0 || accountLockoutMinutesValue > 1440) {
            showConfigAlert('è´¦æˆ·é”å®šæ—¶é—´åº”åœ¨1-1440åˆ†é’Ÿä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (concurrentQueriesValue <= 0 || concurrentQueriesValue > 20) {
            showConfigAlert('å¹¶å‘æŸ¥è¯¢æ•°åº”åœ¨1-20ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (queryQueueSizeValue <= 0 || queryQueueSizeValue > 50) {
            showConfigAlert('æŸ¥è¯¢é˜Ÿåˆ—å¤§å°åº”åœ¨1-50ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (memoryLimitMbValue <= 0 || memoryLimitMbValue > 2048) {
            showConfigAlert('å†…å­˜é™åˆ¶åº”åœ¨1-2048 MBä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (batchInsertSizeValue <= 0 || batchInsertSizeValue > 10000) {
            showConfigAlert('æ‰¹é‡æ’å…¥å¤§å°åº”åœ¨1-10000ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (transactionTimeoutValue <= 0 || transactionTimeoutValue > 600) {
            showConfigAlert('äº‹åŠ¡è¶…æ—¶æ—¶é—´åº”åœ¨1-600ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (connectionRetryCountValue < 0 || connectionRetryCountValue > 10) {
            showConfigAlert('è¿æ¥é‡è¯•æ¬¡æ•°åº”åœ¨0-10ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (logRetentionDaysValue <= 0 || logRetentionDaysValue > 365) {
            showConfigAlert('æ—¥å¿—ä¿ç•™å¤©æ•°åº”åœ¨1-365å¤©ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (autoSaveIntervalValue < 0 || autoSaveIntervalValue > 3600) {
            showConfigAlert('è‡ªåŠ¨ä¿å­˜é—´éš”åº”åœ¨0-3600ç§’ä¹‹é—´ï¼', 'danger');
            return;
        }
        
        if (typeof passwordStrengthRequiredValue !== 'boolean') {
            showConfigAlert('å¯†ç å¤æ‚åº¦éªŒè¯è®¾ç½®æ— æ•ˆï¼', 'danger');
            return;
        }
        
        if (!['default', 'blue', 'green', 'purple', 'red', 'orange', 'night', 'ocean', 'sunset', 'forest', 'sakura', 'ibm', 'oracle', 'sap', 'microsoft', 'google', 'amazon', 'apple'].includes(themeColorValue)) {
            showConfigAlert('ä¸»é¢˜é¢œè‰²è®¾ç½®æ— æ•ˆï¼', 'danger');
            return;
        }
        
        // å‘é€è¯·æ±‚åˆ°åç«¯ä¿å­˜é…ç½®
        const headers = {
            'Content-Type': 'application/json'
        };
        const sessionToken = localStorage.getItem('app_session_token');
        if (sessionToken) {
            headers['X-Session-Token'] = sessionToken;
        }
        
        fetch('/save_app_config', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                app_auto_lock_timeout_minutes: timeoutValue,
                app_auto_lock_reminder_minutes: reminderValue,
                app_title: titleValue,
                db_statement_timeout: stmtTimeoutValue,
                db_connect_timeout: connTimeoutValue,
                app_max_connections: maxConnectionsValue,
                app_min_connections: minConnectionsValue,
                app_connection_pool_timeout: poolTimeoutValue,
                app_result_cache_time: resultCacheTimeValue,
                app_max_result_size: maxResultSizeValue,
                app_login_failures_limit: loginFailuresLimitValue,
                app_account_lockout_minutes: accountLockoutMinutesValue,
                app_password_strength_required: passwordStrengthRequiredValue,  // ä»ç•Œé¢è·å–å¯†ç å¤æ‚åº¦éªŒè¯è®¾ç½®
                app_log_level: "INFO",  // é»˜è®¤æ—¥å¿—çº§åˆ«
                app_log_retention_days: logRetentionDaysValue,
                app_audit_logging_enabled: true,  // é»˜è®¤å¯ç”¨å®¡è®¡æ—¥å¿—
                app_theme_color: themeColorValue,  // ä»ç•Œé¢è·å–ä¸»é¢˜é¢œè‰²è®¾ç½®
                app_language: "zh-CN",  // é»˜è®¤è¯­è¨€
                app_page_size: pageSizeValue,
                app_auto_save_interval: autoSaveIntervalValue,
                app_concurrent_queries: concurrentQueriesValue,
                app_query_queue_size: queryQueueSizeValue,
                app_memory_limit_mb: memoryLimitMbValue,
                app_batch_insert_size: batchInsertSizeValue,
                app_transaction_timeout: transactionTimeoutValue,
                app_connection_retry_count: connectionRetryCountValue,
                app_password: passwordValue  // æ·»åŠ å¯†ç å­—æ®µ
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„é…ç½®
                document.getElementById('currentTitle').textContent = titleValue;
                document.getElementById('currentTimeout').textContent = timeoutValue;
                document.getElementById('currentReminder').textContent = reminderValue;
                document.getElementById('currentStmtTimeout').textContent = stmtTimeoutValue;
                document.getElementById('currentConnTimeout').textContent = connTimeoutValue;
                document.getElementById('currentMaxConnections').textContent = maxConnectionsValue;
                document.getElementById('currentMinConnections').textContent = minConnectionsValue;
                document.getElementById('currentPoolTimeout').textContent = poolTimeoutValue;
                document.getElementById('currentResultCache').textContent = resultCacheTimeValue;
                document.getElementById('currentMaxResultSize').textContent = maxResultSizeValue;
                document.getElementById('currentPasswordStrengthRequired').textContent = passwordStrengthRequiredValue ? 'å¯ç”¨' : 'ç¦ç”¨';
                document.getElementById('currentThemeColor').textContent = themeColorValue;
                
                // æ›´æ–°å…¨å±€é…ç½®å˜é‡
                if (window.appConfig) {
                    window.appConfig.app_title = titleValue;
                    window.appConfig.app_auto_lock_timeout_minutes = timeoutValue;
                    window.appConfig.app_auto_lock_reminder_minutes = reminderValue;
                    window.appConfig.db_statement_timeout = stmtTimeoutValue;
                    window.appConfig.db_connect_timeout = connTimeoutValue;
                    window.appConfig.app_max_connections = maxConnectionsValue;
                    window.appConfig.app_min_connections = minConnectionsValue;
                    window.appConfig.app_connection_pool_timeout = poolTimeoutValue;
                    window.appConfig.app_result_cache_time = resultCacheTimeValue;
                    window.appConfig.app_max_result_size = maxResultSizeValue;
                    window.appConfig.app_login_failures_limit = loginFailuresLimitValue;
                    window.appConfig.app_account_lockout_minutes = accountLockoutMinutesValue;
                    window.appConfig.app_log_retention_days = logRetentionDaysValue;
                    window.appConfig.app_page_size = pageSizeValue;
                    window.appConfig.app_auto_save_interval = autoSaveIntervalValue;
                    window.appConfig.app_concurrent_queries = concurrentQueriesValue;
                    window.appConfig.app_query_queue_size = queryQueueSizeValue;
                    window.appConfig.app_memory_limit_mb = memoryLimitMbValue;
                    window.appConfig.app_batch_insert_size = batchInsertSizeValue;
                    window.appConfig.app_transaction_timeout = transactionTimeoutValue;
                    window.appConfig.app_connection_retry_count = connectionRetryCountValue;
                    window.appConfig.app_password_strength_required = passwordStrengthRequiredValue;
                    window.appConfig.app_theme_color = themeColorValue;
                    window.appConfig.app_password = passwordValue;
                }
                
                // åº”ç”¨æ–°çš„ä¸»é¢˜é¢œè‰²
                if (themeColorValue) {
                    applyTheme(themeColorValue);
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œç„¶ååœ¨æç¤ºå…³é—­åå…³é—­ä¸»é…ç½®æ¨¡æ€æ¡†
                showConfigAlert('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success', function() {
                    // åœ¨æˆåŠŸæç¤ºæ¨¡æ€æ¡†å…³é—­åï¼Œå…³é—­ä¸»é…ç½®æ¨¡æ€æ¡†
                    const configModal = document.getElementById('autoLockConfigModal');
                    if (configModal) {
                        const modalInstance = bootstrap.Modal.getInstance(configModal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                });
            } else {
                showConfigAlert('ä¿å­˜å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        })
        .catch(error => {
            console.error('ä¿å­˜é…ç½®æ—¶å‡ºé”™:', error);
            showConfigAlert('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 'danger');
        });
    }
    
    // æ˜¾ç¤ºé…ç½®æ“ä½œçš„æ¨¡æ€æ¡†æç¤º
    function showConfigAlert(message, type = 'info', onCloseCallback = null) {
        // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æç¤ºæ¨¡æ€æ¡†
        const existingModal = document.getElementById('configAlertModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // åˆ›å»ºæ¨¡æ€æ¡†HTML
        const alertModal = document.createElement('div');
        alertModal.className = 'modal fade';
        alertModal.id = 'configAlertModal';
        alertModal.tabIndex = -1;
        alertModal.setAttribute('aria-labelledby', 'configAlertModalLabel');
        alertModal.setAttribute('aria-hidden', 'true');
        alertModal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-${type}" style="color: white;">
                        <h5 class="modal-title" id="configAlertModalLabel">é…ç½®æç¤º</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex align-items-center">
                            <i class="fas ${type === 'success' ? 'fa-check-circle text-success' : type === 'danger' ? 'fa-exclamation-triangle text-danger' : 'fa-info-circle text-info'} me-3" style="font-size: 1.5rem;"></i>
                            <span>${message}</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-${type === 'danger' ? 'secondary' : 'primary'}" data-bs-dismiss="modal">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(alertModal);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modalInstance = new bootstrap.Modal(alertModal);
        modalInstance.show();
        
        // æ¨¡æ€æ¡†éšè—æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°å¹¶æ¸…ç†DOMå…ƒç´ 
        alertModal.addEventListener('hidden.bs.modal', function () {
            if (onCloseCallback && typeof onCloseCallback === 'function') {
                onCloseCallback();
            }
            this.remove();
        });
    }
    
    /**
     * å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºRGBAæ ¼å¼
     * @param {string} hex - åå…­è¿›åˆ¶é¢œè‰²å€¼
     * @param {number} alpha - é€æ˜åº¦
     * @returns {string} RGBAé¢œè‰²å€¼
     */
    function hexToRgbA(hex, alpha) {
        // ç§»é™¤ # ç¬¦å·
        const cleanHex = hex.replace('#', '');
        
        // è§£æRGBå€¼
        const r = parseInt(cleanHex.substring(0, 2), 16);
        const g = parseInt(cleanHex.substring(2, 4), 16);
        const b = parseInt(cleanHex.substring(4, 6), 16);
        
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // æ›´æ–°faviconå›¾æ ‡ä¸ºRå­—æ¯
    function updateFavicon(color) {
        // ç¡®ä¿é¢œè‰²æ ¼å¼æ­£ç¡®
        if (!color.startsWith('#')) {
            // å¦‚æœä¸æ˜¯åå…­è¿›åˆ¶æ ¼å¼ï¼Œè½¬æ¢ä¸ºåå…­è¿›åˆ¶
            if (color.startsWith('rgb')) {
                // æå–rgbå€¼å¹¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶
                const match = color.match(/\d+/g);
                if (match && match.length >= 3) {
                    const [r, g, b] = match;
                    color = '#' + [r, g, b].map(x => {
                        const hex = parseInt(x).toString(16);
                        return hex.length === 1 ? '0' + hex : hex;
                    }).join('');
                }
            } else {
                // é»˜è®¤é¢œè‰²
                color = '#1890ff';
            }
        }

        // åˆ›å»ºåŒ…å«Rå­—æ¯çš„SVG faviconï¼ˆä½¿ç”¨åŸæ¥çš„Rå­—æ¯è·¯å¾„ï¼‰
        const svgContent = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect width="100" height="100" fill="${color}" />
                <path d="M 30 20 L 30 80 M 30 20 L 60 20 C 70 20, 75 27, 75 35 C 75 43, 70 50, 60 50 L 30 50 M 55 50 L 75 80" 
                      fill="none" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
        
        // ç¼–ç SVGå†…å®¹
        const encodedSvg = encodeURIComponent(svgContent);
        const dataUrl = `data:image/svg+xml,${encodedSvg}`;
        
        // æ›´æ–°favicon
        const favicon = document.getElementById('dynamicFavicon');
        if (favicon) {
            favicon.href = dataUrl;
        }
    }

    // ä¸ºå…¼å®¹æ€§ä¹Ÿæä¾›å°å†™ç‰ˆæœ¬
    function hexToRgba(hex, alpha) {
        return hexToRgbA(hex, alpha);
    }
    
    </script>
    <style>
        /* æ·»åŠ æŠ˜å åŠŸèƒ½çš„æ ·å¼ */
        .common-header {
            cursor: pointer;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .common-header:hover {
            background-color: #e9ecef;
        }

        .common-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .common-toggle-icon {
            transition: transform 0.3s;
        }

        .collapse:not(.show) .common-toggle-icon {
            transform: rotate(-90deg);
        }

        .common-body-wrapper {
            background-color: #fff;
            border-radius: 0 0 6px 6px;
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }

        .config-header {
            cursor: pointer;
            padding: 12px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .config-header:hover {
            background-color: #e9ecef;
        }

        .config-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-toggle-icon {
            transition: transform 0.3s;
        }

        .collapse:not(.show) .config-toggle-icon {
            transform: rotate(-90deg);
        }

        .config-body-wrapper {
            background-color: #fff;
            border-radius: 0 0 6px 6px;
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }
    </style>
    
    <!-- å¼•å…¥Prism.jsç”¨äºSQLè¯­æ³•é«˜äº® -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prism.css') }}">
    <!-- ä¿®å¤æ•°æ®åº“é…ç½®å¯¼å‡ºåŠŸèƒ½çš„è„šæœ¬ -->
    <script src="{{ url_for('static', filename='js/fix-export-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sql-formatter.min.js') }}"></script>
    <!-- exact-plsql-developer-beautifier.js å·²åºŸå¼ƒï¼Œä½¿ç”¨åŸºäºæ•°æ®åº“ç±»å‹çš„åŠ¨æ€ç¾åŒ– -->
    <script src="{{ url_for('static', filename='js/prism.js') }}"></script>
    <script>
        // å½“å‰æ•°æ®åº“ç±»å‹
        let currentDbType = 'sql'; // é»˜è®¤ä¸ºé€šç”¨SQL
        
        // æ›´æ–°æ•°æ®åº“ç±»å‹
        function updateDbType(dbType) {
            // å°†æ•°æ®åº“ç±»å‹æ˜ å°„åˆ°Prismæ”¯æŒçš„è¯­è¨€
            const dbTypeMap = {
                'mysql': 'sql',
                'postgresql': 'sql',
                'sqlite': 'sql',
                'oracle': 'sql',
                'sqlserver': 'sql',
                'mariadb': 'sql',
                'db2': 'sql',
                'mongodb': 'javascript', // MongoDBä½¿ç”¨javascriptè¯­æ³•
                'redis': 'cli', // Redisä½¿ç”¨å‘½ä»¤è¡Œè¯­æ³•
                'elasticsearch': 'json', // Elasticsearchä½¿ç”¨JSONè¯­æ³•
                'cassandra': 'cql', // Cassandraä½¿ç”¨CQL
                'hbase': 'shell', // HBaseä½¿ç”¨shellè¯­æ³•
                'hive': 'sql', // Hiveä½¿ç”¨SQLè¯­æ³•
                'impala': 'sql', // Impalaä½¿ç”¨SQLè¯­æ³•
                'presto': 'sql', // Prestoä½¿ç”¨SQLè¯­æ³•
                'clickhouse': 'sql', // ClickHouseä½¿ç”¨SQLè¯­æ³•
                'doris': 'sql', // Dorisä½¿ç”¨SQLè¯­æ³•
                'tdengine': 'sql', // TDengineä½¿ç”¨SQLè¯­æ³•
                'starrocks': 'sql', // StarRocksä½¿ç”¨SQLè¯­æ³•
                'greenplum': 'sql', // Greenplumä½¿ç”¨SQLè¯­æ³•
                'dameng': 'sql', // è¾¾æ¢¦æ•°æ®åº“ä½¿ç”¨SQLè¯­æ³•
                'kingbase': 'sql', // äººå¤§é‡‘ä»“ä½¿ç”¨SQLè¯­æ³•
                'yashandb': 'sql', // å´–å±±æ•°æ®åº“ä½¿ç”¨é»˜è®¤SQLè¯­æ³•
                'shentong': 'sql', // ç¥é€šæ•°æ®åº“ä½¿ç”¨SQLè¯­æ³•
                'gbase': 'sql', // å—å¤§é€šç”¨SQLè¯­æ³•
                'xugu': 'sql', // è™šè°·æ•°æ®åº“ä½¿ç”¨SQLè¯­æ³•
                'oscar': 'sql', // ä¸­å…´OSCARä½¿ç”¨SQLè¯­æ³•
                'highgo': 'sql', // ç€šé«˜æ•°æ®åº“ä½¿ç”¨SQLè¯­æ³•
                'inceptor': 'sql' // Inceptorä½¿ç”¨SQLè¯­æ³•
            };
            
            // å¦‚æœæ˜ å°„å­˜åœ¨åˆ™ä½¿ç”¨æ˜ å°„å€¼ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤sql
            currentDbType = dbTypeMap[dbType.toLowerCase()] || 'sql';
        }

        // ä¿å­˜å…‰æ ‡ä½ç½®
        function saveCaretPosition(element) {
            const caretOffset = getCaretPosition(element);
            return caretOffset;
        }

        // è·å–å…‰æ ‡ä½ç½®
        function getCaretPosition(element) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return 0;

            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(element);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            return preCaretRange.toString().length;
        }

        // æ¢å¤å…‰æ ‡ä½ç½®
        function restoreCaretPosition(element, caretPos) {
            if (caretPos === undefined) return;

            let charIndex = 0;
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            let node;
            while (node = walker.nextNode()) {
                const nextCharIndex = charIndex + node.nodeValue.length;
                if (caretPos <= nextCharIndex) {
                    const range = document.createRange();
                    range.setStart(node, caretPos - charIndex);
                    range.collapse(true);

                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    break;
                }
                charIndex = nextCharIndex;
            }
        }

        // å®æ—¶æ›´æ–°SQLè¯­æ³•é«˜äº®
        function updateSqlHighlight() {
            const sqlInput = document.getElementById('sqlInput');
            
            if (sqlInput) {
                // ä¿å­˜å½“å‰å…‰æ ‡ä½ç½®
                const caretPos = saveCaretPosition(sqlInput);
                
                // æ ¹æ®å…ƒç´ ç±»å‹æ­£ç¡®è·å–å†…å®¹
                let sqlContent = '';
                if (sqlInput.tagName.toLowerCase() === 'textarea') {
                    sqlContent = sqlInput.value || '';
                } else if (sqlInput.contentEditable === 'true') {
                    sqlContent = sqlInput.textContent || sqlInput.innerText || '';
                } else {
                    // å…œåº•æ–¹æ¡ˆ
                    sqlContent = sqlInput.value || sqlInput.textContent || sqlInput.innerText || '';
                }
                
                // å¦‚æœå†…å®¹ä¸ºç©ºã€ç”¨æˆ·å°šæœªä¸ç¼–è¾‘å™¨äº¤äº’ã€ä¸”ä¸åœ¨æ¸…é™¤å ä½ç¬¦è¿‡ç¨‹ä¸­ï¼Œæ˜¾ç¤ºå¸¦è¯­æ³•é«˜äº®çš„å ä½ç¬¦
                if (!sqlContent.trim() && !userInteractedWithEditor && !isClearingPlaceholder) {
                    const tempCode = document.createElement('code');
                    tempCode.className = `language-${currentDbType}`;
                    tempCode.textContent = 'SELECT * FROM your_table LIMIT 100;';
                    Prism.highlightElement(tempCode);
                    // æ·»åŠ æ·¡è‰²æ ·å¼åˆ°æ•´ä½“
                    sqlInput.innerHTML = `<span style="color: #6c757d;">${tempCode.innerHTML}</span>`;
                    // å¦‚æœæ˜¯ç©ºå†…å®¹ï¼Œå…‰æ ‡åº”è¯¥åœ¨å¼€å¤´
                    return;
                }
                
                // åˆ›å»ºä¸´æ—¶ä»£ç å…ƒç´ ç”¨äºPrismé«˜äº®
                const tempCode = document.createElement('code');
                tempCode.className = `language-${currentDbType}`;
                tempCode.textContent = sqlContent;
                
                // ä½¿ç”¨Prism.jsè¿›è¡Œè¯­æ³•é«˜äº®
                Prism.highlightElement(tempCode);
                
                // å°†é«˜äº®åçš„å†…å®¹æ’å…¥åˆ°æ˜¾ç¤ºåŒºåŸŸ
                sqlInput.innerHTML = tempCode.innerHTML;
                
                // æ¢å¤å…‰æ ‡ä½ç½®
                restoreCaretPosition(sqlInput, caretPos);
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥å¹¶å¼ºåˆ¶è®¾ç½®åˆå§‹çŠ¶æ€
        function initializeEditorState() {
            // é¡µé¢åŠ è½½æ—¶ï¼Œç”¨æˆ·å°šæœªä¸ç¼–è¾‘å™¨äº¤äº’
            userInteractedWithEditor = false;
        }
        
        // ä¸“é—¨ç”¨äºå¤„ç†è¾“å…¥äº‹ä»¶ï¼Œé¿å…ä¸ç‚¹å‡»äº‹ä»¶å†²çª
        let lastProcessedContent = '';
        
        function handleSqlInput() {
            const sqlInput = document.getElementById('sqlInput');
            autoResizeTextarea(sqlInput);
            checkSqlSafety();
            
            // æ ¹æ®å…ƒç´ ç±»å‹æ­£ç¡®è·å–å†…å®¹
            let currentContent = '';
            if (sqlInput.tagName.toLowerCase() === 'textarea') {
                currentContent = sqlInput.value || '';
            } else if (sqlInput.contentEditable === 'true') {
                currentContent = sqlInput.textContent || sqlInput.innerText || '';
            } else {
                // å…œåº•æ–¹æ¡ˆ
                currentContent = sqlInput.value || sqlInput.textContent || sqlInput.innerText || '';
            }
            
            // æ£€æŸ¥å†…å®¹æ˜¯å¦çœŸæ­£å‘ç”Ÿäº†å˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å¤„ç†
            if (currentContent !== lastProcessedContent) {
                lastProcessedContent = currentContent;
                
                // ç”¨æˆ·ä¸ç¼–è¾‘å™¨è¿›è¡Œäº¤äº’ï¼Œè®¾ç½®æ ‡å¿—
                userInteractedWithEditor = true;
                
                updateSqlHighlight(); // æ›´æ–°è¯­æ³•é«˜äº®
            }
        }
        

        

        

        

        
        // æ ¼å¼åŒ–å½“å‰SQL - é‡å†™ç‰ˆæœ¬ï¼šæ ¹æ®æ•°æ®åº“è¿æ¥çŠ¶æ€é€‰æ‹©ç¾åŒ–ç­–ç•¥
        function formatCurrentSql() {
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {
                // æ ¹æ®å…ƒç´ ç±»å‹æ­£ç¡®è·å–å†…å®¹
                let currentText = '';
                if (sqlInput.tagName.toLowerCase() === 'textarea') {
                    currentText = sqlInput.value || '';
                } else if (sqlInput.contentEditable === 'true') {
                    currentText = sqlInput.textContent || sqlInput.innerText || '';
                } else {
                    // å…œåº•æ–¹æ¡ˆ
                    currentText = sqlInput.value || sqlInput.textContent || sqlInput.innerText || '';
                }
                
                if (currentText.trim()) {
                    try {
                        let formattedSql;
                        
                        // åˆ¤æ–­æ˜¯å¦è¿æ¥äº†æ•°æ®åº“
                        const isConnected = window.currentConnectedDbId && 
                                          window.allDatabasesCache && 
                                          window.allDatabasesCache.find(db => db.id === window.currentConnectedDbId);
                        
                        if (isConnected) {
                            // å·²è¿æ¥æ•°æ®åº“ï¼šæ ¹æ®æ•°æ®åº“ç±»å‹ä½¿ç”¨å¯¹åº”çš„SQLç¾åŒ–è§„åˆ™
                            console.log('æ£€æµ‹åˆ°æ•°æ®åº“è¿æ¥ï¼Œä½¿ç”¨æ•°æ®åº“ç‰¹å®šç¾åŒ–è§„åˆ™');
                            const dbType = getCurrentDatabaseType();
                            formattedSql = formatWithDatabaseRules(currentText, dbType);
                        } else {
                            // æœªè¿æ¥æ•°æ®åº“ï¼šé»˜è®¤ä½¿ç”¨PostgreSQLç¾åŒ–è§„åˆ™
                            console.log('æœªæ£€æµ‹åˆ°æ•°æ®åº“è¿æ¥ï¼Œä½¿ç”¨é»˜è®¤PostgreSQLç¾åŒ–è§„åˆ™');
                            formattedSql = formatWithDatabaseRules(currentText, 'postgresql');
                        }
                        
                        // åº”ç”¨æ ¼å¼åŒ–ç»“æœ
                        applyFormattedSql(sqlInput, formattedSql);
                        
                    } catch (e) {
                        console.error('SQLæ ¼å¼åŒ–å¤±è´¥:', e);
                        updateSqlHighlight(); // è‡³å°‘æ›´æ–°è¯­æ³•é«˜äº®
                    }
                } else {
                    updateSqlHighlight();
                }
            }
        }
        
        // åŸºäºæ•°æ®åº“ç±»å‹çš„SQLç¾åŒ–å‡½æ•°
        function formatWithDatabaseRules(sql, dbType) {
            console.log('ä½¿ç”¨æ•°æ®åº“ç±»å‹ç¾åŒ–:', dbType);
            
            // å¦‚æœsql-formatterå¯ç”¨ï¼Œä¼˜å…ˆä½¿ç”¨
            if (typeof window.sqlFormatter !== 'undefined') {
                const config = getDatabaseFormatterConfig(dbType);
                console.log('ä½¿ç”¨sql-formatteré…ç½®:', config);
                try {
                    const formatted = window.sqlFormatter.format(sql, config);
                    console.log('sql-formatteræ ¼å¼åŒ–æˆåŠŸ');
                    return formatted;
                } catch (error) {
                    console.warn('sql-formatteræ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨å†…ç½®è§„åˆ™:', error);
                    // è®°å½•å¤±è´¥çš„SQLç‰‡æ®µç”¨äºè°ƒè¯•
                    console.debug('å¤±è´¥çš„SQLç‰‡æ®µ:', sql.substring(0, 100) + (sql.length > 100 ? '...' : ''));
                }
            }
            
            // sql-formatterä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨å†…ç½®çš„æ•°æ®åº“ç‰¹å®šè§„åˆ™
            return formatWithBuiltInRules(sql, dbType);
        }
        
        // è·å–æ•°æ®åº“ç‰¹å®šçš„formatteré…ç½®
        function getDatabaseFormatterConfig(dbType) {
            const configs = {
                oracle: { language: 'plsql' },
                postgresql: { language: 'postgresql' },
                mysql: { language: 'mysql' },
                sqlserver: { language: 'transactsql' },
                sqlite: { language: 'sqlite' },
                mariadb: { language: 'mysql' }, // MariaDBä½¿ç”¨MySQLè§„åˆ™
                yashandb: { language: 'plsql' }, // å´–å±±æ•°æ®åº“ä½¿ç”¨Oracle PL/SQLè§„åˆ™
                default: { language: 'sql' }
            };
            return configs[dbType.toLowerCase()] || configs.default;
        }
        
        // å†…ç½®çš„æ•°æ®åº“ç‰¹å®šç¾åŒ–è§„åˆ™
        function formatWithBuiltInRules(sql, dbType) {
            console.log('ä½¿ç”¨å†…ç½®è§„åˆ™æ ¼å¼åŒ–ï¼Œæ•°æ®åº“ç±»å‹:', dbType);
            
            // å´–å±±æ•°æ®åº“ä½¿ç”¨Oracleç¾åŒ–è§„åˆ™
            if (dbType.toLowerCase() === 'yashandb') {
                console.log('å´–å±±æ•°æ®åº“ä½¿ç”¨Oracleç¾åŒ–è§„åˆ™');
                return formatOracle(sql);
            }
            
            switch(dbType.toLowerCase()) {
                case 'postgresql':
                    return formatPostgreSQL(sql);
                case 'oracle':
                    return formatOracle(sql);
                case 'mysql':
                case 'mariadb':
                    return formatMySQL(sql);
                case 'sqlserver':
                    return formatSQLServer(sql);
                default:
                    return formatGenericSQL(sql);
            }
        }
        
        // PostgreSQLç¾åŒ–è§„åˆ™
        function formatPostgreSQL(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|LIMIT|OFFSET|UNION|INTERSECT|EXCEPT)\b/gi, '\n$1')
                .replace(/\b(AND|OR|NOT)\b/gi, '\n  $1')
                .replace(/\b(JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN|FULL JOIN|CROSS JOIN)\b/gi, '\n$1')
                .replace(/\b(ON|USING)\b/gi, '\n  $1')
                .replace(/,/g, ',\n  ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Oracleç¾åŒ–è§„åˆ™
        function formatOracle(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|UNION|INTERSECT|MINUS)\b/gi, '\n$1')
                .replace(/\b(AND|OR|NOT)\b/gi, '\n  $1')
                .replace(/\b(JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN|FULL JOIN)\b/gi, '\n$1')
                .replace(/\b(ON)\b/gi, '\n  $1')
                .replace(/,/g, ',\n  ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // MySQLç¾åŒ–è§„åˆ™
        function formatMySQL(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|LIMIT|UNION)\b/gi, '\n$1')
                .replace(/\b(AND|OR|NOT)\b/gi, '\n  $1')
                .replace(/\b(JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN)\b/gi, '\n$1')
                .replace(/\b(ON|USING)\b/gi, '\n  $1')
                .replace(/,/g, ',\n  ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // SQL Serverç¾åŒ–è§„åˆ™
        function formatSQLServer(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|UNION|TOP)\b/gi, '\n$1')
                .replace(/\b(AND|OR|NOT)\b/gi, '\n  $1')
                .replace(/\b(JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN|FULL JOIN|CROSS JOIN)\b/gi, '\n$1')
                .replace(/\b(ON)\b/gi, '\n  $1')
                .replace(/,/g, ',\n  ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // é€šç”¨SQLç¾åŒ–è§„åˆ™
        function formatGenericSQL(sql) {
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|UNION)\b/gi, '\n$1')
                .replace(/\b(AND|OR|NOT)\b/gi, '\n  $1')
                .replace(/\b(JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN)\b/gi, '\n$1')
                .replace(/\b(ON)\b/gi, '\n  $1')
                .replace(/,/g, ',\n  ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // åº”ç”¨æ ¼å¼åŒ–åçš„SQLåˆ°ç¼–è¾‘å™¨
        function applyFormattedSql(sqlInput, formattedSql) {
            // ä¿å­˜å½“å‰å…‰æ ‡ä½ç½®
            const caretPos = saveCaretPosition(sqlInput);
            
            // æ ¹æ®å…ƒç´ ç±»å‹æ­£ç¡®è®¾ç½®å†…å®¹
            if (sqlInput.tagName.toLowerCase() === 'textarea') {
                // å¯¹äºtextareaï¼Œä½¿ç”¨valueå±æ€§
                sqlInput.value = formattedSql;
            } else if (sqlInput.contentEditable === 'true') {
                // å¯¹äºcontenteditableå…ƒç´ ï¼Œä½¿ç”¨textContent
                sqlInput.textContent = formattedSql;
            } else {
                // å…œåº•æ–¹æ¡ˆï¼šå°è¯•å¤šç§æ–¹å¼
                if ('value' in sqlInput) {
                    sqlInput.value = formattedSql;
                } else {
                    sqlInput.textContent = formattedSql;
                }
            }
            
            // è®¾ç½®ç”¨æˆ·å·²äº¤äº’æ ‡å¿—
            userInteractedWithEditor = true;
            
            // é‡æ–°åº”ç”¨è¯­æ³•é«˜äº®
            updateSqlHighlight();
            
            // æ¢å¤å…‰æ ‡ä½ç½®
            setTimeout(() => {
                restoreCaretPosition(sqlInput, formattedSql.length);
            }, 0);
        }
        
        // è·å–å½“å‰æ•°æ®åº“ç±»å‹
        function getCurrentDatabaseType() {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å½“å‰è¿æ¥çš„æ•°æ®åº“
            if (window.currentConnectedDbId && window.allDatabasesCache) {
                const currentDb = window.allDatabasesCache.find(db => db.id === window.currentConnectedDbId);
                if (currentDb && currentDb.type) {
                    return currentDb.type.toLowerCase();
                }
            }
            
            // å¦‚æœæ²¡æœ‰è¿æ¥çš„æ•°æ®åº“ï¼Œä½¿ç”¨å…¨å±€çš„currentDbType
            if (typeof currentDbType !== 'undefined') {
                return currentDbType;
            }
            
            // é»˜è®¤è¿”å›é€šç”¨SQL
            return 'sql';
        }
        



        
        // é«˜çº§ç®€å•æ ¼å¼åŒ–å‡½æ•°ï¼Œæä¾›æ›´å¥½çš„æ ¼å¼åŒ–æ•ˆæœ
        function advancedSimpleFormatSql(sql) {
            // é¢„å¤„ç†ï¼šè§„èŒƒåŒ–ç©ºæ ¼å’Œæ¢è¡Œ
            let formatted = sql
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                .replace(/\t/g, '  ')
                .replace(/\s+/g, ' ')
                .trim();
            
            // ä½¿ç”¨çŠ¶æ€æœºçš„æ–¹å¼è¿›è¡ŒSQLè§£æå’Œæ ¼å¼åŒ–
            // å®šä¹‰SQLå…³é”®å­—åˆ†ç±»
            const clauses = ['SELECT', 'FROM', 'WHERE', 'GROUP BY', 'ORDER BY', 'HAVING', 'LIMIT', 'OFFSET'];
            const dml = ['INSERT INTO', 'UPDATE', 'DELETE FROM'];
            const ddl = ['CREATE', 'DROP', 'ALTER'];
            const joins = ['JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL OUTER JOIN', 'LEFT OUTER JOIN', 'RIGHT OUTER JOIN'];
            const sets = ['UNION', 'UNION ALL', 'INTERSECT', 'EXCEPT'];
            const logicalOps = ['AND', 'OR', 'XOR'];
            const conditional = ['CASE', 'WHEN', 'THEN', 'ELSE', 'END'];
            
            // å°†SQLæŒ‰å…³é”®å­—è¿›è¡Œåˆ†å‰²
            let result = formatted;
            
            // å¤„ç†ä¸»è¦çš„SQLå­å¥
            [...clauses, ...dml, ...ddl, ...sets].forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                result = result.replace(regex, '\n$&');
            });
            
            // å¤„ç†JOIN
            joins.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                result = result.replace(regex, '\n  $&');
            });
            
            // æŒ‰è¡Œåˆ†å‰²å¤„ç†
            let lines = result.split('\n');
            let formattedLines = [];
            

            
            formatted = formattedLines.join('\n');
            
            // æœ€ç»ˆæ¸…ç† - å»é™¤å¤šä½™çš„ç©ºè¡Œå’Œç©ºæ ¼
            formatted = formatted
                .replace(/\n\s*\n/g, '\n')  // å¤šä¸ªç©ºè¡Œå˜ä¸ºä¸€ä¸ª
                .replace(/^\s+|\s+$/g, '')  // å»é™¤é¦–å°¾ç©ºæ ¼
                .replace(/\n+/g, '\n')      // è¿ç»­æ¢è¡Œå˜ä¸ºä¸€ä¸ª
                .trim();
            
            return formatted;
        }
        
        // ç®€å•çš„SQLæ ¼å¼åŒ–å‡½æ•°ä½œä¸ºå¤‡ç”¨
        function simpleFormatSql(sql) {
            // ä¿å­˜åŸå§‹æ¢è¡Œç¬¦ï¼Œé¿å…è¢«æ ¼å¼åŒ–ç ´å
            let formatted = sql.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // å®šä¹‰ä¸åŒçº§åˆ«çš„SQLå…³é”®å­—
            const clauseKeywords = ['SELECT', 'FROM', 'WHERE', 'GROUP BY', 'ORDER BY', 'HAVING', 'LIMIT'];
            const dmlKeywords = ['INSERT INTO', 'UPDATE', 'DELETE FROM'];
            const ddlKeywords = ['CREATE TABLE', 'ALTER TABLE', 'DROP TABLE', 'CREATE INDEX', 'DROP INDEX'];
            const joinKeywords = ['JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL OUTER JOIN', 'CROSS JOIN', 'NATURAL JOIN'];
            const setKeywords = ['UNION', 'UNION ALL', 'INTERSECT', 'EXCEPT'];
            const conditionalKeywords = ['AND', 'OR', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END'];
            
            // å¤„ç†ä¸»è¦çš„SQLå­å¥ - æ¯ä¸ªå­å¥ä¸€è¡Œï¼Œå¹¶ç¼©è¿›
            clauseKeywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                formatted = formatted.replace(regex, '\n' + keyword);
            });
            
            // å¤„ç†DMLè¯­å¥
            dmlKeywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                formatted = formatted.replace(regex, '\n' + keyword);
            });
            
            // å¤„ç†DDLè¯­å¥
            ddlKeywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                formatted = formatted.replace(regex, '\n' + keyword);
            });
            
            // å¤„ç†JOINè¯­å¥ - ä¸FROMå¯¹é½
            joinKeywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                formatted = formatted.replace(regex, '\n  ' + keyword);
            });
            
            // å¤„ç†é›†åˆæ“ä½œ
            setKeywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword.replace(/\s+/g, '\\s+') + '\\b', 'gi');
                formatted = formatted.replace(regex, '\n' + keyword + ' ');
            });
            
            // å¤„ç†æ¡ä»¶è¯­å¥
            conditionalKeywords.forEach(keyword => {
                if (keyword === 'AND' || keyword === 'OR') {
                    // AND/OR åœ¨æ–°è¡Œå¹¶ç¼©è¿›
                    formatted = formatted.replace(new RegExp('\\b' + keyword + '\\b', 'gi'), '\n    ' + keyword);
                } else {
                    // CASE, WHEN, THEN, ELSE, END å¤„ç†
                    formatted = formatted.replace(new RegExp('\\b' + keyword + '\\b', 'gi'), keyword);
                }
            });
            
            // å¤„ç†CASEè¯­å¥çš„ç¼©è¿›
            formatted = formatted.replace(/\b(CASE)\b/gi, '  $1');
            formatted = formatted.replace(/\b(WHEN)\b/gi, '    $1');
            formatted = formatted.replace(/\b(THEN)\b/gi, '      $1');
            formatted = formatted.replace(/\b(ELSE)\b/gi, '    $1');
            formatted = formatted.replace(/\b(END)\b/gi, '  $1');
            
            // å¤„ç†æ‹¬å·å†…çš„å†…å®¹ - ä½¿æ‹¬å·å†…å®¹é€‚å½“ç¼©è¿›
            formatted = formatted.replace(/\(/g, '( ');
            formatted = formatted.replace(/\)/g, ' )');
            
            // å¤„ç†é€—å· - æ¢è¡Œå¹¶å¯¹é½
            // å…ˆå¤„ç†å‡½æ•°å‚æ•°ä¸­çš„é€—å·ï¼ˆä¸æ¢è¡Œï¼‰
            formatted = formatted.replace(/\([^)]+\)/g, function(match) {
                return match.replace(/,\s*/g, ', ');
            });
            
            // ç„¶åå¤„ç†å­—æ®µåˆ—è¡¨ä¸­çš„é€—å·ï¼ˆæ¢è¡Œå¹¶ç¼©è¿›ï¼‰
            formatted = formatted.replace(/,\s*(?![^(]*\))/g, ',\n  '); // é¿å…åœ¨æ‹¬å·å†…æ¢è¡Œ
            
            // æ¸…ç†å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œ
            formatted = formatted.replace(/\n\s*\n/g, '\n'); // å¤šä¸ªç©ºè¡Œå˜ä¸€ä¸ª
            formatted = formatted.replace(/\s+/g, ' '); // å¤šä¸ªç©ºæ ¼å˜ä¸€ä¸ª
            formatted = formatted.replace(/\s*([,()])\s*/g, '$1'); // æ‹¬å·å’Œé€—å·å‘¨å›´çš„ç©ºæ ¼
            
            // ä¿®å¤æ‹¬å·ä¸­çš„ç©ºæ ¼
            formatted = formatted.replace(/\(\s+/g, '('); // å·¦æ‹¬å·åä¸ç•™ç©ºæ ¼
            formatted = formatted.replace(/\s+\)/g, ')'); // å³æ‹¬å·å‰ä¸ç•™ç©ºæ ¼
            
            // æœ€ç»ˆå¤„ç† - ä½¿å­å¥å¯¹é½
            let lines = formatted.split('\n');
            let result = [];
            let indentLevel = 0;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸»è¦å­å¥å¼€å§‹
                if (/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|LIMIT|INSERT INTO|UPDATE|DELETE FROM|CREATE|DROP|UNION)\b/i.test(line)) {
                    result.push(line);
                    indentLevel = line.startsWith('FROM') || line.startsWith('WHERE') ? 2 : 0;
                } else {
                    // å…¶ä»–è¡Œæ ¹æ®å†…å®¹æ·»åŠ é€‚å½“çš„ç¼©è¿›
                    if (/\b(JOIN|LEFT JOIN|RIGHT JOIN|INNER JOIN)\b/i.test(line)) {
                        result.push('  ' + line.trim());
                    } else if (/\b(AND|OR)\b/i.test(line)) {
                        result.push('    ' + line.trim());
                    } else {
                        result.push(line);
                    }
                }
            }
            
            formatted = result.join('\n');
            
            // æ¸…ç†å¼€å¤´å’Œç»“å°¾çš„ç©ºç™½
            formatted = formatted.trim();
            
            return formatted;
        }
        
        // ä¸“é—¨ç”¨äºå¤„ç†è¾“å…¥äº‹ä»¶
        function handleSqlInputOptimized() {
            const sqlInput = document.getElementById('sqlInput');
            console.log('handleSqlInputOptimized called');
            console.log('sqlInput element:', sqlInput);
            if (sqlInput) {
                console.log('Calling autoResizeTextarea');
                // ç›´æ¥è°ƒç”¨é«˜åº¦è°ƒæ•´
                autoResizeTextarea(sqlInput);
            } else {
                console.error('sqlInput element not found!');
            }
            checkSqlSafety();
            
            // ç”¨æˆ·ä¸ç¼–è¾‘å™¨è¿›è¡Œäº¤äº’ï¼Œè®¾ç½®æ ‡å¿—
            userInteractedWithEditor = true;
            
            updateSqlHighlight(); // æ›´æ–°è¯­æ³•é«˜äº®
        }
        

        

        
        // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²ç»ä¸ç¼–è¾‘å™¨è¿›è¡Œäº†äº¤äº’
        let userInteractedWithEditor = false;
        
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ¸…ç©ºå ä½ç¬¦ï¼Œé¿å…é‡å¤è§¦å‘
        let isClearingPlaceholder = false;
        
        // æ’¤é”€/é‡åšå†å²è®°å½•ç®¡ç†
        let undoHistory = [];
        let redoHistory = [];
        let currentHistoryIndex = -1;
        const MAX_HISTORY_SIZE = 50; // æœ€å¤§å†å²è®°å½•æ•°
        
        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
        function saveToHistory(content, cursorPosition) {
            const currentState = {
                content: content,
                cursorPosition: cursorPosition || 0
            };
            
            console.log('=== ä¿å­˜å†å²è®°å½• ===');
            console.log('ä¿å­˜å†…å®¹:', content);
            console.log('å…‰æ ‡ä½ç½®:', cursorPosition);
            console.log('ä¿å­˜å‰çŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length);
            
            // å¦‚æœå½“å‰ä¸æ˜¯æœ€æ–°çš„å†å²è®°å½•ï¼Œæ¸…é™¤åç»­çš„å†å²
            if (currentHistoryIndex < undoHistory.length - 1) {
                console.log('æ¸…ç†åç»­å†å²è®°å½•');
                undoHistory = undoHistory.slice(0, currentHistoryIndex + 1);
            }
            
            // æ·»åŠ æ–°çš„å†å²è®°å½•
            undoHistory.push(currentState);
            currentHistoryIndex++;
            
            // é™åˆ¶å†å²è®°å½•å¤§å°
            if (undoHistory.length > MAX_HISTORY_SIZE) {
                console.log('å†å²è®°å½•è¶…é™ï¼Œç§»é™¤æœ€æ—©è®°å½•');
                undoHistory.shift();
                currentHistoryIndex--;
            }
            
            // æ³¨æ„ï¼šä¸æ¸…ç©ºé‡åšå†å²ï¼Œä¿æŒé‡åšèƒ½åŠ›
            // redoHistory = []; // è¿™è¡Œè¢«æ³¨é‡Šæ‰æ˜¯å…³é”®ï¼
            
            console.log('ä¿å­˜åçŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length, 'å½“å‰ç´¢å¼•:', currentHistoryIndex);
            console.log('History saved:', { undoLength: undoHistory.length, currentIndex: currentHistoryIndex });
        }
        
        // æ’¤é”€æ“ä½œ
        function undo() {
            console.log('=== æ‰§è¡Œæ’¤é”€æ“ä½œ ===');
            console.log('æ’¤é”€å‰çŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length, 'å½“å‰ç´¢å¼•:', currentHistoryIndex);
            
            if (currentHistoryIndex > 0) {
                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšå†å²
                const currentContent = sqlInput.contentEditable === 'true' ? 
                    sqlInput.textContent : sqlInput.value;
                const currentCursorPos = getCaretPosition(sqlInput);
                
                console.log('ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšå†å²:', {
                    content: currentContent,
                    cursorPosition: currentCursorPos
                });
                
                redoHistory.push({
                    content: currentContent,
                    cursorPosition: currentCursorPos
                });
                
                // ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªå†å²çŠ¶æ€
                currentHistoryIndex--;
                const prevState = undoHistory[currentHistoryIndex];
                
                console.log('ä»æ’¤é”€å†å²å–å‡ºçŠ¶æ€:', prevState);
                
                // éªŒè¯prevStateæ˜¯å¦å­˜åœ¨ä¸”æœ‰contentå±æ€§
                if (!prevState || typeof prevState.content === 'undefined') {
                    console.error('æ’¤é”€çŠ¶æ€æ•°æ®å¼‚å¸¸:', prevState);
                    return;
                }
                
                // åº”ç”¨å†å²çŠ¶æ€
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = prevState.content;
                } else {
                    sqlInput.value = prevState.content;
                }
                
                setCaretPosition(sqlInput, prevState.cursorPosition);
                handleSqlInputOptimized();
                
                console.log('æ’¤é”€åçŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length, 'å½“å‰ç´¢å¼•:', currentHistoryIndex);
                console.log('Undo performed:', { currentIndex: currentHistoryIndex, contentLength: prevState.content.length });
            } else {
                console.log('æ— æ³•æ’¤é”€ï¼šå·²åˆ°è¾¾å†å²è®°å½•å¼€å§‹');
            }
        }
        
        // é‡åšæ“ä½œ
        function redo() {
            console.log('=== æ‰§è¡Œé‡åšæ“ä½œ ===');
            console.log('é‡åšå‰çŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length, 'å½“å‰ç´¢å¼•:', currentHistoryIndex);
            
            if (redoHistory.length > 0) {
                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€å†å²ï¼ˆä¸ºäº†èƒ½å¤Ÿå†æ¬¡æ’¤é”€è¿™æ¬¡é‡åšï¼‰
                const currentContent = sqlInput.contentEditable === 'true' ? 
                    sqlInput.textContent : sqlInput.value;
                const currentCursorPos = getCaretPosition(sqlInput);
                
                console.log('ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€å†å²:', {
                    content: currentContent,
                    cursorPosition: currentCursorPos
                });
                
                // æ³¨æ„ï¼šè¿™é‡Œä¸è°ƒç”¨saveToHistoryï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œæ•°ç»„
                // å› ä¸ºsaveToHistoryä¼šæ¸…ç©ºredoHistory
                const currentState = {
                    content: currentContent,
                    cursorPosition: currentCursorPos
                };
                
                // å¦‚æœå½“å‰ä¸æ˜¯æœ€æ–°çš„å†å²è®°å½•ï¼Œæ¸…é™¤åç»­çš„å†å²
                if (currentHistoryIndex < undoHistory.length - 1) {
                    undoHistory = undoHistory.slice(0, currentHistoryIndex + 1);
                }
                
                undoHistory.push(currentState);
                currentHistoryIndex++;
                
                // é™åˆ¶å†å²è®°å½•å¤§å°
                if (undoHistory.length > MAX_HISTORY_SIZE) {
                    undoHistory.shift();
                    currentHistoryIndex--;
                }
                
                // ä»é‡åšå†å²å–å‡ºçŠ¶æ€
                const nextState = redoHistory.pop();
                
                console.log('ä»é‡åšå†å²å–å‡ºçŠ¶æ€:', nextState);
                
                // éªŒè¯nextStateæ˜¯å¦å­˜åœ¨ä¸”æœ‰contentå±æ€§
                if (!nextState || typeof nextState.content === 'undefined') {
                    console.error('é‡åšçŠ¶æ€æ•°æ®å¼‚å¸¸:', nextState);
                    return;
                }
                
                // åº”ç”¨é‡åšçŠ¶æ€
                if (sqlInput.contentEditable === 'true') {
                    sqlInput.textContent = nextState.content;
                } else {
                    sqlInput.value = nextState.content;
                }
                
                setCaretPosition(sqlInput, nextState.cursorPosition);
                handleSqlInputOptimized();
                
                console.log('é‡åšåçŠ¶æ€ - æ’¤é”€å†å²:', undoHistory.length, 'é‡åšå†å²:', redoHistory.length, 'å½“å‰ç´¢å¼•:', currentHistoryIndex);
                console.log('Redo performed:', { redoLength: redoHistory.length, contentLength: nextState.content.length });
            } else {
                console.log('æ— æ³•æ‰§è¡Œé‡åšï¼šé‡åšå†å²ä¸ºç©º');
            }
        }
        
        // è·å–å…‰æ ‡ä½ç½®
        function getCaretPosition(element) {
            if (element.contentEditable === 'true') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    return preCaretRange.toString().length;
                }
                return 0;
            } else {
                return element.selectionStart || 0;
            }
        }
        
        // è®¾ç½®å…‰æ ‡ä½ç½®
        function setCaretPosition(element, position) {
            if (element.contentEditable === 'true') {
                const range = document.createRange();
                const selection = window.getSelection();
                
                // æ‰¾åˆ°æ­£ç¡®çš„èŠ‚ç‚¹å’Œåç§»é‡
                let currentPos = 0;
                const walkNodes = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        if (currentPos + node.textContent.length >= position) {
                            range.setStart(node, position - currentPos);
                            range.collapse(true);
                            return true;
                        }
                        currentPos += node.textContent.length;
                    } else {
                        for (let child of node.childNodes) {
                            if (walkNodes(child)) return true;
                        }
                    }
                    return false;
                };
                
                walkNodes(element);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                element.setSelectionRange(position, position);
            }
        }
        

        

        

        
        // åŠ¨æ€è°ƒæ•´æ¨¡æ€æ¡†å°ºå¯¸ä»¥é€‚åº”ç§»åŠ¨ç«¯
        function adjustModalForMobile() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            const isMobile = window.innerWidth <= 768;
                
            if (isMobile) {
                // è·å–æ‰€æœ‰æ¨¡æ€æ¡†
                const modals = document.querySelectorAll('.modal');
                    
                modals.forEach(modal => {
                    const dialog = modal.querySelector('.modal-dialog');
                    const content = modal.querySelector('.modal-content');
                        
                    if (dialog && content) {
                        // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è°ƒæ•´
                        if (window.innerWidth <= 576) {
                            // è¶…å°å±å¹•è®¾å¤‡
                            dialog.style.margin = '0.25rem';
                            dialog.style.maxWidth = 'calc(100vw - 0.5rem)';
                            content.style.maxHeight = '95vh';
                            content.style.borderRadius = '8px';
                        } else {
                            // ä¸­ç­‰ç§»åŠ¨è®¾å¤‡
                            dialog.style.margin = '0.5rem';
                            dialog.style.maxWidth = 'calc(100vw - 1rem)';
                            content.style.maxHeight = '90vh';
                            content.style.borderRadius = '12px';
                        }
                            
                        // ç¡®ä¿å†…å®¹å¯ä»¥æ»šåŠ¨
                        content.style.overflowY = 'auto';
                    }
                });
            }
        }
            
        // ä¸“é—¨å¤„ç†ç©ºå†…å®¹çš„å‡½æ•°
        function checkEmptyContent() {
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {
                const content = sqlInput.textContent || sqlInput.innerText;
                if (!content.trim()) {
                    // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæ¸…ç©ºå…ƒç´ å¹¶è®©å…¶èƒ½æ¥æ”¶è¾“å…¥
                    sqlInput.innerHTML = '';
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç¼–è¾‘å™¨çŠ¶æ€
            initializeEditorState();
            
            // åŠ¨æ€è°ƒæ•´æ¨¡æ€æ¡†å°ºå¯¸ä»¥é€‚åº”ç§»åŠ¨ç«¯
            adjustModalForMobile();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', adjustModalForMobile);
            
            // ç›‘å¬æ¨¡æ€æ¡†æ˜¾ç¤ºäº‹ä»¶
            document.addEventListener('shown.bs.modal', function(event) {
                adjustModalForMobile();
            });
            
            // ç›‘å¬ç²˜è´´äº‹ä»¶
            const sqlInput = document.getElementById('sqlInput');
            if (sqlInput) {

                // åˆå§‹æ—¶æ›´æ–°é«˜äº®
                updateSqlHighlight(); // åˆå§‹æ—¶æ›´æ–°é«˜äº®
                
                sqlInput.addEventListener('paste', function() {
                    // ç”¨æˆ·ç²˜è´´å†…å®¹ï¼Œè®¾ç½®æ ‡å¿—
                    userInteractedWithEditor = true;
                    setTimeout(updateSqlHighlight, 10); // ç²˜è´´åç¨ç­‰ä¸€ä¸‹å†æ›´æ–°
                });
                
                // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œå¤„ç†å„ç§å¿«æ·é”®
                sqlInput.addEventListener('keydown', function(e) {
                    const sqlInput = this;
                    
                    console.log('=== é”®ç›˜äº‹ä»¶æ•è· ===');
                    console.log('æŒ‰é”®:', e.key);
                    console.log('Ctrlé”®çŠ¶æ€:', e.ctrlKey);
                    console.log('Shifté”®çŠ¶æ€:', e.shiftKey);
                    console.log('å…ƒç´ ç±»å‹:', sqlInput.tagName);
                    console.log('contentEditableçŠ¶æ€:', sqlInput.contentEditable);
                    console.log('å½“å‰å†…å®¹:', sqlInput.contentEditable === 'true' ? sqlInput.textContent : sqlInput.value);
                    
                    // Ctrl+Z æ’¤é”€
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        console.log('æ£€æµ‹åˆ° Ctrl+Z ç»„åˆé”®');
                        e.preventDefault();
                        e.stopPropagation();
                        undo();
                        console.log('Ctrl+Z å¤„ç†å®Œæˆ');
                        return false;
                    }
                    
                    // Ctrl+Y é‡åš (æˆ–è€… Ctrl+Shift+Z)
                    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                        console.log('æ£€æµ‹åˆ° Ctrl+Y æˆ– Ctrl+Shift+Z ç»„åˆé”®');
                        console.log('Ctrl+Y æˆ– Ctrl+Shift+Z è¢«æŒ‰ä¸‹');
                        e.preventDefault();
                        e.stopPropagation();
                        redo();
                        console.log('Ctrl+Y/Ctrl+Shift+Z å¤„ç†å®Œæˆ');
                        return false;
                    }
                    
                    // Enteré”®å¤„ç† - æŒ‰ç…§ç”¨æˆ·è¦æ±‚è°ƒæ•´è¡Œä¸º
                    if (e.key === 'Enter') {
                        console.log('=== Enteré”®äº‹ä»¶å¤„ç† ===');
                        console.log('Enteré”®è¢«æŒ‰ä¸‹');
                        
                        // å¦‚æœæŒ‰ä½Shifté”®ï¼Œåˆ™å¼ºåˆ¶æ¢è¡Œ
                        if (e.shiftKey) {
                            console.log('Shift+Enter: å¼ºåˆ¶æ¢è¡Œ');
                            return true; // å…è®¸é»˜è®¤æ¢è¡Œè¡Œä¸º
                        }
                        
                        // è·å–å½“å‰å†…å®¹
                        const content = sqlInput.contentEditable === 'true' ? 
                            sqlInput.textContent : sqlInput.value;
                        console.log('å½“å‰å†…å®¹:', content);
                        
                        // æ£€æŸ¥å…‰æ ‡ä½ç½®é™„è¿‘æ˜¯å¦æœ‰åˆ†å·
                        const cursorPos = getCaretPosition(sqlInput);
                        const beforeCursor = content.substring(0, cursorPos).trim();
                        const afterCursor = content.substring(cursorPos).trim();
                        
                        // åˆ¤æ–­é€»è¾‘ï¼šåªæœ‰åœ¨å…‰æ ‡å‰çš„å†…å®¹ä»¥åˆ†å·ç»“å°¾æ—¶æ‰æ‰§è¡Œ
                        const shouldExecute = beforeCursor.endsWith(';');
                        
                        console.log('åˆ¤æ–­ä¾æ®:', {
                            beforeCursor: beforeCursor,
                            afterCursor: afterCursor,
                            endsWithSemicolon: beforeCursor.endsWith(';'),
                            shouldExecute: shouldExecute,
                            cursorPosition: cursorPos
                        });
                        
                        if (shouldExecute) {
                            // æ‰§è¡ŒæŸ¥è¯¢
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('æ‰§è¡ŒæŸ¥è¯¢ - å…‰æ ‡å‰æœ‰åˆ†å·');
                            showExecuteConfirm();
                            console.log('Enteré”®æ‰§è¡ŒæŸ¥è¯¢å¤„ç†å®Œæˆ');
                            return false;
                        } else {
                            // å…è®¸æ¢è¡Œï¼ˆé»˜è®¤è¡Œä¸ºï¼‰- ä¼˜åŒ–ç‰ˆæœ¬
                            console.log('å…è®¸æ¢è¡Œ - å…‰æ ‡å‰æ— åˆ†å·');
                            
                            // å¯¹äºcontentEditableå…ƒç´ ï¼Œç›´æ¥æ“ä½œæ–‡æœ¬å†…å®¹
                            if (sqlInput.contentEditable === 'true') {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // è·å–å½“å‰çŠ¶æ€
                                const originalContent = sqlInput.textContent || '';
                                const cursorPos = getCaretPosition(sqlInput);
                                
                                // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ¢è¡Œç¬¦
                                const newContent = originalContent.substring(0, cursorPos) + '\n' + originalContent.substring(cursorPos);
                                sqlInput.textContent = newContent;
                                
                                // ç«‹å³è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½®
                                setCaretPosition(sqlInput, cursorPos + 1);
                                
                                console.log('Enteré”®æ¢è¡Œå¤„ç†å®Œæˆ - å…‰æ ‡å·²å®šä½');
                                handleSqlInputOptimized();
                                return false;
                            } else {
                                // textareaå…ƒç´ å…è®¸é»˜è®¤æ¢è¡Œè¡Œä¸º
                                console.log('textareaå…è®¸é»˜è®¤æ¢è¡Œ');
                                return true;
                            }
                        }
                    }
                    
                    // å¤„ç†åˆ é™¤é”®è¡Œä¸ºï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
                    if ((e.key === 'Backspace' || e.key === 'Delete')) {
                        // æ£€æŸ¥å½“å‰æ˜¯å¦åªåŒ…å«å ä½ç¬¦æ–‡æœ¬
                        const currentText = sqlInput.contentEditable === 'true' ? 
                            sqlInput.textContent : sqlInput.value;
                        if (currentText.trim() === 'SELECT * FROM your_table LIMIT 100;'.trim()) {
                            // è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºæ­£åœ¨æ¸…ç©ºå ä½ç¬¦
                            isClearingPlaceholder = true;
                            // æ¸…ç©ºå†…å®¹ï¼Œä¸æ˜¾ç¤ºå ä½ç¬¦ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥æ­£å¸¸è¾“å…¥
                            if (sqlInput.contentEditable === 'true') {
                                sqlInput.innerHTML = '';
                            } else {
                                sqlInput.value = '';
                            }
                            // ç”¨æˆ·å·²æ¸…ç©ºå ä½ç¬¦ï¼Œè®¾ç½®æ ‡å¿—
                            userInteractedWithEditor = true;
                            // ç¡®ä¿å…‰æ ‡åœ¨æ­£ç¡®ä½ç½®
                            setTimeout(() => {
                                if (window.getSelection) {
                                    const sel = window.getSelection();
                                    if (sel.rangeCount > 0) {
                                        sel.removeAllRanges();
                                    }
                                    const range = document.createRange();
                                    range.selectNodeContents(sqlInput);
                                    range.collapse(true);
                                    sel.addRange(range);
                                }
                                // æ¸…é™¤æ ‡å¿—
                                isClearingPlaceholder = false;
                            }, 1);
                        }
                    }
                });
                
                // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æ—¶æ¸…é™¤å ä½ç¬¦
                sqlInput.addEventListener('click', function(e) {
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const currentText = this.textContent || this.innerText;
                    if (currentText.trim() === 'SELECT * FROM your_table LIMIT 100;'.trim()) {
                        // è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºæ­£åœ¨æ¸…ç©ºå ä½ç¬¦
                        isClearingPlaceholder = true;
                        // æ¸…ç©ºå†…å®¹
                        this.innerHTML = '';
                        // ç”¨æˆ·å·²ä¸ç¼–è¾‘å™¨äº¤äº’
                        userInteractedWithEditor = true;

                        
                        // ç¡®ä¿å…‰æ ‡åœ¨æ­£ç¡®ä½ç½®
                        if (window.getSelection) {
                            const sel = window.getSelection();
                            if (sel.rangeCount > 0) {
                                sel.removeAllRanges();
                            }
                            const range = document.createRange();
                            range.selectNodeContents(this);
                            range.collapse(true);
                            sel.addRange(range);
                        }
                        
                        // é˜»æ­¢è¿›ä¸€æ­¥çš„äº‹ä»¶å¤„ç†
                        return false;
                    } else {
                        // å¦‚æœç‚¹å‡»æ—¶ä¸æ˜¯å ä½ç¬¦ï¼Œåˆ™è¯´æ˜ç”¨æˆ·å¼€å§‹ä½¿ç”¨ç¼–è¾‘å™¨
                        userInteractedWithEditor = true;
                    }
                });
                
                // ç›‘å¬focusäº‹ä»¶ï¼Œç¡®ä¿è·å¾—ç„¦ç‚¹æ—¶ä¸ä¼šæ˜¾ç¤ºå ä½ç¬¦
                sqlInput.addEventListener('focus', function() {
                    const currentText = this.textContent || this.innerText;
                    if (currentText.trim() === 'SELECT * FROM your_table LIMIT 100;'.trim()) {
                        // å¦‚æœå½“å‰æ˜¯å ä½ç¬¦ï¼Œåˆ™æ¸…é™¤å®ƒ
                        isClearingPlaceholder = true;
                        this.innerHTML = '';
                        userInteractedWithEditor = true;
                        // ç¡®ä¿å…‰æ ‡åœ¨æ­£ç¡®ä½ç½®
                        if (window.getSelection) {
                            const sel = window.getSelection();
                            if (sel.rangeCount > 0) {
                                sel.removeAllRanges();
                            }
                            const range = document.createRange();
                            range.selectNodeContents(this);
                            range.collapse(true);
                            sel.addRange(range);
                        }
                    } else {
                        // å¦‚æœä¸æ˜¯å ä½ç¬¦ï¼Œåˆ™åªæ˜¯æ ‡è®°ç”¨æˆ·å·²äº¤äº’
                        userInteractedWithEditor = true;
                    }
                });
                
                // ç›‘å¬å…¶ä»–å¯èƒ½çš„äº‹ä»¶ï¼Œç¡®ä¿ç”¨æˆ·å¼€å§‹ä½¿ç”¨ç¼–è¾‘å™¨åä¸å†æ˜¾ç¤ºå ä½ç¬¦
                sqlInput.addEventListener('blur', function() {
                    // å³ä½¿å¤±å»ç„¦ç‚¹ï¼Œä¹Ÿè®¤ä¸ºç”¨æˆ·å·²ç»å¼€å§‹ä½¿ç”¨ç¼–è¾‘å™¨
                    userInteractedWithEditor = true;
                });
                
                sqlInput.addEventListener('input', function() {
                    // ä»»ä½•è¾“å…¥äº‹ä»¶éƒ½è¡¨æ˜ç”¨æˆ·åœ¨ä½¿ç”¨ç¼–è¾‘å™¨
                    userInteractedWithEditor = true;
                    
                    // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
                    const content = sqlInput.contentEditable === 'true' ? 
                        sqlInput.textContent : sqlInput.value;
                    const cursorPos = getCaretPosition(sqlInput);
                    
                    // ä½¿ç”¨setTimeoutè¿›è¡Œç®€å•çš„é˜²æŠ–
                    clearTimeout(sqlInput.historyTimeout);
                    sqlInput.historyTimeout = setTimeout(() => {
                        saveToHistory(content, cursorPos);
                    }, 500); // 500msé˜²æŠ–
                });
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°sqlInputå…ƒç´ ï¼Œä¹Ÿè¦æ›´æ–°é«˜äº®
                updateSqlHighlight();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç¾åŒ–å™¨çŠ¶æ€
        window.addEventListener('load', function() {
            console.log('=== SQLç¾åŒ–å™¨è¯Šæ–­ä¿¡æ¯ ===');
            console.log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
            console.log('SqlBeautifierçŠ¶æ€æ£€æŸ¥:');
            console.log('- typeof SqlBeautifier:', typeof SqlBeautifier);
            console.log('- SqlBeautifier exists:', typeof SqlBeautifier !== 'undefined');
            if (typeof SqlBeautifier !== 'undefined') {
                console.log('- typeof SqlBeautifier.beautify:', typeof SqlBeautifier.beautify);
                console.log('- SqlBeautifier.beautify is function:', typeof SqlBeautifier.beautify === 'function');
                // æµ‹è¯•ç¾åŒ–åŠŸèƒ½
                try {
                    const testResult = new SqlBeautifier().beautify('select * from test');
                    console.log('âœ“ ç¾åŒ–å™¨æµ‹è¯•æˆåŠŸ:', testResult);
                } catch (error) {
                    console.error('âœ— ç¾åŒ–å™¨æµ‹è¯•å¤±è´¥:', error);
                }
            } else {
                console.log('âœ— SqlBeautifieræœªå®šä¹‰');
            }
            console.log('=== è¯Šæ–­ç»“æŸ ===');
        });
    </script>
</body>
</html>            
